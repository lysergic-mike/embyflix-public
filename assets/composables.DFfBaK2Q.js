import{r as e,o as t,a as r,u as o,p as a,i as n}from"./vue-vendor.C_Pyh8sQ.js";import{C as i}from"./components.7o9iPyN2.js";import{H as s}from"./hls-vendor.swFHWmXm.js";const l=()=>{try{return"undefined"!=typeof window&&void 0!==window.localStorage}catch{return!1}},c=(e,t,r)=>{if(l())try{const o=JSON.stringify({isAuthenticated:e,currentUser:t,isDemoMode:r});localStorage.setItem("embyflix-auth",o),console.log("[Auth] Saved auth state to localStorage:",{isAuth:e,user:t,isDemo:r})}catch(o){if(o instanceof DOMException&&"QuotaExceededError"===o.name){console.error("[Auth] localStorage quota exceeded (5 MB limit). Attempting to clear old data...");try{localStorage.removeItem("embyflix-auth"),localStorage.setItem("embyflix-auth",JSON.stringify({isAuthenticated:e,currentUser:t,isDemoMode:r})),console.log("[Auth] Successfully saved auth state after clearing old data")}catch(a){console.error("[Auth] Failed to save auth state after clearing:",a)}}else console.error("[Auth] Failed to save auth state:",o)}else console.warn("[Auth] localStorage is not available, state will not persist")},u=(()=>{if(!l())return console.warn("[Auth] localStorage is not available"),{isAuthenticated:!1,currentUser:null,isDemoMode:!1};try{const e=localStorage.getItem("embyflix-auth");if(e){const t=JSON.parse(e);return console.log("[Auth] Loaded auth state from localStorage:",t),{isAuthenticated:t.isAuthenticated||!1,currentUser:t.currentUser||null,isDemoMode:t.isDemoMode||!1}}console.log("[Auth] No saved auth state found in localStorage")}catch(e){console.error("[Auth] Failed to load auth state:",e)}return{isAuthenticated:!1,currentUser:null,isDemoMode:!1}})(),d=e(u.isAuthenticated),m=e(u.currentUser),g=e(u.isDemoMode);function v(){return{isAuthenticated:d,currentUser:m,isDemoMode:g,login:e=>{console.log("[Auth] Login called with user:",e),d.value=!0,m.value=e,g.value=!1,c(!0,e,!1),console.log("[Auth] Login complete. isAuthenticated:",d.value,"currentUser:",m.value)},logout:()=>{if(console.log("[Auth] Logout called"),d.value=!1,m.value=null,g.value=!1,c(!1,null,!1),l())try{localStorage.removeItem("embyflix-api"),console.log("[Auth] API state cleared from localStorage")}catch(e){console.error("Failed to remove API state:",e)}console.log("[Auth] Logout complete")},enableDemoMode:()=>{console.log("[Auth] Enabling demo mode"),g.value=!0,d.value=!0,m.value={Name:"Demo User",Id:"demo-user-id"},c(!0,m.value,!0),console.log("[Auth] Demo mode enabled")}}}function h(){const t=e([{Id:"demo-movies",Name:"Movies",Type:"CollectionFolder",CollectionType:"movies"},{Id:"demo-tvshows",Name:"TV Shows",Type:"CollectionFolder",CollectionType:"tvshows"},{Id:"demo-collections",Name:"Collections",Type:"CollectionFolder",CollectionType:"collections"}]),r=e([{Id:"demo-1",Name:"The Cosmic Journey",Type:"Movie",ProductionYear:2023,Overview:"An epic space adventure that follows a crew of explorers as they venture beyond the known galaxy to discover new worlds and face unexpected challenges. Their journey tests the limits of human courage and ingenuity as they encounter alien civilizations and cosmic phenomena that defy understanding.",CommunityRating:8.4,OfficialRating:"PG-13",RunTimeTicks:72e9,Genres:["Science Fiction","Adventure","Drama"],ImageUrl:"/DemoContent/Posters/joker-poster.png",HeroImageUrl:"/DemoContent/HeroImages/avengers-hero-banner.jpg"},{Id:"demo-2",Name:"Mystery at Midnight Manor",Type:"Movie",ProductionYear:2022,Overview:"A classic whodunit mystery set in a sprawling Victorian mansion. When a renowned detective is invited to a weekend party, he finds himself investigating a puzzling murder that occurred at the stroke of midnight. Every guest has secrets, and everyone is a suspect.",CommunityRating:7.9,OfficialRating:"PG",RunTimeTicks:66e9,Genres:["Mystery","Thriller","Drama"],ImageUrl:"/DemoContent/Posters/dr-strange-poster.jpg",HeroImageUrl:"/DemoContent/HeroImages/avengers-2-hero-banner.jpg"},{Id:"demo-3",Name:"Laughing Through Life",Type:"Movie",ProductionYear:2024,Overview:"A heartwarming comedy about a struggling comedian who discovers that the best jokes come from the most unexpected moments in life. Follow her journey from open mic nights to the big stage as she learns that laughter truly is the best medicine.",CommunityRating:8.1,OfficialRating:"R",RunTimeTicks:54e9,Genres:["Comedy","Drama"],ImageUrl:"/DemoContent/Posters/exorcist-poster.jpg",HeroImageUrl:"/DemoContent/HeroImages/xmen-hero-image.jpg"},{Id:"demo-4",Name:"Dragon's Peak",Type:"Movie",ProductionYear:2023,Overview:"In a realm where dragons and humans once coexisted, a young warrior must climb the legendary Dragon's Peak to prevent an ancient evil from returning. This epic fantasy adventure combines stunning visuals with a timeless tale of courage and friendship.",CommunityRating:9.2,OfficialRating:"PG-13",RunTimeTicks:9e10,Genres:["Fantasy","Adventure","Action"],ImageUrl:"/DemoContent/Posters/wayns-world-2-poster.jpg"},{Id:"demo-5",Name:"The Last Algorithm",Type:"Movie",ProductionYear:2024,Overview:"A gripping techno-thriller about a brilliant programmer who discovers a hidden algorithm that could either save humanity or bring about its downfall. As powerful corporations hunt her down, she must decide who to trust in a world where nothing is as it seems.",CommunityRating:8.7,OfficialRating:"R",RunTimeTicks:78e9,Genres:["Thriller","Science Fiction","Action"],ImageUrl:"/DemoContent/Posters/joker-poster.png"},{Id:"demo-6",Name:"Summer of '89",Type:"Movie",ProductionYear:2023,Overview:"A nostalgic coming-of-age story set during one unforgettable summer. Follow a group of friends as they navigate the challenges of growing up, discovering who they are, and learning the true meaning of friendship before everything changes forever.",CommunityRating:8.5,OfficialRating:"PG-13",RunTimeTicks:6e10,Genres:["Drama","Romance","Coming of Age"],ImageUrl:"/DemoContent/Posters/joker-poster.png"}]),o=e([{Id:"demo-tv-1",Name:"Tech Titans",Type:"Series",ProductionYear:2023,Overview:"A dramatic series following the rise and fall of tech entrepreneurs in Silicon Valley.",CommunityRating:8.8,OfficialRating:"TV-MA",Genres:["Drama","Technology"],ImageUrl:"/DemoContent/Posters/dr-strange-poster.jpg"},{Id:"demo-tv-2",Name:"Galactic Patrol",Type:"Series",ProductionYear:2022,Overview:"Space opera following an intergalactic police force protecting the universe.",CommunityRating:9,OfficialRating:"TV-14",Genres:["Science Fiction","Action","Adventure"],ImageUrl:"/DemoContent/Posters/wayns-world-2-poster.jpg"}]),a=e([{Id:"demo-collection-1",Name:"Epic Space Saga",Type:"BoxSet",Overview:"The complete collection of space adventure films.",ImageUrl:"/DemoContent/Posters/joker-poster.png",ChildCount:3},{Id:"demo-collection-2",Name:"Mystery Classics",Type:"BoxSet",Overview:"Timeless mystery and detective stories.",ImageUrl:"/DemoContent/Posters/exorcist-poster.jpg",ChildCount:5}]),n=e([{Id:"demo-tv-1-s1",Name:"Season 1",Type:"Season",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",IndexNumber:1,ProductionYear:2023},{Id:"demo-tv-1-s2",Name:"Season 2",Type:"Season",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",IndexNumber:2,ProductionYear:2024},{Id:"demo-tv-2-s1",Name:"Season 1",Type:"Season",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",IndexNumber:1,ProductionYear:2022}]),i=e([{Id:"demo-tv-1-s1e1",Name:"The Pitch",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:1,ParentIndexNumber:1,ProductionYear:2023,Overview:"A young entrepreneur pitches her revolutionary app idea to investors.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s1e2",Name:"First Hire",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:2,ParentIndexNumber:1,ProductionYear:2023,Overview:"The team struggles to find their first key employee.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s1e3",Name:"Beta Launch",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:3,ParentIndexNumber:1,ProductionYear:2023,Overview:"The app launches to the public with unexpected results.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s2e1",Name:"Scaling Up",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:1,ParentIndexNumber:2,ProductionYear:2024,Overview:"The company faces growing pains as it expands rapidly.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s2e2",Name:"Competitor Threat",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:2,ParentIndexNumber:2,ProductionYear:2024,Overview:"A well-funded competitor emerges with a similar product.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s2e3",Name:"Acquisition Offer",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:3,ParentIndexNumber:2,ProductionYear:2024,Overview:"A major tech company makes an unexpected acquisition offer.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s2e4",Name:"Breaking Point",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:4,ParentIndexNumber:2,ProductionYear:2024,Overview:"The startup faces a critical decision that could make or break the company.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e1",Name:"New Recruit",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:1,ParentIndexNumber:1,ProductionYear:2022,Overview:"A rookie joins the elite Galactic Patrol force.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e2",Name:"First Mission",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:2,ParentIndexNumber:1,ProductionYear:2022,Overview:"The team investigates a distress signal from a remote planet.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e3",Name:"Alien Encounter",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:3,ParentIndexNumber:1,ProductionYear:2022,Overview:"First contact with a new alien species goes wrong.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e4",Name:"The Artifact",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:4,ParentIndexNumber:1,ProductionYear:2022,Overview:"Discovery of an ancient artifact threatens galactic peace.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e5",Name:"Betrayal",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:5,ParentIndexNumber:1,ProductionYear:2022,Overview:"A trusted member of the patrol may be working with the enemy.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e6",Name:"The Rise of Heroes",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:6,ParentIndexNumber:1,ProductionYear:2022,Overview:"The patrol faces their greatest challenge yet as an ancient threat emerges.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"}]),s=e([{Id:"demo-cw-1",Name:"The Rise of Heroes",Type:"Episode",SeriesName:"Galactic Patrol",SeriesId:"demo-tv-2",SeasonId:"demo-tv-2-s1",IndexNumber:6,ParentIndexNumber:1,ProductionYear:2022,Overview:"The patrol faces their greatest challenge yet as an ancient threat emerges.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/HeroImages/avengers-hero-banner.jpg",UserData:{PlaybackPositionTicks:165e8,PlayedPercentage:55,Played:!1}},{Id:"demo-cw-2",Name:"The Cosmic Journey",Type:"Movie",ProductionYear:2023,Overview:"An epic space adventure that follows a crew of explorers.",RunTimeTicks:72e9,ImageUrl:"/DemoContent/HeroImages/avengers-2-hero-banner.jpg",UserData:{PlaybackPositionTicks:216e8,PlayedPercentage:30,Played:!1}},{Id:"demo-cw-3",Name:"Breaking Point",Type:"Episode",SeriesName:"Tech Titans",SeriesId:"demo-tv-1",SeasonId:"demo-tv-1-s2",IndexNumber:4,ParentIndexNumber:2,ProductionYear:2023,Overview:"The startup faces a critical decision that could make or break the company.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/HeroImages/xmen-hero-image.jpg",UserData:{PlaybackPositionTicks:264e8,PlayedPercentage:80,Played:!1}}]),l=e=>[...r.value,...o.value,...a.value].find(t=>t.Id===e);return{demoLibraries:t,demoMovies:r,demoTVShows:o,demoCollections:a,getLibraries:()=>t.value,getLibraryItems:e=>"demo-movies"===e?r.value:"demo-tvshows"===e?o.value:"demo-collections"===e?a.value:[],getItemDetails:l,getCollectionItems:e=>r.value.slice(0,3),getContinueWatching:()=>s.value,getSimilarItems:(e,t=15)=>{const a=l(e);if(!a)return[];return("Series"===a.Type?o.value:r.value).filter(t=>t.Id!==e).map(e=>{const t=e.Genres?.filter(e=>a.Genres?.includes(e)).length||0;return{item:e,score:t}}).sort((e,t)=>t.score-e.score).map(({item:e})=>e).slice(0,t)},getSeasons:e=>n.value.filter(t=>t.SeriesId===e),getEpisodes:(e,t)=>i.value.filter(r=>r.SeriesId===e&&r.SeasonId===t)}}const y={},f=function(e,t,r){let o=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};const a=document.getElementsByTagName("link"),n=document.querySelector("meta[property=csp-nonce]"),i=n?.nonce||n?.getAttribute("nonce");o=e(t.map(e=>{if(e=function(e,t){return new URL(e,t).href}(e,r),e in y)return;y[e]=!0;const t=e.endsWith(".css"),o=t?'[rel="stylesheet"]':"";if(r)for(let r=a.length-1;r>=0;r--){const o=a[r];if(o.href===e&&(!t||"stylesheet"===o.rel))return}else if(document.querySelector(`link[href="${e}"]${o}`))return;const n=document.createElement("link");return n.rel=t?"stylesheet":"modulepreload",t||(n.as="script"),n.crossOrigin="",n.href=e,i&&n.setAttribute("nonce",i),document.head.appendChild(n),t?new Promise((t,r)=>{n.addEventListener("load",t),n.addEventListener("error",()=>r(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function a(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return o.then(t=>{for(const e of t||[])"rejected"===e.status&&a(e.reason);return e().catch(a)})},p=()=>{try{return"undefined"!=typeof window&&void 0!==window.localStorage}catch{return!1}},w=(()=>{if(!p())return console.warn("[EmbyAPI] localStorage is not available"),{serverUrl:"",userId:"",accessToken:""};try{const e=localStorage.getItem("embyflix-api");if(e){const t=JSON.parse(e);return console.log("[EmbyAPI] Loaded API state from localStorage:",{serverUrl:t.serverUrl,userId:t.userId,hasToken:!!t.accessToken}),{serverUrl:t.serverUrl||"",userId:t.userId||"",accessToken:t.accessToken||""}}console.log("[EmbyAPI] No saved API state found in localStorage")}catch(e){console.error("[EmbyAPI] Failed to load API state:",e)}return{serverUrl:"",userId:"",accessToken:""}})(),b=new Map,I=new Map,S=(e,t={})=>`${e}?${Object.keys(t).sort().map(e=>`${e}=${t[e]}`).join("&")}`,T=e=>{const t=I.get(e);return t&&(e=>!!e&&Date.now()-e.timestamp<3e5)(t)?(console.log("[EmbyAPI] Cache hit:",e),t.data):(t&&(console.log("[EmbyAPI] Cache expired:",e),I.delete(e)),null)},P=(e,t)=>{I.set(e,{data:t,timestamp:Date.now()}),console.log("[EmbyAPI] Cached:",e)},M=()=>{I.clear(),b.clear(),console.log("[EmbyAPI] Cache cleared")},E=e(w.serverUrl),k=e(w.userId),D=e(w.accessToken),C=e(!1),A=e(null);function R(){const e=()=>{const e={"Content-Type":"application/json","X-Emby-Authorization":'MediaBrowser Client="EmbyFlix", Device="Samsung TV", DeviceId="embyflix-tizen", Version="1.0.0"'};return D.value&&(e["X-Emby-Token"]=D.value),e},t=async(t,r)=>{C.value=!0,A.value=null;try{let o=`${E.value}/emby/Shows/${t}/Episodes?UserId=${k.value}&Fields=Overview,PrimaryImageAspectRatio`;r&&(o+=`&SeasonId=${r}`);const a=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)throw new Error(`Failed to get episodes: ${a.status}`);return(await a.json()).Items||[]}catch(o){throw A.value=o instanceof Error?o.message:"Unknown error",console.error("[EmbyAPI] getEpisodes error:",o),o}finally{C.value=!1}},r=async t=>{console.log("[EmbyAPI] getItemDetails called:",t),C.value=!0,A.value=null;try{const r=`${E.value}/emby/Users/${k.value}/Items/${t}?fields=ShareLevel`;console.log("[EmbyAPI] Fetching item details URL:",r);const o=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!o.ok)throw console.error("[EmbyAPI] Failed to get item details. Status:",o.status),new Error(`Failed to get item details: ${o.status}`);const a=await o.json();return console.log("[EmbyAPI] Received item details:",a),a}catch(r){throw A.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] getItemDetails error:",r),r}finally{C.value=!1}},o=(e,t="Primary",r=300)=>{const o=new URLSearchParams({maxWidth:r.toString(),quality:"90",api_key:D.value});return`${E.value}/emby/Items/${e}/Images/${t}?${o.toString()}`};return{serverUrl:E,userId:k,accessToken:D,isLoading:C,error:A,authenticateByName:async(t,r,o="")=>{console.log("[EmbyAPI] Authenticating:",{server:t,username:r}),C.value=!0,A.value=null;try{E.value=t;const a=`${t}/emby/Users/AuthenticateByName`,n={Username:r,Pw:o},i=await fetch(a,{method:"POST",headers:e(),body:JSON.stringify(n),mode:"cors",credentials:"omit"});if(!i.ok){console.error("[EmbyAPI] Authentication failed with status:",i.status);let e="Authentication failed";throw 401===i.status?e="Invalid username or password":404===i.status?e="Server not found. Check the server URL":i.status>=500&&(e="Server error. Please try again later"),new Error(e)}const s=await i.json();return D.value=s.AccessToken,k.value=s.User.Id,console.log("[EmbyAPI] Authentication successful:",{userId:k.value,userName:s.User.Name,serverUrl:E.value}),((e,t,r)=>{if(p())try{const o=JSON.stringify({serverUrl:e,userId:t,accessToken:r});localStorage.setItem("embyflix-api",o),console.log("[EmbyAPI] Saved API state to localStorage:",{serverUrl:e,userId:t,hasToken:!!r})}catch(o){if(o instanceof DOMException&&"QuotaExceededError"===o.name){console.error("[EmbyAPI] localStorage quota exceeded (5 MB limit). Attempting to clear old data...");try{localStorage.removeItem("embyflix-api"),localStorage.setItem("embyflix-api",JSON.stringify({serverUrl:e,userId:t,accessToken:r})),console.log("[EmbyAPI] Successfully saved API state after clearing old data")}catch(a){console.error("[EmbyAPI] Failed to save API state after clearing:",a)}}else console.error("[EmbyAPI] Failed to save API state:",o)}else console.warn("[EmbyAPI] localStorage is not available, API state will not persist")})(E.value,k.value,D.value),s}catch(a){let e="Unknown error";throw a instanceof TypeError&&a.message.includes("fetch")?e="Cannot connect to server.":a instanceof Error&&(e=a.message),A.value=e,console.error("[EmbyAPI] Authentication error:",a),new Error(e)}finally{C.value=!1}},getViews:async()=>{const t=S("views",{userId:k.value}),r=T(t);if(r)return r;C.value=!0,A.value=null;try{const r=`${E.value}/emby/Users/${k.value}/Views`,o=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!o.ok)throw new Error(`Failed to get views: ${o.status}`);const a=(await o.json()).Items||[];return P(t,a),a}catch(o){throw A.value=o instanceof Error?o.message:"Unknown error",o}finally{C.value=!1}},getItems:async(t,r=null)=>{console.log("[EmbyAPI] getItems called:",{parentId:t,itemType:r});const o=S("items",{parentId:t,itemType:r||"all",userId:k.value}),a=T(o);if(a)return a;C.value=!0,A.value=null;try{const a=[];let n=0;const i=300;let s=0;do{let o=`${E.value}/emby/Users/${k.value}/Items?ParentId=${t}&Recursive=true&StartIndex=${n}&Limit=${i}`;r&&(o+=`&IncludeItemTypes=${r}`),o+="&Fields=UserData,Genres,Studios,Overview,CommunityRating,CriticRating,ProductionYear",console.log("[EmbyAPI] Fetching URL:",o,`(${n}-${n+i})`);const l=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!l.ok)throw console.error("[EmbyAPI] Failed to get items. Status:",l.status),new Error(`Failed to get items: ${l.status}`);const c=await l.json();s=c.TotalRecordCount||0;const u=c.Items||[];console.log("[EmbyAPI] Received batch:",u.length,`Total: ${a.length+u.length}/${s}`),a.push(...u),n+=i}while(n<s);return console.log("[EmbyAPI] Received all items:",a.length),P(o,a),a}catch(n){throw A.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getItems error:",n),n}finally{C.value=!1}},getCollectionItems:async t=>{const r=S("collection",{collectionId:t,userId:k.value}),o=T(r);if(o)return o;C.value=!0,A.value=null;try{const o=[];let a=0;const n=300;let i=0;do{const r=`${E.value}/emby/Users/${k.value}/Items?ParentId=${t}&StartIndex=${a}&Limit=${n}&Fields=UserData`,s=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!s.ok)throw new Error(`Failed to get collection items: ${s.status}`);const l=await s.json();i=l.TotalRecordCount||0;const c=l.Items||[];o.push(...c),a+=n}while(a<i);return console.log("[EmbyAPI] Received all collection items:",o.length),P(r,o),o}catch(a){throw A.value=a instanceof Error?a.message:"Unknown error",a}finally{C.value=!1}},getSeasons:async t=>{C.value=!0,A.value=null;try{const r=`${E.value}/emby/Shows/${t}/Seasons?UserId=${k.value}`,o=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!o.ok)throw new Error(`Failed to get seasons: ${o.status}`);return(await o.json()).Items||[]}catch(r){throw A.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] getSeasons error:",r),r}finally{C.value=!1}},getEpisodes:t,getNextEpisode:async e=>{if("Episode"!==e.Type||!e.SeriesId)return null;try{const r=await t(e.SeriesId),o=r.findIndex(t=>t.Id===e.Id);return-1===o||o===r.length-1?null:r[o+1]}catch(r){return console.error("[EmbyAPI] getNextEpisode error:",r),null}},getPreviousEpisode:async e=>{if("Episode"!==e.Type||!e.SeriesId)return null;try{const r=await t(e.SeriesId),o=r.findIndex(t=>t.Id===e.Id);return o<=0?null:r[o-1]}catch(r){return console.error("[EmbyAPI] getPreviousEpisode error:",r),null}},getContinueWatching:async()=>{const t=S("continueWatching",{userId:k.value}),r=T(t);if(r)return r;C.value=!0,A.value=null;try{const r=`${E.value}/emby/Users/${k.value}/Items/Resume?Limit=10&Recursive=true&Fields=PrimaryImageAspectRatio,BasicSyncInfo&ImageTypeLimit=1&EnableImageTypes=Primary&MediaTypes=Video`;console.log("[EmbyAPI] Fetching continue watching items");const o=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!o.ok)throw new Error(`Failed to get continue watching: ${o.status}`);const a=(await o.json()).Items||[];return console.log("[EmbyAPI] Continue watching items:",a.length),P(t,a),a}catch(o){throw A.value=o instanceof Error?o.message:"Unknown error",console.error("[EmbyAPI] getContinueWatching error:",o),o}finally{C.value=!1}},getRecentlyWatched:async(t=20,r=["Movie","Series"])=>{const o=S("recentlyWatched",{userId:k.value,limit:t,itemTypes:r.join(",")}),a=T(o);if(a)return a;C.value=!0,A.value=null;try{const a=`${E.value}/emby/Users/${k.value}/Items?Limit=${t}&Recursive=true&SortBy=DatePlayed&SortOrder=Descending&Filters=IsPlayed&Fields=PrimaryImageAspectRatio,BasicSyncInfo&ImageTypeLimit=1&EnableImageTypes=Primary&IncludeItemTypes=${r.join(",")}`;console.log("[EmbyAPI] Fetching recently watched items:",r.join(","));const n=await fetch(a,{headers:e(),mode:"cors",credentials:"omit"});if(!n.ok)throw new Error(`Failed to get recently watched: ${n.status}`);const i=(await n.json()).Items||[];return console.log("[EmbyAPI] Recently watched items:",i.length),P(o,i),i}catch(n){throw A.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getRecentlyWatched error:",n),n}finally{C.value=!1}},getItemDetails:r,getMediaSources:async t=>{try{const r=`${E.value}/emby/Items/${t}/PlaybackInfo?UserId=${k.value}`;console.log("[EmbyAPI] Fetching media sources:",r);const o=await fetch(r,{method:"POST",headers:e(),body:JSON.stringify({DeviceProfile:{MaxStreamingBitrate:14e7}}),mode:"cors",credentials:"omit"});if(!o.ok)throw new Error(`Failed to get media sources: ${o.status}`);const a=await o.json();return console.log("[EmbyAPI] Media sources response:",a),a.MediaSources||[]}catch(r){throw console.error("[EmbyAPI] getMediaSources error:",r),r}},getPlaybackInfo:async(t,r,o)=>{try{const a=new URLSearchParams({UserId:k.value,StartTimeTicks:"0",IsPlayback:"true",AutoOpenLiveStream:"true",MaxStreamingBitrate:"140000000"});void 0!==r&&a.append("AudioStreamIndex",r.toString()),void 0!==o&&a.append("SubtitleStreamIndex",o.toString());const n=`${E.value}/emby/Items/${t}/PlaybackInfo?${a.toString()}`;console.log("[EmbyAPI] Fetching playback info:",n);const i=await fetch(n,{method:"POST",headers:e(),body:JSON.stringify({DeviceProfile:{MaxStreamingBitrate:14e7,MusicStreamingTranscodingBitrate:192e3}}),mode:"cors",credentials:"omit"});if(!i.ok){console.error("[EmbyAPI] Failed to get playback info. Status:",i.status);const e=await i.text();throw console.error("[EmbyAPI] Error response:",e),new Error(`Failed to get playback info: ${i.status}`)}const s=await i.json();if(console.log("[EmbyAPI] Playback info response:",s),s.ErrorCode)throw console.error("[EmbyAPI] Playback error code:",s.ErrorCode),new Error(`Playback error: ${s.ErrorCode}`);return s}catch(a){throw console.error("[EmbyAPI] getPlaybackInfo error:",a),a}},getStreamUrl:e=>{const t=new URLSearchParams({Static:"true",MediaSourceId:e,DeviceId:"EmbyFlix",api_key:D.value});return`${E.value}/emby/Videos/${e}/stream.mp4?${t.toString()}`},generatePlaySessionId:()=>`${Date.now()}_${Math.random().toString(36).substring(2,11)}`,reportPlaybackStart:async(t,r)=>{try{const o=`${E.value}/emby/Sessions/Playing`,a={ItemId:t,PlaySessionId:r,MediaSourceId:t,CanSeek:!0,IsMuted:!1,IsPaused:!1,PositionTicks:0,PlayMethod:"DirectStream"};console.log("[EmbyAPI] Reporting playback start:",a),await fetch(o,{method:"POST",headers:e(),body:JSON.stringify(a),mode:"cors",credentials:"omit"})}catch(o){console.error("Failed to report playback start:",o)}},reportPlaybackProgress:async(t,r,o,a)=>{try{const n=`${E.value}/emby/Sessions/Playing/Progress`,i={ItemId:t,PlaySessionId:a,MediaSourceId:t,PositionTicks:r,IsPaused:o,IsMuted:!1,PlayMethod:"DirectStream"};await fetch(n,{method:"POST",headers:e(),body:JSON.stringify(i),mode:"cors",credentials:"omit"})}catch(n){console.error("Failed to report playback progress:",n)}},reportPlaybackStopped:async(t,o,a)=>{try{const n=`${E.value}/emby/Sessions/Playing/Stopped`,i={ItemId:t,PlaySessionId:a,MediaSourceId:t,PositionTicks:o,PlayMethod:"DirectStream"};await fetch(n,{method:"POST",headers:e(),body:JSON.stringify(i),mode:"cors",credentials:"omit"}),f(async()=>{const{useAnalytics:e}=await Promise.resolve().then(()=>Oe);return{useAnalytics:e}},void 0,import.meta.url).then(({useAnalytics:e})=>{e().trackPlaybackFromTicks(t,o,r)}).catch(e=>{console.error("[EmbyAPI] Failed to load analytics module:",e)})}catch(n){console.error("Failed to report playback stopped:",n)}},getImageUrl:o,getHeroImageUrl:async t=>{const r=`${t}-hero`;if(b.has(r))return b.get(r);try{const o=`${E.value}/emby/Users/${k.value}/Items/${t}?Fields=RemoteTrailers,ProviderIds`,a=await fetch(o,{headers:e(),cache:"default"});if(a.ok){const o=await a.json();if(o.ProviderIds?.Tmdb){const o=`${E.value}/emby/Items/${t}/RemoteImages?ProviderName=TheMovieDb&Type=Backdrop&IncludeAllLanguages=false`,a=await fetch(o,{headers:e(),cache:"default"});if(a.ok){const e=await a.json();if(e.Images&&e.Images.length>0){const t=e.Images[0].Url;return b.set(r,t),t}}}}}catch(s){console.log("[EmbyAPI] Could not fetch TMDB backdrop, falling back to Emby images:",s)}const a=new URLSearchParams({maxWidth:"1920",quality:"90",api_key:D.value}),n=`${E.value}/emby/Items/${t}/Images/Backdrop?${a.toString()}`;try{if((await fetch(n,{method:"HEAD",cache:"force-cache"})).ok)return b.set(r,n),n}catch{}const i=o(t,"Primary",1920);return b.set(r,i),i},searchItems:async(t,r)=>{if(!t.trim())return[];console.log("[EmbyAPI] searchItems called:",{query:t,itemTypes:r});const o=S("search",{query:t.toLowerCase(),itemTypes:r?.join(",")||"all",userId:k.value}),a=T(o);if(a)return a;C.value=!0,A.value=null;try{const a=new URLSearchParams({SearchTerm:t,Recursive:"true",Fields:"UserData,CriticRating,CommunityRating,OfficialRating,Studios,TagItems,Genres,Name,ProviderIds",Limit:"100",UserId:k.value});r&&r.length>0&&a.append("IncludeItemTypes",r.join(","));const n=`${E.value}/emby/Users/${k.value}/Items?${a.toString()}`;console.log("[EmbyAPI] Search URL:",n);const i=await fetch(n,{headers:e(),mode:"cors",credentials:"omit"});if(!i.ok)throw console.error("[EmbyAPI] Failed to search items. Status:",i.status),new Error(`Failed to search items: ${i.status}`);const s=(await i.json()).Items||[];return console.log("[EmbyAPI] Search results:",s.length),P(o,s),s}catch(n){throw A.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] searchItems error:",n),n}finally{C.value=!1}},searchItemsByExternalId:async(t,r,o)=>{if(!t&&!r)return[];console.log("[EmbyAPI] searchItemsByExternalId called:",{imdbId:t,tmdbId:r,itemTypes:o});const a=S("search-external-id",{imdbId:t||"",tmdbId:r||"",itemTypes:o?.join(",")||"all",userId:k.value}),n=T(a);if(n)return n;C.value=!0,A.value=null;try{const n=new URLSearchParams({Recursive:"true",Fields:"UserData,CriticRating,CommunityRating,OfficialRating,Studios,TagItems,Genres,Name,ProviderIds,ProductionYear",Limit:"100",UserId:k.value});t&&n.append("AnyProviderIdEquals",`imdb.${t}`),r&&n.append("AnyProviderIdEquals",`tmdb.${r}`),o&&o.length>0&&n.append("IncludeItemTypes",o.join(","));const i=`${E.value}/emby/Users/${k.value}/Items?${n.toString()}`;console.log("[EmbyAPI] Search by external ID URL:",i);const s=await fetch(i,{headers:e(),mode:"cors",credentials:"omit"});if(!s.ok)throw console.error("[EmbyAPI] Failed to search by external ID. Status:",s.status),new Error(`Failed to search by external ID: ${s.status}`);const l=(await s.json()).Items||[];return console.log("[EmbyAPI] Search by external ID results:",l.length),P(a,l),l}catch(i){throw A.value=i instanceof Error?i.message:"Unknown error",console.error("[EmbyAPI] searchItemsByExternalId error:",i),i}finally{C.value=!1}},getSimilarItems:async(t,r=15)=>{console.log("[EmbyAPI] getSimilarItems called:",{itemId:t,limit:r});const o=S("similar-items",{itemId:t,limit:r,userId:k.value}),a=T(o);if(a)return a;C.value=!0,A.value=null;try{const a=new URLSearchParams({UserId:k.value,Limit:r.toString(),Fields:"UserData,CriticRating,CommunityRating,OfficialRating,ProductionYear"}),n=`${E.value}/emby/Items/${t}/Similar?${a.toString()}`;console.log("[EmbyAPI] Similar items URL:",n);const i=await fetch(n,{headers:e(),mode:"cors",credentials:"omit"});if(!i.ok)throw console.error("[EmbyAPI] Failed to get similar items. Status:",i.status),new Error(`Failed to get similar items: ${i.status}`);const s=(await i.json()).Items||[];return console.log("[EmbyAPI] Similar items results:",s.length),P(o,s),s}catch(n){throw A.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getSimilarItems error:",n),n}finally{C.value=!1}},markAsPlayed:async t=>{console.log("[EmbyAPI] markAsPlayed called:",{itemId:t}),C.value=!0,A.value=null;try{const r=`${E.value}/emby/Users/${k.value}/PlayedItems/${t}`;console.log("[EmbyAPI] Mark as played URL:",r);const o=await fetch(r,{method:"POST",headers:e(),mode:"cors",credentials:"omit"});if(!o.ok)throw console.error("[EmbyAPI] Failed to mark as played. Status:",o.status),new Error(`Failed to mark as played: ${o.status}`);console.log("[EmbyAPI] Item marked as played successfully");const a=S("continueWatching",{userId:k.value});I.delete(a)}catch(r){throw A.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] markAsPlayed error:",r),r}finally{C.value=!1}},markAsUnplayed:async t=>{console.log("[EmbyAPI] markAsUnplayed called:",{itemId:t}),C.value=!0,A.value=null;try{const r=`${E.value}/emby/Users/${k.value}/PlayedItems/${t}`;console.log("[EmbyAPI] Mark as unplayed URL:",r);const o=await fetch(r,{method:"DELETE",headers:e(),mode:"cors",credentials:"omit"});if(!o.ok)throw console.error("[EmbyAPI] Failed to mark as unplayed. Status:",o.status),new Error(`Failed to mark as unplayed: ${o.status}`);console.log("[EmbyAPI] Item marked as unplayed successfully");const a=S("continueWatching",{userId:k.value});I.delete(a)}catch(r){throw A.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] markAsUnplayed error:",r),r}finally{C.value=!1}},getIntroSkipMarkers:async t=>{console.log("[EmbyAPI] getIntroSkipMarkers called:",{itemId:t});try{const r=`${E.value}/emby/Users/${k.value}/Items/${t}`,o=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!o.ok)return console.error("[EmbyAPI] Failed to get intro markers. Status:",o.status),null;const a=await o.json();if(a.Chapters&&Array.isArray(a.Chapters)){const e=a.Chapters.find(e=>"IntroStart"===e.MarkerType||"Intro"===e.Name||"Intro"===e.ChapterType);if(e){const t=e.StartPositionTicks||0,r=e.EndPositionTicks||t+6e8;return console.log("[EmbyAPI] Found intro markers:",{introStart:t,introEnd:r}),{IntroStart:t,IntroEnd:r}}}return void 0!==a.IntroStart&&void 0!==a.IntroEnd?(console.log("[EmbyAPI] Found intro markers in IntroStart/IntroEnd:",{IntroStart:a.IntroStart,IntroEnd:a.IntroEnd}),{IntroStart:a.IntroStart,IntroEnd:a.IntroEnd}):(console.log("[EmbyAPI] No intro markers found for item"),null)}catch(r){return console.error("[EmbyAPI] getIntroSkipMarkers error:",r),null}},clearCache:M}}function N(){const o=e(!1);let a=null,n=[],i=0;let s=!1;const l=(e,t)=>{const r=t.querySelector("[data-nav-scrollable]");if(!r)return;const o=e.getBoundingClientRect(),a=r.getBoundingClientRect(),n=o.width,i=3*n,s=o.left-a.left+r.scrollLeft,l=s+n,c=r.scrollLeft,u=c+a.width;s-i<c?r.scrollTo({left:Math.max(0,s-i),behavior:"smooth"}):l+i>u&&r.scrollTo({left:l+i-a.width,behavior:"smooth"})},c=()=>(()=>{const e=Date.now();if(e-i>100){const t='button:not([disabled]):not([tabindex="-1"]), a[href], input:not([disabled]), [tabindex]:not([tabindex="-1"]), .media-card, .nav-item, .hero-slider-wrapper, .player-control-btn, .up-next-item';n=Array.from(document.querySelectorAll(t)),i=e}return n})(),u=e=>e?document.querySelector(`[data-slider-id="${e}"]`):document.querySelector(".hero-slider-wrapper"),d=e=>{e.classList.contains("hero-slider-wrapper")&&(o.value=!0),console.log("[focusElement] About to focus:",e.getAttribute("aria-label")),console.log("[focusElement] Element:",e),console.log("[focusElement] Stack trace:",(new Error).stack),e.focus({preventScroll:!0}),console.log("[focusElement] After focus, activeElement:",document.activeElement?.getAttribute("aria-label")),e.scrollIntoView({behavior:"smooth",block:"center"})},m=(e,t,r)=>{const o=e.getBoundingClientRect(),a={x:o.left+o.width/2,y:o.top+o.height/2};let n=null,i=1/0;for(const s of t){if(s===e)continue;const t=s.getBoundingClientRect(),o={x:t.left+t.width/2,y:t.top+t.height/2},l=o.x-a.x,c=o.y-a.y;let u=!1;switch(r){case"up":u=c<-10;break;case"down":u=c>10;break;case"left":u=l<-10;break;case"right":u=l>10}if(!u)continue;const d=s.classList.contains("hero-slider-wrapper");if(d&&("up"===r||"down"===r)){const e=a.x,r=t.left,o=t.right;if(e>=r&&e<=o){const e=Math.abs(c);e<i&&(i=e,n=s);continue}}const m=Math.sqrt(l*l+c*c);let g=0;g="up"===r||"down"===r?d?.1*Math.abs(l):.5*Math.abs(l):.5*Math.abs(c);const v=m+g;v<i&&(i=v,n=s)}return n},g=(e,t)=>{o.value=!1;const r=u(t),n=c();if(!r||0===n.length)return;if("left"===e){a=r;const e=document.querySelector(".sidebar .nav-item");if(e)return void d(e)}const i=r.getBoundingClientRect(),s=i.top,l=i.bottom;if("up"===e){let e=null,t=1/0;for(const o of n){if(o===r)continue;if(o.closest('[data-nav-zone="sidebar"]'))continue;const a=o.getBoundingClientRect();if(a.bottom<=s+10){const r=s-a.bottom;r<t&&(t=r,e=o)}}if(e)return void d(e)}let m=null,g=1/0;for(const o of n){if(o===r)continue;if(o.closest('[data-nav-zone="sidebar"]'))continue;const e=o.getBoundingClientRect();if(e.top>=l-10){const t=e.top-l;t<g&&(g=t,m=o)}}m?d(m):n.length>0&&d(n[0])},v=e=>{if(console.log("[handleNavigation] Called with direction:",e,"isNavigating:",s),s)console.log("[handleNavigation] Already navigating, ignoring duplicate call");else{s=!0;try{if(o.value){if("up"===e||"down"===e){const t=document.activeElement,r=t?.getAttribute("data-slider-id")||void 0;g(e,r)}if("left"===e){const e=u();if(e&&e===document.activeElement)return}return}const t=c(),r=document.activeElement;if(!r)return void(t.length>0&&d(t[0]));const a=(e=>{const t=e.closest("[data-nav-zone]");return t?t.getAttribute("data-nav-zone"):null})(r);"media-row"===a?h(r,e,t):"movie-grid"===a?y(r,e,t):"genre-filter"===a?f(r,e,t):"sidebar"===a?p(r,e,t):"player-controls"===a||"skip-controls"===a||"media-sidebar"===a?w(r,e,t):b(r,e,t)}finally{setTimeout(()=>{s=!1},50)}}},h=(e,t,r)=>{const o=e.closest('[data-nav-zone="media-row"]');if(!o)return;const n=(e=>Array.from(e.querySelectorAll(".media-card")))(o),i=n.indexOf(e.closest(".media-card"));if("left"===t)if(0===i){a=e;const t=document.querySelector(".sidebar .nav-item");t&&d(t)}else i>0&&(d(n[i-1]),l(n[i-1],o));else if("right"===t)i<n.length-1&&(d(n[i+1]),l(n[i+1],o));else if("up"===t||"down"===t){const o=r.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),a=m(e,o,t);a&&d(a)}},y=(e,t,r)=>{const o=e.closest('[data-nav-zone="movie-grid"]');if(!o)return;const n=Array.from(o.querySelectorAll(".media-card")),i=e.closest(".media-card"),s=n.indexOf(i);if(-1===s)return;const{row:l,col:c,colCount:u}=((e,t)=>{const r=t.indexOf(e);if(-1===r)return{row:0,col:0,colCount:1};const o=e.closest('[data-nav-zone="movie-grid"]');if(!o)return{row:0,col:0,colCount:1};const a=o.clientWidth,n=e.getBoundingClientRect().width,i=Math.max(1,Math.floor(a/(n+16)));return{row:Math.floor(r/i),col:r%i,colCount:i}})(i,n);if("left"===t)if(0===c){if(0===l){a=e;const t=document.querySelector(".sidebar .nav-item");t&&d(t)}}else s>0&&d(n[s-1]);else if("right"===t)s<n.length-1&&d(n[s+1]);else if("up"===t)if(0===l){const t=r.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),o=m(e,t,"up");o&&d(o)}else{const e=s-u;e>=0&&d(n[e])}else if("down"===t){const e=s+u;e<n.length&&d(n[e])}},f=(e,t,r)=>{if("left"===t){const t=e.closest('[data-nav-zone="genre-filter"]');if(t){if(0===Array.from(t.querySelectorAll(".genre-pill")).indexOf(e)){a=e;const t=document.querySelector(".sidebar .nav-item");t&&d(t)}}}else if("down"===t){const t=e.closest('[data-nav-zone="genre-filter"]');if(!t)return;const o=t.nextElementSibling;if(o&&o.hasAttribute("data-nav-zone")&&"media-row"===o.getAttribute("data-nav-zone")){const e=o.querySelector(".media-card");if(e)return void d(e)}const a=r.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),n=m(e,a,"down");n&&d(n)}else if("up"===t){const t=r.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),o=m(e,t,"up");o&&d(o)}},p=(e,t,r)=>{if("left"===t){if(null!==e.querySelector("i.fa-search")){const e=document.querySelector(".sidebar .nav-item:has(i.fa-home)");e&&d(e)}}else if("right"===t){if(a&&document.body.contains(a)){const e=a;a=null,e.classList.contains("hero-slider-wrapper")&&(o.value=!0),d(e);const t=e.closest('[data-nav-zone="media-row"]');if(t){const r=e.closest(".media-card");r&&l(r,t)}return}const e=Array.from(document.querySelectorAll(".hero-slider-wrapper")).filter(e=>{const t=e.getBoundingClientRect();return t.height>0&&t.width>0});if(e.length>0)return o.value=!0,void d(e[0]);const t=document.querySelector("#content-container");if(t){const e=t.querySelector(".media-card, .genre-pill, button, a[href]");if(e)return void d(e)}}else if("up"===t||"down"===t){const o=r.filter(e=>e.closest('[data-nav-zone="sidebar"]')),a=o.indexOf(e);if("down"===t){if(a>=0&&a<o.length-1){const r=m(e,o,t);r&&d(r)}}else{if(null!==e.querySelector("i.fa-home")){const e=document.querySelector(".search-input");if(e)return void d(e)}const r=m(e,o,t);r&&d(r)}}},w=(e,t,r)=>{const o=e.closest('[data-nav-zone="player-controls"], [data-nav-zone="skip-controls"], [data-nav-zone="media-sidebar"]');if(!o)return;if("media-sidebar"===o.getAttribute("data-nav-zone")){if("left"===t){const e=document.querySelector(".back-btn");e&&d(e)}else if("up"===t){const t=Array.from(document.querySelectorAll(".up-next-item")),r=t.indexOf(e);if(0===r){const e=document.querySelector(".volume-menu-container .icon-btn");e&&d(e)}else r>0&&d(t[r-1])}else if("down"===t){const t=Array.from(document.querySelectorAll(".up-next-item")),r=t.indexOf(e);r>=0&&r<t.length-1&&d(t[r+1])}return}const a=Array.from(o.querySelectorAll(".player-control-btn")).filter(e=>{const t=e.getBoundingClientRect();return t.width>0&&t.height>0});if("left"===t||"right"===t){if("skip-controls"===o.getAttribute("data-nav-zone")){if("right"===t){const e=document.querySelector(".subtitle-menu-container .icon-btn");e&&d(e)}else if("left"===t){const e=document.querySelector(".back-btn");e&&d(e)}return}if("player-controls"===o.getAttribute("data-nav-zone")){const r=[...a].sort((e,t)=>{const r=e.getBoundingClientRect(),o=t.getBoundingClientRect();return r.left-o.left});let o=e;if(!o.classList.contains("player-control-btn")){const t=e.closest(".player-control-btn");t&&(o=t)}const n=r.indexOf(o);return-1===n?void(r.length>0&&d(r[0])):void("right"===t?n<r.length-1&&(console.log("[handlePlayerControlsNavigation] Moving right from index",n,"to",n+1),d(r[n+1])):"left"===t&&n>0&&(console.log("[handlePlayerControlsNavigation] Moving left from index",n,"to",n-1),d(r[n-1])))}if(e.closest(".top-bar")){if(e===document.querySelector(".volume-menu-container .icon-btn")||e.closest(".volume-menu-container")){if("left"===t){const e=document.querySelector(".back-btn");e&&d(e)}return}}if(e.closest(".control-buttons-row")){const r=[document.querySelector(".subtitle-menu-container .icon-btn"),document.querySelector(".quality-menu-container .icon-btn"),document.querySelector(".control-buttons-row > .icon-btn")].filter(e=>e&&e.getBoundingClientRect().width>0);let o=e;if(!o.classList.contains("icon-btn")){const t=e.closest(".icon-btn");t&&(o=t)}const a=r.indexOf(o);if("right"===t)a>=0&&a<r.length-1&&d(r[a+1]);else if("left"===t)if(a>0)d(r[a-1]);else if(0===a){const e=document.querySelector('[data-nav-zone="skip-controls"] .player-control-btn');if(e){const t=e.getBoundingClientRect();if(t.width>0&&t.height>0)return void d(e)}}return}}else if("up"===t||"down"===t){if("skip-controls"===o.getAttribute("data-nav-zone")){if("up"===t){const e=document.querySelector(".back-btn");e&&d(e)}else if("down"===t){const e=document.querySelector('[data-nav-zone="player-controls"]');if(e){const t=e.querySelector(".control-btn-large");if(t)d(t);else{const t=e.querySelector(".player-control-btn");t&&d(t)}}}return}if(e.closest(".control-buttons-row")){if("up"===t){const e=document.querySelector(".up-next-item");e&&d(e)}return}if("player-controls"===o.getAttribute("data-nav-zone")){const e=document.querySelector('[data-nav-zone="skip-controls"] .player-control-btn');if(e&&"up"===t){const t=e.getBoundingClientRect();t.width>0&&t.height>0&&d(e)}}}},b=(e,t,r)=>{if("right"===t){const t=u();if(t&&(!e||e.closest(".sidebar")))return o.value=!0,void d(t)}if(!r.includes(e))return void(r.length>0&&d(r[0]));const a=m(e,r,t);a&&d(a)},I=e=>{if("Escape"===e.key||"Return"===e.key||"GoBack"===e.key||"Back"===e.key||10009===e.keyCode||461===e.keyCode){e.preventDefault();const t=new CustomEvent("app-back-navigation");return void window.dispatchEvent(t)}switch(e.key){case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":e.preventDefault(),v(e.key.replace("Arrow","").toLowerCase());break;case"Enter":const t=document.activeElement;t&&("BUTTON"===t.tagName||t.classList.contains("player-control-btn"))}},S=e=>{const t=e.detail,r=e.type.replace("exit","").replace("Slider","");"left"===t?g("left",r):"down"===t?g("down",r):"up"===t&&g("up",r)};return t(()=>{window.addEventListener("keydown",I),window.addEventListener("exitHeroSlider",S),window.addEventListener("exitBecauseYouWatchedSlider",S);const e=c();e.length>0&&d(e[0])}),r(()=>{window.removeEventListener("keydown",I),window.removeEventListener("exitHeroSlider",S),window.removeEventListener("exitBecauseYouWatchedSlider",S)}),{handleNavigation:v,isSliderMode:o}}function F(t,r,o){const a=e(new Map),n=(e,a="Primary",n=i.MEDIA_CARD_DEFAULT)=>{if(o.value){const t=r.getItemDetails(e);return t?.ImageUrl||""}return t.getImageUrl(e,a,n)},s=e=>a.value.get(e)||"",l=(e,t)=>{a.value.set(e,t)},c=e=>{if(!e)return;(new Image).src=e};return{getImageUrl:n,getHeroImageUrl:async(e,a)=>{if(o.value){const t=r.getItemDetails(e);return t?.HeroImageUrl||t?.ImageUrl||""}if(a){const t=a.find(t=>t.Id===e);if(t?.HeroImageUrl)return t.HeroImageUrl}return await t.getHeroImageUrl(e)},loadImageUrl:async(e,t,r)=>{if(t){const r=t(e);return r instanceof Promise?await r:r}const o=r?.find(t=>t.Id===e);return o?.ImageUrl||""},getCachedImageUrl:s,cacheImageUrl:l,preloadImage:c,preloadImages:e=>{e.forEach(e=>c(e))},clearCache:()=>{a.value.clear()},resolveAndCacheImageUrl:(e,t="Primary",r=i.MEDIA_CARD_DEFAULT)=>{const o=s(e);if(o)return o;const a=n(e,t,r);return l(e,a),a},imageUrlCache:a}}function _(){return{formatRuntime:e=>{if(!e)return"";const t=Math.floor(e/6e8),r=Math.floor(t/60),o=t%60;return r>0?`${r}h ${o}m`:`${o}m`},formatRating:e=>{if(!e)return"";return`${"â­".repeat(Math.round(e/2))} ${e.toFixed(1)}`},formatDate:(e,t)=>{if(!e)return"";try{const r=new Date(e),o={year:"numeric",month:"short",day:"numeric"};return r.toLocaleDateString(void 0,t||o)}catch(r){return console.error("[useFormatters] Error formatting date:",r),e}},formatFileSize:(e,t=2)=>{if(!e||0===e)return"0 Bytes";const r=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,o)).toFixed(r))} ${["Bytes","KB","MB","GB","TB","PB"][o]}`},formatDuration:e=>{if(!e||e<0)return"00:00";const t=Math.floor(e/3600),r=Math.floor(e%3600/60),o=Math.floor(e%60),a=e=>e.toString().padStart(2,"0");return t>0?`${a(t)}:${a(r)}:${a(o)}`:`${a(r)}:${a(o)}`},formatYearRange:(e,t)=>{if(!e)return"";const r=new Date(e).getFullYear();if(!t)return`${r}-Present`;const o=new Date(t).getFullYear();return r===o?`${r}`:`${r}-${o}`},truncateText:(e,t=100)=>e?e.length<=t?e:`${e.substring(0,t).trim()}...`:"",formatTypeName:e=>({Movie:"Movies",Series:"TV Shows",Episode:"Episodes",Season:"Seasons",MusicAlbum:"Albums",Audio:"Music",Person:"People",BoxSet:"Collections"}[e]||e),getTypeIcon:e=>({Movie:"fas fa-film",Series:"fas fa-tv",Episode:"fas fa-video",Season:"fas fa-layer-group",MusicAlbum:"fas fa-compact-disc",Audio:"fas fa-music",Person:"fas fa-user",BoxSet:"fas fa-box"}[e]||"fas fa-file")}}function $(o,a={}){const n=e(!1),{threshold:i=.1,rootMargin:s="0px",onEnter:l,onExit:c}=a;let u=null;return t(()=>{o.value&&(u=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?(n.value=!0,l?.()):(n.value=!1,c?.())})},{threshold:i,rootMargin:s}),u.observe(o.value))}),r(()=>{u&&u.disconnect()}),{isVisible:n}}const U=e([]);function L(){const e=o(),t=(e,t,r,o)=>{U.value.push({route:e,query:t,params:r,state:o}),console.log("[NavigationHistory] Pushed to stack:",{route:e,query:t,stackSize:U.value.length})};return{pushToHistory:t,goBack:()=>{if(0===U.value.length)return console.log("[NavigationHistory] Stack empty, cannot go back"),!1;U.value.pop();const t=U.value[U.value.length-1];return t?(console.log("[NavigationHistory] Going back to:",t),e.push({name:t.route,query:t.query,params:t.params}),!0):(console.log("[NavigationHistory] No previous location, going to home"),e.push({name:"Home"}),!0)},peekHistory:()=>U.value[U.value.length-1],clearHistory:()=>{U.value=[],console.log("[NavigationHistory] History cleared")},getStackSize:()=>U.value.length,replaceCurrentEntry:(e,r,o,a)=>{U.value.length>0?(U.value[U.value.length-1]={route:e,query:r,params:o,state:a},console.log("[NavigationHistory] Replaced current entry:",{route:e,query:r})):t(e,r,o,a)},navigationStack:U}}const x="tmdb_api_key";let B="0aed65eb34fa5c354e10385b63ab9e94";const O="https://image.tmdb.org/t/p",j=new Map,W=e=>{const t=j.get(e);return t&&(e=>!!e&&Date.now()-e.timestamp<6e5)(t)?(console.log("[TMDB] Cache hit:",e),t.data):(t&&(console.log("[TMDB] Cache expired:",e),j.delete(e)),null)},z=(e,t)=>{j.set(e,{data:t,timestamp:Date.now()}),console.log("[TMDB] Cached:",e)};function q(){const t=e(!1),r=e(null),o=()=>!!B,a=async(e,t={})=>{if(!o())throw new Error("TMDB API key not configured");const r=new URL(`https://api.themoviedb.org/3${e}`);r.searchParams.append("api_key",B),Object.entries(t).forEach(([e,t])=>{r.searchParams.append(e,t)}),console.log("[TMDB] Fetching:",e,t);const a=await fetch(r.toString(),{mode:"cors",credentials:"omit"});if(!a.ok){const e=await a.text();throw console.error("[TMDB] API error:",a.status,e),new Error(`TMDB API error: ${a.status}`)}return await a.json()},n=async()=>{const e="movie-genres",o=W(e);if(o)return o;t.value=!0,r.value=null;try{const t=await a("/genre/movie/list");return z(e,t.genres),t.genres}catch(n){throw r.value=n instanceof Error?n.message:"Unknown error",console.error("[TMDB] getMovieGenres error:",n),n}finally{t.value=!1}},i=async()=>{const e="tv-genres",o=W(e);if(o)return o;t.value=!0,r.value=null;try{const t=await a("/genre/tv/list");return z(e,t.genres),t.genres}catch(n){throw r.value=n instanceof Error?n.message:"Unknown error",console.error("[TMDB] getTvGenres error:",n),n}finally{t.value=!1}};return{isLoading:t,error:r,isConfigured:o(),setApiKey:e=>{B=e,localStorage.setItem(x,e)},clearApiKey:()=>{B="",localStorage.removeItem(x)},makeRequest:a,getTrendingMovies:async(e="day",o=1)=>{const n=`trending-movies-${e}-${o}`,i=W(n);if(i)return i;t.value=!0,r.value=null;try{const t=await a(`/trending/movie/${e}`,{page:o.toString()});return t.results=t.results.map(e=>({...e,media_type:"movie"})),z(n,t),t}catch(s){throw r.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingMovies error:",s),s}finally{t.value=!1}},getTrendingTvShows:async(e="day",o=1)=>{const n=`trending-tv-${e}-${o}`,i=W(n);if(i)return i;t.value=!0,r.value=null;try{const t=await a(`/trending/tv/${e}`,{page:o.toString()});return t.results=t.results.map(e=>({...e,media_type:"tv"})),z(n,t),t}catch(s){throw r.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingTvShows error:",s),s}finally{t.value=!1}},getTrendingAll:async(e="day",o=1)=>{const n=`trending-all-${e}-${o}`,i=W(n);if(i)return i;t.value=!0,r.value=null;try{const t=await a(`/trending/all/${e}`,{page:o.toString()});return z(n,t),t}catch(s){throw r.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingAll error:",s),s}finally{t.value=!1}},getPopularMovies:async(e=1)=>{const o=`popular-movies-${e}`,n=W(o);if(n)return n;t.value=!0,r.value=null;try{const t=await a("/movie/popular",{page:e.toString()});return t.results=t.results.map(e=>({...e,media_type:"movie"})),z(o,t),t}catch(i){throw r.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] getPopularMovies error:",i),i}finally{t.value=!1}},getPopularTvShows:async(e=1)=>{const o=`popular-tv-${e}`,n=W(o);if(n)return n;t.value=!0,r.value=null;try{const t=await a("/tv/popular",{page:e.toString()});return t.results=t.results.map(e=>({...e,media_type:"tv"})),z(o,t),t}catch(i){throw r.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] getPopularTvShows error:",i),i}finally{t.value=!1}},getMovieGenres:n,getTvGenres:i,getAllGenres:async()=>{const e="all-genres",o=W(e);if(o)return o;t.value=!0,r.value=null;try{const[t,r]=await Promise.all([n(),i()]),o={movie:t,tv:r};return z(e,o),o}catch(a){throw r.value=a instanceof Error?a.message:"Unknown error",console.error("[TMDB] getAllGenres error:",a),a}finally{t.value=!1}},getMovieDetails:async(e,o=["videos","images","credits","recommendations"])=>{const n=o.join(","),i=`movie-details-${e}-${n}`,s=W(i);if(s)return s;t.value=!0,r.value=null;try{const t=await a(`/movie/${e}`,{append_to_response:n});return z(i,t),t}catch(l){throw r.value=l instanceof Error?l.message:"Unknown error",console.error("[TMDB] getMovieDetails error:",l),l}finally{t.value=!1}},getTvDetails:async(e,o=["videos","images","credits","recommendations"])=>{const n=o.join(","),i=`tv-details-${e}-${n}`,s=W(i);if(s)return s;t.value=!0,r.value=null;try{const t=await a(`/tv/${e}`,{append_to_response:n});return z(i,t),t}catch(l){throw r.value=l instanceof Error?l.message:"Unknown error",console.error("[TMDB] getTvDetails error:",l),l}finally{t.value=!1}},getMovieWatchProviders:async(e,t="US")=>{const r=`movie-watch-providers-${e}-${t}`,o=W(r);if(null!==o)return o;try{const o=(await a(`/movie/${e}/watch/providers`)).results[t]||null;return z(r,o),o}catch(n){return console.error("[TMDB] getMovieWatchProviders error:",n),z(r,null),null}},getTvWatchProviders:async(e,t="US")=>{const r=`tv-watch-providers-${e}-${t}`,o=W(r);if(null!==o)return o;try{const o=(await a(`/tv/${e}/watch/providers`)).results[t]||null;return z(r,o),o}catch(n){return console.error("[TMDB] getTvWatchProviders error:",n),z(r,null),null}},discoverMovies:async(e={})=>{const o=`discover-movies-${JSON.stringify(e)}`,n=W(o);if(n)return n;t.value=!0,r.value=null;try{const t={};Object.entries(e).forEach(([e,r])=>{void 0!==r&&(t[e]=String(r))});const r=await a("/discover/movie",t);return r.results=r.results.map(e=>({...e,media_type:"movie"})),z(o,r),r}catch(i){throw r.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] discoverMovies error:",i),i}finally{t.value=!1}},discoverTvShows:async(e={})=>{const o=`discover-tv-${JSON.stringify(e)}`,n=W(o);if(n)return n;t.value=!0,r.value=null;try{const t={};Object.entries(e).forEach(([e,r])=>{void 0!==r&&(t[e]=String(r))});const r=await a("/discover/tv",t);return r.results=r.results.map(e=>({...e,media_type:"tv"})),z(o,r),r}catch(i){throw r.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] discoverTvShows error:",i),i}finally{t.value=!1}},getPosterUrl:(e,t="w500")=>e?`${O}/${t}${e}`:null,getBackdropUrl:(e,t="w1280")=>e?`${O}/${t}${e}`:null,getProviderLogoUrl:e=>e?`${O}/original${e}`:null,clearCache:()=>{j.clear(),console.log("[TMDB] Cache cleared")}}}const G="viewingHistory",H="browseHistory",Y="searchHistory",V="userProfile",J="notInterested";const K=new class{db=null;initPromise=null;async init(){return this.db?this.db:(this.initPromise||(this.initPromise=new Promise((e,t)=>{const r=indexedDB.open("EmbyFlixPersonalization",1);r.onerror=()=>{console.error("IndexedDB error:",r.error),t(r.error)},r.onsuccess=()=>{this.db=r.result,e(this.db)},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(G)){const e=t.createObjectStore(G,{keyPath:"id",autoIncrement:!0});e.createIndex("itemId","itemId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("itemType","itemType",{unique:!1})}if(!t.objectStoreNames.contains(H)){const e=t.createObjectStore(H,{keyPath:"id",autoIncrement:!0});e.createIndex("itemId","itemId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}if(!t.objectStoreNames.contains(Y)){const e=t.createObjectStore(Y,{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("query","query",{unique:!1})}if(t.objectStoreNames.contains(V)||t.createObjectStore(V,{keyPath:"id"}),!t.objectStoreNames.contains(J)){t.createObjectStore(J,{keyPath:"itemId"}).createIndex("timestamp","timestamp",{unique:!1})}}})),this.initPromise)}async add(e,t){const r=await this.init();return new Promise((o,a)=>{const n=r.transaction([e],"readwrite").objectStore(e).add(t);n.onsuccess=()=>o(n.result),n.onerror=()=>a(n.error)})}async put(e,t){const r=await this.init();return new Promise((o,a)=>{const n=r.transaction([e],"readwrite").objectStore(e).put(t);n.onsuccess=()=>o(),n.onerror=()=>a(n.error)})}async get(e,t){const r=await this.init();return new Promise((o,a)=>{const n=r.transaction([e],"readonly").objectStore(e).get(t);n.onsuccess=()=>o(n.result),n.onerror=()=>a(n.error)})}async getAll(e){const t=await this.init();return new Promise((r,o)=>{const a=t.transaction([e],"readonly").objectStore(e).getAll();a.onsuccess=()=>r(a.result),a.onerror=()=>o(a.error)})}async getAllByIndex(e,t,r){const o=await this.init();return new Promise((a,n)=>{const i=o.transaction([e],"readonly").objectStore(e).index(t),s=r?i.getAll(r):i.getAll();s.onsuccess=()=>a(s.result),s.onerror=()=>n(s.error)})}async delete(e,t){const r=await this.init();return new Promise((o,a)=>{const n=r.transaction([e],"readwrite").objectStore(e).delete(t);n.onsuccess=()=>o(),n.onerror=()=>a(n.error)})}async clear(e){const t=await this.init();return new Promise((r,o)=>{const a=t.transaction([e],"readwrite").objectStore(e).clear();a.onsuccess=()=>r(),a.onerror=()=>o(a.error)})}async count(e){const t=await this.init();return new Promise((r,o)=>{const a=t.transaction([e],"readonly").objectStore(e).count();a.onsuccess=()=>r(a.result),a.onerror=()=>o(a.error)})}async getRecent(e,t){const r=await this.init(),o=new Date;return o.setDate(o.getDate()-t),new Promise((t,a)=>{const n=r.transaction([e],"readonly").objectStore(e).index("timestamp"),i=IDBKeyRange.lowerBound(o),s=n.getAll(i);s.onsuccess=()=>t(s.result),s.onerror=()=>a(s.error)})}};async function Q(e){return K.getRecent(G,e)}async function X(e){return K.getRecent(H,e)}async function Z(e){return K.getRecent(Y,e)}async function ee(){return(await K.getAll(J)).map(e=>e.itemId)}const te=e(!1),re=e([]),oe=e([]),ae=e([]);function ne(){return{isInitialized:te,viewingHistory:re,browseHistory:oe,searchHistory:ae,init:async function(){if(!te.value)try{const[e,t,r]=await Promise.all([Q(180),X(180),Z(180)]);re.value=e,oe.value=t,ae.value=r,te.value=!0,console.log("[ViewingHistory] Loaded:",{viewingEvents:e.length,browseEvents:t.length,searchEvents:r.length})}catch(e){console.error("[ViewingHistory] Failed to initialize:",e)}},trackViewing:async function(e){try{const t={...e,timestamp:new Date},r=await async function(e){const t={itemId:e.itemId,itemName:e.itemName,itemType:e.itemType,genres:[...e.genres],studios:[...e.studios],timestamp:new Date(e.timestamp),watchDuration:e.watchDuration,completionPercent:e.completionPercent,communityRating:e.communityRating,criticRating:e.criticRating,productionYear:e.productionYear};return K.add(G,t)}(t);return re.value.push({...t,id:r}),console.log("[ViewingHistory] Tracked viewing:",{item:e.itemName,completion:e.completionPercent,duration:e.watchDuration}),r}catch(t){return console.error("[ViewingHistory] Failed to track viewing:",t),null}},trackBrowse:async function(e){try{const t={...e,timestamp:new Date},r=await async function(e){const t={itemId:e.itemId,itemName:e.itemName,itemType:e.itemType,genres:[...e.genres],studios:[...e.studios],timestamp:new Date(e.timestamp),timeSpent:e.timeSpent};return K.add(H,t)}(t);return oe.value.push({...t,id:r}),console.log("[ViewingHistory] Tracked browse:",{item:e.itemName,timeSpent:e.timeSpent}),r}catch(t){return console.error("[ViewingHistory] Failed to track browse:",t),null}},trackSearch:async function(e){try{const t={...e,timestamp:new Date},r=await async function(e){const t={query:e.query,timestamp:new Date(e.timestamp),filters:e.filters?{genres:e.filters.genres?[...e.filters.genres]:void 0,studios:e.filters.studios?[...e.filters.studios]:void 0,itemTypes:e.filters.itemTypes?[...e.filters.itemTypes]:void 0}:void 0,clickedItemId:e.clickedItemId};return K.add(Y,t)}(t);return ae.value.push({...t,id:r}),console.log("[ViewingHistory] Tracked search:",{query:e.query,hasFilters:!!e.filters,clicked:!!e.clickedItemId}),r}catch(t){return console.error("[ViewingHistory] Failed to track search:",t),null}},getViewingStats:function(){const e=re.value.reduce((e,t)=>e+t.watchDuration,0),t=re.value.filter(e=>e.completionPercent>=90).length,r=re.value.length>0?re.value.reduce((e,t)=>e+t.completionPercent,0)/re.value.length:0,o=new Map;re.value.forEach(e=>{e.genres.forEach(e=>{o.set(e,(o.get(e)||0)+1)})});const a=Array.from(o.entries()).sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e,t])=>({genre:e,count:t}));return{totalItems:re.value.length,totalWatchTime:e,completedItems:t,avgCompletionRate:r,topGenres:a}},hasEnoughData:function(e=1){return re.value.length>=e},getMostWatchedGenres:function(e=10){const t=new Map;return re.value.forEach(e=>{e.genres.forEach(e=>{t.set(e,(t.get(e)||0)+1)})}),Array.from(t.entries()).sort((e,t)=>t[1]-e[1]).slice(0,e)},getMostWatchedStudios:function(e=10){const t=new Map;return re.value.forEach(e=>{e.studios.forEach(e=>{t.set(e,(t.get(e)||0)+1)})}),Array.from(t.entries()).sort((e,t)=>t[1]-e[1]).slice(0,e)}}}const ie=e(null),se=e(!1);function le(){const e=ne();async function t(){if(se.value)return ie.value;try{const e=await async function(){return K.get(V,"current")}();return e?(ie.value={...e,genreWeights:new Map(Object.entries(e.genreWeights)),studioWeights:new Map(Object.entries(e.studioWeights))},se.value=!0,console.log("[Preferences] Loaded profile:",{genres:ie.value.genreWeights.size,studios:ie.value.studioWeights.size,totalItems:ie.value.totalItems})):console.log("[Preferences] No existing profile found"),ie.value}catch(e){return console.error("[Preferences] Failed to load profile:",e),null}}async function r(){e.isInitialized.value||await e.init();const t=e.viewingHistory.value;if(0===t.length)return console.log("[Preferences] No viewing history to build profile from"),null;console.log("[Preferences] Building profile from",t.length,"viewing events");const r=new Date,o=new Map,a=new Map;let n=0,i=0,s=0,l=0,c=0,u=0,d=0;t.forEach(e=>{const t=(r.getTime()-new Date(e.timestamp).getTime())/864e5,m=Math.pow(.5,t/30)*(e.completionPercent/100);n+=e.watchDuration,e.genres.forEach(t=>{const r=o.get(t)||{genre:t,weight:0,totalWatches:0,avgCompletionRate:0};r.weight+=m,r.totalWatches+=1,r.avgCompletionRate=(r.avgCompletionRate*(r.totalWatches-1)+e.completionPercent)/r.totalWatches,o.set(t,r)}),e.studios.forEach(e=>{const t=a.get(e)||{studio:e,weight:0,totalWatches:0};t.weight+=m,t.totalWatches+=1,a.set(e,t)}),e.communityRating&&(i+=e.communityRating,l++),e.criticRating&&(s+=e.criticRating,c++),e.watchDuration&&(u+=e.watchDuration,d++)});const m=Math.max(...Array.from(o.values()).map(e=>e.weight));o.forEach((e,t)=>{e.weight=e.weight/m,o.set(t,e)});const g=Math.max(...Array.from(a.values()).map(e=>e.weight));a.forEach((e,t)=>{e.weight=e.weight/g,a.set(t,e)});const v=l>0?i/l:0,h=c>0?s/c:0,y=d>0?u/d:0,f=t.map(e=>e.watchDuration).filter(e=>e>0),p=f.length>0?Math.min(...f):0,w=f.length>0?Math.max(...f):0;ie.value={id:"current",genreWeights:o,studioWeights:a,lastUpdated:r,totalWatchTime:n,totalItems:t.length,avgCommunityRating:v,avgCriticRating:h,preferredRuntime:{min:p,max:w,avg:y}};const b={id:"current",genreWeights:Object.fromEntries(Array.from(o.entries())),studioWeights:Object.fromEntries(Array.from(a.entries())),lastUpdated:r,totalWatchTime:n,totalItems:t.length,avgCommunityRating:v,avgCriticRating:h,preferredRuntime:{min:p,max:w,avg:y}};return await async function(e){return K.put(V,e)}(b),se.value=!0,console.log("[Preferences] Profile built:",{genres:o.size,studios:a.size,totalItems:t.length,avgCommunityRating:v.toFixed(1),avgCriticRating:h.toFixed(1)}),ie.value}function o(){if(!ie.value)return!1;return((new Date).getTime()-new Date(ie.value.lastUpdated).getTime())/36e5<24}return{profile:ie,isLoaded:se,loadProfile:t,buildProfile:r,updateProfile:async function(){return await t(),o()?console.log("[Preferences] Profile is fresh, skipping rebuild"):(console.log("[Preferences] Profile is stale, rebuilding..."),await r()),ie.value},getTopGenres:function(e=10){return ie.value?Array.from(ie.value.genreWeights.values()).sort((e,t)=>t.weight-e.weight).slice(0,e):[]},getTopStudios:function(e=10){return ie.value?Array.from(ie.value.studioWeights.values()).sort((e,t)=>t.weight-e.weight).slice(0,e):[]},getGenreWeight:function(e){return ie.value&&ie.value.genreWeights.get(e)?.weight||0},getStudioWeight:function(e){return ie.value&&ie.value.studioWeights.get(e)?.weight||0},isProfileFresh:o,getLeastWatchedGenres:function(e,t=5){if(!ie.value||0===e.length)return e.slice(0,t);const r=new Set(ie.value.genreWeights.keys()),o=e.filter(e=>!r.has(e));if(o.length>=t)return o.slice(0,t);const a=Array.from(ie.value.genreWeights.values()).sort((e,t)=>e.weight-t.weight).slice(0,t-o.length).map(e=>e.genre);return[...o,...a]}}}const ce=.4,ue=.2,de=.2,me=.1,ge=.1;function ve(e,t){const r=function(e,t){if(!e||0===e.length)return 0;let r=0,o=0;return e.forEach(e=>{const a=t.genreWeights.get(e);a&&(o+=a.weight),r+=1}),r>0?o/r:0}(e.Genres,t),o=function(e,t){if(!e||0===e.length)return 0;let r=0,o=0;return e.forEach(e=>{const a=t.studioWeights.get(e.Name);a&&(o+=a.weight),r+=1}),r>0?o/r:0}(e.Studios,t),a=function(e,t){if(!e)return 0;const r=e/100;if(t.avgCriticRating>0){const e=t.avgCriticRating/100;return 1-Math.abs(r-e)}return r}(e.CriticRating,t),n=function(e,t){if(!e)return 0;const r=e/10;if(t.avgCommunityRating>0){const e=t.avgCommunityRating/10;return 1-Math.abs(r-e)}return r}(e.CommunityRating,t),i=function(e){if(!e)return 0;const t=(new Date).getFullYear()-e;return Math.max(0,1-.05*t)}(e.ProductionYear),s=void 0!==e.CriticRating&&e.CriticRating>0,l=void 0!==e.CommunityRating&&e.CommunityRating>0;let c=0;return c+=r*ce,c+=o*ue,c+=i*me,s?c+=a*de:(c+=r*(.6*de),c+=o*(.4*de)),l?c+=n*ge:(c+=r*(.6*ge),c+=o*(.4*ge)),{itemId:e.Id,score:c,breakdown:{genreMatch:r,studioMatch:o,criticRating:a,recencyBoost:i,communityRating:n},isDiscovery:!1}}function he(e,t){let r=0;const o=new Set(e.Genres||[]),a=new Set(t.Genres||[]),n=new Set([...o].filter(e=>a.has(e))),i=new Set([...o,...a]);if(i.size>0){r+=.7*(n.size/i.size)}const s=new Set((e.Studios||[]).map(e=>e.Name)),l=new Set((t.Studios||[]).map(e=>e.Name)),c=new Set([...s].filter(e=>l.has(e))),u=new Set([...s,...l]);if(u.size>0){r+=.3*(c.size/u.size)}return r}function ye(e){return[...e].sort((e,t)=>t.score-e.score)}const fe=e(!1);function pe(){const e=ne(),t=le(),r=a(()=>e.isInitialized.value&&t.isLoaded.value&&e.hasEnoughData(1));async function o(){if(!fe.value){if(console.log("[Personalization] Initializing..."),await e.init(),!e.hasEnoughData(1))return console.log("[Personalization] Not enough viewing history (minimum 5 items required)"),void(fe.value=!0);await t.loadProfile(),t.profile.value?t.isProfileFresh()||(console.log("[Personalization] Updating stale profile..."),await t.buildProfile()):(console.log("[Personalization] Building initial profile..."),await t.buildProfile()),fe.value=!0,console.log("[Personalization] Ready")}}return{isInitialized:fe,isReady:r,init:o,getRecommendations:async function(e,a={}){const{limit:n=20,excludeWatched:i=!0,minScore:s=.2,discoveryPercent:l=10}=a;if(fe.value||await o(),!r.value)return console.log("[Personalization] Not ready, returning empty recommendations"),[];const c=t.profile.value;if(!c)return console.log("[Personalization] No profile available"),[];const u=await ee(),d=new Set(u);let m=e.filter(e=>!d.has(e.Id)&&(!i||!e.UserData?.Played));if(console.log("[Personalization] User profile genres:",Object.keys(c.genreWeights||{}).slice(0,10)),console.log("[Personalization] User profile studios:",Object.keys(c.studioWeights||{}).slice(0,10)),m.length>0){const e=m[0];console.log("[Personalization] Sample candidate genres:",e.Genres),console.log("[Personalization] Sample candidate studios:",e.Studios?.map(e=>e.Name))}const g=m.map(e=>ve(e,c));if(console.log("[Personalization] Scored",g.length,"items"),g.length>0){const e=g.map(e=>e.score).sort((e,t)=>t-e);console.log("[Personalization] Score range:",{max:e[0]?.toFixed(3),median:e[Math.floor(e.length/2)]?.toFixed(3),min:e[e.length-1]?.toFixed(3),minThreshold:s})}const v=function(e,t){return e.filter(e=>e.score>=t)}(g,s);console.log("[Personalization] After minScore filter:",v.length,"/",g.length);const h=ye(v),y=Math.floor(n*l/100),f=n-y,p=h.slice(0,f),w=function(e,r,o,a){const n=new Set;e.forEach(e=>{e.Genres?.forEach(e=>n.add(e))});const i=t.getLeastWatchedGenres(Array.from(n),Math.ceil(o/2)),s=e.filter(e=>!a.has(e.Id)&&e.Genres?.some(e=>i.includes(e))),l=s.map(e=>{const t=ve(e,r);return t.isDiscovery=!0,t}).filter(e=>e.score>=.1);return ye(l).slice(0,o)}(m,c,y,new Set(p.map(e=>e.itemId))),b=function(e){const t=[...e];for(let r=t.length-1;r>0;r--){const e=Math.floor(Math.random()*(r+1));[t[r],t[e]]=[t[e],t[r]]}return t}([...p,...w]),I=new Map(m.map(e=>[e.Id,e])),S=b.map(e=>I.get(e.itemId)).filter(e=>void 0!==e);return console.log("[Personalization] Generated",S.length,"recommendations",{regular:p.length,discovery:w.length}),S},getSimilarItems:async function(e,t,r={}){const{limit:o=15,excludeWatched:a=!0}=r,n=await ee(),i=new Set(n),s=t.filter(t=>t.Id!==e.Id&&(!i.has(t.Id)&&(!a||!t.UserData?.Played))).map(t=>({item:t,similarity:he(e,t)})).sort((e,t)=>t.similarity-e.similarity).slice(0,o).map(e=>e.item);return console.log("[Personalization] Found",s.length,"similar items for",e.Name),s},rankSearchResults:async function(e){if(!r.value)return e;const o=t.profile.value;return o?e.map(e=>({item:e,score:ve(e,o).score})).sort((e,t)=>t.score-e.score).map(e=>e.item):e},updateAfterViewing:async function(){await t.buildProfile()}}}const we="embyflix-tmdb-match-cache",be=864e5;function Ie(){const e=e=>{try{const t=Array.from(e.entries());localStorage.setItem(we,JSON.stringify(t)),console.log(`[useMediaMatching] Saved ${e.size} TMDB matches to cache`)}catch(t){console.error("[useMediaMatching] Failed to save TMDB match cache:",t)}},t=(()=>{try{const e=localStorage.getItem(we);if(!e)return new Map;const t=JSON.parse(e),r=Date.now(),o=t.filter(([e,t])=>r-t.timestamp<be);return console.log(`[useMediaMatching] Loaded ${o.length} cached TMDB matches from localStorage`),new Map(o)}catch(e){return console.error("[useMediaMatching] Failed to load TMDB match cache:",e),new Map}})(),r=e=>e.toLowerCase().replace(/^(the|a|an)\s+/i,"").replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim();return{matchTmdbWithEmby:async(o,a,n=!1)=>{if(n)return null;const i=o.id;if(t.has(i)){const r=t.get(i),o=Date.now()-r.timestamp;if(o<be)return console.log(`[useMediaMatching] Using cached match for TMDB ID ${i} (age: ${Math.round(o/1e3/60)}m)`),r.embyItem;t.delete(i),e(t)}try{const n="title"in o?"Movie":"Series",s="title"in o?o.title:o.name,l="release_date"in o?o.release_date?new Date(o.release_date).getFullYear():null:o.first_air_date?new Date(o.first_air_date).getFullYear():null,c=await a.searchItemsByExternalId(void 0,o.id.toString(),[n]);if(c.length>0){console.log(`[useMediaMatching] Matched "${s}" by TMDB ID:`,o.id);const r={embyItem:c[0],timestamp:Date.now()};return t.set(i,r),e(t),c[0]}const u=await a.searchItems(s,[n]);if(0===u.length){console.log(`[useMediaMatching] No search results for "${s}"`);const r={embyItem:null,timestamp:Date.now()};return t.set(i,r),e(t),null}let d=u.find(e=>{const t=e.Name?.toLowerCase()===s.toLowerCase(),r=!l||Math.abs((e.ProductionYear||0)-l)<=1;return t&&r});if(d){console.log(`[useMediaMatching] Matched "${s}" by exact title+year`);const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}const m=r(s);if(d=u.find(e=>{const t=r(e.Name||"")===m,o=!l||Math.abs((e.ProductionYear||0)-l)<=2;return t&&o}),d){console.log(`[useMediaMatching] Matched "${s}" by normalized title+year`);const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}if(l&&(d=u.find(e=>{const t=e.Name?.toLowerCase()||"",r=s.toLowerCase(),o=t.includes(r)||r.includes(t),a=Math.abs((e.ProductionYear||0)-l)<=1;return o&&a}),d)){console.log(`[useMediaMatching] Matched "${s}" by fuzzy title+strict year`);const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}if(l){const r=u.filter(e=>Math.abs((e.ProductionYear||0)-l)<=1);if(1===r.length){console.log(`[useMediaMatching] Matched "${s}" as only result with year ${l}`);const o={embyItem:r[0],timestamp:Date.now()};return t.set(i,o),e(t),r[0]}}if(l&&(d=u.find(e=>{const t=r(e.Name||""),o=Math.abs((e.ProductionYear||0)-l)<=3;return(t.includes(m)||m.includes(t))&&o}),d)){console.log(`[useMediaMatching] Matched "${s}" by partial title+lenient year (Â±3)`);const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}if(u.length<=2){const o=u[0],a=r(o.Name||""),n=Math.min(m.length,a.length),l=m.length>a.length?m:a,c=m.length<=a.length?m:a;if(c.length>=.6*n&&l.includes(c)){console.log(`[useMediaMatching] Matched "${s}" as first result with similar title (${u.length} results)`);const r={embyItem:o,timestamp:Date.now()};return t.set(i,r),e(t),o}}if(!l){if(d=u.find(e=>r(e.Name||"")===m),d){console.log(`[useMediaMatching] Matched "${s}" by normalized title (no year data available)`);const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}if(1===u.length){const o=r(u[0].Name||"");if(o.includes(m)||m.includes(o)){console.log(`[useMediaMatching] Matched "${s}" as only result (no year data)`);const r={embyItem:u[0],timestamp:Date.now()};return t.set(i,r),e(t),u[0]}}}if(d=u.find(e=>r(e.Name||"")===m),d){console.log(`[useMediaMatching] Matched "${s}" by exact normalized title (ignoring year mismatch)`);const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}console.log(`[useMediaMatching] No confident match found for "${s}" (${l||"no year"}) among ${u.length} results:`,u.slice(0,5).map(e=>({name:e.Name,year:e.ProductionYear,type:e.Type})));const g={embyItem:null,timestamp:Date.now()};return t.set(i,g),e(t),null}catch(s){console.error("[useMediaMatching] Error matching TMDB item:",s);const r={embyItem:null,timestamp:Date.now()};return t.set(i,r),e(t),null}},batchWithConcurrency:async(e,t,r=5)=>{const o=[];for(let a=0;a<e.length;a+=r){const n=e.slice(a,a+r),i=await Promise.all(n.map(t));o.push(...i)}return o},normalizeTitle:r,clearMatchCache:()=>{try{localStorage.removeItem(we),t.clear(),console.log("[useMediaMatching] Cache cleared")}catch(e){console.error("[useMediaMatching] Failed to clear cache:",e)}},tmdbMatchCache:t}}function Se(t,r,o,a,n,i=!1){const s=e([]),l=e(null),c=e([]),u=e("libraries"),d=e(!1),m=async e=>{try{const t="Movie"===e.Type,r="Series"===e.Type;if(!t&&!r)return e;const a=e.Name||"",n=e.ProductionYear,i=t?"/search/movie":"/search/tv",s={query:a};n&&(s[t?"year":"first_air_date_year"]=n.toString());const l=await o.makeRequest(i,s);if(l.results&&l.results.length>0){let r=l.results[0];if(n&&l.results.length>1){const e=l.results.find(e=>{const r=t?e.release_date?new Date(e.release_date).getFullYear():null:e.first_air_date?new Date(e.first_air_date).getFullYear():null;return r&&Math.abs(r-n)<=1});e&&(r=e)}if(r.backdrop_path){const t=o.getBackdropUrl(r.backdrop_path,"original");return console.log(`[LibraryManager] Enhanced "${a}" with TMDB backdrop`),{...e,HeroImageUrl:t}}}return e}catch(t){return console.error("[LibraryManager] Failed to enhance item with TMDB backdrop:",t),e}};return{allLibraries:s,currentLibrary:l,featuredItems:c,isLoadingFeatured:d,currentView:u,findLibraryByType:e=>s.value.find(t=>t.CollectionType===e||t.Name?.toLowerCase().includes(e.replace("s",""))),loadFeaturedItems:async(e,r,n)=>{d.value=!0,c.value=[];const s=e.find(e=>"movies"===e.CollectionType||e.Name?.toLowerCase().includes("movie"));if(console.log("[LibraryManager] Found movie library for hero:",s),i&&s)try{const r=e.find(e=>"tvshows"===e.CollectionType||e.Name?.toLowerCase().includes("tv")||e.Name?.toLowerCase().includes("show")),o=await t.getItems(s.Id,"Movie");console.log("[LibraryManager] Loaded movie items for hero slider:",o.length);let n=[];r&&(n=await t.getItems(r.Id,"Series"),console.log("[LibraryManager] Loaded TV show items for hero slider:",n.length));const i=[...o,...n];if(await a.init(),a.isReady.value){console.log("[LibraryManager] Using personalized recommendations for hero slider");const e=(new Date).getFullYear(),t=i.filter(t=>{const r=t.ProductionYear&&t.ProductionYear>=e-15,o=t.CommunityRating&&t.CommunityRating>=6.5;return r||o}),r=t.length>100?t:i.slice(0,400);console.log("[LibraryManager] Pre-filtered to",r.length,"candidates for scoring");const o=await a.getRecommendations(r,{limit:6,excludeWatched:!0,minScore:.15,discoveryPercent:10});if(o.length>=6){const e=new Set,t=new Set,r=o.filter(r=>{if(e.has(r.Id))return console.warn("[LibraryManager] Duplicate ID in recommendations:",r.Name,r.Id),!1;const o=r.Name?.toLowerCase().trim();return o&&t.has(o)?(console.warn("[LibraryManager] Duplicate name in recommendations:",r.Name,"(ID:",r.Id,")"),!1):(e.add(r.Id),o&&t.add(o),!0)});console.log("[LibraryManager] Enhancing personalized items with TMDB backdrops...");const a=await Promise.all(r.map(e=>m(e)));return c.value=a,console.log("[LibraryManager] Featured items set (personalized):",c.value.length,"after deduplication and TMDB enhancement"),void(d.value=!1)}if(o.length<5){console.log("[LibraryManager] Found",o.length,"personalized items, supplementing with unwatched popular content");try{const e=new Set(o.map(e=>e.Id)),t=r.filter(t=>!e.has(t.Id)&&!t.UserData?.Played);console.log("[LibraryManager] Found",t.length,"unwatched candidates for supplementation");const a=t.filter(e=>e.UserData).length,n=t.filter(e=>e.UserData?.Played).length;console.log("[LibraryManager] Candidates with UserData:",a,"/",t.length),console.log("[LibraryManager] Played items filtered out:",n);const i=t.sort((e,t)=>{const r=e.CommunityRating||0,o=t.CommunityRating||0,a=e.ProductionYear||0,n=t.ProductionYear||0;return r!==o?o-r:n-a}),s=i.slice(0,20).sort(()=>Math.random()-.5),l=6-o.length,u=s.slice(0,l),g=[...o,...u],v=new Set,h=new Set,y=g.filter(e=>{if(v.has(e.Id))return console.warn("[LibraryManager] Duplicate ID detected:",e.Name,e.Id),!1;const t=e.Name?.toLowerCase().trim();return t&&h.has(t)?(console.warn("[LibraryManager] Duplicate name detected:",e.Name,"(ID:",e.Id,")"),!1):(v.add(e.Id),t&&h.add(t),!0)});console.log("[LibraryManager] Enhancing supplemented items with TMDB backdrops...");const f=await Promise.all(y.map(e=>m(e)));if(c.value=f,console.log("[LibraryManager] Supplemented with",u.length,"unwatched items, total:",c.value.length),c.value.length>=5)return void(d.value=!1)}catch(l){console.error("[LibraryManager] Failed to supplement with unwatched items:",l)}console.log("[LibraryManager] Still not enough items after supplementation, falling back to trending")}else console.log("[LibraryManager] Not enough personalized recommendations, falling back to trending",o.length)}else console.log("[LibraryManager] Personalization not ready (need at least 5 viewing events), using trending")}catch(l){console.error("[LibraryManager] Failed to load personalized items:",l)}else console.log("[LibraryManager] Personalization disabled or no movie library, using trending content");if(r&&r.length>0||n&&n.length>0){console.log("[LibraryManager] Using trending content for hero slider");const e=[...r?.slice(0,4).map(e=>({...e.embyItem,HeroImageUrl:o.getBackdropUrl(e.tmdbData.backdrop_path,"original")||e.embyItem.HeroImageUrl}))||[],...n?.slice(0,2).map(e=>({...e.embyItem,HeroImageUrl:o.getBackdropUrl(e.tmdbData.backdrop_path,"original")||e.embyItem.HeroImageUrl}))||[]];c.value=e.slice(0,6),console.log("[LibraryManager] Featured items set from trending:",c.value.length)}else if(s){console.log("[LibraryManager] No trending content available, using Emby library");try{const e=await t.getItems(s.Id,"Movie"),r=e.filter(e=>e.CommunityRating);let o;if(r.length>=6){o=r.sort((e,t)=>(t.CommunityRating||0)-(e.CommunityRating||0)).slice(0,6)}else o=e.slice(0,6);console.log("[LibraryManager] Enhancing Emby library items with TMDB backdrops...");const a=await Promise.all(o.map(e=>m(e)));c.value=a,console.log("[LibraryManager] Featured items set from Emby library:",c.value.length)}catch(l){console.error("[LibraryManager] Failed to load from Emby library:",l),c.value=[]}}else console.warn("[LibraryManager] No movie library found and no trending content"),c.value=[];d.value=!1},loadLibraries:async()=>{if(u.value="libraries",l.value=null,n.value){s.value=r.getLibraries();const e=r.getLibraryItems("demo-movies");c.value=e.slice(0,6)}else try{const e=await t.getViews();s.value=e,console.log("[LibraryManager] Loaded libraries:",e),console.log("[LibraryManager] Library types:",e.map(e=>({name:e.Name,type:e.Type,collectionType:e.CollectionType,id:e.Id})))}catch(e){console.error("[LibraryManager] Failed to load libraries:",e),s.value=[]}return s.value},loadLibraryItems:async e=>{console.log("[LibraryManager] loadLibraryItems called with:",e),l.value=e,u.value="items";let o=[];if(n.value)o=r.getLibraryItems(e.Id);else try{let r=null;"movies"===e.CollectionType?r="Movie":"tvshows"===e.CollectionType?r="Series":"collections"===e.CollectionType&&(r="BoxSet"),console.log("[LibraryManager] Fetching items for library:",{libraryId:e.Id,libraryName:e.Name,itemType:r,collectionType:e.CollectionType}),o=await t.getItems(e.Id,r),console.log("[LibraryManager] Loaded items:",o.length)}catch(a){console.error("[LibraryManager] Failed to load library items:",a),o=[]}return o},loadCollectionItems:async e=>{if(n.value)return r.getLibraryItems(e);try{const r=await t.getItems(e,null);return console.log("[LibraryManager] Loaded collection items:",r.length),r}catch(o){return console.error("[LibraryManager] Failed to load collection items:",o),[]}},reset:()=>{s.value=[],l.value=null,c.value=[],u.value="libraries"}}}function Te(t,r,o,a){const n=e([]),i=e([]),s=e(!1),l=e(!1),c=e(1),u=e(1),d=e(!1),m=e(!1),g=e(!0),v=e(!0);return{trendingMovies:n,trendingTvShows:i,isLoadingTrending:s,isLoadingMoreMovies:d,isLoadingMoreTv:m,hasMoreMovies:g,hasMoreTv:v,shouldShowSplash:l,loadTrendingContent:async e=>{if(!t.isConfigured)return void console.log("[TrendingContent] TMDB API not configured, skipping trending content");if(a.value)return void console.log("[TrendingContent] Demo mode - skipping Emby matching for trending");const c=o.tmdbMatchCache.size;l.value=0===c,l.value&&e?(console.log("[TrendingContent] No cache found - showing splash screen for initial load"),e.onShow()):console.log(`[TrendingContent] Found ${c} cached items - skipping splash screen`),s.value=!0;try{const[e,s]=await Promise.all([t.getTrendingMovies("week",1),t.getTrendingTvShows("week",1)]),l=e.results,c=s.results;console.log("[TrendingContent] Loaded TMDB trending:",{movies:l.length,tvShows:c.length}),console.log("[TrendingContent] Matching trending items with Emby library...");const[u,d]=await Promise.all([o.batchWithConcurrency(l.slice(0,15),async e=>{const n=await o.matchTmdbWithEmby(e,r,a.value);if(!n)return null;const i=await t.getMovieWatchProviders(e.id,"US");return{tmdbData:e,embyId:n.Id,embyItem:n,streamingProviders:i?.flatrate||[]}},5),o.batchWithConcurrency(c.slice(0,15),async e=>{const n=await o.matchTmdbWithEmby(e,r,a.value);if(!n)return null;const i=await t.getTvWatchProviders(e.id,"US");return{tmdbData:e,embyId:n.Id,embyItem:n,streamingProviders:i?.flatrate||[]}},5)]);n.value=u.filter(e=>null!==e),i.value=d.filter(e=>null!==e),console.log("[TrendingContent] Filtered trending content (in Emby library):",{movies:`${n.value.length}/${l.length}`,tvShows:`${i.value.length}/${c.length}`})}catch(u){console.error("[TrendingContent] Failed to load trending content:",u)}finally{s.value=!1,l.value&&e&&(e.onHide(),l.value=!1)}},loadMoreMovies:async()=>{if(t.isConfigured&&!a.value&&!d.value&&g.value){d.value=!0;try{const e=c.value+1;console.log(`[TrendingContent] Loading more movies - page ${e}`);const i=await t.getTrendingMovies("week",e);if(0===i.results.length||e>=i.total_pages)return g.value=!1,void console.log("[TrendingContent] No more movies to load");const s=new Map(i.results.map(e=>[e.id,e])),l=Array.from(s.values()),u=(await o.batchWithConcurrency(l,async e=>{const n=await o.matchTmdbWithEmby(e,r,a.value);if(!n)return null;const i=await t.getMovieWatchProviders(e.id,"US");return{tmdbData:e,embyId:n.Id,embyItem:n,streamingProviders:i?.flatrate||[]}},5)).filter(e=>null!==e),d=new Set(n.value.map(e=>e.tmdbData.id)),m=new Set(n.value.map(e=>e.embyId)),v=u.filter(e=>!d.has(e.tmdbData.id)&&!m.has(e.embyId));n.value=[...n.value,...v],c.value=e,console.log(`[TrendingContent] Loaded ${v.length} more movies (page ${e}, ${u.length-v.length} duplicates filtered)`)}catch(e){console.error("[TrendingContent] Failed to load more movies:",e)}finally{d.value=!1}}},loadMoreTvShows:async()=>{if(t.isConfigured&&!a.value&&!m.value&&v.value){m.value=!0;try{const e=u.value+1;console.log(`[TrendingContent] Loading more TV shows - page ${e}`);const n=await t.getTrendingTvShows("week",e);if(0===n.results.length||e>=n.total_pages)return v.value=!1,void console.log("[TrendingContent] No more TV shows to load");const s=new Map(n.results.map(e=>[e.id,e])),l=Array.from(s.values()),c=(await o.batchWithConcurrency(l,async e=>{const n=await o.matchTmdbWithEmby(e,r,a.value);if(!n)return null;const i=await t.getTvWatchProviders(e.id,"US");return{tmdbData:e,embyId:n.Id,embyItem:n,streamingProviders:i?.flatrate||[]}},5)).filter(e=>null!==e),d=new Set(i.value.map(e=>e.tmdbData.id)),m=new Set(i.value.map(e=>e.embyId)),g=c.filter(e=>!d.has(e.tmdbData.id)&&!m.has(e.embyId));i.value=[...i.value,...g],u.value=e,console.log(`[TrendingContent] Loaded ${g.length} more TV shows (page ${e}, ${c.length-g.length} duplicates filtered)`)}catch(e){console.error("[TrendingContent] Failed to load more TV shows:",e)}finally{m.value=!1}}},filterMoviesByGenres:e=>0===e.length?n.value:n.value.filter(t=>{const r=t.tmdbData.genre_ids||[];return e.every(e=>r.includes(e))}),filterTvShowsByGenres:e=>0===e.length?i.value:i.value.filter(t=>{const r=t.tmdbData.genre_ids||[];return e.every(e=>r.includes(e))}),reset:()=>{n.value=[],i.value=[],s.value=!1,l.value=!1,c.value=1,u.value=1,d.value=!1,m.value=!1,g.value=!0,v.value=!0}}}function Pe(t,r){const o=e([]),n=e([]),i=a(()=>{if(0===r.value.length||0===o.value.length)return[];if(0===n.value.length){const e=new Set;return r.value.forEach(t=>{t.genre_ids.forEach(t=>e.add(t))}),o.value.filter(t=>e.has(t.id))}const e=r.value.filter(e=>n.value.every(t=>e.genre_ids.includes(t))),t=new Set;return e.forEach(e=>{e.genre_ids.forEach(e=>t.add(e))}),o.value.filter(e=>t.has(e.id))}),s=a(()=>0===n.value.length?r.value:r.value.filter(e=>n.value.every(t=>e.genre_ids.includes(t))));return{allGenres:o,selectedGenres:n,availableGenres:i,filteredItems:s,loadGenres:async e=>{if(t.isConfigured)try{const r="movie"===e?await t.getMovieGenres():await t.getTvGenres();o.value=r,console.log(`[GenreFilter] Loaded ${e} genres:`,r.length)}catch(r){console.error(`[GenreFilter] Failed to load ${e} genres:`,r)}},toggleGenre:e=>{const t=n.value.indexOf(e);t>-1?n.value.splice(t,1):n.value.push(e)},clearGenres:()=>{n.value=[]},isGenreSelected:e=>n.value.includes(e),reset:()=>{o.value=[],n.value=[]}}}const Me=[{day:"Monday",timeSlot:"morning",tvTheme:"Daily Discovery (Documentary)",tvFilters:{with_genres:"99","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Quiet Focus Film (History)",movieFilters:{with_genres:"36","vote_average.gte":7,"with_runtime.lte":90,sort_by:"vote_average.desc"}},{day:"Monday",timeSlot:"midday",tvTheme:"Workday Motivation (Lifestyle/Reality)",tvFilters:{with_genres:"10764",sort_by:"popularity.desc"},movieTheme:"Inspirational Doc (Non-Fiction Feature)",movieFilters:{with_genres:"99","vote_count.gte":500,sort_by:"vote_count.desc"}},{day:"Monday",timeSlot:"evening",tvTheme:"Prestige Drama Premiere (New or Trending Drama)",tvFilters:{with_genres:"18","first_air_date.gte":new Date(Date.now()-15552e6).toISOString().split("T")[0],sort_by:"popularity.desc"},movieTheme:"Heavy Hitter Movie (Crime/Mystery)",movieFilters:{with_genres:"80,9648","vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Tuesday",timeSlot:"morning",tvTheme:"Sci-Fi Short (Animation/Sci-Fi)",tvFilters:{with_genres:"16|878",sort_by:"popularity.desc"},movieTheme:"80s/90s Action Film (Throwback Action)",movieFilters:{with_genres:"28","primary_release_date.gte":"1980-01-01","primary_release_date.lte":"1999-12-31",sort_by:"popularity.desc"}},{day:"Tuesday",timeSlot:"midday",tvTheme:"Lunch Break Lite (Classic Sitcom/Comedy)",tvFilters:{with_genres:"35","first_air_date.lte":"2010-01-01",sort_by:"vote_average.desc"},movieTheme:"Visual Escapism (Travel/Nature Documentary)",movieFilters:{with_genres:"99",sort_by:"vote_average.desc"}},{day:"Tuesday",timeSlot:"evening",tvTheme:"Terror Tuesday (Horror Series)",tvFilters:{with_genres:"27","vote_average.gte":7,sort_by:"vote_count.desc"},movieTheme:"Psychological Thriller (High Tension Movie)",movieFilters:{with_genres:"53","vote_average.gte":7,"with_runtime.lte":120,sort_by:"vote_average.desc"}},{day:"Wednesday",timeSlot:"morning",tvTheme:"World News Review (News/Talk Show)",tvFilters:{with_genres:"10763",sort_by:"popularity.desc"},movieTheme:"Foreign Film Spotlight (Non-English Movie)",movieFilters:{"vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Wednesday",timeSlot:"midday",tvTheme:"Feel-Good Food Show (Cooking/Baking)",tvFilters:{with_genres:"10764|10767",sort_by:"popularity.desc"},movieTheme:"Animated Comfort Film (Family/Animation)",movieFilters:{with_genres:"16|10751",sort_by:"popularity.desc"}},{day:"Wednesday",timeSlot:"evening",tvTheme:"Hump Day Mystery (Whodunit Series)",tvFilters:{with_genres:"9648","vote_count.gte":100,sort_by:"vote_average.desc"},movieTheme:"Noir Classic (Black & White, Older Film)",movieFilters:{with_genres:"80|18|53","primary_release_date.lte":"1960-01-01",sort_by:"vote_average.desc"}},{day:"Thursday",timeSlot:"morning",tvTheme:"Deep Dive History (Historical Miniseries)",tvFilters:{with_genres:"36|18","vote_average.gte":7.5,sort_by:"vote_average.desc"},movieTheme:"Period Romance (Costume Drama/Romance)",movieFilters:{with_genres:"10749",sort_by:"vote_average.desc"}},{day:"Thursday",timeSlot:"midday",tvTheme:"Sports Short (Sport Documentary/Series)",tvFilters:{with_genres:"10764|99",sort_by:"popularity.desc"},movieTheme:"Fantasy/Adventure Film (Escapist Movie)",movieFilters:{with_genres:"14|12","vote_count.gte":1e3,sort_by:"popularity.desc"}},{day:"Thursday",timeSlot:"evening",tvTheme:"Throwback Thursday (Re-watch Old TV Show)",tvFilters:{"first_air_date.lte":"2005-01-01","vote_count.gte":100,sort_by:"vote_average.desc"},movieTheme:"Cult Classic (Offbeat or Niche Movie)",movieFilters:{"vote_average.gte":7,"vote_count.lte":1e3,sort_by:"vote_average.desc"}},{day:"Friday",timeSlot:"morning",tvTheme:"Tech & Science Explainer (Science Documentary/Talk)",tvFilters:{with_genres:"99",sort_by:"vote_average.desc"},movieTheme:"Art House Film (Indie/Experimental)",movieFilters:{with_genres:"18|35","vote_count.lte":500,"vote_average.gte":7.5,sort_by:"vote_average.desc"}},{day:"Friday",timeSlot:"midday",tvTheme:"Family Favorites (Kid-Friendly Series)",tvFilters:{with_genres:"10751",sort_by:"popularity.desc"},movieTheme:"Danish Movies",movieFilters:{sort_by:"popularity.desc",watch_region:"DK",with_origin_country:"DK",with_original_language:"da"}},{day:"Friday",timeSlot:"evening",tvTheme:"Friday Night Blockbuster (Action/Sci-Fi Series)",tvFilters:{with_genres:"28|878",sort_by:"popularity.desc"},movieTheme:"New Release Movie Night (Theatrical/VOD Premiere)",movieFilters:{"primary_release_date.gte":new Date(Date.now()-7776e6).toISOString().split("T")[0],sort_by:"primary_release_date.desc"}},{day:"Saturday",timeSlot:"morning",tvTheme:"Saturday Morning Animation (Cartoons/Anime)",tvFilters:{with_genres:"16|10751",sort_by:"popularity.desc"},movieTheme:"Recharge & Reflect (Spiritual/Thought-Provoking)",movieFilters:{with_genres:"18","vote_average.gte":7.5,sort_by:"vote_average.desc"}},{day:"Saturday",timeSlot:"midday",tvTheme:"Comedy Miniseries Binge (Short Comedy TV)",tvFilters:{with_genres:"35","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Midday Thriller (Suspense/Mystery Feature)",movieFilters:{with_genres:"53|9648","vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Saturday",timeSlot:"evening",tvTheme:"Saturday Night Favorites (Top-Rated Series)",tvFilters:{"vote_average.gte":8,sort_by:"popularity.desc"},movieTheme:"Saturday Night Cinema",movieFilters:{sort_by:"popularity.desc",watch_region:"DK",with_release_type:3,page:(Ee=1,ke=5,Math.floor(Math.random()*(ke-Ee))+Ee)}},{day:"Sunday",timeSlot:"morning",tvTheme:"World Travel Log (Travel Series)",tvFilters:{with_genres:"99|10764",sort_by:"popularity.desc"},movieTheme:"Family Sunday Film (G-Rated or Family Adventure)",movieFilters:{with_genres:"10751",sort_by:"primary_release_date.desc"}},{day:"Sunday",timeSlot:"midday",tvTheme:"Guilty Pleasure Reality (Low-Commitment Reality)",tvFilters:{with_genres:"10764",sort_by:"popularity.desc"},movieTheme:"Silly Comedy Feature (Low-Brow Humor)",movieFilters:{with_genres:"35",sort_by:"popularity.desc"}},{day:"Sunday",timeSlot:"evening",tvTheme:"Winding Down Watch (Calm, Comfort Series)",tvFilters:{with_genres:"10749|18","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Classic Blockbuster Revisit (Nostalgic Film)",movieFilters:{with_genres:"12|28|878","primary_release_date.lte":"2000-01-01","vote_count.gte":1e3,sort_by:"popularity.desc"}}];var Ee,ke;function De(e=new Date){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()]}function Ce(){const e=new Date,t=e.getHours(),r=function(){const e=(new Date).getHours();return e>=5&&e<12?"morning":e>=12&&e<18?"midday":"evening"}();let o;if("evening"===r&&t>=0&&t<5){const t=new Date(e);t.setDate(t.getDate()-1),o=De(t)}else o=De(e);return function(e,t){return Me.find(r=>r.day===e&&r.timeSlot===t)}(o,r)}const Ae="embyflix-daily-discovery-cache";function Re(e){const t={page:1,...e};return t.sort_by||(t.sort_by="popularity.desc"),t}function Ne(e,t){return t?{tmdbData:e,embyId:t.Id,embyItem:t}:null}function Fe(e,t){return t?{tmdbData:e,embyId:t.Id,embyItem:t}:null}function _e(){return(new Date).toISOString().split("T")[0]}function $e(){const t=q(),{matchTmdbWithEmby:r,batchWithConcurrency:o}=Ie(),n=e(!1),i=e(null),s=e([]),l=e([]),c=e(Ce()),u=e(1),d=e(1),m=e(!1),g=e(!1),v=e(!0),h=e(!0),y=a(()=>c.value?.movieTheme||"Daily Movie Pick"),f=a(()=>c.value?.tvTheme||"Daily TV Pick"),p=a(()=>s.value.length>0||l.value.length>0),w=async(e,o=!1)=>{const a=function(){try{const e=localStorage.getItem(Ae);if(!e)return null;const t=JSON.parse(e),r=Date.now()-t.timestamp,o=_e(),a=Ce();return r<864e5&&t.date===o&&a&&t.timeSlot===a.timeSlot?(console.log("[useDailyDiscovery] Using cached daily content",{date:t.date,timeSlot:t.timeSlot,age:Math.round(r/1e3/60)+"m"}),t):(console.log("[useDailyDiscovery] Cache invalid or expired",{cachedDate:t.date,currentDate:o,cachedSlot:t.timeSlot,currentSlot:a?.timeSlot}),null)}catch(i){return console.error("[useDailyDiscovery] Failed to load cache:",i),null}}();if(a)return s.value=a.movies,l.value=a.tvShows,void(c.value=a.theme);n.value=!0,i.value=null;try{const a=Ce();if(!a)throw new Error("No theme found for current date/time");c.value=a,console.log("[useDailyDiscovery] Loading daily content",{day:a.day,timeSlot:a.timeSlot,movieTheme:a.movieTheme,tvTheme:a.tvTheme});const n=Re(a.movieFilters),u=Re(a.tvFilters),[d,m]=await Promise.all([t.discoverMovies(n),t.discoverTvShows(u)]);console.log("[useDailyDiscovery] Fetched from TMDB",{movies:d.results.length,tvShows:m.results.length,movieParams:n,tvParams:u});const g=d.results.slice(0,20),v=m.results.slice(0,20),h=await Promise.all(g.map(async t=>Ne(t,await r(t,e,o)))),y=await Promise.all(v.map(async t=>Fe(t,await r(t,e,o)))),f=h.filter(e=>null!==e),p=y.filter(e=>null!==e);console.log("[useDailyDiscovery] Matched with Emby",{movies:`${f.length}/${h.length}`,tvShows:`${p.length}/${y.length}`}),s.value=f,l.value=p;!function(e){try{localStorage.setItem(Ae,JSON.stringify(e)),console.log("[useDailyDiscovery] Saved daily cache",{date:e.date,timeSlot:e.timeSlot,movies:e.movies.length,tvShows:e.tvShows.length})}catch(i){console.error("[useDailyDiscovery] Failed to save cache:",i)}}({date:_e(),timeSlot:a.timeSlot,theme:a,movies:f,tvShows:p,timestamp:Date.now()})}catch(u){i.value=u instanceof Error?u.message:"Failed to load daily content",console.error("[useDailyDiscovery] Error loading daily content:",u)}finally{n.value=!1}},b=()=>{localStorage.removeItem(Ae),s.value=[],l.value=[],console.log("[useDailyDiscovery] Cache cleared")};return{isLoading:n,error:i,dailyMovies:s,dailyTvShows:l,currentTheme:c,movieThemeTitle:y,tvThemeTitle:f,hasContent:p,loadDailyContent:w,clearCache:b,refresh:async(e,t=!1)=>{b(),await w(e,t)},loadMoreMovies:async(e,a=!1)=>{if(!m.value&&v.value&&c.value){m.value=!0;try{const n=u.value+1;console.log(`[useDailyDiscovery] Loading more movies - page ${n}`);const i=Re(c.value.movieFilters);i.page=n;const l=await t.discoverMovies(i);if(0===l.results.length||n>=l.total_pages)return v.value=!1,void console.log("[useDailyDiscovery] No more movies to load");const d=l.results.slice(0,20),m=(await o(d,async t=>Ne(t,await r(t,e,a)),5)).filter(e=>null!==e),g=new Set(s.value.map(e=>e.tmdbData.id)),h=new Set(s.value.map(e=>e.embyId)),y=m.filter(e=>!g.has(e.tmdbData.id)&&!h.has(e.embyId));s.value=[...s.value,...y],u.value=n,console.log(`[useDailyDiscovery] Loaded ${y.length} more movies (page ${n})`)}catch(n){i.value=n instanceof Error?n.message:"Failed to load more movies",console.error("[useDailyDiscovery] Error loading more movies:",n)}finally{m.value=!1}}},loadMoreTvShows:async(e,a=!1)=>{if(!g.value&&h.value&&c.value){g.value=!0;try{const n=d.value+1;console.log(`[useDailyDiscovery] Loading more TV shows - page ${n}`);const i=Re(c.value.tvFilters);i.page=n;const s=await t.discoverTvShows(i);if(0===s.results.length||n>=s.total_pages)return h.value=!1,void console.log("[useDailyDiscovery] No more TV shows to load");const u=s.results.slice(0,20),m=(await o(u,async t=>Fe(t,await r(t,e,a)),5)).filter(e=>null!==e),g=new Set(l.value.map(e=>e.tmdbData.id)),v=new Set(l.value.map(e=>e.embyId)),y=m.filter(e=>!g.has(e.tmdbData.id)&&!v.has(e.embyId));l.value=[...l.value,...y],d.value=n,console.log(`[useDailyDiscovery] Loaded ${y.length} more TV shows (page ${n})`)}catch(n){i.value=n instanceof Error?n.message:"Failed to load more TV shows",console.error("[useDailyDiscovery] Error loading more TV shows:",n)}finally{g.value=!1}}},isLoadingMoreMovies:m,isLoadingMoreTv:g,hasMoreMovies:v,hasMoreTv:h}}function Ue(){const t=e(!1),r=e(null);const o=a(()=>r.value?`Because you watched: ${r.value.referenceItem.name}`:""),n=a(()=>null!==r.value&&r.value.recommendations.length>0);return{isLoading:t,becauseYouWatchedItem:r,sectionTitle:o,hasRecommendations:n,loadBecauseYouWatched:async function(e){if(!t.value){t.value=!0;try{r.value=await async function(e){try{const t=await e.getRecentlyWatched(20,["Movie","Series"]);if(0===t.length)return console.log("[BecauseYouWatched] No recently watched items"),null;const r=t.slice(0,Math.min(5,t.length)),o=r[Math.floor(Math.random()*r.length)];console.log("[BecauseYouWatched] Generating recommendations based on:",o.Name);const a=(await e.getSimilarItems(o.Id,25)).filter(e=>!e.UserData?.Played);return 0===a.length?(console.log("[BecauseYouWatched] No unwatched similar items found"),null):(console.log("[BecauseYouWatched] Generated",a.length,"recommendations"),{referenceItem:{id:o.Id,name:o.Name||"Unknown",type:o.Type},recommendations:a})}catch(t){return console.error("[BecauseYouWatched] Error generating recommendations:",t),null}}(e)}catch(o){console.error("[BecauseYouWatched] Error loading recommendations:",o),r.value=null}finally{t.value=!1}}}}}function Le(){const e=o(),a=e=>{switch(e){case"home":return{name:"Home"};case"movies":return{name:"Category",params:{category:"movies"}};case"tvshows":return{name:"Category",params:{category:"tvshows"}};case"collections":return{name:"Category",params:{category:"collections"}};case"search":return{name:"Search"};case"settings":return null;default:return console.warn("[useSidebarNavigation] Unknown navigation ID:",e),null}},n=(e,t)=>{const r=e.detail;if(console.log("[useSidebarNavigation] Navigation requested:",r),t){const e=t(r);if(e instanceof Promise)return void e.then(e=>{e&&i(r)});if(!e)return void console.log("[useSidebarNavigation] Navigation cancelled by beforeNavigate hook")}i(r)},i=t=>{const r=a(t);r&&e.push(r)};return{navigateTo:a,handleSidebarNavigation:n,performNavigation:i,registerSidebarNavigation:e=>{const o=t=>n(t,e);return t(()=>{window.addEventListener("sidebar-navigate",o)}),r(()=>{window.removeEventListener("sidebar-navigate",o)}),o}}}function xe(e="Home"){const a=o(),n=L(),i=()=>{console.log("[useBackNavigation] Back navigation triggered");n.goBack()||(console.log(`[useBackNavigation] No history, navigating to ${e}`),a.push({name:e}))};return t(()=>{window.addEventListener("app-back-navigation",i)}),r(()=>{window.removeEventListener("app-back-navigation",i)}),{handleBack:i,handleSimpleBack:()=>{console.log("[useBackNavigation] Simple back navigation"),a.back()}}}function Be(t){const o=ne(),a=e(0),n=e(null),i=e=>{n.value=e,a.value=Date.now()},s=(e,r)=>{if(t?.value)return;const n=r??(a.value>0?Math.floor((Date.now()-a.value)/1e3):0);n>=2&&o.trackBrowse({itemId:e.Id,itemName:e.Name,itemType:e.Type,genres:e.Genres||[],studios:(e.Studios||[]).map(e=>e.Name),timeSpent:n})},l=(e,r,a)=>{if(t?.value)return;const n=a>0?r/a*100:0;o.trackViewing({itemId:e.Id,itemName:e.Name,itemType:e.Type,genres:e.Genres||[],studios:(e.Studios||[]).map(e=>e.Name),watchDuration:r,completionPercent:Math.min(n,100),communityRating:e.CommunityRating,criticRating:e.CriticRating,productionYear:e.ProductionYear})};return{startBrowseTracking:i,trackBrowseEvent:s,trackCurrentBrowseEvent:()=>{n.value&&a.value>0&&s(n.value)},trackSearchEvent:(e,r,a)=>{t?.value||o.trackSearch({query:e,filters:r||{},clickedItemId:a})},trackPlaybackEvent:l,trackPlaybackFromTicks:async(e,r,o)=>{if(!t?.value)try{const t=await o(e),a=Math.floor(r/1e7),n=t.RunTimeTicks?Math.floor(t.RunTimeTicks/1e7):0;l(t,a,n)}catch(a){console.error("[Analytics] Failed to track playback event:",a)}},autoTrackBrowsing:e=>{i(e.value);const t=()=>{e.value&&a.value>0&&s(e.value)};return r(t),t},reset:()=>{a.value=0,n.value=null},pageLoadTime:a,currentItem:n}}const Oe=Object.freeze(Object.defineProperty({__proto__:null,useAnalytics:Be},Symbol.toStringTag,{value:"Module"})),je=1e7;function We(o,a,i={}){const l=e(!1),c=e(""),u=e(null),d=e(null);let m=!1;const g=e=>{if(!o.value||!e)return;c.value="",m=!1;e.includes(".m3u8")?s.isSupported()?(u.value&&u.value.destroy(),u.value=new s({debug:!1,enableWorker:!0,lowLatencyMode:!1,backBufferLength:90}),u.value.loadSource(e),u.value.attachMedia(o.value),u.value.on(s.Events.ERROR,(e,t)=>{if(t.fatal)switch(c.value=`[VideoPlayer] HLS error: ${t.type}`,t.type){case s.ErrorTypes.NETWORK_ERROR:u.value?.startLoad();break;case s.ErrorTypes.MEDIA_ERROR:u.value?.recoverMediaError();break;default:u.value?.destroy()}})):(console.error("[VideoPlayer] HLS is not supported in this browser"),c.value="HLS.js is not supported in this browser"):(o.value.src=e,o.value.load())},v=()=>{if(!o.value||!i.onProgress)return;const e=Math.floor(o.value.currentTime*je),t=o.value.paused;i.onProgress(e,t)},h=()=>{d.value&&(clearInterval(d.value),d.value=null),u.value&&(u.value.destroy(),u.value=null),m=!1};return n(a,e=>{e&&o.value&&g(e)}),t(()=>{o.value&&(o.value&&(o.value.addEventListener("error",()=>{if(o.value?.error){const e={1:"MEDIA_ERR_ABORTED - Playback was aborted",2:"MEDIA_ERR_NETWORK - Network error occurred",3:"MEDIA_ERR_DECODE - Codec not supported",4:"MEDIA_ERR_SRC_NOT_SUPPORTED - Format not supported"};c.value=e[o.value.error.code]||"Unknown error"}}),o.value.addEventListener("canplay",()=>{if(!m&&o.value){m=!0;const e=o.value.play();void 0!==e&&e.then(()=>{l.value=!0,c.value="",i.onPlaybackStart&&i.onPlaybackStart()}).catch(e=>{c.value=`Playback failed: ${e.name} - ${e.message}`,l.value=!1})}}),o.value.addEventListener("playing",()=>{l.value=!0})),a.value&&g(a.value),d.value=window.setInterval(v,1e4))}),r(()=>{h()}),{isPlaying:l,errorMessage:c,handlePlayPause:()=>{if(o.value)if(o.value.paused){const e=o.value.play();void 0!==e?e.then(()=>{l.value=!0}).catch(e=>{console.error("[VideoPlayer] Play failed:",e.name,e.message),l.value=!1}):l.value=!0}else o.value.pause(),l.value=!1},handleStop:()=>{if(!o.value)return 0;const e=Math.floor(o.value.currentTime*je);return i.onPlaybackStop&&i.onPlaybackStop(e),e},handleSeek:e=>{if(!o.value)return;const t=o.value.currentTime+e,r=o.value.duration;o.value.currentTime=t<0?0:t>r?r:t},initializeVideo:g,cleanup:h}}const ze=e=>e/1e7,qe=e=>Math.floor(1e7*e),Ge="embyflix-credits-markers",He=e=>{try{const t=localStorage.getItem(Ge);if(!t)return{};return JSON.parse(t)[e]||{}}catch(t){return console.error("[CreditsDetection] Failed to load from storage:",t),{}}},Ye=(e,t,r)=>{try{const o=localStorage.getItem(Ge),a=o?JSON.parse(o):{};a[e]||(a[e]={}),a[e][t]=r,localStorage.setItem(Ge,JSON.stringify(a)),console.log("[CreditsDetection] Saved to storage:",{seriesId:e,itemId:t,marker:r})}catch(o){console.error("[CreditsDetection] Failed to save to storage:",o)}};function Ve(){const t=e(!1),r=e(0);return{isDetecting:t,detectionProgress:r,detectCreditsPassively:(e,t)=>{if(!e||!e.duration)return console.log("[CreditsDetection] Invalid video element"),()=>{};const r=e.duration,o=Math.max(.2*r,r-600),a=[];let n=0;console.log("[CreditsDetection] Starting passive detection (credits zone starts at",o.toFixed(1),"s)");const i=()=>{const i=e.currentTime;if(i<o)return;if(i-n<5)return;n=i;const s=(e=>{const t=document.createElement("canvas"),r=t.getContext("2d",{willReadFrequently:!0});if(!r)return-1;t.width=160,t.height=90;try{return r.drawImage(e,0,0,t.width,t.height),(e=>{const t=e.data;let r=0;for(let o=0;o<t.length;o+=16)r+=.299*t[o]+.587*t[o+1]+.114*t[o+2];return r/(t.length/16)})(r.getImageData(0,0,t.width,t.height))}catch(o){return console.error("[CreditsDetection] Failed to analyze frame:",o),-1}})(e);if(s>=0&&s<5&&(a.push({time:i,brightness:s}),console.log(`[CreditsDetection] Dark frame detected at ${i.toFixed(1)}s, brightness: ${s.toFixed(1)}`),a.length>=3)){const e=a[0].time,o=Math.min(i+60,r),n={CreditsStart:qe(e),CreditsEnd:qe(o),confidence:Math.min(a.length/10,1),detectionMethod:"black-frames"};console.log("[CreditsDetection] Credits detected passively:",{start:e.toFixed(1),end:o.toFixed(1),darkFrameCount:a.length,confidence:n.confidence}),t(n)}};return e.addEventListener("timeupdate",i),()=>{e.removeEventListener("timeupdate",i),console.log("[CreditsDetection] Passive detection stopped")}},getCreditsMarker:async(e,t,r,o)=>{if(o)return console.log("[CreditsDetection] Using server marker"),o;if(t){const r=He(t);if(r[e])return console.log("[CreditsDetection] Using cached marker"),r[e];const o=Object.values(r);if(o.length>0){const e=o[0];return console.log("[CreditsDetection] Using estimated marker from same series"),{...e,confidence:.8*e.confidence}}}return null},loadCreditsFromStorage:He,saveCreditsToStorage:Ye,ticksToSeconds:ze,secondsToTicks:qe}}function Je(t){const o=e(""),a=e(""),n=e(0),i=e=>(o.value=t.generatePlaySessionId(),a.value=e,n.value=0,console.log("[usePlaybackSession] Session initialized:",o.value),o.value),s=e=>{if(a.value&&o.value){const r=void 0!==e?e:n.value;console.log("[usePlaybackSession] Reporting playback stop at",r),t.reportPlaybackStopped(a.value,r,o.value)}},l=e=>{o.value&&(s(e),o.value="",a.value="",n.value=0,console.log("[usePlaybackSession] Session ended"))};return r(()=>{o.value&&(console.log("[usePlaybackSession] Component unmounting, ending session"),l())}),{playSessionId:o,currentItemId:a,initializeSession:i,reportStart:()=>{a.value&&o.value&&(console.log("[usePlaybackSession] Reporting playback start"),t.reportPlaybackStart(a.value,o.value))},reportProgress:(e,r)=>{a.value&&o.value&&(n.value=e,t.reportPlaybackProgress(a.value,e,r,o.value))},reportStop:s,endSession:l,switchItem:e=>(l(0),i(e))}}function Ke(){const t=R(),r=e(""),o=e([]),i=e(!1),s=e(null),l=e({itemTypes:[],genres:[],studios:[],tags:[],runtime:"any",criticRating:"any",communityRating:"any",sortBy:"relevance"});let c=null;const u=e=>{if("any"!==l.value.criticRating){const t="60+"===l.value.criticRating?60:80,r=e.CriticRating;if(!r||r<t)return!1}if("any"!==l.value.communityRating){const t="60+"===l.value.communityRating?6:8,r=e.CommunityRating;if(!r||r<t)return!1}if("any"!==l.value.runtime){const t=(e=>e.RunTimeTicks?Math.round(e.RunTimeTicks/1e4/1e3/60):null)(e);if(!t)return!1;switch(l.value.runtime){case"short":if(t>=30)return!1;break;case"medium":if(t<30||t>=90)return!1;break;case"long":if(t<90||t>=150)return!1;break;case"verylong":if(t<150)return!1}}return!0},d=a(()=>{let e=o.value;return l.value.itemTypes.length>0&&(e=e.filter(e=>l.value.itemTypes.includes(e.Type))),l.value.genres.length>0&&(e=e.filter(e=>e.Genres&&e.Genres.some(e=>l.value.genres.includes(e)))),l.value.studios.length>0&&(e=e.filter(e=>e.Studios&&e.Studios.some(e=>l.value.studios.includes(e.Name)))),l.value.tags.length>0&&(e=e.filter(e=>e.Tags&&e.Tags.some(e=>l.value.tags.includes(e)))),e=e.filter(u),e=[...e].sort((e,t)=>{switch(l.value.sortBy){case"relevance":{const o=r.value.toLowerCase(),a=e.Name.toLowerCase(),n=t.Name.toLowerCase(),i=a===o?3:0,s=n===o?3:0;if(i!==s)return s-i;const l=a.startsWith(o)?2:0,c=n.startsWith(o)?2:0;if(l!==c)return c-l;const u=a.includes(o)?1:0,d=n.includes(o)?1:0;return u!==d?d-u:(t.CommunityRating||0)-(e.CommunityRating||0)}case"name-asc":return e.Name.localeCompare(t.Name);case"name-desc":return t.Name.localeCompare(e.Name);case"date-newest":{const r=e.PremiereDate?new Date(e.PremiereDate).getTime():365*(e.ProductionYear||0)*24*60*60*1e3;return(t.PremiereDate?new Date(t.PremiereDate).getTime():365*(t.ProductionYear||0)*24*60*60*1e3)-r}case"date-oldest":return(e.PremiereDate?new Date(e.PremiereDate).getTime():365*(e.ProductionYear||0)*24*60*60*1e3)-(t.PremiereDate?new Date(t.PremiereDate).getTime():365*(t.ProductionYear||0)*24*60*60*1e3);case"rating-high":return(t.CommunityRating||0)-(e.CommunityRating||0);case"rating-low":return(e.CommunityRating||0)-(t.CommunityRating||0);case"critic-high":return(t.CriticRating||0)-(e.CriticRating||0);case"critic-low":return(e.CriticRating||0)-(t.CriticRating||0);default:return 0}}),e}),m=a(()=>{const e={};return d.value.forEach(t=>{e[t.Type]||(e[t.Type]=[]),e[t.Type].push(t)}),e}),g=a(()=>{const e={};return o.value.forEach(t=>{e[t.Type]=(e[t.Type]||0)+1}),e}),v=a(()=>Object.keys(g.value).sort()),h=a(()=>{const e=new Set;return o.value.forEach(t=>{t.Genres&&t.Genres.forEach(t=>e.add(t))}),Array.from(e).sort()}),y=a(()=>{const e={};return o.value.forEach(t=>{t.Genres&&t.Genres.forEach(t=>{e[t]=(e[t]||0)+1})}),e}),f=a(()=>{const e=new Set;return o.value.forEach(t=>{t.Studios&&t.Studios.forEach(t=>e.add(t.Name))}),Array.from(e).sort()}),p=a(()=>{const e={};return o.value.forEach(t=>{t.Studios&&t.Studios.forEach(t=>{e[t.Name]=(e[t.Name]||0)+1})}),e}),w=a(()=>{const e=new Set;return o.value.forEach(t=>{t.Tags&&t.Tags.forEach(t=>e.add(t))}),Array.from(e).sort()}),b=a(()=>{const e={};return o.value.forEach(t=>{t.Tags&&t.Tags.forEach(t=>{e[t]=(e[t]||0)+1})}),e}),I=async e=>{if(!e.trim())return o.value=[],void(s.value=null);i.value=!0,s.value=null;try{const r=l.value.itemTypes.length>0?l.value.itemTypes:void 0,a=await t.searchItems(e,r);console.log("results",a),o.value=(e=>{const t=new Set,r=[];for(const a of e){const e=a.Name.toLowerCase().trim();t.has(e)||(t.add(e),r.push(a))}const o=e.length-r.length;return o>0&&console.log(`[useSearch] Deduplicated ${e.length} results to ${r.length} unique items (removed ${o} duplicates by name)`),r})(a)}catch(r){s.value=r instanceof Error?r.message:"Search failed",console.error("[useSearch] Search error:",r),o.value=[]}finally{i.value=!1}};n(r,e=>{var t;e.trim()?(t=e,c&&clearTimeout(c),c=setTimeout(()=>{I(t)},300)):(o.value=[],s.value=null,i.value=!1)});return{searchQuery:r,searchResults:o,filteredResults:d,groupedResults:m,resultCounts:g,availableTypes:v,availableGenres:h,genreCounts:y,availableStudios:f,studioCounts:p,availableTags:w,tagCounts:b,isSearching:i,searchError:s,filters:l,toggleFilter:e=>{const t=l.value.itemTypes.indexOf(e);t>-1?l.value.itemTypes.splice(t,1):l.value.itemTypes.push(e)},toggleGenre:e=>{const t=l.value.genres.indexOf(e);t>-1?l.value.genres.splice(t,1):l.value.genres.push(e)},toggleStudio:e=>{const t=l.value.studios.indexOf(e);t>-1?l.value.studios.splice(t,1):l.value.studios.push(e)},toggleTag:e=>{const t=l.value.tags.indexOf(e);t>-1?l.value.tags.splice(t,1):l.value.tags.push(e)},clearFilters:()=>{l.value.itemTypes=[],l.value.genres=[],l.value.studios=[],l.value.tags=[],l.value.runtime="any",l.value.criticRating="any",l.value.communityRating="any",l.value.sortBy="relevance"},setFilter:e=>{l.value.itemTypes=e},isTypeFiltered:e=>l.value.itemTypes.includes(e),isGenreFiltered:e=>l.value.genres.includes(e),isStudioFiltered:e=>l.value.studios.includes(e),isTagFiltered:e=>l.value.tags.includes(e),setCriticRating:e=>{l.value.criticRating=e},setCommunityRating:e=>{l.value.communityRating=e},setRuntime:e=>{l.value.runtime=e},setSortBy:e=>{l.value.sortBy=e},clearSearch:()=>{r.value="",o.value=[],s.value=null,i.value=!1,c&&clearTimeout(c)},immediateSearch:async e=>{r.value=e,c&&clearTimeout(c),await I(e)}}}export{v as a,R as b,F as c,_ as d,$ as e,Ve as f,We as g,N as h,q as i,pe as j,Ie as k,Se as l,Te as m,$e as n,Ue as o,xe as p,Pe as q,Le as r,L as s,Be as t,h as u,Je as v,Ke as w};
