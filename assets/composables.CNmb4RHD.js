import{r as e,o as t,a as o,u as r,k as a,m as n}from"./vue-vendor.B0WUDMXT.js";import{C as i}from"./components.BQNxwHwS.js";const s=()=>{try{return"undefined"!=typeof window&&void 0!==window.localStorage}catch{return!1}},l=(e,t,o)=>{if(s())try{const r=JSON.stringify({isAuthenticated:e,currentUser:t,isDemoMode:o});localStorage.setItem("embyflix-auth",r),console.log("[Auth] Saved auth state to localStorage:",{isAuth:e,user:t,isDemo:o})}catch(r){if(r instanceof DOMException&&"QuotaExceededError"===r.name){console.error("[Auth] localStorage quota exceeded (5 MB limit). Attempting to clear old data...");try{localStorage.removeItem("embyflix-auth"),localStorage.setItem("embyflix-auth",JSON.stringify({isAuthenticated:e,currentUser:t,isDemoMode:o})),console.log("[Auth] Successfully saved auth state after clearing old data")}catch(a){console.error("[Auth] Failed to save auth state after clearing:",a)}}else console.error("[Auth] Failed to save auth state:",r)}else console.warn("[Auth] localStorage is not available, state will not persist")},c=(()=>{if(!s())return console.warn("[Auth] localStorage is not available"),{isAuthenticated:!1,currentUser:null,isDemoMode:!1};try{const e=localStorage.getItem("embyflix-auth");if(e){const t=JSON.parse(e);return console.log("[Auth] Loaded auth state from localStorage:",t),{isAuthenticated:t.isAuthenticated||!1,currentUser:t.currentUser||null,isDemoMode:t.isDemoMode||!1}}console.log("[Auth] No saved auth state found in localStorage")}catch(e){console.error("[Auth] Failed to load auth state:",e)}return{isAuthenticated:!1,currentUser:null,isDemoMode:!1}})(),u=e(c.isAuthenticated),d=e(c.currentUser),m=e(c.isDemoMode);function g(){return{isAuthenticated:u,currentUser:d,isDemoMode:m,login:e=>{console.log("[Auth] Login called with user:",e),u.value=!0,d.value=e,m.value=!1,l(!0,e,!1),console.log("[Auth] Login complete. isAuthenticated:",u.value,"currentUser:",d.value)},logout:()=>{if(console.log("[Auth] Logout called"),u.value=!1,d.value=null,m.value=!1,l(!1,null,!1),s())try{localStorage.removeItem("embyflix-api"),console.log("[Auth] API state cleared from localStorage")}catch(e){console.error("Failed to remove API state:",e)}console.log("[Auth] Logout complete")},enableDemoMode:()=>{console.log("[Auth] Enabling demo mode"),m.value=!0,u.value=!0,d.value={Name:"Demo User",Id:"demo-user-id"},l(!0,d.value,!0),console.log("[Auth] Demo mode enabled")}}}function y(){const t=e([{Id:"demo-movies",Name:"Movies",Type:"CollectionFolder",CollectionType:"movies"},{Id:"demo-tvshows",Name:"TV Shows",Type:"CollectionFolder",CollectionType:"tvshows"},{Id:"demo-collections",Name:"Collections",Type:"CollectionFolder",CollectionType:"collections"}]),o=e([{Id:"demo-1",Name:"The Cosmic Journey",Type:"Movie",ProductionYear:2023,Overview:"An epic space adventure that follows a crew of explorers as they venture beyond the known galaxy to discover new worlds and face unexpected challenges. Their journey tests the limits of human courage and ingenuity as they encounter alien civilizations and cosmic phenomena that defy understanding.",CommunityRating:8.4,OfficialRating:"PG-13",RunTimeTicks:72e9,Genres:["Science Fiction","Adventure","Drama"],ImageUrl:"/DemoContent/Posters/joker-poster.png",HeroImageUrl:"/DemoContent/HeroImages/avengers-hero-banner.jpg"},{Id:"demo-2",Name:"Mystery at Midnight Manor",Type:"Movie",ProductionYear:2022,Overview:"A classic whodunit mystery set in a sprawling Victorian mansion. When a renowned detective is invited to a weekend party, he finds himself investigating a puzzling murder that occurred at the stroke of midnight. Every guest has secrets, and everyone is a suspect.",CommunityRating:7.9,OfficialRating:"PG",RunTimeTicks:66e9,Genres:["Mystery","Thriller","Drama"],ImageUrl:"/DemoContent/Posters/dr-strange-poster.jpg",HeroImageUrl:"/DemoContent/HeroImages/avengers-2-hero-banner.jpg"},{Id:"demo-3",Name:"Laughing Through Life",Type:"Movie",ProductionYear:2024,Overview:"A heartwarming comedy about a struggling comedian who discovers that the best jokes come from the most unexpected moments in life. Follow her journey from open mic nights to the big stage as she learns that laughter truly is the best medicine.",CommunityRating:8.1,OfficialRating:"R",RunTimeTicks:54e9,Genres:["Comedy","Drama"],ImageUrl:"/DemoContent/Posters/exorcist-poster.jpg",HeroImageUrl:"/DemoContent/HeroImages/xmen-hero-image.jpg"},{Id:"demo-4",Name:"Dragon's Peak",Type:"Movie",ProductionYear:2023,Overview:"In a realm where dragons and humans once coexisted, a young warrior must climb the legendary Dragon's Peak to prevent an ancient evil from returning. This epic fantasy adventure combines stunning visuals with a timeless tale of courage and friendship.",CommunityRating:9.2,OfficialRating:"PG-13",RunTimeTicks:9e10,Genres:["Fantasy","Adventure","Action"],ImageUrl:"/DemoContent/Posters/wayns-world-2-poster.jpg"},{Id:"demo-5",Name:"The Last Algorithm",Type:"Movie",ProductionYear:2024,Overview:"A gripping techno-thriller about a brilliant programmer who discovers a hidden algorithm that could either save humanity or bring about its downfall. As powerful corporations hunt her down, she must decide who to trust in a world where nothing is as it seems.",CommunityRating:8.7,OfficialRating:"R",RunTimeTicks:78e9,Genres:["Thriller","Science Fiction","Action"],ImageUrl:"/DemoContent/Posters/joker-poster.png"},{Id:"demo-6",Name:"Summer of '89",Type:"Movie",ProductionYear:2023,Overview:"A nostalgic coming-of-age story set during one unforgettable summer. Follow a group of friends as they navigate the challenges of growing up, discovering who they are, and learning the true meaning of friendship before everything changes forever.",CommunityRating:8.5,OfficialRating:"PG-13",RunTimeTicks:6e10,Genres:["Drama","Romance","Coming of Age"],ImageUrl:"/DemoContent/Posters/joker-poster.png"}]),r=e([{Id:"demo-tv-1",Name:"Tech Titans",Type:"Series",ProductionYear:2023,Overview:"A dramatic series following the rise and fall of tech entrepreneurs in Silicon Valley.",CommunityRating:8.8,OfficialRating:"TV-MA",Genres:["Drama","Technology"],ImageUrl:"/DemoContent/Posters/dr-strange-poster.jpg"},{Id:"demo-tv-2",Name:"Galactic Patrol",Type:"Series",ProductionYear:2022,Overview:"Space opera following an intergalactic police force protecting the universe.",CommunityRating:9,OfficialRating:"TV-14",Genres:["Science Fiction","Action","Adventure"],ImageUrl:"/DemoContent/Posters/wayns-world-2-poster.jpg"}]),a=e([{Id:"demo-collection-1",Name:"Epic Space Saga",Type:"BoxSet",Overview:"The complete collection of space adventure films.",ImageUrl:"/DemoContent/Posters/joker-poster.png",ChildCount:3},{Id:"demo-collection-2",Name:"Mystery Classics",Type:"BoxSet",Overview:"Timeless mystery and detective stories.",ImageUrl:"/DemoContent/Posters/exorcist-poster.jpg",ChildCount:5}]),n=e([{Id:"demo-tv-1-s1",Name:"Season 1",Type:"Season",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",IndexNumber:1,ProductionYear:2023},{Id:"demo-tv-1-s2",Name:"Season 2",Type:"Season",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",IndexNumber:2,ProductionYear:2024},{Id:"demo-tv-2-s1",Name:"Season 1",Type:"Season",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",IndexNumber:1,ProductionYear:2022}]),i=e([{Id:"demo-tv-1-s1e1",Name:"The Pitch",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:1,ParentIndexNumber:1,ProductionYear:2023,Overview:"A young entrepreneur pitches her revolutionary app idea to investors.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s1e2",Name:"First Hire",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:2,ParentIndexNumber:1,ProductionYear:2023,Overview:"The team struggles to find their first key employee.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s1e3",Name:"Beta Launch",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:3,ParentIndexNumber:1,ProductionYear:2023,Overview:"The app launches to the public with unexpected results.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s2e1",Name:"Scaling Up",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:1,ParentIndexNumber:2,ProductionYear:2024,Overview:"The company faces growing pains as it expands rapidly.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s2e2",Name:"Competitor Threat",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:2,ParentIndexNumber:2,ProductionYear:2024,Overview:"A well-funded competitor emerges with a similar product.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s2e3",Name:"Acquisition Offer",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:3,ParentIndexNumber:2,ProductionYear:2024,Overview:"A major tech company makes an unexpected acquisition offer.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s2e4",Name:"Breaking Point",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:4,ParentIndexNumber:2,ProductionYear:2024,Overview:"The startup faces a critical decision that could make or break the company.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e1",Name:"New Recruit",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:1,ParentIndexNumber:1,ProductionYear:2022,Overview:"A rookie joins the elite Galactic Patrol force.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e2",Name:"First Mission",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:2,ParentIndexNumber:1,ProductionYear:2022,Overview:"The team investigates a distress signal from a remote planet.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e3",Name:"Alien Encounter",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:3,ParentIndexNumber:1,ProductionYear:2022,Overview:"First contact with a new alien species goes wrong.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e4",Name:"The Artifact",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:4,ParentIndexNumber:1,ProductionYear:2022,Overview:"Discovery of an ancient artifact threatens galactic peace.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e5",Name:"Betrayal",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:5,ParentIndexNumber:1,ProductionYear:2022,Overview:"A trusted member of the patrol may be working with the enemy.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e6",Name:"The Rise of Heroes",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:6,ParentIndexNumber:1,ProductionYear:2022,Overview:"The patrol faces their greatest challenge yet as an ancient threat emerges.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"}]),s=e([{Id:"demo-cw-1",Name:"The Rise of Heroes",Type:"Episode",SeriesName:"Galactic Patrol",SeriesId:"demo-tv-2",SeasonId:"demo-tv-2-s1",IndexNumber:6,ParentIndexNumber:1,ProductionYear:2022,Overview:"The patrol faces their greatest challenge yet as an ancient threat emerges.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/HeroImages/avengers-hero-banner.jpg",UserData:{PlaybackPositionTicks:165e8,PlayedPercentage:55,Played:!1}},{Id:"demo-cw-2",Name:"The Cosmic Journey",Type:"Movie",ProductionYear:2023,Overview:"An epic space adventure that follows a crew of explorers.",RunTimeTicks:72e9,ImageUrl:"/DemoContent/HeroImages/avengers-2-hero-banner.jpg",UserData:{PlaybackPositionTicks:216e8,PlayedPercentage:30,Played:!1}},{Id:"demo-cw-3",Name:"Breaking Point",Type:"Episode",SeriesName:"Tech Titans",SeriesId:"demo-tv-1",SeasonId:"demo-tv-1-s2",IndexNumber:4,ParentIndexNumber:2,ProductionYear:2023,Overview:"The startup faces a critical decision that could make or break the company.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/HeroImages/xmen-hero-image.jpg",UserData:{PlaybackPositionTicks:264e8,PlayedPercentage:80,Played:!1}}]),l=e=>[...o.value,...r.value,...a.value].find(t=>t.Id===e);return{demoLibraries:t,demoMovies:o,demoTVShows:r,demoCollections:a,getLibraries:()=>t.value,getLibraryItems:e=>"demo-movies"===e?o.value:"demo-tvshows"===e?r.value:"demo-collections"===e?a.value:[],getItemDetails:l,getCollectionItems:e=>o.value.slice(0,3),getContinueWatching:()=>s.value,getSimilarItems:(e,t=15)=>{const a=l(e);if(!a)return[];return("Series"===a.Type?r.value:o.value).filter(t=>t.Id!==e).map(e=>{const t=e.Genres?.filter(e=>a.Genres?.includes(e)).length||0;return{item:e,score:t}}).sort((e,t)=>t.score-e.score).map(({item:e})=>e).slice(0,t)},getSeasons:e=>n.value.filter(t=>t.SeriesId===e),getEpisodes:(e,t)=>i.value.filter(o=>o.SeriesId===e&&o.SeasonId===t)}}const v={},h=function(e,t,o){let r=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};const a=document.getElementsByTagName("link"),n=document.querySelector("meta[property=csp-nonce]"),i=n?.nonce||n?.getAttribute("nonce");r=e(t.map(e=>{if(e=function(e,t){return new URL(e,t).href}(e,o),e in v)return;v[e]=!0;const t=e.endsWith(".css"),r=t?'[rel="stylesheet"]':"";if(o)for(let o=a.length-1;o>=0;o--){const r=a[o];if(r.href===e&&(!t||"stylesheet"===r.rel))return}else if(document.querySelector(`link[href="${e}"]${r}`))return;const n=document.createElement("link");return n.rel=t?"stylesheet":"modulepreload",t||(n.as="script"),n.crossOrigin="",n.href=e,i&&n.setAttribute("nonce",i),document.head.appendChild(n),t?new Promise((t,o)=>{n.addEventListener("load",t),n.addEventListener("error",()=>o(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function a(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return r.then(t=>{for(const e of t||[])"rejected"===e.status&&a(e.reason);return e().catch(a)})},f=()=>{try{return"undefined"!=typeof window&&void 0!==window.localStorage}catch{return!1}},p=(()=>{if(!f())return console.warn("[EmbyAPI] localStorage is not available"),{serverUrl:"",userId:"",accessToken:""};try{const e=localStorage.getItem("embyflix-api");if(e){const t=JSON.parse(e);return console.log("[EmbyAPI] Loaded API state from localStorage:",{serverUrl:t.serverUrl,userId:t.userId,hasToken:!!t.accessToken}),{serverUrl:t.serverUrl||"",userId:t.userId||"",accessToken:t.accessToken||""}}console.log("[EmbyAPI] No saved API state found in localStorage")}catch(e){console.error("[EmbyAPI] Failed to load API state:",e)}return{serverUrl:"",userId:"",accessToken:""}})(),w=new Map,b=new Map,I=(e,t={})=>`${e}?${Object.keys(t).sort().map(e=>`${e}=${t[e]}`).join("&")}`,S=e=>{const t=b.get(e);return t&&(e=>!!e&&Date.now()-e.timestamp<3e5)(t)?(console.log("[EmbyAPI] Cache hit:",e),t.data):(t&&(console.log("[EmbyAPI] Cache expired:",e),b.delete(e)),null)},T=(e,t)=>{b.set(e,{data:t,timestamp:Date.now()}),console.log("[EmbyAPI] Cached:",e)},k=()=>{b.clear(),w.clear(),console.log("[EmbyAPI] Cache cleared")},P=e(p.serverUrl),E=e(p.userId),M=e(p.accessToken),C=e(!1),D=e(null);function N(){const e=()=>{const e={"Content-Type":"application/json","X-Emby-Authorization":'MediaBrowser Client="EmbyFlix", Device="Samsung TV", DeviceId="embyflix-tizen", Version="1.0.0"'};return M.value&&(e["X-Emby-Token"]=M.value),e},t=async(t,o)=>{C.value=!0,D.value=null;try{let r=`${P.value}/emby/Shows/${t}/Episodes?UserId=${E.value}&Fields=Overview,PrimaryImageAspectRatio`;o&&(r+=`&SeasonId=${o}`);const a=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)throw new Error(`Failed to get episodes: ${a.status}`);return(await a.json()).Items||[]}catch(r){throw D.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] getEpisodes error:",r),r}finally{C.value=!1}},o=async t=>{console.log("[EmbyAPI] getItemDetails called:",t),C.value=!0,D.value=null;try{const o=`${P.value}/emby/Users/${E.value}/Items/${t}?fields=ShareLevel`;console.log("[EmbyAPI] Fetching item details URL:",o);const r=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!r.ok)throw console.error("[EmbyAPI] Failed to get item details. Status:",r.status),new Error(`Failed to get item details: ${r.status}`);const a=await r.json();return console.log("[EmbyAPI] Received item details:",a),a}catch(o){throw D.value=o instanceof Error?o.message:"Unknown error",console.error("[EmbyAPI] getItemDetails error:",o),o}finally{C.value=!1}},r=(e,t="Primary",o=300)=>{const r=new URLSearchParams({maxWidth:o.toString(),quality:"90",api_key:M.value});return`${P.value}/emby/Items/${e}/Images/${t}?${r.toString()}`};return{serverUrl:P,userId:E,accessToken:M,isLoading:C,error:D,authenticateByName:async(t,o,r="")=>{console.log("[EmbyAPI] Authenticating:",{server:t,username:o}),C.value=!0,D.value=null;try{P.value=t;const a=`${t}/emby/Users/AuthenticateByName`,n={Username:o,Pw:r},i=await fetch(a,{method:"POST",headers:e(),body:JSON.stringify(n),mode:"cors",credentials:"omit"});if(!i.ok){console.error("[EmbyAPI] Authentication failed with status:",i.status);let e="Authentication failed";throw 401===i.status?e="Invalid username or password":404===i.status?e="Server not found. Check the server URL":i.status>=500&&(e="Server error. Please try again later"),new Error(e)}const s=await i.json();return M.value=s.AccessToken,E.value=s.User.Id,console.log("[EmbyAPI] Authentication successful:",{userId:E.value,userName:s.User.Name,serverUrl:P.value}),((e,t,o)=>{if(f())try{const r=JSON.stringify({serverUrl:e,userId:t,accessToken:o});localStorage.setItem("embyflix-api",r),console.log("[EmbyAPI] Saved API state to localStorage:",{serverUrl:e,userId:t,hasToken:!!o})}catch(r){if(r instanceof DOMException&&"QuotaExceededError"===r.name){console.error("[EmbyAPI] localStorage quota exceeded (5 MB limit). Attempting to clear old data...");try{localStorage.removeItem("embyflix-api"),localStorage.setItem("embyflix-api",JSON.stringify({serverUrl:e,userId:t,accessToken:o})),console.log("[EmbyAPI] Successfully saved API state after clearing old data")}catch(a){console.error("[EmbyAPI] Failed to save API state after clearing:",a)}}else console.error("[EmbyAPI] Failed to save API state:",r)}else console.warn("[EmbyAPI] localStorage is not available, API state will not persist")})(P.value,E.value,M.value),s}catch(a){let e="Unknown error";throw a instanceof TypeError&&a.message.includes("fetch")?e="Cannot connect to server.":a instanceof Error&&(e=a.message),D.value=e,console.error("[EmbyAPI] Authentication error:",a),new Error(e)}finally{C.value=!1}},getViews:async()=>{const t=I("views",{userId:E.value}),o=S(t);if(o)return o;C.value=!0,D.value=null;try{const o=`${P.value}/emby/Users/${E.value}/Views`,r=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!r.ok)throw new Error(`Failed to get views: ${r.status}`);const a=(await r.json()).Items||[];return T(t,a),a}catch(r){throw D.value=r instanceof Error?r.message:"Unknown error",r}finally{C.value=!1}},getItems:async(t,o=null)=>{console.log("[EmbyAPI] getItems called:",{parentId:t,itemType:o});const r=I("items",{parentId:t,itemType:o||"all",userId:E.value}),a=S(r);if(a)return a;C.value=!0,D.value=null;try{const a=[];let n=0;const i=300;let s=0;do{let r=`${P.value}/emby/Users/${E.value}/Items?ParentId=${t}&Recursive=true&StartIndex=${n}&Limit=${i}`;o&&(r+=`&IncludeItemTypes=${o}`),r+="&Fields=UserData,Genres,Studios,Overview,CommunityRating,CriticRating,ProductionYear",console.log("[EmbyAPI] Fetching URL:",r,`(${n}-${n+i})`);const l=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!l.ok)throw console.error("[EmbyAPI] Failed to get items. Status:",l.status),new Error(`Failed to get items: ${l.status}`);const c=await l.json();s=c.TotalRecordCount||0;const u=c.Items||[];console.log("[EmbyAPI] Received batch:",u.length,`Total: ${a.length+u.length}/${s}`),a.push(...u),n+=i}while(n<s);return console.log("[EmbyAPI] Received all items:",a.length),T(r,a),a}catch(n){throw D.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getItems error:",n),n}finally{C.value=!1}},getCollectionItems:async t=>{const o=I("collection",{collectionId:t,userId:E.value}),r=S(o);if(r)return r;C.value=!0,D.value=null;try{const r=[];let a=0;const n=300;let i=0;do{const o=`${P.value}/emby/Users/${E.value}/Items?ParentId=${t}&StartIndex=${a}&Limit=${n}&Fields=UserData`,s=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!s.ok)throw new Error(`Failed to get collection items: ${s.status}`);const l=await s.json();i=l.TotalRecordCount||0;const c=l.Items||[];r.push(...c),a+=n}while(a<i);return console.log("[EmbyAPI] Received all collection items:",r.length),T(o,r),r}catch(a){throw D.value=a instanceof Error?a.message:"Unknown error",a}finally{C.value=!1}},getSeasons:async t=>{C.value=!0,D.value=null;try{const o=`${P.value}/emby/Shows/${t}/Seasons?UserId=${E.value}`,r=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!r.ok)throw new Error(`Failed to get seasons: ${r.status}`);return(await r.json()).Items||[]}catch(o){throw D.value=o instanceof Error?o.message:"Unknown error",console.error("[EmbyAPI] getSeasons error:",o),o}finally{C.value=!1}},getEpisodes:t,getNextEpisode:async e=>{if("Episode"!==e.Type||!e.SeriesId)return null;try{const o=await t(e.SeriesId),r=o.findIndex(t=>t.Id===e.Id);return-1===r||r===o.length-1?null:o[r+1]}catch(o){return console.error("[EmbyAPI] getNextEpisode error:",o),null}},getPreviousEpisode:async e=>{if("Episode"!==e.Type||!e.SeriesId)return null;try{const o=await t(e.SeriesId),r=o.findIndex(t=>t.Id===e.Id);return r<=0?null:o[r-1]}catch(o){return console.error("[EmbyAPI] getPreviousEpisode error:",o),null}},getContinueWatching:async()=>{const t=I("continueWatching",{userId:E.value}),o=S(t);if(o)return o;C.value=!0,D.value=null;try{const o=`${P.value}/emby/Users/${E.value}/Items/Resume?Limit=10&Recursive=true&Fields=PrimaryImageAspectRatio,BasicSyncInfo&ImageTypeLimit=1&EnableImageTypes=Primary&MediaTypes=Video`;console.log("[EmbyAPI] Fetching continue watching items");const r=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!r.ok)throw new Error(`Failed to get continue watching: ${r.status}`);const a=(await r.json()).Items||[];return console.log("[EmbyAPI] Continue watching items:",a.length),T(t,a),a}catch(r){throw D.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] getContinueWatching error:",r),r}finally{C.value=!1}},getRecentlyWatched:async(t=20,o=["Movie","Series"])=>{const r=I("recentlyWatched",{userId:E.value,limit:t,itemTypes:o.join(",")}),a=S(r);if(a)return a;C.value=!0,D.value=null;try{const a=`${P.value}/emby/Users/${E.value}/Items?Limit=${t}&Recursive=true&SortBy=DatePlayed&SortOrder=Descending&Filters=IsPlayed&Fields=PrimaryImageAspectRatio,BasicSyncInfo&ImageTypeLimit=1&EnableImageTypes=Primary&IncludeItemTypes=${o.join(",")}`;console.log("[EmbyAPI] Fetching recently watched items:",o.join(","));const n=await fetch(a,{headers:e(),mode:"cors",credentials:"omit"});if(!n.ok)throw new Error(`Failed to get recently watched: ${n.status}`);const i=(await n.json()).Items||[];return console.log("[EmbyAPI] Recently watched items:",i.length),T(r,i),i}catch(n){throw D.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getRecentlyWatched error:",n),n}finally{C.value=!1}},getItemDetails:o,getMediaSources:async t=>{try{const o=`${P.value}/emby/Items/${t}/PlaybackInfo?UserId=${E.value}`;console.log("[EmbyAPI] Fetching media sources:",o);const r=await fetch(o,{method:"POST",headers:e(),body:JSON.stringify({DeviceProfile:{MaxStreamingBitrate:14e7}}),mode:"cors",credentials:"omit"});if(!r.ok)throw new Error(`Failed to get media sources: ${r.status}`);const a=await r.json();return console.log("[EmbyAPI] Media sources response:",a),a.MediaSources||[]}catch(o){throw console.error("[EmbyAPI] getMediaSources error:",o),o}},getPlaybackInfo:async(t,o,r)=>{try{const a=new URLSearchParams({UserId:E.value,StartTimeTicks:"0",IsPlayback:"true",AutoOpenLiveStream:"true",MaxStreamingBitrate:"140000000"});void 0!==o&&a.append("AudioStreamIndex",o.toString()),void 0!==r&&a.append("SubtitleStreamIndex",r.toString());const n=`${P.value}/emby/Items/${t}/PlaybackInfo?${a.toString()}`;console.log("[EmbyAPI] Fetching playback info:",n);const i=await fetch(n,{method:"POST",headers:e(),body:JSON.stringify({DeviceProfile:{MaxStreamingBitrate:14e7,MusicStreamingTranscodingBitrate:192e3}}),mode:"cors",credentials:"omit"});if(!i.ok){console.error("[EmbyAPI] Failed to get playback info. Status:",i.status);const e=await i.text();throw console.error("[EmbyAPI] Error response:",e),new Error(`Failed to get playback info: ${i.status}`)}const s=await i.json();if(console.log("[EmbyAPI] Playback info response:",s),s.ErrorCode)throw console.error("[EmbyAPI] Playback error code:",s.ErrorCode),new Error(`Playback error: ${s.ErrorCode}`);return s}catch(a){throw console.error("[EmbyAPI] getPlaybackInfo error:",a),a}},getStreamUrl:e=>{const t=new URLSearchParams({Static:"true",MediaSourceId:e,DeviceId:"EmbyFlix",api_key:M.value});return`${P.value}/emby/Videos/${e}/stream.mp4?${t.toString()}`},generatePlaySessionId:()=>`${Date.now()}_${Math.random().toString(36).substring(2,11)}`,reportPlaybackStart:async(t,o)=>{try{const r=`${P.value}/emby/Sessions/Playing`,a={ItemId:t,PlaySessionId:o,MediaSourceId:t,CanSeek:!0,IsMuted:!1,IsPaused:!1,PositionTicks:0,PlayMethod:"DirectStream"};console.log("[EmbyAPI] Reporting playback start:",a),await fetch(r,{method:"POST",headers:e(),body:JSON.stringify(a),mode:"cors",credentials:"omit"})}catch(r){console.error("Failed to report playback start:",r)}},reportPlaybackProgress:async(t,o,r,a)=>{try{const n=`${P.value}/emby/Sessions/Playing/Progress`,i={ItemId:t,PlaySessionId:a,MediaSourceId:t,PositionTicks:o,IsPaused:r,IsMuted:!1,PlayMethod:"DirectStream"};await fetch(n,{method:"POST",headers:e(),body:JSON.stringify(i),mode:"cors",credentials:"omit"})}catch(n){console.error("Failed to report playback progress:",n)}},reportPlaybackStopped:async(t,r,a)=>{try{const n=`${P.value}/emby/Sessions/Playing/Stopped`,i={ItemId:t,PlaySessionId:a,MediaSourceId:t,PositionTicks:r,PlayMethod:"DirectStream"};await fetch(n,{method:"POST",headers:e(),body:JSON.stringify(i),mode:"cors",credentials:"omit"}),h(async()=>{const{useAnalytics:e}=await Promise.resolve().then(()=>oe);return{useAnalytics:e}},void 0,import.meta.url).then(({useAnalytics:e})=>{e().trackPlaybackFromTicks(t,r,o)}).catch(e=>{console.error("[EmbyAPI] Failed to load analytics module:",e)})}catch(n){console.error("Failed to report playback stopped:",n)}},getImageUrl:r,getHeroImageUrl:async t=>{const o=`${t}-hero`;if(w.has(o))return w.get(o);try{const r=`${P.value}/emby/Users/${E.value}/Items/${t}?Fields=RemoteTrailers,ProviderIds`,a=await fetch(r,{headers:e(),cache:"default"});if(a.ok){const r=await a.json();if(r.ProviderIds?.Tmdb){const r=`${P.value}/emby/Items/${t}/RemoteImages?ProviderName=TheMovieDb&Type=Backdrop&IncludeAllLanguages=false`,a=await fetch(r,{headers:e(),cache:"default"});if(a.ok){const e=await a.json();if(e.Images&&e.Images.length>0){const t=e.Images[0].Url;return w.set(o,t),t}}}}}catch(s){console.log("[EmbyAPI] Could not fetch TMDB backdrop, falling back to Emby images:",s)}const a=new URLSearchParams({maxWidth:"1920",quality:"90",api_key:M.value}),n=`${P.value}/emby/Items/${t}/Images/Backdrop?${a.toString()}`;try{if((await fetch(n,{method:"HEAD",cache:"force-cache"})).ok)return w.set(o,n),n}catch{}const i=r(t,"Primary",1920);return w.set(o,i),i},searchItems:async(t,o)=>{if(!t.trim())return[];console.log("[EmbyAPI] searchItems called:",{query:t,itemTypes:o});const r=I("search",{query:t.toLowerCase(),itemTypes:o?.join(",")||"all",userId:E.value}),a=S(r);if(a)return a;C.value=!0,D.value=null;try{const a=new URLSearchParams({SearchTerm:t,Recursive:"true",Fields:"UserData,CriticRating,CommunityRating,OfficialRating,Studios,TagItems,Genres,Name,ProviderIds",Limit:"100",UserId:E.value});o&&o.length>0&&a.append("IncludeItemTypes",o.join(","));const n=`${P.value}/emby/Users/${E.value}/Items?${a.toString()}`;console.log("[EmbyAPI] Search URL:",n);const i=await fetch(n,{headers:e(),mode:"cors",credentials:"omit"});if(!i.ok)throw console.error("[EmbyAPI] Failed to search items. Status:",i.status),new Error(`Failed to search items: ${i.status}`);const s=(await i.json()).Items||[];return console.log("[EmbyAPI] Search results:",s.length),T(r,s),s}catch(n){throw D.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] searchItems error:",n),n}finally{C.value=!1}},searchItemsByExternalId:async(t,o,r)=>{if(!t&&!o)return[];console.log("[EmbyAPI] searchItemsByExternalId called:",{imdbId:t,tmdbId:o,itemTypes:r});const a=I("search-external-id",{imdbId:t||"",tmdbId:o||"",itemTypes:r?.join(",")||"all",userId:E.value}),n=S(a);if(n)return n;C.value=!0,D.value=null;try{const n=new URLSearchParams({Recursive:"true",Fields:"UserData,CriticRating,CommunityRating,OfficialRating,Studios,TagItems,Genres,Name,ProviderIds,ProductionYear",Limit:"100",UserId:E.value});t&&n.append("AnyProviderIdEquals",`imdb.${t}`),o&&n.append("AnyProviderIdEquals",`tmdb.${o}`),r&&r.length>0&&n.append("IncludeItemTypes",r.join(","));const i=`${P.value}/emby/Users/${E.value}/Items?${n.toString()}`;console.log("[EmbyAPI] Search by external ID URL:",i);const s=await fetch(i,{headers:e(),mode:"cors",credentials:"omit"});if(!s.ok)throw console.error("[EmbyAPI] Failed to search by external ID. Status:",s.status),new Error(`Failed to search by external ID: ${s.status}`);const l=(await s.json()).Items||[];return console.log("[EmbyAPI] Search by external ID results:",l.length),T(a,l),l}catch(i){throw D.value=i instanceof Error?i.message:"Unknown error",console.error("[EmbyAPI] searchItemsByExternalId error:",i),i}finally{C.value=!1}},getSimilarItems:async(t,o=15)=>{console.log("[EmbyAPI] getSimilarItems called:",{itemId:t,limit:o});const r=I("similar-items",{itemId:t,limit:o,userId:E.value}),a=S(r);if(a)return a;C.value=!0,D.value=null;try{const a=new URLSearchParams({UserId:E.value,Limit:o.toString(),Fields:"UserData,CriticRating,CommunityRating,OfficialRating,ProductionYear"}),n=`${P.value}/emby/Items/${t}/Similar?${a.toString()}`;console.log("[EmbyAPI] Similar items URL:",n);const i=await fetch(n,{headers:e(),mode:"cors",credentials:"omit"});if(!i.ok)throw console.error("[EmbyAPI] Failed to get similar items. Status:",i.status),new Error(`Failed to get similar items: ${i.status}`);const s=(await i.json()).Items||[];return console.log("[EmbyAPI] Similar items results:",s.length),T(r,s),s}catch(n){throw D.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getSimilarItems error:",n),n}finally{C.value=!1}},markAsPlayed:async t=>{console.log("[EmbyAPI] markAsPlayed called:",{itemId:t}),C.value=!0,D.value=null;try{const o=`${P.value}/emby/Users/${E.value}/PlayedItems/${t}`;console.log("[EmbyAPI] Mark as played URL:",o);const r=await fetch(o,{method:"POST",headers:e(),mode:"cors",credentials:"omit"});if(!r.ok)throw console.error("[EmbyAPI] Failed to mark as played. Status:",r.status),new Error(`Failed to mark as played: ${r.status}`);console.log("[EmbyAPI] Item marked as played successfully");const a=I("continueWatching",{userId:E.value});b.delete(a)}catch(o){throw D.value=o instanceof Error?o.message:"Unknown error",console.error("[EmbyAPI] markAsPlayed error:",o),o}finally{C.value=!1}},markAsUnplayed:async t=>{console.log("[EmbyAPI] markAsUnplayed called:",{itemId:t}),C.value=!0,D.value=null;try{const o=`${P.value}/emby/Users/${E.value}/PlayedItems/${t}`;console.log("[EmbyAPI] Mark as unplayed URL:",o);const r=await fetch(o,{method:"DELETE",headers:e(),mode:"cors",credentials:"omit"});if(!r.ok)throw console.error("[EmbyAPI] Failed to mark as unplayed. Status:",r.status),new Error(`Failed to mark as unplayed: ${r.status}`);console.log("[EmbyAPI] Item marked as unplayed successfully");const a=I("continueWatching",{userId:E.value});b.delete(a)}catch(o){throw D.value=o instanceof Error?o.message:"Unknown error",console.error("[EmbyAPI] markAsUnplayed error:",o),o}finally{C.value=!1}},getIntroSkipMarkers:async t=>{console.log("[EmbyAPI] getIntroSkipMarkers called:",{itemId:t});try{const o=`${P.value}/emby/Users/${E.value}/Items/${t}`,r=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!r.ok)return console.error("[EmbyAPI] Failed to get intro markers. Status:",r.status),null;const a=await r.json();if(a.Chapters&&Array.isArray(a.Chapters)){const e=a.Chapters.find(e=>"IntroStart"===e.MarkerType||"Intro"===e.Name||"Intro"===e.ChapterType);if(e){const t=e.StartPositionTicks||0,o=e.EndPositionTicks||t+6e8;return console.log("[EmbyAPI] Found intro markers:",{introStart:t,introEnd:o}),{IntroStart:t,IntroEnd:o}}}return void 0!==a.IntroStart&&void 0!==a.IntroEnd?(console.log("[EmbyAPI] Found intro markers in IntroStart/IntroEnd:",{IntroStart:a.IntroStart,IntroEnd:a.IntroEnd}),{IntroStart:a.IntroStart,IntroEnd:a.IntroEnd}):(console.log("[EmbyAPI] No intro markers found for item"),null)}catch(o){return console.error("[EmbyAPI] getIntroSkipMarkers error:",o),null}},clearCache:k}}const A={ARROW_LEFT:{keyName:"ArrowLeft",keyCode:37,category:"navigation",description:"Left arrow / Navigate left",recommendedUse:"Spatial navigation left"},ARROW_UP:{keyName:"ArrowUp",keyCode:38,category:"navigation",description:"Up arrow / Navigate up",recommendedUse:"Spatial navigation up"},ARROW_RIGHT:{keyName:"ArrowRight",keyCode:39,category:"navigation",description:"Right arrow / Navigate right",recommendedUse:"Spatial navigation right"},ARROW_DOWN:{keyName:"ArrowDown",keyCode:40,category:"navigation",description:"Down arrow / Navigate down",recommendedUse:"Spatial navigation down"},ENTER:{keyName:"Enter",keyCode:13,category:"navigation",description:"Enter / OK button",recommendedUse:"Select/activate focused element"},BACK:{keyName:"Back",keyCode:10009,category:"navigation",description:"Back button",recommendedUse:"Navigate to previous page/screen"},NUM_0:{keyName:"0",keyCode:48,category:"numeric",description:"Number 0",recommendedUse:"Quick jump to content, input fields"},NUM_1:{keyName:"1",keyCode:49,category:"numeric",description:"Number 1",recommendedUse:"Quick jump to content, input fields"},NUM_2:{keyName:"2",keyCode:50,category:"numeric",description:"Number 2",recommendedUse:"Quick jump to content, input fields"},NUM_3:{keyName:"3",keyCode:51,category:"numeric",description:"Number 3",recommendedUse:"Quick jump to content, input fields"},NUM_4:{keyName:"4",keyCode:52,category:"numeric",description:"Number 4",recommendedUse:"Quick jump to content, input fields"},NUM_5:{keyName:"5",keyCode:53,category:"numeric",description:"Number 5",recommendedUse:"Quick jump to content, input fields"},NUM_6:{keyName:"6",keyCode:54,category:"numeric",description:"Number 6",recommendedUse:"Quick jump to content, input fields"},NUM_7:{keyName:"7",keyCode:55,category:"numeric",description:"Number 7",recommendedUse:"Quick jump to content, input fields"},NUM_8:{keyName:"8",keyCode:56,category:"numeric",description:"Number 8",recommendedUse:"Quick jump to content, input fields"},NUM_9:{keyName:"9",keyCode:57,category:"numeric",description:"Number 9",recommendedUse:"Quick jump to content, input fields"},MINUS:{keyName:"Minus",keyCode:189,category:"numeric",description:"Minus/Dash key",recommendedUse:"Special numeric input"},VOLUME_UP:{keyName:"VolumeUp",keyCode:447,category:"volume",description:"Volume up button",recommendedUse:"Increase volume (handled by TV OS, but can be intercepted)"},VOLUME_DOWN:{keyName:"VolumeDown",keyCode:448,category:"volume",description:"Volume down button",recommendedUse:"Decrease volume (handled by TV OS, but can be intercepted)"},VOLUME_MUTE:{keyName:"VolumeMute",keyCode:449,category:"volume",description:"Mute/unmute button",recommendedUse:"Toggle mute (handled by TV OS, but can be intercepted)"},CHANNEL_UP:{keyName:"ChannelUp",keyCode:427,category:"channel",description:"Channel up button",recommendedUse:"Navigate to next episode/video in playlist"},CHANNEL_DOWN:{keyName:"ChannelDown",keyCode:428,category:"channel",description:"Channel down button",recommendedUse:"Navigate to previous episode/video in playlist"},CHANNEL_LIST:{keyName:"ChannelList",keyCode:10073,category:"channel",description:"Channel list button",recommendedUse:"Show playlist/episode list"},PREVIOUS_CHANNEL:{keyName:"PreviousChannel",keyCode:10190,category:"channel",description:"Previous channel button",recommendedUse:"Jump back to previous content"},MEDIA_PLAY_PAUSE:{keyName:"MediaPlayPause",keyCode:10252,category:"media",description:"Play/Pause toggle button",recommendedUse:"Toggle video playback"},MEDIA_REWIND:{keyName:"MediaRewind",keyCode:412,category:"media",description:"Rewind button",recommendedUse:"Seek backward 10-30 seconds"},MEDIA_FAST_FORWARD:{keyName:"MediaFastForward",keyCode:417,category:"media",description:"Fast forward button",recommendedUse:"Seek forward 10-30 seconds"},MEDIA_PLAY:{keyName:"MediaPlay",keyCode:415,category:"media",description:"Play button",recommendedUse:"Resume/start playback"},MEDIA_PAUSE:{keyName:"MediaPause",keyCode:19,category:"media",description:"Pause button",recommendedUse:"Pause playback"},MEDIA_STOP:{keyName:"MediaStop",keyCode:413,category:"media",description:"Stop button",recommendedUse:"Stop playback and return to content list"},MEDIA_RECORD:{keyName:"MediaRecord",keyCode:416,category:"media",description:"Record button",recommendedUse:"Add to watchlist/favorites"},MEDIA_TRACK_PREVIOUS:{keyName:"MediaTrackPrevious",keyCode:10232,category:"media",description:"Previous track/episode button",recommendedUse:"Jump to previous episode"},MEDIA_TRACK_NEXT:{keyName:"MediaTrackNext",keyCode:10233,category:"media",description:"Next track/episode button",recommendedUse:"Jump to next episode"},COLOR_RED:{keyName:"ColorF0Red",keyCode:403,category:"color",description:"Red color button (F0)",recommendedUse:"Filter by genre, quick action 1"},COLOR_GREEN:{keyName:"ColorF1Green",keyCode:404,category:"color",description:"Green color button (F1)",recommendedUse:"Sort options, quick action 2"},COLOR_YELLOW:{keyName:"ColorF2Yellow",keyCode:405,category:"color",description:"Yellow color button (F2)",recommendedUse:"Search, quick action 3"},COLOR_BLUE:{keyName:"ColorF3Blue",keyCode:406,category:"color",description:"Blue color button (F3)",recommendedUse:"Settings/options, quick action 4"},MENU:{keyName:"Menu",keyCode:18,category:"system",description:"Menu button",recommendedUse:"Open main menu/sidebar"},TOOLS:{keyName:"Tools",keyCode:10135,category:"system",description:"Tools button",recommendedUse:"Open context menu/options"},INFO:{keyName:"Info",keyCode:457,category:"system",description:"Info button",recommendedUse:"Show content details/metadata"},SOURCE:{keyName:"Source",keyCode:10072,category:"system",description:"Source button",recommendedUse:"Not typically used in apps"},EXIT:{keyName:"Exit",keyCode:10182,category:"system",description:"Exit button",recommendedUse:"Exit app or close modal"},CAPTION:{keyName:"Caption",keyCode:10221,category:"system",description:"Caption/Subtitle button",recommendedUse:"Toggle subtitles on/off"},E_MANUAL:{keyName:"E-Manual",keyCode:10146,category:"system",description:"Electronic manual button",recommendedUse:"Show help/instructions"},THREE_D:{keyName:"3D",keyCode:10199,category:"system",description:"3D mode button",recommendedUse:"Not typically used"},EXTRA:{keyName:"Extra",keyCode:10253,category:"system",description:"Extra content button",recommendedUse:"Show extras/bonus content"},PICTURE_SIZE:{keyName:"PictureSize",keyCode:10140,category:"system",description:"Picture size/aspect ratio button",recommendedUse:"Toggle fullscreen or aspect ratio"},SOCCER:{keyName:"Soccer",keyCode:10228,category:"system",description:"Soccer mode button",recommendedUse:"Sports-specific features (if applicable)"},TELETEXT:{keyName:"Teletext",keyCode:10200,category:"system",description:"Teletext button",recommendedUse:"Not typically used in apps"},MTS:{keyName:"MTS",keyCode:10195,category:"system",description:"Multi-track sound button",recommendedUse:"Switch audio tracks"},SEARCH:{keyName:"Search",keyCode:10225,category:"system",description:"Search button",recommendedUse:"Open search interface"},GUIDE:{keyName:"Guide",keyCode:458,category:"system",description:"TV Guide button",recommendedUse:"Show content guide/schedule"}};function R(e,t){return e.keyCode===t.keyCode||e.key===t.keyName}function U(e){const t=(o=e.keyCode,Object.values(A).find(e=>e.keyCode===o));var o;return t?`[TizenKey] ${t.keyName} (${t.keyCode}) - ${t.description}`:`[TizenKey] Unknown key: keyCode=${e.keyCode}, key='${e.key}'`}function _(){const r=e(!1);let a=null,n=[],i=0;let s=!1,l=null;const c=e=>{const t=e.closest("[data-nav-zone]");return t?t.getAttribute("data-nav-zone"):null},u=(e,t)=>{const o=t.indexOf(e);if(-1===o)return{row:0,col:0,colCount:1};const r=e.closest('[data-nav-zone="movie-grid"], .results-grid');if(!r)return{row:0,col:0,colCount:1};const a=r.clientWidth,n=e.getBoundingClientRect().width,i=Math.max(1,Math.floor(a/(n+16)));return{row:Math.floor(o/i),col:o%i,colCount:i}},d=(e,t)=>{const o=t.querySelector("[data-nav-scrollable]");if(!o)return;const r=e.getBoundingClientRect(),a=o.getBoundingClientRect(),n=r.width,i=3*n,s=r.left-a.left+o.scrollLeft,l=s+n,c=o.scrollLeft,u=c+a.width;s-i<c?o.scrollTo({left:Math.max(0,s-i),behavior:"smooth"}):l+i>u&&o.scrollTo({left:l+i-a.width,behavior:"smooth"})},m=()=>(()=>{const e=Date.now();if(e-i>500){const t='button:not([disabled]):not([tabindex="-1"]), a[href], input:not([disabled]), [tabindex]:not([tabindex="-1"]), .media-card, .nav-item, .hero-slider-wrapper, .player-control-btn, .up-next-item, .search-input, .clear-search-btn';n=Array.from(document.querySelectorAll(t)),i=e}return n})(),g=e=>e?document.querySelector(`[data-slider-id="${e}"]`):document.querySelector(".hero-slider-wrapper"),y=e=>{e.classList.contains("hero-slider-wrapper")&&(r.value=!0),console.log("[focusElement] About to focus:",e.getAttribute("aria-label")),console.log("[focusElement] Element:",e),console.log("[focusElement] Stack trace:",(new Error).stack),e.focus({preventScroll:!0}),console.log("[focusElement] After focus, activeElement:",document.activeElement?.getAttribute("aria-label"));const t=e.closest(".filters-sidebar");if(t){const o=e.getBoundingClientRect(),r=t.getBoundingClientRect();(o.top<r.top||o.bottom>r.bottom)&&e.scrollIntoView({behavior:"smooth",block:"nearest"})}else e.scrollIntoView({behavior:"smooth",block:"center"})},v=(e,t,o)=>{const r=e.getBoundingClientRect(),a={x:r.left+r.width/2,y:r.top+r.height/2};let n=null,i=1/0;for(const s of t){if(s===e)continue;const t=s.getBoundingClientRect(),r={x:t.left+t.width/2,y:t.top+t.height/2},l=r.x-a.x,c=r.y-a.y;let u=!1;switch(o){case"up":u=c<-10;break;case"down":u=c>10;break;case"left":u=l<-10;break;case"right":u=l>10}if(!u)continue;const d=s.classList.contains("hero-slider-wrapper");if(d&&("up"===o||"down"===o)){const e=a.x,o=t.left,r=t.right;if(e>=o&&e<=r){const e=Math.abs(c);e<i&&(i=e,n=s);continue}}const m=Math.sqrt(l*l+c*c);let g=0;g="up"===o||"down"===o?d?.1*Math.abs(l):.5*Math.abs(l):.5*Math.abs(c);const y=m+g;y<i&&(i=y,n=s)}return n},h=(e,t)=>{r.value=!1;const o=g(t),n=m();if(!o||0===n.length)return;if("left"===e){a=o;const e=document.querySelector(".sidebar .nav-item");if(e)return void y(e)}const i=o.getBoundingClientRect(),s=i.top,l=i.bottom;if("up"===e){let e=null,t=1/0;for(const r of n){if(r===o)continue;if(r.closest('[data-nav-zone="sidebar"]'))continue;const a=r.getBoundingClientRect();if(a.bottom<=s+10){const o=s-a.bottom;o<t&&(t=o,e=r)}}if(e)return void y(e)}let c=null,u=1/0;for(const r of n){if(r===o)continue;if(r.closest('[data-nav-zone="sidebar"]'))continue;const e=r.getBoundingClientRect();if(e.top>=l-10){const t=e.top-l;t<u&&(u=t,c=r)}}c?y(c):n.length>0&&y(n[0])},f=e=>{if(console.log("[handleNavigation] Called with direction:",e,"isNavigating:",s),l)console.log("[handleNavigation] Throttled, ignoring rapid call");else if(s)console.log("[handleNavigation] Already navigating, ignoring duplicate call");else{s=!0,l=window.setTimeout(()=>{l=null},50);try{if(r.value){if("up"===e||"down"===e){const t=document.activeElement,o=t?.getAttribute("data-slider-id")||void 0;h(e,o)}if("left"===e){const e=g();if(e&&e===document.activeElement)return}return}const t=m(),o=document.activeElement;if(!o)return void(t.length>0&&y(t[0]));const a=c(o);"search-input"===a?w(o,e,t):"search-filters"===a||"search-results"===a?p(o,e,t):"media-row"===a?b(o,e,t):"movie-grid"===a?I(o,e,t):"genre-filter"===a?S(o,e,t):"sidebar"===a?T(o,e,t):"player-controls"===a||"skip-controls"===a||"media-sidebar"===a?k(o,e,t):P(o,e,t)}finally{setTimeout(()=>{s=!1},16)}}},p=(e,t,o)=>{const r=c(e);if((e.classList.contains("media-card")||null!==e.closest(".media-card"))&&"search-results"===r){const o=e.closest(".results-grid");if(o){const r=Array.from(o.querySelectorAll(".media-card")),a=e.closest(".media-card"),n=r.indexOf(a);if(-1!==n){const{row:o,col:i,colCount:s}=u(a,r);if("left"===t){if(0===i){if(document.querySelector(".filters-sidebar")){const e=document.querySelector(".filters-sidebar .filter-chip");if(e)return void y(e)}else{const e=document.querySelector(".sidebar .nav-item");if(e)return void y(e)}}else if(n>0)return void y(r[n-1])}else if("right"===t){if(n<r.length-1)return void y(r[n+1])}else if("up"===t)if(0===o){const t=e.closest(".results-group");if(t){const e=t.previousElementSibling;if(e&&e.classList.contains("results-group")){const t=Array.from(e.querySelectorAll(".results-grid .media-card"));if(t.length>0){if(e.querySelector(".results-grid")){const{colCount:e}=u(t[0],t),o=Math.floor((t.length-1)/e)*e+Math.min(i,(t.length-1)%e);if(o<t.length)return void y(t[o])}}}else{const e=document.querySelector(".search-page .search-input");if(e)return void y(e)}}}else{const e=n-s;if(e>=0)return void y(r[e])}else if("down"===t){const t=n+s;if(t<r.length)return void y(r[t]);const o=e.closest(".results-group");if(o){const e=o.nextElementSibling;if(e&&e.classList.contains("results-group")){const t=e.querySelector(".results-grid .media-card");if(t)return void y(t)}}return}}}}if("search-filters"===r){const o=document.querySelector(".filters-sidebar");if(!o)return;const r=Array.from(o.querySelectorAll(".filter-chip, .sort-select, .clear-filters-btn")),a=r.indexOf(e);if("up"===t)if(0===a||-1===a){const e=document.querySelector(".search-page .search-input");if(e)return void y(e)}else{const t=v(e,r,"up");if(t)return void y(t)}else if("down"===t){const t=v(e,r,"down");if(t)return void y(t)}else if("right"===t){const e=document.querySelector(".results-grid .media-card");if(e)return void y(e)}else if("left"===t){const e=document.querySelector(".sidebar .nav-item");if(e)return void y(e)}return}const a=o.filter(e=>c(e)===r),n=v(e,a,t);n&&y(n)},w=(e,t,o)=>{if(e.classList.contains("clear-search-btn")||null!==e.closest(".clear-search-btn")){if("left"===t||"up"===t||"down"===t){const e=document.querySelector(".search-page .search-input");e&&y(e)}}else if("down"===t){const t=document.querySelector(".filters-sidebar .filter-chip");if(t)return void y(t);const r=document.querySelector(".results-grid .media-card");if(r)return void y(r);const a=o.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),n=v(e,a,"down");n&&y(n)}else if("left"===t){if(document.querySelector(".filters-sidebar")){const e=document.querySelector(".filters-sidebar .filter-chip");if(e)return void y(e)}else{const e=document.querySelector(".sidebar .nav-item");if(e)return void y(e)}}else if("right"===t){const e=document.querySelector(".clear-search-btn");e&&null!==e.offsetParent&&y(e)}},b=(e,t,o)=>{const r=e.closest('[data-nav-zone="media-row"]');if(!r)return;const n=(e=>Array.from(e.querySelectorAll(".media-card")))(r),i=n.indexOf(e.closest(".media-card"));if("left"===t)if(0===i){a=e;const t=document.querySelector(".sidebar .nav-item");t&&y(t)}else i>0&&(y(n[i-1]),d(n[i-1],r));else if("right"===t)i<n.length-1&&(y(n[i+1]),d(n[i+1],r));else if("up"===t||"down"===t){const r=o.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),a=v(e,r,t);a&&y(a)}},I=(e,t,o)=>{const r=e.closest('[data-nav-zone="movie-grid"]');if(!r)return;const n=Array.from(r.querySelectorAll(".media-card")),i=e.closest(".media-card"),s=n.indexOf(i);if(-1===s)return;const{row:l,col:c,colCount:d}=u(i,n);if("left"===t)if(0===c){if(0===l){a=e;const t=document.querySelector(".sidebar .nav-item");t&&y(t)}}else s>0&&y(n[s-1]);else if("right"===t)s<n.length-1&&y(n[s+1]);else if("up"===t)if(0===l){const t=o.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),r=v(e,t,"up");r&&y(r)}else{const e=s-d;e>=0&&y(n[e])}else if("down"===t){const e=s+d;e<n.length&&y(n[e])}},S=(e,t,o)=>{if("left"===t){const t=e.closest('[data-nav-zone="genre-filter"]');if(t){if(0===Array.from(t.querySelectorAll(".genre-pill")).indexOf(e)){a=e;const t=document.querySelector(".sidebar .nav-item");t&&y(t)}}}else if("down"===t){const t=e.closest('[data-nav-zone="genre-filter"]');if(!t)return;const r=t.nextElementSibling;if(r&&r.hasAttribute("data-nav-zone")&&"media-row"===r.getAttribute("data-nav-zone")){const e=r.querySelector(".media-card");if(e)return void y(e)}const a=o.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),n=v(e,a,"down");n&&y(n)}else if("up"===t){const t=o.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),r=v(e,t,"up");r&&y(r)}},T=(e,t,o)=>{if("left"===t){if(null!==e.querySelector("i.fa-search")){const e=document.querySelector(".sidebar .nav-item:has(i.fa-home)");e&&y(e)}}else if("right"===t){const e=document.querySelector(".search-page .search-input");if(e)return void y(e);if(a&&document.body.contains(a)){const e=a;a=null,e.classList.contains("hero-slider-wrapper")&&(r.value=!0),y(e);const t=e.closest('[data-nav-zone="media-row"]');if(t){const o=e.closest(".media-card");o&&d(o,t)}return}const t=Array.from(document.querySelectorAll(".hero-slider-wrapper")).filter(e=>{const t=e.getBoundingClientRect();return t.height>0&&t.width>0});if(t.length>0)return r.value=!0,void y(t[0]);const o=document.querySelector("#content-container");if(o){const e=o.querySelector(".media-card, .genre-pill, button, a[href]");if(e)return void y(e)}}else if("up"===t||"down"===t){const r=o.filter(e=>e.closest('[data-nav-zone="sidebar"]')),a=r.indexOf(e);if("down"===t){if(a>=0&&a<r.length-1){const o=v(e,r,t);o&&y(o)}}else{if(null!==e.querySelector("i.fa-home")){const e=document.querySelector(".search-page .search-input");if(e)return void y(e)}const o=v(e,r,t);o&&y(o)}}},k=(e,t,o)=>{const r=e.closest('[data-nav-zone="player-controls"], [data-nav-zone="skip-controls"], [data-nav-zone="media-sidebar"]');if(!r)return;if("media-sidebar"===r.getAttribute("data-nav-zone")){if("left"===t){const e=document.querySelector(".back-btn");e&&y(e)}else if("up"===t){const t=Array.from(document.querySelectorAll(".up-next-item")),o=t.indexOf(e);if(0===o){const e=document.querySelector(".volume-menu-container .icon-btn");e&&y(e)}else o>0&&y(t[o-1])}else if("down"===t){const t=Array.from(document.querySelectorAll(".up-next-item")),o=t.indexOf(e);o>=0&&o<t.length-1&&y(t[o+1])}return}const a=Array.from(r.querySelectorAll(".player-control-btn")).filter(e=>{const t=e.getBoundingClientRect();return t.width>0&&t.height>0});if("left"===t||"right"===t){if("skip-controls"===r.getAttribute("data-nav-zone")){if("right"===t){const e=document.querySelector(".subtitle-menu-container .icon-btn");e&&y(e)}else if("left"===t){const e=document.querySelector(".back-btn");e&&y(e)}return}if("player-controls"===r.getAttribute("data-nav-zone")){const o=[...a].sort((e,t)=>{const o=e.getBoundingClientRect(),r=t.getBoundingClientRect();return o.left-r.left});let r=e;if(!r.classList.contains("player-control-btn")){const t=e.closest(".player-control-btn");t&&(r=t)}const n=o.indexOf(r);return-1===n?void(o.length>0&&y(o[0])):void("right"===t?n<o.length-1&&(console.log("[handlePlayerControlsNavigation] Moving right from index",n,"to",n+1),y(o[n+1])):"left"===t&&n>0&&(console.log("[handlePlayerControlsNavigation] Moving left from index",n,"to",n-1),y(o[n-1])))}if(e.closest(".top-bar")){if(e===document.querySelector(".volume-menu-container .icon-btn")||e.closest(".volume-menu-container")){if("left"===t){const e=document.querySelector(".back-btn");e&&y(e)}return}}if(e.closest(".control-buttons-row")){const o=[document.querySelector(".subtitle-menu-container .icon-btn"),document.querySelector(".quality-menu-container .icon-btn"),document.querySelector(".control-buttons-row > .icon-btn")].filter(e=>e&&e.getBoundingClientRect().width>0);let r=e;if(!r.classList.contains("icon-btn")){const t=e.closest(".icon-btn");t&&(r=t)}const a=o.indexOf(r);if("right"===t)a>=0&&a<o.length-1&&y(o[a+1]);else if("left"===t)if(a>0)y(o[a-1]);else if(0===a){const e=document.querySelector('[data-nav-zone="skip-controls"] .player-control-btn');if(e){const t=e.getBoundingClientRect();if(t.width>0&&t.height>0)return void y(e)}}return}}else if("up"===t||"down"===t){if("skip-controls"===r.getAttribute("data-nav-zone")){if("up"===t){const e=document.querySelector(".back-btn");e&&y(e)}else if("down"===t){const e=document.querySelector('[data-nav-zone="player-controls"]');if(e){const t=e.querySelector(".control-btn-large");if(t)y(t);else{const t=e.querySelector(".player-control-btn");t&&y(t)}}}return}if(e.closest(".control-buttons-row")){if("up"===t){const e=document.querySelector(".up-next-item");e&&y(e)}return}if("player-controls"===r.getAttribute("data-nav-zone")){const e=document.querySelector('[data-nav-zone="skip-controls"] .player-control-btn');if(e&&"up"===t){const t=e.getBoundingClientRect();t.width>0&&t.height>0&&y(e)}}}},P=(e,t,o)=>{if("right"===t){const t=g();if(t&&(!e||e.closest(".sidebar")))return r.value=!0,void y(t)}if(!o.includes(e))return void(o.length>0&&y(o[0]));const a=v(e,o,t);a&&y(a)},E=e=>{console.log(U(e));if("Escape"===e.key||"Return"===e.key||"GoBack"===e.key||"Back"===e.key||R(e,A.BACK)||461===e.keyCode){e.preventDefault();const t=new CustomEvent("app-back-navigation");return void window.dispatchEvent(t)}const t="ArrowUp"===e.key||R(e,A.ARROW_UP),o="ArrowDown"===e.key||R(e,A.ARROW_DOWN),r="ArrowLeft"===e.key||R(e,A.ARROW_LEFT),a="ArrowRight"===e.key||R(e,A.ARROW_RIGHT);if(t)return e.preventDefault(),void f("up");if(o)return e.preventDefault(),void f("down");if(r)return e.preventDefault(),void f("left");if(a)return e.preventDefault(),void f("right");if("Enter"===e.key||R(e,A.ENTER)){const e=document.activeElement;return void(e&&("BUTTON"===e.tagName||e.classList.contains("player-control-btn")||e.hasAttribute("tabindex")&&e.onclick||e.hasAttribute("tabindex")&&e.click()))}},M=e=>{const t=e.detail,o=e.type.replace("exit","").replace("Slider","");"left"===t?h("left",o):"down"===t?h("down",o):"up"===t&&h("up",o)};return t(()=>{window.addEventListener("keydown",E),window.addEventListener("exitHeroSlider",M),window.addEventListener("exitBecauseYouWatchedSlider",M);const e=m();e.length>0&&y(e[0])}),o(()=>{window.removeEventListener("keydown",E),window.removeEventListener("exitHeroSlider",M),window.removeEventListener("exitBecauseYouWatchedSlider",M)}),{handleNavigation:f,isSliderMode:r}}const $=[{id:"purple-dream",name:"Purple Dream",colors:{solid:"#41295a",gradientStart:"#41295a",gradientMid:"#3a194b",gradientEnd:"#2F0743"}},{id:"ocean-blue",name:"Ocean Blue",colors:{solid:"#1e3a5f",gradientStart:"#1e3a5f",gradientMid:"#0f2847",gradientEnd:"#051628"}},{id:"forest-green",name:"Forest Green",colors:{solid:"#1a4d2e",gradientStart:"#1a4d2e",gradientMid:"#0f3820",gradientEnd:"#052314"}},{id:"midnight-black",name:"Midnight Black",colors:{solid:"#1a1a1a",gradientStart:"#2a2a2a",gradientMid:"#1a1a1a",gradientEnd:"#0a0a0a"}},{id:"ruby-red",name:"Ruby Red",colors:{solid:"#5a1a1a",gradientStart:"#5a1a1a",gradientMid:"#4a0f0f",gradientEnd:"#2d0505"}},{id:"sunset-orange",name:"Sunset Orange",colors:{solid:"#5a3a1a",gradientStart:"#5a3a1a",gradientMid:"#4a2a0f",gradientEnd:"#2d1805"}}],F="embyflix_theme",L={mode:"gradient",selectedPresetId:"purple-dream"},x=e({...L});function O(){const e=e=>{try{localStorage.setItem(F,JSON.stringify(e)),x.value={...e}}catch(t){console.error("Failed to save theme:",t)}},t=e=>{const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}},o=e=>{const o=$.find(t=>t.id===e.selectedPresetId);if(!o)return void console.warn(`[Theme] Preset not found: ${e.selectedPresetId}`);const r=document.body,a=document.documentElement;if(r&&a)if(console.log(`[Theme] Applying theme: ${o.name} (${e.mode} mode)`),"solid"===e.mode){const n=e.customSolidColor||o.colors.solid;r.style.background=n,r.style.backgroundColor=n;const i=t(n);a.style.setProperty("--background-color",n),a.style.setProperty("--background-color-start",n),a.style.setProperty("--background-color-mid",n),a.style.setProperty("--background-color-end",n),a.style.setProperty("--background-darker-20",`rgba(${i.r}, ${i.g}, ${i.b}, 0.2)`),a.style.setProperty("--background-darker-80",`rgba(${i.r}, ${i.g}, ${i.b}, 0.8)`),a.style.setProperty("--background-darker-95",`rgba(${i.r}, ${i.g}, ${i.b}, 0.95)`),console.log(`[Theme] CSS vars set - color: ${n}, darker-80: rgba(${i.r}, ${i.g}, ${i.b}, 0.8)`)}else{const e=`linear-gradient(-45deg, ${o.colors.gradientStart} 0%, ${o.colors.gradientMid} 50%, ${o.colors.gradientEnd} 100%)`;r.style.background=e,r.style.backgroundColor=o.colors.gradientStart;const n=t(o.colors.gradientStart);console.log(`[Theme] Gradient Start Hex: ${o.colors.gradientStart}`),console.log(`[Theme] Converted RGB: r=${n.r}, g=${n.g}, b=${n.b}`),a.style.setProperty("--background-color",o.colors.gradientStart),a.style.setProperty("--background-color-start",o.colors.gradientStart),a.style.setProperty("--background-color-mid",o.colors.gradientMid),a.style.setProperty("--background-color-end",o.colors.gradientEnd),a.style.setProperty("--background-darker-20",`rgba(${n.r}, ${n.g}, ${n.b}, 0.2)`),a.style.setProperty("--background-darker-80",`rgba(${n.r}, ${n.g}, ${n.b}, 0.8)`),a.style.setProperty("--background-darker-95",`rgba(${n.r}, ${n.g}, ${n.b}, 0.95)`),console.log(`[Theme] Set --background-color: ${o.colors.gradientStart}`),console.log(`[Theme] Set --background-darker-80: rgba(${n.r}, ${n.g}, ${n.b}, 0.8)`)}else console.warn("[Theme] DOM not ready, cannot apply theme")};return{currentTheme:x,setThemeMode:t=>{const r={...x.value,mode:t};e(r),o(r)},setThemePreset:t=>{const r={...x.value,selectedPresetId:t};e(r),o(r)},setCustomSolidColor:t=>{const r={...x.value,customSolidColor:t};e(r),o(r)},initializeTheme:()=>{const e=(()=>{try{const e=localStorage.getItem(F);if(e)return{...L,...JSON.parse(e)}}catch(e){console.error("Failed to load theme:",e)}return{...L}})();if(x.value=e,o(e),document.documentElement){const e=getComputedStyle(document.documentElement);console.log("[Theme] Current CSS variables:"),console.log("  --background-color:",e.getPropertyValue("--background-color")),console.log("  --background-darker-80:",e.getPropertyValue("--background-darker-80"))}},applyTheme:o}}const B="viewingHistory",j="browseHistory",W="searchHistory",q="userProfile",z="notInterested";const G=new class{db=null;initPromise=null;async init(){return this.db?this.db:(this.initPromise||(this.initPromise=new Promise((e,t)=>{const o=indexedDB.open("EmbyFlixPersonalization",1);o.onerror=()=>{console.error("IndexedDB error:",o.error),t(o.error)},o.onsuccess=()=>{this.db=o.result,e(this.db)},o.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(B)){const e=t.createObjectStore(B,{keyPath:"id",autoIncrement:!0});e.createIndex("itemId","itemId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("itemType","itemType",{unique:!1})}if(!t.objectStoreNames.contains(j)){const e=t.createObjectStore(j,{keyPath:"id",autoIncrement:!0});e.createIndex("itemId","itemId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}if(!t.objectStoreNames.contains(W)){const e=t.createObjectStore(W,{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("query","query",{unique:!1})}if(t.objectStoreNames.contains(q)||t.createObjectStore(q,{keyPath:"id"}),!t.objectStoreNames.contains(z)){t.createObjectStore(z,{keyPath:"itemId"}).createIndex("timestamp","timestamp",{unique:!1})}}})),this.initPromise)}async add(e,t){const o=await this.init();return new Promise((r,a)=>{const n=o.transaction([e],"readwrite").objectStore(e).add(t);n.onsuccess=()=>r(n.result),n.onerror=()=>a(n.error)})}async put(e,t){const o=await this.init();return new Promise((r,a)=>{const n=o.transaction([e],"readwrite").objectStore(e).put(t);n.onsuccess=()=>r(),n.onerror=()=>a(n.error)})}async get(e,t){const o=await this.init();return new Promise((r,a)=>{const n=o.transaction([e],"readonly").objectStore(e).get(t);n.onsuccess=()=>r(n.result),n.onerror=()=>a(n.error)})}async getAll(e){const t=await this.init();return new Promise((o,r)=>{const a=t.transaction([e],"readonly").objectStore(e).getAll();a.onsuccess=()=>o(a.result),a.onerror=()=>r(a.error)})}async getAllByIndex(e,t,o){const r=await this.init();return new Promise((a,n)=>{const i=r.transaction([e],"readonly").objectStore(e).index(t),s=o?i.getAll(o):i.getAll();s.onsuccess=()=>a(s.result),s.onerror=()=>n(s.error)})}async delete(e,t){const o=await this.init();return new Promise((r,a)=>{const n=o.transaction([e],"readwrite").objectStore(e).delete(t);n.onsuccess=()=>r(),n.onerror=()=>a(n.error)})}async clear(e){const t=await this.init();return new Promise((o,r)=>{const a=t.transaction([e],"readwrite").objectStore(e).clear();a.onsuccess=()=>o(),a.onerror=()=>r(a.error)})}async count(e){const t=await this.init();return new Promise((o,r)=>{const a=t.transaction([e],"readonly").objectStore(e).count();a.onsuccess=()=>o(a.result),a.onerror=()=>r(a.error)})}async getRecent(e,t){const o=await this.init(),r=new Date;return r.setDate(r.getDate()-t),new Promise((t,a)=>{const n=o.transaction([e],"readonly").objectStore(e).index("timestamp"),i=IDBKeyRange.lowerBound(r),s=n.getAll(i);s.onsuccess=()=>t(s.result),s.onerror=()=>a(s.error)})}};async function H(e){return G.getRecent(B,e)}async function Y(e){return G.getRecent(j,e)}async function V(e){return G.getRecent(W,e)}async function J(){return(await G.getAll(z)).map(e=>e.itemId)}const Q=e(!1),K=e([]),Z=e([]),X=e([]);function ee(){return{isInitialized:Q,viewingHistory:K,browseHistory:Z,searchHistory:X,init:async function(){if(!Q.value)try{const[e,t,o]=await Promise.all([H(180),Y(180),V(180)]);K.value=e,Z.value=t,X.value=o,Q.value=!0,console.log("[ViewingHistory] Loaded:",{viewingEvents:e.length,browseEvents:t.length,searchEvents:o.length})}catch(e){console.error("[ViewingHistory] Failed to initialize:",e)}},trackViewing:async function(e){try{const t={...e,timestamp:new Date},o=await async function(e){const t={itemId:e.itemId,itemName:e.itemName,itemType:e.itemType,genres:[...e.genres],studios:[...e.studios],timestamp:new Date(e.timestamp),watchDuration:e.watchDuration,completionPercent:e.completionPercent,communityRating:e.communityRating,criticRating:e.criticRating,productionYear:e.productionYear};return G.add(B,t)}(t);return K.value.push({...t,id:o}),console.log("[ViewingHistory] Tracked viewing:",{item:e.itemName,completion:e.completionPercent,duration:e.watchDuration}),o}catch(t){return console.error("[ViewingHistory] Failed to track viewing:",t),null}},trackBrowse:async function(e){try{const t={...e,timestamp:new Date},o=await async function(e){const t={itemId:e.itemId,itemName:e.itemName,itemType:e.itemType,genres:[...e.genres],studios:[...e.studios],timestamp:new Date(e.timestamp),timeSpent:e.timeSpent};return G.add(j,t)}(t);return Z.value.push({...t,id:o}),console.log("[ViewingHistory] Tracked browse:",{item:e.itemName,timeSpent:e.timeSpent}),o}catch(t){return console.error("[ViewingHistory] Failed to track browse:",t),null}},trackSearch:async function(e){try{const t={...e,timestamp:new Date},o=await async function(e){const t={query:e.query,timestamp:new Date(e.timestamp),filters:e.filters?{genres:e.filters.genres?[...e.filters.genres]:void 0,studios:e.filters.studios?[...e.filters.studios]:void 0,itemTypes:e.filters.itemTypes?[...e.filters.itemTypes]:void 0}:void 0,clickedItemId:e.clickedItemId};return G.add(W,t)}(t);return X.value.push({...t,id:o}),console.log("[ViewingHistory] Tracked search:",{query:e.query,hasFilters:!!e.filters,clicked:!!e.clickedItemId}),o}catch(t){return console.error("[ViewingHistory] Failed to track search:",t),null}},getViewingStats:function(){const e=K.value.reduce((e,t)=>e+t.watchDuration,0),t=K.value.filter(e=>e.completionPercent>=90).length,o=K.value.length>0?K.value.reduce((e,t)=>e+t.completionPercent,0)/K.value.length:0,r=new Map;K.value.forEach(e=>{e.genres.forEach(e=>{r.set(e,(r.get(e)||0)+1)})});const a=Array.from(r.entries()).sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e,t])=>({genre:e,count:t}));return{totalItems:K.value.length,totalWatchTime:e,completedItems:t,avgCompletionRate:o,topGenres:a}},hasEnoughData:function(e=1){return K.value.length>=e},getMostWatchedGenres:function(e=10){const t=new Map;return K.value.forEach(e=>{e.genres.forEach(e=>{t.set(e,(t.get(e)||0)+1)})}),Array.from(t.entries()).sort((e,t)=>t[1]-e[1]).slice(0,e)},getMostWatchedStudios:function(e=10){const t=new Map;return K.value.forEach(e=>{e.studios.forEach(e=>{t.set(e,(t.get(e)||0)+1)})}),Array.from(t.entries()).sort((e,t)=>t[1]-e[1]).slice(0,e)}}}function te(t){const r=ee(),a=e(0),n=e(null),i=e=>{n.value=e,a.value=Date.now()},s=(e,o)=>{if(t?.value)return;const n=o??(a.value>0?Math.floor((Date.now()-a.value)/1e3):0);n>=2&&r.trackBrowse({itemId:e.Id,itemName:e.Name,itemType:e.Type,genres:e.Genres||[],studios:(e.Studios||[]).map(e=>e.Name),timeSpent:n})},l=(e,o,a)=>{if(t?.value)return;const n=a>0?o/a*100:0;r.trackViewing({itemId:e.Id,itemName:e.Name,itemType:e.Type,genres:e.Genres||[],studios:(e.Studios||[]).map(e=>e.Name),watchDuration:o,completionPercent:Math.min(n,100),communityRating:e.CommunityRating,criticRating:e.CriticRating,productionYear:e.ProductionYear})};return{startBrowseTracking:i,trackBrowseEvent:s,trackCurrentBrowseEvent:()=>{n.value&&a.value>0&&s(n.value)},trackSearchEvent:(e,o,a)=>{t?.value||r.trackSearch({query:e,filters:o||{},clickedItemId:a})},trackPlaybackEvent:l,trackPlaybackFromTicks:async(e,o,r)=>{if(!t?.value)try{const t=await r(e),a=Math.floor(o/1e7),n=t.RunTimeTicks?Math.floor(t.RunTimeTicks/1e7):0;l(t,a,n)}catch(a){console.error("[Analytics] Failed to track playback event:",a)}},autoTrackBrowsing:e=>{i(e.value);const t=()=>{e.value&&a.value>0&&s(e.value)};return o(t),t},reset:()=>{a.value=0,n.value=null},pageLoadTime:a,currentItem:n}}const oe=Object.freeze(Object.defineProperty({__proto__:null,useAnalytics:te},Symbol.toStringTag,{value:"Module"}));function re(t,o,r){const a=e(new Map),n=(e,a="Primary",n=i.MEDIA_CARD_DEFAULT)=>{if(r.value){const t=o.getItemDetails(e);return t?.ImageUrl||""}return t.getImageUrl(e,a,n)},s=e=>a.value.get(e)||"",l=(e,t)=>{a.value.set(e,t)},c=e=>{if(!e)return;(new Image).src=e};return{getImageUrl:n,getHeroImageUrl:async(e,a)=>{if(r.value){const t=o.getItemDetails(e);return t?.HeroImageUrl||t?.ImageUrl||""}if(a){const t=a.find(t=>t.Id===e);if(t?.HeroImageUrl)return t.HeroImageUrl}return await t.getHeroImageUrl(e)},loadImageUrl:async(e,t,o)=>{if(t){const o=t(e);return o instanceof Promise?await o:o}const r=o?.find(t=>t.Id===e);return r?.ImageUrl||""},getCachedImageUrl:s,cacheImageUrl:l,preloadImage:c,preloadImages:e=>{e.forEach(e=>c(e))},clearCache:()=>{a.value.clear()},resolveAndCacheImageUrl:(e,t="Primary",o=i.MEDIA_CARD_DEFAULT)=>{const r=s(e);if(r)return r;const a=n(e,t,o);return l(e,a),a},imageUrlCache:a}}function ae(){return{formatRuntime:e=>{if(!e)return"";const t=Math.floor(e/6e8),o=Math.floor(t/60),r=t%60;return o>0?`${o}h ${r}m`:`${r}m`},formatRating:e=>{if(!e)return"";return`${"".repeat(Math.round(e/2))} ${e.toFixed(1)}`},formatDate:(e,t)=>{if(!e)return"";try{const o=new Date(e),r={year:"numeric",month:"short",day:"numeric"};return o.toLocaleDateString(void 0,t||r)}catch(o){return console.error("[useFormatters] Error formatting date:",o),e}},formatFileSize:(e,t=2)=>{if(!e||0===e)return"0 Bytes";const o=t<0?0:t,r=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,r)).toFixed(o))} ${["Bytes","KB","MB","GB","TB","PB"][r]}`},formatDuration:e=>{if(!e||e<0)return"00:00";const t=Math.floor(e/3600),o=Math.floor(e%3600/60),r=Math.floor(e%60),a=e=>e.toString().padStart(2,"0");return t>0?`${a(t)}:${a(o)}:${a(r)}`:`${a(o)}:${a(r)}`},formatYearRange:(e,t)=>{if(!e)return"";const o=new Date(e).getFullYear();if(!t)return`${o}-Present`;const r=new Date(t).getFullYear();return o===r?`${o}`:`${o}-${r}`},truncateText:(e,t=100)=>e?e.length<=t?e:`${e.substring(0,t).trim()}...`:"",formatTypeName:e=>({Movie:"Movies",Series:"TV Shows",Episode:"Episodes",Season:"Seasons",MusicAlbum:"Albums",Audio:"Music",Person:"People",BoxSet:"Collections"}[e]||e),getTypeIcon:e=>({Movie:"fas fa-film",Series:"fas fa-tv",Episode:"fas fa-video",Season:"fas fa-layer-group",MusicAlbum:"fas fa-compact-disc",Audio:"fas fa-music",Person:"fas fa-user",BoxSet:"fas fa-box"}[e]||"fas fa-file")}}function ne(r,a={}){const n=e(!1),{threshold:i=.1,rootMargin:s="0px",onEnter:l,onExit:c}=a;let u=null;return t(()=>{r.value&&(u=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?(n.value=!0,l?.()):(n.value=!1,c?.())})},{threshold:i,rootMargin:s}),u.observe(r.value))}),o(()=>{u&&u.disconnect()}),{isVisible:n}}const ie=e([]);function se(){const e=r(),t=(e,t,o,r)=>{ie.value.push({route:e,query:t,params:o,state:r}),console.log("[NavigationHistory] Pushed to stack:",{route:e,query:t,stackSize:ie.value.length})};return{pushToHistory:t,goBack:()=>{if(0===ie.value.length)return console.log("[NavigationHistory] Stack empty, cannot go back"),!1;ie.value.pop();const t=ie.value[ie.value.length-1];return t?(console.log("[NavigationHistory] Going back to:",t),e.push({name:t.route,query:t.query,params:t.params}),!0):(console.log("[NavigationHistory] No previous location, going to home"),e.push({name:"Home"}),!0)},peekHistory:()=>ie.value[ie.value.length-1],clearHistory:()=>{ie.value=[],console.log("[NavigationHistory] History cleared")},getStackSize:()=>ie.value.length,replaceCurrentEntry:(e,o,r,a)=>{ie.value.length>0?(ie.value[ie.value.length-1]={route:e,query:o,params:r,state:a},console.log("[NavigationHistory] Replaced current entry:",{route:e,query:o})):t(e,o,r,a)},navigationStack:ie}}const le="tmdb_api_key",ce="tmdb_v4_access_token";let ue="0aed65eb34fa5c354e10385b63ab9e94",de="eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwYWVkNjVlYjM0ZmE1YzM1NGUxMDM4NWI2M2FiOWU5NCIsIm5iZiI6MTc2MjI4MTY3MS40NDgsInN1YiI6IjY5MGE0OGM3YmJiOTA1OTU3ODFhMDg5ZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.JPZun-_M7uQTLQ0waF831FvEillgSTZ3ZkCh7HAlhDE";const me="https://image.tmdb.org/t/p",ge=new Map,ye=e=>{const t=ge.get(e);return t&&(e=>!!e&&Date.now()-e.timestamp<6e5)(t)?(console.log("[TMDB] Cache hit:",e),t.data):(t&&(console.log("[TMDB] Cache expired:",e),ge.delete(e)),null)},ve=(e,t)=>{ge.set(e,{data:t,timestamp:Date.now()}),console.log("[TMDB] Cached:",e)};function he(){const t=e(!1),o=e(null),r=()=>!!ue,a=async(e,t={},o=3)=>{if(!r())throw new Error("TMDB API key not configured");const n=new URL(`${4===o?"https://api.themoviedb.org/4":"https://api.themoviedb.org/3"}${e}`),i={};if(4===o){if(!de)return console.warn("[TMDB] V4 access token not configured, falling back to v3"),a(e,t,3);i.Authorization=`Bearer ${de}`,i["Content-Type"]="application/json;charset=utf-8"}else n.searchParams.append("api_key",ue);Object.entries(t).forEach(([e,t])=>{n.searchParams.append(e,t)}),console.log(`[TMDB v${o}] Fetching:`,e,t);const s=await fetch(n.toString(),{mode:"cors",credentials:"omit",headers:i});if(!s.ok){const e=await s.text();throw console.error(`[TMDB v${o}] API error:`,s.status,e),new Error(`TMDB API error: ${s.status}`)}return await s.json()},n=async()=>{const e="movie-genres",r=ye(e);if(r)return r;t.value=!0,o.value=null;try{const t=await a("/genre/movie/list");return ve(e,t.genres),t.genres}catch(n){throw o.value=n instanceof Error?n.message:"Unknown error",console.error("[TMDB] getMovieGenres error:",n),n}finally{t.value=!1}},i=async()=>{const e="tv-genres",r=ye(e);if(r)return r;t.value=!0,o.value=null;try{const t=await a("/genre/tv/list");return ve(e,t.genres),t.genres}catch(n){throw o.value=n instanceof Error?n.message:"Unknown error",console.error("[TMDB] getTvGenres error:",n),n}finally{t.value=!1}},s=async(e,t="US")=>{const o=`movie-watch-providers-${e}-${t}`,r=ye(o);if(null!==r)return r;try{const r=(await a(`/movie/${e}/watch/providers`)).results[t]||null;return ve(o,r),r}catch(n){return console.error("[TMDB] getMovieWatchProviders error:",n),ve(o,null),null}},l=async(e,t="US")=>{const o=`tv-watch-providers-${e}-${t}`,r=ye(o);if(null!==r)return r;try{const r=(await a(`/tv/${e}/watch/providers`)).results[t]||null;return ve(o,r),r}catch(n){return console.error("[TMDB] getTvWatchProviders error:",n),ve(o,null),null}};return{isLoading:t,error:o,isConfigured:r(),setApiKey:e=>{ue=e,localStorage.setItem(le,e)},clearApiKey:()=>{ue="",localStorage.removeItem(le)},setV4AccessToken:e=>{de=e,localStorage.setItem(ce,e)},clearV4AccessToken:()=>{de="",localStorage.removeItem(ce)},makeRequest:a,getTrendingMovies:async(e="day",r=1)=>{const n=`trending-movies-${e}-${r}`,i=ye(n);if(i)return i;t.value=!0,o.value=null;try{const t=await a(`/trending/movie/${e}`,{page:r.toString()});return t.results=t.results.map(e=>({...e,media_type:"movie"})),ve(n,t),t}catch(s){throw o.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingMovies error:",s),s}finally{t.value=!1}},getTrendingTvShows:async(e="day",r=1)=>{const n=`trending-tv-${e}-${r}`,i=ye(n);if(i)return i;t.value=!0,o.value=null;try{const t=await a(`/trending/tv/${e}`,{page:r.toString()});return t.results=t.results.map(e=>({...e,media_type:"tv"})),ve(n,t),t}catch(s){throw o.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingTvShows error:",s),s}finally{t.value=!1}},getTrendingAll:async(e="day",r=1)=>{const n=`trending-all-${e}-${r}`,i=ye(n);if(i)return i;t.value=!0,o.value=null;try{const t=await a(`/trending/all/${e}`,{page:r.toString()});return ve(n,t),t}catch(s){throw o.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingAll error:",s),s}finally{t.value=!1}},getPopularMovies:async(e=1)=>{const r=`popular-movies-${e}`,n=ye(r);if(n)return n;t.value=!0,o.value=null;try{const t=await a("/movie/popular",{page:e.toString()});return t.results=t.results.map(e=>({...e,media_type:"movie"})),ve(r,t),t}catch(i){throw o.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] getPopularMovies error:",i),i}finally{t.value=!1}},getPopularTvShows:async(e=1)=>{const r=`popular-tv-${e}`,n=ye(r);if(n)return n;t.value=!0,o.value=null;try{const t=await a("/tv/popular",{page:e.toString()});return t.results=t.results.map(e=>({...e,media_type:"tv"})),ve(r,t),t}catch(i){throw o.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] getPopularTvShows error:",i),i}finally{t.value=!1}},getMovieGenres:n,getTvGenres:i,getAllGenres:async()=>{const e="all-genres",r=ye(e);if(r)return r;t.value=!0,o.value=null;try{const[t,o]=await Promise.all([n(),i()]),r={movie:t,tv:o};return ve(e,r),r}catch(a){throw o.value=a instanceof Error?a.message:"Unknown error",console.error("[TMDB] getAllGenres error:",a),a}finally{t.value=!1}},getMovieDetails:async(e,r=["videos","images","credits","recommendations"])=>{const n=r.join(","),i=`movie-details-${e}-${n}`,s=ye(i);if(s)return s;t.value=!0,o.value=null;try{const t=await a(`/movie/${e}`,{append_to_response:n});return ve(i,t),t}catch(l){throw o.value=l instanceof Error?l.message:"Unknown error",console.error("[TMDB] getMovieDetails error:",l),l}finally{t.value=!1}},getTvDetails:async(e,r=["videos","images","credits","recommendations"])=>{const n=r.join(","),i=`tv-details-${e}-${n}`,s=ye(i);if(s)return s;t.value=!0,o.value=null;try{const t=await a(`/tv/${e}`,{append_to_response:n});return ve(i,t),t}catch(l){throw o.value=l instanceof Error?l.message:"Unknown error",console.error("[TMDB] getTvDetails error:",l),l}finally{t.value=!1}},getMovieWatchProviders:s,getTvWatchProviders:l,getWatchProvidersBatch:async(e,t="US",o=10)=>{const r=new Map,a=async e=>{try{const o="movie"===e.mediaType?await s(e.id,t):await l(e.id,t);r.set(e.id,o)}catch(o){console.error(`[TMDB] Error fetching watch providers for ${e.mediaType} ${e.id}:`,o),r.set(e.id,null)}},n=[];for(let i=0;i<e.length;i+=o){const t=e.slice(i,i+o);n.push(...t.map(a)),i+o<e.length&&(await Promise.all(n),n.length=0)}return await Promise.all(n),console.log(`[TMDB] Batch fetched watch providers for ${e.length} items (${r.size} successful)`),r},discoverMovies:async(e={})=>{const r=`discover-movies-${JSON.stringify(e)}`,n=ye(r);if(n)return n;t.value=!0,o.value=null;try{const t={};Object.entries(e).forEach(([e,o])=>{void 0!==o&&(t[e]=String(o))});const o=await a("/discover/movie",t);return o.results=o.results.map(e=>({...e,media_type:"movie"})),ve(r,o),o}catch(i){throw o.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] discoverMovies error:",i),i}finally{t.value=!1}},discoverTvShows:async(e={})=>{const r=`discover-tv-${JSON.stringify(e)}`,n=ye(r);if(n)return n;t.value=!0,o.value=null;try{const t={};Object.entries(e).forEach(([e,o])=>{void 0!==o&&(t[e]=String(o))});const o=await a("/discover/tv",t);return o.results=o.results.map(e=>({...e,media_type:"tv"})),ve(r,o),o}catch(i){throw o.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] discoverTvShows error:",i),i}finally{t.value=!1}},getPosterUrl:(e,t="w500")=>e?`${me}/${t}${e}`:null,getBackdropUrl:(e,t="w1280")=>e?`${me}/${t}${e}`:null,getProviderLogoUrl:(e,t="w92")=>e?`${me}/${t}${e}`:null,clearCache:()=>{ge.clear(),console.log("[TMDB] Cache cleared")}}}const fe=e(null),pe=e(!1);function we(){const e=ee();async function t(){if(pe.value)return fe.value;try{const e=await async function(){return G.get(q,"current")}();return e?(fe.value={...e,genreWeights:new Map(Object.entries(e.genreWeights)),studioWeights:new Map(Object.entries(e.studioWeights))},pe.value=!0,console.log("[Preferences] Loaded profile:",{genres:fe.value.genreWeights.size,studios:fe.value.studioWeights.size,totalItems:fe.value.totalItems})):console.log("[Preferences] No existing profile found"),fe.value}catch(e){return console.error("[Preferences] Failed to load profile:",e),null}}async function o(){e.isInitialized.value||await e.init();const t=e.viewingHistory.value;if(0===t.length)return console.log("[Preferences] No viewing history to build profile from"),null;console.log("[Preferences] Building profile from",t.length,"viewing events");const o=new Date,r=new Map,a=new Map;let n=0,i=0,s=0,l=0,c=0,u=0,d=0;t.forEach(e=>{const t=(o.getTime()-new Date(e.timestamp).getTime())/864e5,m=Math.pow(.5,t/30)*(e.completionPercent/100);n+=e.watchDuration,e.genres.forEach(t=>{const o=r.get(t)||{genre:t,weight:0,totalWatches:0,avgCompletionRate:0};o.weight+=m,o.totalWatches+=1,o.avgCompletionRate=(o.avgCompletionRate*(o.totalWatches-1)+e.completionPercent)/o.totalWatches,r.set(t,o)}),e.studios.forEach(e=>{const t=a.get(e)||{studio:e,weight:0,totalWatches:0};t.weight+=m,t.totalWatches+=1,a.set(e,t)}),e.communityRating&&(i+=e.communityRating,l++),e.criticRating&&(s+=e.criticRating,c++),e.watchDuration&&(u+=e.watchDuration,d++)});const m=Math.max(...Array.from(r.values()).map(e=>e.weight));r.forEach((e,t)=>{e.weight=e.weight/m,r.set(t,e)});const g=Math.max(...Array.from(a.values()).map(e=>e.weight));a.forEach((e,t)=>{e.weight=e.weight/g,a.set(t,e)});const y=l>0?i/l:0,v=c>0?s/c:0,h=d>0?u/d:0,f=t.map(e=>e.watchDuration).filter(e=>e>0),p=f.length>0?Math.min(...f):0,w=f.length>0?Math.max(...f):0;fe.value={id:"current",genreWeights:r,studioWeights:a,lastUpdated:o,totalWatchTime:n,totalItems:t.length,avgCommunityRating:y,avgCriticRating:v,preferredRuntime:{min:p,max:w,avg:h}};const b={id:"current",genreWeights:Object.fromEntries(Array.from(r.entries())),studioWeights:Object.fromEntries(Array.from(a.entries())),lastUpdated:o,totalWatchTime:n,totalItems:t.length,avgCommunityRating:y,avgCriticRating:v,preferredRuntime:{min:p,max:w,avg:h}};return await async function(e){return G.put(q,e)}(b),pe.value=!0,console.log("[Preferences] Profile built:",{genres:r.size,studios:a.size,totalItems:t.length,avgCommunityRating:y.toFixed(1),avgCriticRating:v.toFixed(1)}),fe.value}function r(){if(!fe.value)return!1;return((new Date).getTime()-new Date(fe.value.lastUpdated).getTime())/36e5<24}return{profile:fe,isLoaded:pe,loadProfile:t,buildProfile:o,updateProfile:async function(){return await t(),r()?console.log("[Preferences] Profile is fresh, skipping rebuild"):(console.log("[Preferences] Profile is stale, rebuilding..."),await o()),fe.value},getTopGenres:function(e=10){return fe.value?Array.from(fe.value.genreWeights.values()).sort((e,t)=>t.weight-e.weight).slice(0,e):[]},getTopStudios:function(e=10){return fe.value?Array.from(fe.value.studioWeights.values()).sort((e,t)=>t.weight-e.weight).slice(0,e):[]},getGenreWeight:function(e){return fe.value&&fe.value.genreWeights.get(e)?.weight||0},getStudioWeight:function(e){return fe.value&&fe.value.studioWeights.get(e)?.weight||0},isProfileFresh:r,getLeastWatchedGenres:function(e,t=5){if(!fe.value||0===e.length)return e.slice(0,t);const o=new Set(fe.value.genreWeights.keys()),r=e.filter(e=>!o.has(e));if(r.length>=t)return r.slice(0,t);const a=Array.from(fe.value.genreWeights.values()).sort((e,t)=>e.weight-t.weight).slice(0,t-r.length).map(e=>e.genre);return[...r,...a]}}}const be=.4,Ie=.2,Se=.2,Te=.1,ke=.1;function Pe(e,t){const o=function(e,t){if(!e||0===e.length)return 0;let o=0,r=0;return e.forEach(e=>{const a=t.genreWeights.get(e);a&&(r+=a.weight),o+=1}),o>0?r/o:0}(e.Genres,t),r=function(e,t){if(!e||0===e.length)return 0;let o=0,r=0;return e.forEach(e=>{const a=t.studioWeights.get(e.Name);a&&(r+=a.weight),o+=1}),o>0?r/o:0}(e.Studios,t),a=function(e,t){if(!e)return 0;const o=e/100;if(t.avgCriticRating>0){const e=t.avgCriticRating/100;return 1-Math.abs(o-e)}return o}(e.CriticRating,t),n=function(e,t){if(!e)return 0;const o=e/10;if(t.avgCommunityRating>0){const e=t.avgCommunityRating/10;return 1-Math.abs(o-e)}return o}(e.CommunityRating,t),i=function(e){if(!e)return 0;const t=(new Date).getFullYear()-e;return Math.max(0,1-.05*t)}(e.ProductionYear),s=void 0!==e.CriticRating&&e.CriticRating>0,l=void 0!==e.CommunityRating&&e.CommunityRating>0;let c=0;return c+=o*be,c+=r*Ie,c+=i*Te,s?c+=a*Se:(c+=o*(.6*Se),c+=r*(.4*Se)),l?c+=n*ke:(c+=o*(.6*ke),c+=r*(.4*ke)),{itemId:e.Id,score:c,breakdown:{genreMatch:o,studioMatch:r,criticRating:a,recencyBoost:i,communityRating:n},isDiscovery:!1}}function Ee(e,t){let o=0;const r=new Set(e.Genres||[]),a=new Set(t.Genres||[]),n=new Set([...r].filter(e=>a.has(e))),i=new Set([...r,...a]);if(i.size>0){o+=.7*(n.size/i.size)}const s=new Set((e.Studios||[]).map(e=>e.Name)),l=new Set((t.Studios||[]).map(e=>e.Name)),c=new Set([...s].filter(e=>l.has(e))),u=new Set([...s,...l]);if(u.size>0){o+=.3*(c.size/u.size)}return o}function Me(e){return[...e].sort((e,t)=>t.score-e.score)}const Ce=e(!1);function De(){const e=ee(),t=we(),o=a(()=>e.isInitialized.value&&t.isLoaded.value&&e.hasEnoughData(1));async function r(){if(!Ce.value){if(console.log("[Personalization] Initializing..."),await e.init(),!e.hasEnoughData(1))return console.log("[Personalization] Not enough viewing history (minimum 5 items required)"),void(Ce.value=!0);await t.loadProfile(),t.profile.value?t.isProfileFresh()||(console.log("[Personalization] Updating stale profile..."),await t.buildProfile()):(console.log("[Personalization] Building initial profile..."),await t.buildProfile()),Ce.value=!0,console.log("[Personalization] Ready")}}return{isInitialized:Ce,isReady:o,init:r,getRecommendations:async function(e,a={}){const{limit:n=20,excludeWatched:i=!0,minScore:s=.2,discoveryPercent:l=10}=a;if(Ce.value||await r(),!o.value)return console.log("[Personalization] Not ready, returning empty recommendations"),[];const c=t.profile.value;if(!c)return console.log("[Personalization] No profile available"),[];const u=await J(),d=new Set(u);let m=e.filter(e=>!d.has(e.Id)&&(!i||!e.UserData?.Played));if(console.log("[Personalization] User profile genres:",Object.keys(c.genreWeights||{}).slice(0,10)),console.log("[Personalization] User profile studios:",Object.keys(c.studioWeights||{}).slice(0,10)),m.length>0){const e=m[0];console.log("[Personalization] Sample candidate genres:",e.Genres),console.log("[Personalization] Sample candidate studios:",e.Studios?.map(e=>e.Name))}const g=m.map(e=>Pe(e,c));if(console.log("[Personalization] Scored",g.length,"items"),g.length>0){const e=g.map(e=>e.score).sort((e,t)=>t-e);console.log("[Personalization] Score range:",{max:e[0]?.toFixed(3),median:e[Math.floor(e.length/2)]?.toFixed(3),min:e[e.length-1]?.toFixed(3),minThreshold:s})}const y=function(e,t){return e.filter(e=>e.score>=t)}(g,s);console.log("[Personalization] After minScore filter:",y.length,"/",g.length);const v=Me(y),h=Math.floor(n*l/100),f=n-h,p=v.slice(0,f),w=function(e,o,r,a){const n=new Set;e.forEach(e=>{e.Genres?.forEach(e=>n.add(e))});const i=t.getLeastWatchedGenres(Array.from(n),Math.ceil(r/2)),s=e.filter(e=>!a.has(e.Id)&&e.Genres?.some(e=>i.includes(e))),l=s.map(e=>{const t=Pe(e,o);return t.isDiscovery=!0,t}).filter(e=>e.score>=.1);return Me(l).slice(0,r)}(m,c,h,new Set(p.map(e=>e.itemId))),b=function(e){const t=[...e];for(let o=t.length-1;o>0;o--){const e=Math.floor(Math.random()*(o+1));[t[o],t[e]]=[t[e],t[o]]}return t}([...p,...w]),I=new Map(m.map(e=>[e.Id,e])),S=b.map(e=>I.get(e.itemId)).filter(e=>void 0!==e);return console.log("[Personalization] Generated",S.length,"recommendations",{regular:p.length,discovery:w.length}),S},getSimilarItems:async function(e,t,o={}){const{limit:r=15,excludeWatched:a=!0}=o,n=await J(),i=new Set(n),s=t.filter(t=>t.Id!==e.Id&&(!i.has(t.Id)&&(!a||!t.UserData?.Played))).map(t=>({item:t,similarity:Ee(e,t)})).sort((e,t)=>t.similarity-e.similarity).slice(0,r).map(e=>e.item);return console.log("[Personalization] Found",s.length,"similar items for",e.Name),s},rankSearchResults:async function(e){if(!o.value)return e;const r=t.profile.value;return r?e.map(e=>({item:e,score:Pe(e,r).score})).sort((e,t)=>t.score-e.score).map(e=>e.item):e},updateAfterViewing:async function(){await t.buildProfile()}}}const Ne="embyflix-tmdb-match-cache",Ae=864e5;function Re(){const e=e=>{try{const t=Array.from(e.entries());localStorage.setItem(Ne,JSON.stringify(t)),console.log(`[useMediaMatching] Saved ${e.size} TMDB matches to cache`)}catch(t){console.error("[useMediaMatching] Failed to save TMDB match cache:",t)}},t=(()=>{try{const e=localStorage.getItem(Ne);if(!e)return new Map;const t=JSON.parse(e),o=Date.now(),r=t.filter(([e,t])=>o-t.timestamp<Ae);return console.log(`[useMediaMatching] Loaded ${r.length} cached TMDB matches from localStorage`),new Map(r)}catch(e){return console.error("[useMediaMatching] Failed to load TMDB match cache:",e),new Map}})(),o=e=>e.toLowerCase().replace(/^(the|a|an)\s+/i,"").replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim();return{matchTmdbWithEmby:async(r,a,n=!1)=>{if(n)return null;const i=r.id;if(t.has(i)){const o=t.get(i),r=Date.now()-o.timestamp;if(r<Ae)return console.log(`[useMediaMatching] Using cached match for TMDB ID ${i} (age: ${Math.round(r/1e3/60)}m)`),o.embyItem;t.delete(i),e(t)}try{const n="title"in r?"Movie":"Series",s="title"in r?r.title:r.name,l="release_date"in r?r.release_date?new Date(r.release_date).getFullYear():null:r.first_air_date?new Date(r.first_air_date).getFullYear():null,c=await a.searchItemsByExternalId(void 0,r.id.toString(),[n]);if(c.length>0){console.log(`[useMediaMatching] Matched "${s}" by TMDB ID:`,r.id);const o={embyItem:c[0],timestamp:Date.now()};return t.set(i,o),e(t),c[0]}const u=await a.searchItems(s,[n]);if(0===u.length){console.log(`[useMediaMatching] No search results for "${s}"`);const o={embyItem:null,timestamp:Date.now()};return t.set(i,o),e(t),null}let d=u.find(e=>{const t=e.Name?.toLowerCase()===s.toLowerCase(),o=!l||Math.abs((e.ProductionYear||0)-l)<=1;return t&&o});if(d){console.log(`[useMediaMatching] Matched "${s}" by exact title+year`);const o={embyItem:d,timestamp:Date.now()};return t.set(i,o),e(t),d}const m=o(s);if(d=u.find(e=>{const t=o(e.Name||"")===m,r=!l||Math.abs((e.ProductionYear||0)-l)<=2;return t&&r}),d){console.log(`[useMediaMatching] Matched "${s}" by normalized title+year`);const o={embyItem:d,timestamp:Date.now()};return t.set(i,o),e(t),d}if(l&&(d=u.find(e=>{const t=e.Name?.toLowerCase()||"",o=s.toLowerCase(),r=t.includes(o)||o.includes(t),a=Math.abs((e.ProductionYear||0)-l)<=1;return r&&a}),d)){console.log(`[useMediaMatching] Matched "${s}" by fuzzy title+strict year`);const o={embyItem:d,timestamp:Date.now()};return t.set(i,o),e(t),d}if(l){const o=u.filter(e=>Math.abs((e.ProductionYear||0)-l)<=1);if(1===o.length){console.log(`[useMediaMatching] Matched "${s}" as only result with year ${l}`);const r={embyItem:o[0],timestamp:Date.now()};return t.set(i,r),e(t),o[0]}}if(l&&(d=u.find(e=>{const t=o(e.Name||""),r=Math.abs((e.ProductionYear||0)-l)<=3;return(t.includes(m)||m.includes(t))&&r}),d)){console.log(`[useMediaMatching] Matched "${s}" by partial title+lenient year (3)`);const o={embyItem:d,timestamp:Date.now()};return t.set(i,o),e(t),d}if(u.length<=2){const r=u[0],a=o(r.Name||""),n=Math.min(m.length,a.length),l=m.length>a.length?m:a,c=m.length<=a.length?m:a;if(c.length>=.6*n&&l.includes(c)){console.log(`[useMediaMatching] Matched "${s}" as first result with similar title (${u.length} results)`);const o={embyItem:r,timestamp:Date.now()};return t.set(i,o),e(t),r}}if(!l){if(d=u.find(e=>o(e.Name||"")===m),d){console.log(`[useMediaMatching] Matched "${s}" by normalized title (no year data available)`);const o={embyItem:d,timestamp:Date.now()};return t.set(i,o),e(t),d}if(1===u.length){const r=o(u[0].Name||"");if(r.includes(m)||m.includes(r)){console.log(`[useMediaMatching] Matched "${s}" as only result (no year data)`);const o={embyItem:u[0],timestamp:Date.now()};return t.set(i,o),e(t),u[0]}}}if(d=u.find(e=>o(e.Name||"")===m),d){console.log(`[useMediaMatching] Matched "${s}" by exact normalized title (ignoring year mismatch)`);const o={embyItem:d,timestamp:Date.now()};return t.set(i,o),e(t),d}console.log(`[useMediaMatching] No confident match found for "${s}" (${l||"no year"}) among ${u.length} results:`,u.slice(0,5).map(e=>({name:e.Name,year:e.ProductionYear,type:e.Type})));const g={embyItem:null,timestamp:Date.now()};return t.set(i,g),e(t),null}catch(s){console.error("[useMediaMatching] Error matching TMDB item:",s);const o={embyItem:null,timestamp:Date.now()};return t.set(i,o),e(t),null}},batchWithConcurrency:async(e,t,o=5)=>{const r=[];for(let a=0;a<e.length;a+=o){const n=e.slice(a,a+o),i=await Promise.all(n.map(t));r.push(...i)}return r},normalizeTitle:o,clearMatchCache:()=>{try{localStorage.removeItem(Ne),t.clear(),console.log("[useMediaMatching] Cache cleared")}catch(e){console.error("[useMediaMatching] Failed to clear cache:",e)}},tmdbMatchCache:t}}function Ue(t,o,r,a,n,i=!1){const s=e([]),l=e(null),c=e([]),u=e("libraries"),d=e(!1),m=async e=>{try{const t="Movie"===e.Type,o="Series"===e.Type;if(!t&&!o)return e;const a=e.Name||"",n=e.ProductionYear,i=t?"/search/movie":"/search/tv",s={query:a};n&&(s[t?"year":"first_air_date_year"]=n.toString());const l=await r.makeRequest(i,s);if(l.results&&l.results.length>0){let o=l.results[0];if(n&&l.results.length>1){const e=l.results.find(e=>{const o=t?e.release_date?new Date(e.release_date).getFullYear():null:e.first_air_date?new Date(e.first_air_date).getFullYear():null;return o&&Math.abs(o-n)<=1});e&&(o=e)}if(o.backdrop_path){const t=r.getBackdropUrl(o.backdrop_path,"w1280");return console.log(`[LibraryManager] Enhanced "${a}" with TMDB backdrop`),{...e,HeroImageUrl:t}}}return e}catch(t){return console.error("[LibraryManager] Failed to enhance item with TMDB backdrop:",t),e}};return{allLibraries:s,currentLibrary:l,featuredItems:c,isLoadingFeatured:d,currentView:u,findLibraryByType:e=>s.value.find(t=>t.CollectionType===e||t.Name?.toLowerCase().includes(e.replace("s",""))),loadFeaturedItems:async(e,o,n)=>{d.value=!0,c.value=[];const s=e.find(e=>"movies"===e.CollectionType||e.Name?.toLowerCase().includes("movie"));if(console.log("[LibraryManager] Found movie library for hero:",s),i&&s)try{const o=e.find(e=>"tvshows"===e.CollectionType||e.Name?.toLowerCase().includes("tv")||e.Name?.toLowerCase().includes("show")),r=await t.getItems(s.Id,"Movie");console.log("[LibraryManager] Loaded movie items for hero slider:",r.length);let n=[];o&&(n=await t.getItems(o.Id,"Series"),console.log("[LibraryManager] Loaded TV show items for hero slider:",n.length));const i=[...r,...n];if(await a.init(),a.isReady.value){console.log("[LibraryManager] Using personalized recommendations for hero slider");const e=(new Date).getFullYear(),t=i.filter(t=>{const o=t.ProductionYear&&t.ProductionYear>=e-15,r=t.CommunityRating&&t.CommunityRating>=6.5;return o||r}),o=t.length>100?t:i.slice(0,400);console.log("[LibraryManager] Pre-filtered to",o.length,"candidates for scoring");const r=await a.getRecommendations(o,{limit:6,excludeWatched:!0,minScore:.15,discoveryPercent:10});if(r.length>=6){const e=new Set,t=new Set,o=r.filter(o=>{if(e.has(o.Id))return console.warn("[LibraryManager] Duplicate ID in recommendations:",o.Name,o.Id),!1;const r=o.Name?.toLowerCase().trim();return r&&t.has(r)?(console.warn("[LibraryManager] Duplicate name in recommendations:",o.Name,"(ID:",o.Id,")"),!1):(e.add(o.Id),r&&t.add(r),!0)});console.log("[LibraryManager] Enhancing personalized items with TMDB backdrops...");const a=await Promise.all(o.map(e=>m(e)));return c.value=a,console.log("[LibraryManager] Featured items set (personalized):",c.value.length,"after deduplication and TMDB enhancement"),void(d.value=!1)}if(r.length<5){console.log("[LibraryManager] Found",r.length,"personalized items, supplementing with unwatched popular content");try{const e=new Set(r.map(e=>e.Id)),t=o.filter(t=>!e.has(t.Id)&&!t.UserData?.Played);console.log("[LibraryManager] Found",t.length,"unwatched candidates for supplementation");const a=t.filter(e=>e.UserData).length,n=t.filter(e=>e.UserData?.Played).length;console.log("[LibraryManager] Candidates with UserData:",a,"/",t.length),console.log("[LibraryManager] Played items filtered out:",n);const i=t.sort((e,t)=>{const o=e.CommunityRating||0,r=t.CommunityRating||0,a=e.ProductionYear||0,n=t.ProductionYear||0;return o!==r?r-o:n-a}),s=i.slice(0,20).sort(()=>Math.random()-.5),l=6-r.length,u=s.slice(0,l),g=[...r,...u],y=new Set,v=new Set,h=g.filter(e=>{if(y.has(e.Id))return console.warn("[LibraryManager] Duplicate ID detected:",e.Name,e.Id),!1;const t=e.Name?.toLowerCase().trim();return t&&v.has(t)?(console.warn("[LibraryManager] Duplicate name detected:",e.Name,"(ID:",e.Id,")"),!1):(y.add(e.Id),t&&v.add(t),!0)});console.log("[LibraryManager] Enhancing supplemented items with TMDB backdrops...");const f=await Promise.all(h.map(e=>m(e)));if(c.value=f,console.log("[LibraryManager] Supplemented with",u.length,"unwatched items, total:",c.value.length),c.value.length>=5)return void(d.value=!1)}catch(l){console.error("[LibraryManager] Failed to supplement with unwatched items:",l)}console.log("[LibraryManager] Still not enough items after supplementation, falling back to trending")}else console.log("[LibraryManager] Not enough personalized recommendations, falling back to trending",r.length)}else console.log("[LibraryManager] Personalization not ready (need at least 5 viewing events), using trending")}catch(l){console.error("[LibraryManager] Failed to load personalized items:",l)}else console.log("[LibraryManager] Personalization disabled or no movie library, using trending content");if(o&&o.length>0||n&&n.length>0){console.log("[LibraryManager] Using trending content for hero slider");const e=[...o?.slice(0,4).map(e=>({...e.embyItem,HeroImageUrl:r.getBackdropUrl(e.tmdbData.backdrop_path,"w1280")||e.embyItem.HeroImageUrl}))||[],...n?.slice(0,2).map(e=>({...e.embyItem,HeroImageUrl:r.getBackdropUrl(e.tmdbData.backdrop_path,"w1280")||e.embyItem.HeroImageUrl}))||[]];c.value=e.slice(0,6),console.log("[LibraryManager] Featured items set from trending:",c.value.length)}else if(s){console.log("[LibraryManager] No trending content available, using Emby library");try{const e=await t.getItems(s.Id,"Movie"),o=e.filter(e=>e.CommunityRating);let r;if(o.length>=6){r=o.sort((e,t)=>(t.CommunityRating||0)-(e.CommunityRating||0)).slice(0,6)}else r=e.slice(0,6);console.log("[LibraryManager] Enhancing Emby library items with TMDB backdrops...");const a=await Promise.all(r.map(e=>m(e)));c.value=a,console.log("[LibraryManager] Featured items set from Emby library:",c.value.length)}catch(l){console.error("[LibraryManager] Failed to load from Emby library:",l),c.value=[]}}else console.warn("[LibraryManager] No movie library found and no trending content"),c.value=[];d.value=!1},loadLibraries:async()=>{if(u.value="libraries",l.value=null,n.value){s.value=o.getLibraries();const e=o.getLibraryItems("demo-movies");c.value=e.slice(0,6)}else try{const e=await t.getViews();s.value=e,console.log("[LibraryManager] Loaded libraries:",e),console.log("[LibraryManager] Library types:",e.map(e=>({name:e.Name,type:e.Type,collectionType:e.CollectionType,id:e.Id})))}catch(e){console.error("[LibraryManager] Failed to load libraries:",e),s.value=[]}return s.value},loadLibraryItems:async e=>{console.log("[LibraryManager] loadLibraryItems called with:",e),l.value=e,u.value="items";let r=[];if(n.value)r=o.getLibraryItems(e.Id);else try{let o=null;"movies"===e.CollectionType?o="Movie":"tvshows"===e.CollectionType?o="Series":"collections"===e.CollectionType&&(o="BoxSet"),console.log("[LibraryManager] Fetching items for library:",{libraryId:e.Id,libraryName:e.Name,itemType:o,collectionType:e.CollectionType}),r=await t.getItems(e.Id,o),console.log("[LibraryManager] Loaded items:",r.length)}catch(a){console.error("[LibraryManager] Failed to load library items:",a),r=[]}return r},loadCollectionItems:async e=>{if(n.value)return o.getLibraryItems(e);try{const o=await t.getItems(e,null);return console.log("[LibraryManager] Loaded collection items:",o.length),o}catch(r){return console.error("[LibraryManager] Failed to load collection items:",r),[]}},reset:()=>{s.value=[],l.value=null,c.value=[],u.value="libraries"}}}function _e(t,o,r,a){const n=e([]),i=e([]),s=e(!1),l=e(!1),c=e(1),u=e(1),d=e(!1),m=e(!1),g=e(!0),y=e(!0);return{trendingMovies:n,trendingTvShows:i,isLoadingTrending:s,isLoadingMoreMovies:d,isLoadingMoreTv:m,hasMoreMovies:g,hasMoreTv:y,shouldShowSplash:l,loadTrendingContent:async e=>{if(!t.isConfigured)return void console.log("[TrendingContent] TMDB API not configured, skipping trending content");if(a.value)return void console.log("[TrendingContent] Demo mode - skipping Emby matching for trending");const c=r.tmdbMatchCache.size;l.value=0===c,l.value&&e?(console.log("[TrendingContent] No cache found - showing splash screen for initial load"),e.onShow()):console.log(`[TrendingContent] Found ${c} cached items - skipping splash screen`),s.value=!0;try{const[e,s]=await Promise.all([t.getTrendingMovies("week",1),t.getTrendingTvShows("week",1)]),l=e.results,c=s.results;console.log("[TrendingContent] Loaded TMDB trending:",{movies:l.length,tvShows:c.length}),console.log("[TrendingContent] Matching trending items with Emby library...");const u=l.slice(0,15),d=c.slice(0,15),[m,g]=await Promise.all([t.getWatchProvidersBatch(u.map(e=>({id:e.id,mediaType:"movie"})),"US"),t.getWatchProvidersBatch(d.map(e=>({id:e.id,mediaType:"tv"})),"US")]),[y,v]=await Promise.all([r.batchWithConcurrency(u,async e=>{const t=await r.matchTmdbWithEmby(e,o,a.value);if(!t)return null;const n=m.get(e.id);return{tmdbData:e,embyId:t.Id,embyItem:t,streamingProviders:n?.flatrate||[]}},5),r.batchWithConcurrency(d,async e=>{const t=await r.matchTmdbWithEmby(e,o,a.value);if(!t)return null;const n=g.get(e.id);return{tmdbData:e,embyId:t.Id,embyItem:t,streamingProviders:n?.flatrate||[]}},5)]);n.value=y.filter(e=>null!==e),i.value=v.filter(e=>null!==e),console.log("[TrendingContent] Filtered trending content (in Emby library):",{movies:`${n.value.length}/${l.length}`,tvShows:`${i.value.length}/${c.length}`})}catch(u){console.error("[TrendingContent] Failed to load trending content:",u)}finally{s.value=!1,l.value&&e&&(e.onHide(),l.value=!1)}},loadMoreMovies:async()=>{if(t.isConfigured&&!a.value&&!d.value&&g.value){d.value=!0;try{const e=c.value+1;console.log(`[TrendingContent] Loading more movies - page ${e}`);const i=await t.getTrendingMovies("week",e);if(0===i.results.length||e>=i.total_pages)return g.value=!1,void console.log("[TrendingContent] No more movies to load");const s=new Map(i.results.map(e=>[e.id,e])),l=Array.from(s.values()),u=await t.getWatchProvidersBatch(l.map(e=>({id:e.id,mediaType:"movie"})),"US"),d=(await r.batchWithConcurrency(l,async e=>{const t=await r.matchTmdbWithEmby(e,o,a.value);if(!t)return null;const n=u.get(e.id);return{tmdbData:e,embyId:t.Id,embyItem:t,streamingProviders:n?.flatrate||[]}},5)).filter(e=>null!==e),m=new Set(n.value.map(e=>e.tmdbData.id)),y=new Set(n.value.map(e=>e.embyId)),v=d.filter(e=>!m.has(e.tmdbData.id)&&!y.has(e.embyId));n.value=[...n.value,...v],c.value=e,console.log(`[TrendingContent] Loaded ${v.length} more movies (page ${e}, ${d.length-v.length} duplicates filtered)`)}catch(e){console.error("[TrendingContent] Failed to load more movies:",e)}finally{d.value=!1}}},loadMoreTvShows:async()=>{if(t.isConfigured&&!a.value&&!m.value&&y.value){m.value=!0;try{const e=u.value+1;console.log(`[TrendingContent] Loading more TV shows - page ${e}`);const n=await t.getTrendingTvShows("week",e);if(0===n.results.length||e>=n.total_pages)return y.value=!1,void console.log("[TrendingContent] No more TV shows to load");const s=new Map(n.results.map(e=>[e.id,e])),l=Array.from(s.values()),c=await t.getWatchProvidersBatch(l.map(e=>({id:e.id,mediaType:"tv"})),"US"),d=(await r.batchWithConcurrency(l,async e=>{const t=await r.matchTmdbWithEmby(e,o,a.value);if(!t)return null;const n=c.get(e.id);return{tmdbData:e,embyId:t.Id,embyItem:t,streamingProviders:n?.flatrate||[]}},5)).filter(e=>null!==e),m=new Set(i.value.map(e=>e.tmdbData.id)),g=new Set(i.value.map(e=>e.embyId)),v=d.filter(e=>!m.has(e.tmdbData.id)&&!g.has(e.embyId));i.value=[...i.value,...v],u.value=e,console.log(`[TrendingContent] Loaded ${v.length} more TV shows (page ${e}, ${d.length-v.length} duplicates filtered)`)}catch(e){console.error("[TrendingContent] Failed to load more TV shows:",e)}finally{m.value=!1}}},filterMoviesByGenres:e=>0===e.length?n.value:n.value.filter(t=>{const o=t.tmdbData.genre_ids||[];return e.every(e=>o.includes(e))}),filterTvShowsByGenres:e=>0===e.length?i.value:i.value.filter(t=>{const o=t.tmdbData.genre_ids||[];return e.every(e=>o.includes(e))}),reset:()=>{n.value=[],i.value=[],s.value=!1,l.value=!1,c.value=1,u.value=1,d.value=!1,m.value=!1,g.value=!0,y.value=!0}}}function $e(t,o){const r=e([]),n=e([]),i=a(()=>{if(0===o.value.length||0===r.value.length)return[];if(0===n.value.length){const e=new Set;return o.value.forEach(t=>{t.genre_ids.forEach(t=>e.add(t))}),r.value.filter(t=>e.has(t.id))}const e=o.value.filter(e=>n.value.every(t=>e.genre_ids.includes(t))),t=new Set;return e.forEach(e=>{e.genre_ids.forEach(e=>t.add(e))}),r.value.filter(e=>t.has(e.id))}),s=a(()=>0===n.value.length?o.value:o.value.filter(e=>n.value.every(t=>e.genre_ids.includes(t))));return{allGenres:r,selectedGenres:n,availableGenres:i,filteredItems:s,loadGenres:async e=>{if(t.isConfigured)try{const o="movie"===e?await t.getMovieGenres():await t.getTvGenres();r.value=o,console.log(`[GenreFilter] Loaded ${e} genres:`,o.length)}catch(o){console.error(`[GenreFilter] Failed to load ${e} genres:`,o)}},toggleGenre:e=>{const t=n.value.indexOf(e);t>-1?n.value.splice(t,1):n.value.push(e)},clearGenres:()=>{n.value=[]},isGenreSelected:e=>n.value.includes(e),reset:()=>{r.value=[],n.value=[]}}}const Fe=[{day:"Monday",timeSlot:"morning",tvTheme:"Daily Discovery (Documentary)",tvFilters:{with_genres:"99","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Quiet Focus Film (History)",movieFilters:{with_genres:"36","vote_average.gte":7,"with_runtime.lte":90,sort_by:"vote_average.desc"}},{day:"Monday",timeSlot:"midday",tvTheme:"Workday Motivation (Lifestyle/Reality)",tvFilters:{with_genres:"10764",sort_by:"popularity.desc"},movieTheme:"Inspirational Doc (Non-Fiction Feature)",movieFilters:{with_genres:"99","vote_count.gte":500,sort_by:"vote_count.desc"}},{day:"Monday",timeSlot:"evening",tvTheme:"Prestige Drama Premiere (New or Trending Drama)",tvFilters:{with_genres:"18","first_air_date.gte":new Date(Date.now()-15552e6).toISOString().split("T")[0],sort_by:"popularity.desc"},movieTheme:"Heavy Hitter Movie (Crime/Mystery)",movieFilters:{with_genres:"80,9648","vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Tuesday",timeSlot:"morning",tvTheme:"Sci-Fi Short (Animation/Sci-Fi)",tvFilters:{with_genres:"16|878",sort_by:"popularity.desc"},movieTheme:"80s/90s Action Film (Throwback Action)",movieFilters:{with_genres:"28","primary_release_date.gte":"1980-01-01","primary_release_date.lte":"1999-12-31",sort_by:"popularity.desc"}},{day:"Tuesday",timeSlot:"midday",tvTheme:"Lunch Break Lite (Classic Sitcom/Comedy)",tvFilters:{with_genres:"35","first_air_date.lte":"2010-01-01",sort_by:"vote_average.desc"},movieTheme:"Visual Escapism (Travel/Nature Documentary)",movieFilters:{with_genres:"99",sort_by:"vote_average.desc"}},{day:"Tuesday",timeSlot:"evening",tvTheme:"Terror Tuesday (Horror Series)",tvFilters:{with_genres:"27","vote_average.gte":7,sort_by:"vote_count.desc"},movieTheme:"Psychological Thriller (High Tension Movie)",movieFilters:{with_genres:"53","vote_average.gte":7,"with_runtime.lte":120,sort_by:"vote_average.desc"}},{day:"Wednesday",timeSlot:"morning",tvTheme:"World News Review (News/Talk Show)",tvFilters:{with_genres:"10763",sort_by:"popularity.desc"},movieTheme:"Foreign Film Spotlight (Non-English Movie)",movieFilters:{"vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Wednesday",timeSlot:"midday",tvTheme:"Feel-Good Food Show (Cooking/Baking)",tvFilters:{with_genres:"10764|10767",sort_by:"popularity.desc"},movieTheme:"Animated Comfort Film (Family/Animation)",movieFilters:{with_genres:"16|10751",sort_by:"popularity.desc"}},{day:"Wednesday",timeSlot:"evening",tvTheme:"Hump Day Mystery (Whodunit Series)",tvFilters:{with_genres:"9648","vote_count.gte":100,sort_by:"vote_average.desc"},movieTheme:"Noir Classic (Black & White, Older Film)",movieFilters:{with_genres:"80|18|53","primary_release_date.lte":"1960-01-01",sort_by:"vote_average.desc"}},{day:"Thursday",timeSlot:"morning",tvTheme:"Deep Dive History (Historical Miniseries)",tvFilters:{with_genres:"36|18","vote_average.gte":7.5,sort_by:"vote_average.desc"},movieTheme:"Period Romance (Costume Drama/Romance)",movieFilters:{with_genres:"10749",sort_by:"vote_average.desc"}},{day:"Thursday",timeSlot:"midday",tvTheme:"Sports Short (Sport Documentary/Series)",tvFilters:{with_genres:"10764|99",sort_by:"popularity.desc"},movieTheme:"Fantasy/Adventure Film (Escapist Movie)",movieFilters:{with_genres:"14|12","vote_count.gte":1e3,sort_by:"popularity.desc"}},{day:"Thursday",timeSlot:"evening",tvTheme:"Throwback Thursday (Re-watch Old TV Show)",tvFilters:{"first_air_date.lte":"2005-01-01","vote_count.gte":100,sort_by:"vote_average.desc"},movieTheme:"Cult Classic (Offbeat or Niche Movie)",movieFilters:{"vote_average.gte":7,"vote_count.lte":1e3,sort_by:"vote_average.desc"}},{day:"Friday",timeSlot:"morning",tvTheme:"Tech & Science Explainer (Science Documentary/Talk)",tvFilters:{with_genres:"99",sort_by:"vote_average.desc"},movieTheme:"Art House Film (Indie/Experimental)",movieFilters:{with_genres:"18|35","vote_count.lte":500,"vote_average.gte":7.5,sort_by:"vote_average.desc"}},{day:"Friday",timeSlot:"midday",tvTheme:"Family Favorites (Kid-Friendly Series)",tvFilters:{with_genres:"10751",sort_by:"popularity.desc"},movieTheme:"Danish Movies",movieFilters:{sort_by:"popularity.desc",watch_region:"DK",with_origin_country:"DK",with_original_language:"da"}},{day:"Friday",timeSlot:"evening",tvTheme:"Friday Night Blockbuster (Action/Sci-Fi Series)",tvFilters:{with_genres:"28|878",sort_by:"popularity.desc"},movieTheme:"New Release Movie Night (Theatrical/VOD Premiere)",movieFilters:{"primary_release_date.gte":new Date(Date.now()-7776e6).toISOString().split("T")[0],sort_by:"primary_release_date.desc"}},{day:"Saturday",timeSlot:"morning",tvTheme:"Saturday Morning Animation (Cartoons/Anime)",tvFilters:{with_genres:"16|10751",sort_by:"popularity.desc"},movieTheme:"Recharge & Reflect (Spiritual/Thought-Provoking)",movieFilters:{with_genres:"18","vote_average.gte":7.5,sort_by:"vote_average.desc"}},{day:"Saturday",timeSlot:"midday",tvTheme:"Comedy Miniseries Binge (Short Comedy TV)",tvFilters:{with_genres:"35","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Midday Thriller (Suspense/Mystery Feature)",movieFilters:{with_genres:"53|9648","vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Saturday",timeSlot:"evening",tvTheme:"Saturday Night Favorites (Top-Rated Series)",tvFilters:{"vote_average.gte":8,sort_by:"popularity.desc"},movieTheme:"Saturday Night Cinema",movieFilters:{sort_by:"popularity.desc",watch_region:"DK",with_release_type:3,page:(Le=1,xe=5,Math.floor(Math.random()*(xe-Le))+Le)}},{day:"Sunday",timeSlot:"morning",tvTheme:"World Travel Log (Travel Series)",tvFilters:{with_genres:"99|10764",sort_by:"popularity.desc"},movieTheme:"Family Sunday Film (G-Rated or Family Adventure)",movieFilters:{with_genres:"10751",sort_by:"primary_release_date.desc"}},{day:"Sunday",timeSlot:"midday",tvTheme:"Guilty Pleasure Reality (Low-Commitment Reality)",tvFilters:{with_genres:"10764",sort_by:"popularity.desc"},movieTheme:"Silly Comedy Feature (Low-Brow Humor)",movieFilters:{with_genres:"35",sort_by:"popularity.desc"}},{day:"Sunday",timeSlot:"evening",tvTheme:"Winding Down Watch (Calm, Comfort Series)",tvFilters:{with_genres:"10749|18","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Classic Blockbuster Revisit (Nostalgic Film)",movieFilters:{with_genres:"12|28|878","primary_release_date.lte":"2000-01-01","vote_count.gte":1e3,sort_by:"popularity.desc"}}];var Le,xe;function Oe(e=new Date){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()]}function Be(){const e=new Date,t=e.getHours(),o=function(){const e=(new Date).getHours();return e>=5&&e<12?"morning":e>=12&&e<18?"midday":"evening"}();let r;if("evening"===o&&t>=0&&t<5){const t=new Date(e);t.setDate(t.getDate()-1),r=Oe(t)}else r=Oe(e);return function(e,t){return Fe.find(o=>o.day===e&&o.timeSlot===t)}(r,o)}const je="embyflix-daily-discovery-cache";function We(e){const t={page:1,...e};return t.sort_by||(t.sort_by="popularity.desc"),t}function qe(e,t){return t?{tmdbData:e,embyId:t.Id,embyItem:t}:null}function ze(e,t){return t?{tmdbData:e,embyId:t.Id,embyItem:t}:null}function Ge(){return(new Date).toISOString().split("T")[0]}function He(){const t=he(),{matchTmdbWithEmby:o,batchWithConcurrency:r}=Re(),n=e(!1),i=e(null),s=e([]),l=e([]),c=e(Be()),u=e(1),d=e(1),m=e(!1),g=e(!1),y=e(!0),v=e(!0),h=a(()=>c.value?.movieTheme||"Daily Movie Pick"),f=a(()=>c.value?.tvTheme||"Daily TV Pick"),p=a(()=>s.value.length>0||l.value.length>0),w=async(e,r=!1)=>{const a=function(){try{const e=localStorage.getItem(je);if(!e)return null;const t=JSON.parse(e),o=Date.now()-t.timestamp,r=Ge(),a=Be();return o<864e5&&t.date===r&&a&&t.timeSlot===a.timeSlot?(console.log("[useDailyDiscovery] Using cached daily content",{date:t.date,timeSlot:t.timeSlot,age:Math.round(o/1e3/60)+"m"}),t):(console.log("[useDailyDiscovery] Cache invalid or expired",{cachedDate:t.date,currentDate:r,cachedSlot:t.timeSlot,currentSlot:a?.timeSlot}),null)}catch(i){return console.error("[useDailyDiscovery] Failed to load cache:",i),null}}();if(a)return s.value=a.movies,l.value=a.tvShows,void(c.value=a.theme);n.value=!0,i.value=null;try{const a=Be();if(!a)throw new Error("No theme found for current date/time");c.value=a,console.log("[useDailyDiscovery] Loading daily content",{day:a.day,timeSlot:a.timeSlot,movieTheme:a.movieTheme,tvTheme:a.tvTheme});const n=We(a.movieFilters),u=We(a.tvFilters),[d,m]=await Promise.all([t.discoverMovies(n),t.discoverTvShows(u)]);console.log("[useDailyDiscovery] Fetched from TMDB",{movies:d.results.length,tvShows:m.results.length,movieParams:n,tvParams:u});const g=d.results.slice(0,20),y=m.results.slice(0,20),v=await Promise.all(g.map(async t=>qe(t,await o(t,e,r)))),h=await Promise.all(y.map(async t=>ze(t,await o(t,e,r)))),f=v.filter(e=>null!==e),p=h.filter(e=>null!==e);console.log("[useDailyDiscovery] Matched with Emby",{movies:`${f.length}/${v.length}`,tvShows:`${p.length}/${h.length}`}),s.value=f,l.value=p;!function(e){try{localStorage.setItem(je,JSON.stringify(e)),console.log("[useDailyDiscovery] Saved daily cache",{date:e.date,timeSlot:e.timeSlot,movies:e.movies.length,tvShows:e.tvShows.length})}catch(i){console.error("[useDailyDiscovery] Failed to save cache:",i)}}({date:Ge(),timeSlot:a.timeSlot,theme:a,movies:f,tvShows:p,timestamp:Date.now()})}catch(u){i.value=u instanceof Error?u.message:"Failed to load daily content",console.error("[useDailyDiscovery] Error loading daily content:",u)}finally{n.value=!1}},b=()=>{localStorage.removeItem(je),s.value=[],l.value=[],console.log("[useDailyDiscovery] Cache cleared")};return{isLoading:n,error:i,dailyMovies:s,dailyTvShows:l,currentTheme:c,movieThemeTitle:h,tvThemeTitle:f,hasContent:p,loadDailyContent:w,clearCache:b,refresh:async(e,t=!1)=>{b(),await w(e,t)},loadMoreMovies:async(e,a=!1)=>{if(!m.value&&y.value&&c.value){m.value=!0;try{const n=u.value+1;console.log(`[useDailyDiscovery] Loading more movies - page ${n}`);const i=We(c.value.movieFilters);i.page=n;const l=await t.discoverMovies(i);if(0===l.results.length||n>=l.total_pages)return y.value=!1,void console.log("[useDailyDiscovery] No more movies to load");const d=l.results.slice(0,20),m=(await r(d,async t=>qe(t,await o(t,e,a)),5)).filter(e=>null!==e),g=new Set(s.value.map(e=>e.tmdbData.id)),v=new Set(s.value.map(e=>e.embyId)),h=m.filter(e=>!g.has(e.tmdbData.id)&&!v.has(e.embyId));s.value=[...s.value,...h],u.value=n,console.log(`[useDailyDiscovery] Loaded ${h.length} more movies (page ${n})`)}catch(n){i.value=n instanceof Error?n.message:"Failed to load more movies",console.error("[useDailyDiscovery] Error loading more movies:",n)}finally{m.value=!1}}},loadMoreTvShows:async(e,a=!1)=>{if(!g.value&&v.value&&c.value){g.value=!0;try{const n=d.value+1;console.log(`[useDailyDiscovery] Loading more TV shows - page ${n}`);const i=We(c.value.tvFilters);i.page=n;const s=await t.discoverTvShows(i);if(0===s.results.length||n>=s.total_pages)return v.value=!1,void console.log("[useDailyDiscovery] No more TV shows to load");const u=s.results.slice(0,20),m=(await r(u,async t=>ze(t,await o(t,e,a)),5)).filter(e=>null!==e),g=new Set(l.value.map(e=>e.tmdbData.id)),y=new Set(l.value.map(e=>e.embyId)),h=m.filter(e=>!g.has(e.tmdbData.id)&&!y.has(e.embyId));l.value=[...l.value,...h],d.value=n,console.log(`[useDailyDiscovery] Loaded ${h.length} more TV shows (page ${n})`)}catch(n){i.value=n instanceof Error?n.message:"Failed to load more TV shows",console.error("[useDailyDiscovery] Error loading more TV shows:",n)}finally{g.value=!1}}},isLoadingMoreMovies:m,isLoadingMoreTv:g,hasMoreMovies:y,hasMoreTv:v}}function Ye(){const t=e(!1),o=e(null);const r=a(()=>o.value?`Because you watched: ${o.value.referenceItem.name}`:""),n=a(()=>null!==o.value&&o.value.recommendations.length>0);return{isLoading:t,becauseYouWatchedItem:o,sectionTitle:r,hasRecommendations:n,loadBecauseYouWatched:async function(e){if(!t.value){t.value=!0;try{o.value=await async function(e){try{const t=await e.getRecentlyWatched(20,["Movie","Series"]);if(0===t.length)return console.log("[BecauseYouWatched] No recently watched items"),null;const o=t.slice(0,Math.min(5,t.length)),r=o[Math.floor(Math.random()*o.length)];console.log("[BecauseYouWatched] Generating recommendations based on:",r.Name);const a=(await e.getSimilarItems(r.Id,25)).filter(e=>!e.UserData?.Played);return 0===a.length?(console.log("[BecauseYouWatched] No unwatched similar items found"),null):(console.log("[BecauseYouWatched] Generated",a.length,"recommendations"),{referenceItem:{id:r.Id,name:r.Name||"Unknown",type:r.Type},recommendations:a})}catch(t){return console.error("[BecauseYouWatched] Error generating recommendations:",t),null}}(e)}catch(r){console.error("[BecauseYouWatched] Error loading recommendations:",r),o.value=null}finally{t.value=!1}}}}}function Ve(){const e=r(),a=e=>{switch(e){case"home":return{name:"Home"};case"movies":return{name:"Category",params:{category:"movies"}};case"tvshows":return{name:"Category",params:{category:"tvshows"}};case"collections":return{name:"Category",params:{category:"collections"}};case"search":return{name:"Search"};case"settings":return{name:"Settings"};default:return console.warn("[useSidebarNavigation] Unknown navigation ID:",e),null}},n=(e,t)=>{const o=e.detail;if(console.log("[useSidebarNavigation] Navigation requested:",o),t){const e=t(o);if(e instanceof Promise)return void e.then(e=>{e&&i(o)});if(!e)return void console.log("[useSidebarNavigation] Navigation cancelled by beforeNavigate hook")}i(o)},i=t=>{const o=a(t);o&&e.push(o)};return{navigateTo:a,handleSidebarNavigation:n,performNavigation:i,registerSidebarNavigation:e=>{const r=t=>n(t,e);return t(()=>{window.addEventListener("sidebar-navigate",r)}),o(()=>{window.removeEventListener("sidebar-navigate",r)}),r}}}function Je(e="Home"){const a=r(),n=se(),i=()=>{console.log("[useBackNavigation] Back navigation triggered");n.goBack()||(console.log(`[useBackNavigation] No history, navigating to ${e}`),a.push({name:e}))};return t(()=>{window.addEventListener("app-back-navigation",i)}),o(()=>{window.removeEventListener("app-back-navigation",i)}),{handleBack:i,handleSimpleBack:()=>{console.log("[useBackNavigation] Simple back navigation"),a.back()}}}function Qe(){const t=N(),o=e(""),r=e([]),i=e(!1),s=e(null),l=e({itemTypes:[],genres:[],studios:[],tags:[],runtime:"any",criticRating:"any",communityRating:"any",sortBy:"relevance"});let c=null;const u=e=>{if("any"!==l.value.criticRating){const t="60+"===l.value.criticRating?60:80,o=e.CriticRating;if(!o||o<t)return!1}if("any"!==l.value.communityRating){const t="60+"===l.value.communityRating?6:8,o=e.CommunityRating;if(!o||o<t)return!1}if("any"!==l.value.runtime){const t=(e=>e.RunTimeTicks?Math.round(e.RunTimeTicks/1e4/1e3/60):null)(e);if(!t)return!1;switch(l.value.runtime){case"short":if(t>=30)return!1;break;case"medium":if(t<30||t>=90)return!1;break;case"long":if(t<90||t>=150)return!1;break;case"verylong":if(t<150)return!1}}return!0},d=a(()=>{let e=r.value;return l.value.itemTypes.length>0&&(e=e.filter(e=>l.value.itemTypes.includes(e.Type))),l.value.genres.length>0&&(e=e.filter(e=>e.Genres&&e.Genres.some(e=>l.value.genres.includes(e)))),l.value.studios.length>0&&(e=e.filter(e=>e.Studios&&e.Studios.some(e=>l.value.studios.includes(e.Name)))),l.value.tags.length>0&&(e=e.filter(e=>e.Tags&&e.Tags.some(e=>l.value.tags.includes(e)))),e=e.filter(u),e=[...e].sort((e,t)=>{switch(l.value.sortBy){case"relevance":{const r=o.value.toLowerCase(),a=e.Name.toLowerCase(),n=t.Name.toLowerCase(),i=a===r?3:0,s=n===r?3:0;if(i!==s)return s-i;const l=a.startsWith(r)?2:0,c=n.startsWith(r)?2:0;if(l!==c)return c-l;const u=a.includes(r)?1:0,d=n.includes(r)?1:0;return u!==d?d-u:(t.CommunityRating||0)-(e.CommunityRating||0)}case"name-asc":return e.Name.localeCompare(t.Name);case"name-desc":return t.Name.localeCompare(e.Name);case"date-newest":{const o=e.PremiereDate?new Date(e.PremiereDate).getTime():365*(e.ProductionYear||0)*24*60*60*1e3;return(t.PremiereDate?new Date(t.PremiereDate).getTime():365*(t.ProductionYear||0)*24*60*60*1e3)-o}case"date-oldest":return(e.PremiereDate?new Date(e.PremiereDate).getTime():365*(e.ProductionYear||0)*24*60*60*1e3)-(t.PremiereDate?new Date(t.PremiereDate).getTime():365*(t.ProductionYear||0)*24*60*60*1e3);case"rating-high":return(t.CommunityRating||0)-(e.CommunityRating||0);case"rating-low":return(e.CommunityRating||0)-(t.CommunityRating||0);case"critic-high":return(t.CriticRating||0)-(e.CriticRating||0);case"critic-low":return(e.CriticRating||0)-(t.CriticRating||0);default:return 0}}),e}),m=a(()=>{const e={};return d.value.forEach(t=>{e[t.Type]||(e[t.Type]=[]),e[t.Type].push(t)}),e}),g=a(()=>{const e={};return r.value.forEach(t=>{e[t.Type]=(e[t.Type]||0)+1}),e}),y=a(()=>Object.keys(g.value).sort()),v=a(()=>{const e=new Set;return r.value.forEach(t=>{t.Genres&&t.Genres.forEach(t=>e.add(t))}),Array.from(e).sort()}),h=a(()=>{const e={};return r.value.forEach(t=>{t.Genres&&t.Genres.forEach(t=>{e[t]=(e[t]||0)+1})}),e}),f=a(()=>{const e=new Set;return r.value.forEach(t=>{t.Studios&&t.Studios.forEach(t=>e.add(t.Name))}),Array.from(e).sort()}),p=a(()=>{const e={};return r.value.forEach(t=>{t.Studios&&t.Studios.forEach(t=>{e[t.Name]=(e[t.Name]||0)+1})}),e}),w=a(()=>{const e=new Set;return r.value.forEach(t=>{t.Tags&&t.Tags.forEach(t=>e.add(t))}),Array.from(e).sort()}),b=a(()=>{const e={};return r.value.forEach(t=>{t.Tags&&t.Tags.forEach(t=>{e[t]=(e[t]||0)+1})}),e}),I=async e=>{if(!e.trim())return r.value=[],void(s.value=null);i.value=!0,s.value=null;try{const o=l.value.itemTypes.length>0?l.value.itemTypes:void 0,a=await t.searchItems(e,o);console.log("results",a),r.value=(e=>{const t=new Set,o=[];for(const a of e){const e=a.Name.toLowerCase().trim();t.has(e)||(t.add(e),o.push(a))}const r=e.length-o.length;return r>0&&console.log(`[useSearch] Deduplicated ${e.length} results to ${o.length} unique items (removed ${r} duplicates by name)`),o})(a)}catch(o){s.value=o instanceof Error?o.message:"Search failed",console.error("[useSearch] Search error:",o),r.value=[]}finally{i.value=!1}};n(o,e=>{var t;e.trim()?(t=e,c&&clearTimeout(c),c=setTimeout(()=>{I(t)},300)):(r.value=[],s.value=null,i.value=!1)});return{searchQuery:o,searchResults:r,filteredResults:d,groupedResults:m,resultCounts:g,availableTypes:y,availableGenres:v,genreCounts:h,availableStudios:f,studioCounts:p,availableTags:w,tagCounts:b,isSearching:i,searchError:s,filters:l,toggleFilter:e=>{const t=l.value.itemTypes.indexOf(e);t>-1?l.value.itemTypes.splice(t,1):l.value.itemTypes.push(e)},toggleGenre:e=>{const t=l.value.genres.indexOf(e);t>-1?l.value.genres.splice(t,1):l.value.genres.push(e)},toggleStudio:e=>{const t=l.value.studios.indexOf(e);t>-1?l.value.studios.splice(t,1):l.value.studios.push(e)},toggleTag:e=>{const t=l.value.tags.indexOf(e);t>-1?l.value.tags.splice(t,1):l.value.tags.push(e)},clearFilters:()=>{l.value.itemTypes=[],l.value.genres=[],l.value.studios=[],l.value.tags=[],l.value.runtime="any",l.value.criticRating="any",l.value.communityRating="any",l.value.sortBy="relevance"},setFilter:e=>{l.value.itemTypes=e},isTypeFiltered:e=>l.value.itemTypes.includes(e),isGenreFiltered:e=>l.value.genres.includes(e),isStudioFiltered:e=>l.value.studios.includes(e),isTagFiltered:e=>l.value.tags.includes(e),setCriticRating:e=>{l.value.criticRating=e},setCommunityRating:e=>{l.value.communityRating=e},setRuntime:e=>{l.value.runtime=e},setSortBy:e=>{l.value.sortBy=e},clearSearch:()=>{o.value="",r.value=[],s.value=null,i.value=!1,c&&clearTimeout(c)},immediateSearch:async e=>{o.value=e,c&&clearTimeout(c),await I(e)}}}const Ke=1e7;let Ze=null;function Xe(r,a,i={}){const s=e(!1),l=e(""),c=e(null),u=e(null);let d=!1;const m=async e=>{if(!r.value||!e)return;l.value="",d=!1;if(e.includes(".m3u8")){const t=await(async()=>{if(!Ze){const e=await h(()=>import("./hls-vendor.3L36mPRY.js"),[],import.meta.url);Ze=e.default}return Ze})();t.isSupported()?(c.value&&c.value.destroy(),c.value=new t({debug:!1,enableWorker:!0,lowLatencyMode:!1,backBufferLength:30,maxBufferLength:60,maxMaxBufferLength:120,maxBufferSize:6e7,maxBufferHole:.5}),c.value.loadSource(e),c.value.attachMedia(r.value),c.value.on(t.Events.ERROR,(e,o)=>{if(o.fatal)switch(l.value=`[VideoPlayer] HLS error: ${o.type}`,o.type){case t.ErrorTypes.NETWORK_ERROR:c.value?.startLoad();break;case t.ErrorTypes.MEDIA_ERROR:c.value?.recoverMediaError();break;default:c.value?.destroy()}})):(console.error("[VideoPlayer] HLS is not supported in this browser"),l.value="HLS.js is not supported in this browser")}else r.value.src=e,r.value.load()},g=()=>{if(!r.value||!i.onProgress)return;const e=Math.floor(r.value.currentTime*Ke),t=r.value.paused;i.onProgress(e,t)},y=()=>{u.value&&(clearInterval(u.value),u.value=null),c.value&&(c.value.destroy(),c.value=null),d=!1};return n(a,e=>{e&&r.value&&m(e)}),t(()=>{r.value&&(r.value&&(r.value.addEventListener("error",()=>{if(r.value?.error){const e={1:"MEDIA_ERR_ABORTED - Playback was aborted",2:"MEDIA_ERR_NETWORK - Network error occurred",3:"MEDIA_ERR_DECODE - Codec not supported",4:"MEDIA_ERR_SRC_NOT_SUPPORTED - Format not supported"};l.value=e[r.value.error.code]||"Unknown error"}}),r.value.addEventListener("canplay",()=>{if(!d&&r.value){d=!0;const e=r.value.play();void 0!==e&&e.then(()=>{s.value=!0,l.value="",i.onPlaybackStart&&i.onPlaybackStart()}).catch(e=>{l.value=`Playback failed: ${e.name} - ${e.message}`,s.value=!1})}}),r.value.addEventListener("playing",()=>{s.value=!0})),a.value&&m(a.value),u.value=window.setInterval(g,1e4))}),o(()=>{y()}),{isPlaying:s,errorMessage:l,handlePlayPause:()=>{if(r.value)if(r.value.paused){const e=r.value.play();void 0!==e?e.then(()=>{s.value=!0}).catch(e=>{console.error("[VideoPlayer] Play failed:",e.name,e.message),s.value=!1}):s.value=!0}else r.value.pause(),s.value=!1},handleStop:()=>{if(!r.value)return 0;const e=Math.floor(r.value.currentTime*Ke);return i.onPlaybackStop&&i.onPlaybackStop(e),e},handleSeek:e=>{if(!r.value)return;const t=r.value.currentTime+e,o=r.value.duration;r.value.currentTime=t<0?0:t>o?o:t},initializeVideo:m,cleanup:y}}const et=e=>e/1e7,tt=e=>Math.floor(1e7*e),ot="embyflix-credits-markers",rt=e=>{try{const t=localStorage.getItem(ot);if(!t)return{};return JSON.parse(t)[e]||{}}catch(t){return console.error("[CreditsDetection] Failed to load from storage:",t),{}}},at=(e,t,o)=>{try{const r=localStorage.getItem(ot),a=r?JSON.parse(r):{};a[e]||(a[e]={}),a[e][t]=o,localStorage.setItem(ot,JSON.stringify(a)),console.log("[CreditsDetection] Saved to storage:",{seriesId:e,itemId:t,marker:o})}catch(r){console.error("[CreditsDetection] Failed to save to storage:",r)}};function nt(){const t=e(!1),o=e(0);return{isDetecting:t,detectionProgress:o,detectCreditsPassively:(e,t)=>{if(!e||!e.duration)return console.log("[CreditsDetection] Invalid video element"),()=>{};const o=e.duration,r=Math.max(.2*o,o-600),a=[];let n=0;console.log("[CreditsDetection] Starting passive detection (credits zone starts at",r.toFixed(1),"s)");const i=()=>{const i=e.currentTime;if(i<r)return;if(i-n<5)return;n=i;const s=(e=>{const t=document.createElement("canvas"),o=t.getContext("2d",{willReadFrequently:!0});if(!o)return-1;t.width=160,t.height=90;try{return o.drawImage(e,0,0,t.width,t.height),(e=>{const t=e.data;let o=0;for(let r=0;r<t.length;r+=16)o+=.299*t[r]+.587*t[r+1]+.114*t[r+2];return o/(t.length/16)})(o.getImageData(0,0,t.width,t.height))}catch(r){return console.error("[CreditsDetection] Failed to analyze frame:",r),-1}})(e);if(s>=0&&s<5&&(a.push({time:i,brightness:s}),console.log(`[CreditsDetection] Dark frame detected at ${i.toFixed(1)}s, brightness: ${s.toFixed(1)}`),a.length>=3)){const e=a[0].time,r=Math.min(i+60,o),n={CreditsStart:tt(e),CreditsEnd:tt(r),confidence:Math.min(a.length/10,1),detectionMethod:"black-frames"};console.log("[CreditsDetection] Credits detected passively:",{start:e.toFixed(1),end:r.toFixed(1),darkFrameCount:a.length,confidence:n.confidence}),t(n)}};return e.addEventListener("timeupdate",i),()=>{e.removeEventListener("timeupdate",i),console.log("[CreditsDetection] Passive detection stopped")}},getCreditsMarker:async(e,t,o,r)=>{if(r)return console.log("[CreditsDetection] Using server marker"),r;if(t){const o=rt(t);if(o[e])return console.log("[CreditsDetection] Using cached marker"),o[e];const r=Object.values(o);if(r.length>0){const e=r[0];return console.log("[CreditsDetection] Using estimated marker from same series"),{...e,confidence:.8*e.confidence}}}return null},loadCreditsFromStorage:rt,saveCreditsToStorage:at,ticksToSeconds:et,secondsToTicks:tt}}function it(t){const r=e(""),a=e(""),n=e(0),i=e=>(r.value=t.generatePlaySessionId(),a.value=e,n.value=0,console.log("[usePlaybackSession] Session initialized:",r.value),r.value),s=e=>{if(a.value&&r.value){const o=void 0!==e?e:n.value;console.log("[usePlaybackSession] Reporting playback stop at",o),t.reportPlaybackStopped(a.value,o,r.value)}},l=e=>{r.value&&(s(e),r.value="",a.value="",n.value=0,console.log("[usePlaybackSession] Session ended"))};return o(()=>{r.value&&(console.log("[usePlaybackSession] Component unmounting, ending session"),l())}),{playSessionId:r,currentItemId:a,initializeSession:i,reportStart:()=>{a.value&&r.value&&(console.log("[usePlaybackSession] Reporting playback start"),t.reportPlaybackStart(a.value,r.value))},reportProgress:(e,o)=>{a.value&&r.value&&(n.value=e,t.reportPlaybackProgress(a.value,e,o,r.value))},reportStop:s,endSession:l,switchItem:e=>(l(0),i(e))}}export{$ as A,A as T,h as _,g as a,N as b,re as c,U as d,ae as e,ne as f,nt as g,Xe as h,R as i,_ as j,O as k,he as l,De as m,Re as n,Ue as o,_e as p,He as q,Ye as r,Je as s,$e as t,y as u,Ve as v,se as w,Qe as x,te as y,it as z};
