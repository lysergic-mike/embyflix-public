import{r as e,o as t,a as r,u as a,p as o,i as n}from"./vue-vendor.C6XCEWs1.js";import{C as i}from"./components.DC4RnbFf.js";const s=()=>{try{return"undefined"!=typeof window&&void 0!==window.localStorage}catch{return!1}},l=(e,t,r)=>{if(s())try{const a=JSON.stringify({isAuthenticated:e,currentUser:t,isDemoMode:r});localStorage.setItem("embyflix-auth",a)}catch(a){if(a instanceof DOMException&&"QuotaExceededError"===a.name){console.error("[Auth] localStorage quota exceeded (5 MB limit). Attempting to clear old data...");try{localStorage.removeItem("embyflix-auth"),localStorage.setItem("embyflix-auth",JSON.stringify({isAuthenticated:e,currentUser:t,isDemoMode:r}))}catch(o){console.error("[Auth] Failed to save auth state after clearing:",o)}}else console.error("[Auth] Failed to save auth state:",a)}else console.warn("[Auth] localStorage is not available, state will not persist")},c=(()=>{if(!s())return console.warn("[Auth] localStorage is not available"),{isAuthenticated:!1,currentUser:null,isDemoMode:!1};try{const e=localStorage.getItem("embyflix-auth");if(e){const t=JSON.parse(e);return{isAuthenticated:t.isAuthenticated||!1,currentUser:t.currentUser||null,isDemoMode:t.isDemoMode||!1}}}catch(e){console.error("[Auth] Failed to load auth state:",e)}return{isAuthenticated:!1,currentUser:null,isDemoMode:!1}})(),u=e(c.isAuthenticated),d=e(c.currentUser),m=e(c.isDemoMode);function v(){return{isAuthenticated:u,currentUser:d,isDemoMode:m,login:e=>{u.value=!0,d.value=e,m.value=!1,l(!0,e,!1),u.value,d.value},logout:()=>{if(u.value=!1,d.value=null,m.value=!1,l(!1,null,!1),s())try{localStorage.removeItem("embyflix-api")}catch(e){console.error("Failed to remove API state:",e)}},enableDemoMode:()=>{m.value=!0,u.value=!0,d.value={Name:"Demo User",Id:"demo-user-id"},l(!0,d.value,!0)}}}function g(){const t=e([{Id:"demo-movies",Name:"Movies",Type:"CollectionFolder",CollectionType:"movies"},{Id:"demo-tvshows",Name:"TV Shows",Type:"CollectionFolder",CollectionType:"tvshows"},{Id:"demo-collections",Name:"Collections",Type:"CollectionFolder",CollectionType:"collections"}]),r=e([{Id:"demo-1",Name:"The Cosmic Journey",Type:"Movie",ProductionYear:2023,Overview:"An epic space adventure that follows a crew of explorers as they venture beyond the known galaxy to discover new worlds and face unexpected challenges. Their journey tests the limits of human courage and ingenuity as they encounter alien civilizations and cosmic phenomena that defy understanding.",CommunityRating:8.4,OfficialRating:"PG-13",RunTimeTicks:72e9,Genres:["Science Fiction","Adventure","Drama"],ImageUrl:"/DemoContent/Posters/joker-poster.png",HeroImageUrl:"/DemoContent/HeroImages/avengers-hero-banner.jpg"},{Id:"demo-2",Name:"Mystery at Midnight Manor",Type:"Movie",ProductionYear:2022,Overview:"A classic whodunit mystery set in a sprawling Victorian mansion. When a renowned detective is invited to a weekend party, he finds himself investigating a puzzling murder that occurred at the stroke of midnight. Every guest has secrets, and everyone is a suspect.",CommunityRating:7.9,OfficialRating:"PG",RunTimeTicks:66e9,Genres:["Mystery","Thriller","Drama"],ImageUrl:"/DemoContent/Posters/dr-strange-poster.jpg",HeroImageUrl:"/DemoContent/HeroImages/avengers-2-hero-banner.jpg"},{Id:"demo-3",Name:"Laughing Through Life",Type:"Movie",ProductionYear:2024,Overview:"A heartwarming comedy about a struggling comedian who discovers that the best jokes come from the most unexpected moments in life. Follow her journey from open mic nights to the big stage as she learns that laughter truly is the best medicine.",CommunityRating:8.1,OfficialRating:"R",RunTimeTicks:54e9,Genres:["Comedy","Drama"],ImageUrl:"/DemoContent/Posters/exorcist-poster.jpg",HeroImageUrl:"/DemoContent/HeroImages/xmen-hero-image.jpg"},{Id:"demo-4",Name:"Dragon's Peak",Type:"Movie",ProductionYear:2023,Overview:"In a realm where dragons and humans once coexisted, a young warrior must climb the legendary Dragon's Peak to prevent an ancient evil from returning. This epic fantasy adventure combines stunning visuals with a timeless tale of courage and friendship.",CommunityRating:9.2,OfficialRating:"PG-13",RunTimeTicks:9e10,Genres:["Fantasy","Adventure","Action"],ImageUrl:"/DemoContent/Posters/wayns-world-2-poster.jpg"},{Id:"demo-5",Name:"The Last Algorithm",Type:"Movie",ProductionYear:2024,Overview:"A gripping techno-thriller about a brilliant programmer who discovers a hidden algorithm that could either save humanity or bring about its downfall. As powerful corporations hunt her down, she must decide who to trust in a world where nothing is as it seems.",CommunityRating:8.7,OfficialRating:"R",RunTimeTicks:78e9,Genres:["Thriller","Science Fiction","Action"],ImageUrl:"/DemoContent/Posters/joker-poster.png"},{Id:"demo-6",Name:"Summer of '89",Type:"Movie",ProductionYear:2023,Overview:"A nostalgic coming-of-age story set during one unforgettable summer. Follow a group of friends as they navigate the challenges of growing up, discovering who they are, and learning the true meaning of friendship before everything changes forever.",CommunityRating:8.5,OfficialRating:"PG-13",RunTimeTicks:6e10,Genres:["Drama","Romance","Coming of Age"],ImageUrl:"/DemoContent/Posters/joker-poster.png"}]),a=e([{Id:"demo-tv-1",Name:"Tech Titans",Type:"Series",ProductionYear:2023,Overview:"A dramatic series following the rise and fall of tech entrepreneurs in Silicon Valley.",CommunityRating:8.8,OfficialRating:"TV-MA",Genres:["Drama","Technology"],ImageUrl:"/DemoContent/Posters/dr-strange-poster.jpg"},{Id:"demo-tv-2",Name:"Galactic Patrol",Type:"Series",ProductionYear:2022,Overview:"Space opera following an intergalactic police force protecting the universe.",CommunityRating:9,OfficialRating:"TV-14",Genres:["Science Fiction","Action","Adventure"],ImageUrl:"/DemoContent/Posters/wayns-world-2-poster.jpg"}]),o=e([{Id:"demo-collection-1",Name:"Epic Space Saga",Type:"BoxSet",Overview:"The complete collection of space adventure films.",ImageUrl:"/DemoContent/Posters/joker-poster.png",ChildCount:3},{Id:"demo-collection-2",Name:"Mystery Classics",Type:"BoxSet",Overview:"Timeless mystery and detective stories.",ImageUrl:"/DemoContent/Posters/exorcist-poster.jpg",ChildCount:5}]),n=e([{Id:"demo-tv-1-s1",Name:"Season 1",Type:"Season",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",IndexNumber:1,ProductionYear:2023},{Id:"demo-tv-1-s2",Name:"Season 2",Type:"Season",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",IndexNumber:2,ProductionYear:2024},{Id:"demo-tv-2-s1",Name:"Season 1",Type:"Season",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",IndexNumber:1,ProductionYear:2022}]),i=e([{Id:"demo-tv-1-s1e1",Name:"The Pitch",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:1,ParentIndexNumber:1,ProductionYear:2023,Overview:"A young entrepreneur pitches her revolutionary app idea to investors.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s1e2",Name:"First Hire",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:2,ParentIndexNumber:1,ProductionYear:2023,Overview:"The team struggles to find their first key employee.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s1e3",Name:"Beta Launch",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s1",IndexNumber:3,ParentIndexNumber:1,ProductionYear:2023,Overview:"The app launches to the public with unexpected results.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s2e1",Name:"Scaling Up",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:1,ParentIndexNumber:2,ProductionYear:2024,Overview:"The company faces growing pains as it expands rapidly.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s2e2",Name:"Competitor Threat",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:2,ParentIndexNumber:2,ProductionYear:2024,Overview:"A well-funded competitor emerges with a similar product.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-1-s2e3",Name:"Acquisition Offer",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:3,ParentIndexNumber:2,ProductionYear:2024,Overview:"A major tech company makes an unexpected acquisition offer.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-1-s2e4",Name:"Breaking Point",Type:"Episode",SeriesId:"demo-tv-1",SeriesName:"Tech Titans",SeasonId:"demo-tv-1-s2",IndexNumber:4,ParentIndexNumber:2,ProductionYear:2024,Overview:"The startup faces a critical decision that could make or break the company.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e1",Name:"New Recruit",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:1,ParentIndexNumber:1,ProductionYear:2022,Overview:"A rookie joins the elite Galactic Patrol force.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e2",Name:"First Mission",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:2,ParentIndexNumber:1,ProductionYear:2022,Overview:"The team investigates a distress signal from a remote planet.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e3",Name:"Alien Encounter",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:3,ParentIndexNumber:1,ProductionYear:2022,Overview:"First contact with a new alien species goes wrong.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e4",Name:"The Artifact",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:4,ParentIndexNumber:1,ProductionYear:2022,Overview:"Discovery of an ancient artifact threatens galactic peace.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"},{Id:"demo-tv-2-s1e5",Name:"Betrayal",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:5,ParentIndexNumber:1,ProductionYear:2022,Overview:"A trusted member of the patrol may be working with the enemy.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview-2.jpg"},{Id:"demo-tv-2-s1e6",Name:"The Rise of Heroes",Type:"Episode",SeriesId:"demo-tv-2",SeriesName:"Galactic Patrol",SeasonId:"demo-tv-2-s1",IndexNumber:6,ParentIndexNumber:1,ProductionYear:2022,Overview:"The patrol faces their greatest challenge yet as an ancient threat emerges.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/TvShows/episode-preview.jpg"}]),s=e([{Id:"demo-cw-1",Name:"The Rise of Heroes",Type:"Episode",SeriesName:"Galactic Patrol",SeriesId:"demo-tv-2",SeasonId:"demo-tv-2-s1",IndexNumber:6,ParentIndexNumber:1,ProductionYear:2022,Overview:"The patrol faces their greatest challenge yet as an ancient threat emerges.",RunTimeTicks:3e10,ImageUrl:"/DemoContent/HeroImages/avengers-hero-banner.jpg",UserData:{PlaybackPositionTicks:165e8,PlayedPercentage:55,Played:!1}},{Id:"demo-cw-2",Name:"The Cosmic Journey",Type:"Movie",ProductionYear:2023,Overview:"An epic space adventure that follows a crew of explorers.",RunTimeTicks:72e9,ImageUrl:"/DemoContent/HeroImages/avengers-2-hero-banner.jpg",UserData:{PlaybackPositionTicks:216e8,PlayedPercentage:30,Played:!1}},{Id:"demo-cw-3",Name:"Breaking Point",Type:"Episode",SeriesName:"Tech Titans",SeriesId:"demo-tv-1",SeasonId:"demo-tv-1-s2",IndexNumber:4,ParentIndexNumber:2,ProductionYear:2023,Overview:"The startup faces a critical decision that could make or break the company.",RunTimeTicks:33e9,ImageUrl:"/DemoContent/HeroImages/xmen-hero-image.jpg",UserData:{PlaybackPositionTicks:264e8,PlayedPercentage:80,Played:!1}}]),l=e=>[...r.value,...a.value,...o.value].find(t=>t.Id===e);return{demoLibraries:t,demoMovies:r,demoTVShows:a,demoCollections:o,getLibraries:()=>t.value,getLibraryItems:e=>"demo-movies"===e?r.value:"demo-tvshows"===e?a.value:"demo-collections"===e?o.value:[],getItemDetails:l,getCollectionItems:e=>r.value.slice(0,3),getContinueWatching:()=>s.value,getSimilarItems:(e,t=15)=>{const o=l(e);if(!o)return[];return("Series"===o.Type?a.value:r.value).filter(t=>t.Id!==e).map(e=>{const t=e.Genres?.filter(e=>o.Genres?.includes(e)).length||0;return{item:e,score:t}}).sort((e,t)=>t.score-e.score).map(({item:e})=>e).slice(0,t)},getSeasons:e=>n.value.filter(t=>t.SeriesId===e),getEpisodes:(e,t)=>i.value.filter(r=>r.SeriesId===e&&r.SeasonId===t)}}const y={},h=function(e,t,r){let a=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};const o=document.getElementsByTagName("link"),n=document.querySelector("meta[property=csp-nonce]"),i=n?.nonce||n?.getAttribute("nonce");a=e(t.map(e=>{if(e=function(e,t){return new URL(e,t).href}(e,r),e in y)return;y[e]=!0;const t=e.endsWith(".css"),a=t?'[rel="stylesheet"]':"";if(r)for(let r=o.length-1;r>=0;r--){const a=o[r];if(a.href===e&&(!t||"stylesheet"===a.rel))return}else if(document.querySelector(`link[href="${e}"]${a}`))return;const n=document.createElement("link");return n.rel=t?"stylesheet":"modulepreload",t||(n.as="script"),n.crossOrigin="",n.href=e,i&&n.setAttribute("nonce",i),document.head.appendChild(n),t?new Promise((t,r)=>{n.addEventListener("load",t),n.addEventListener("error",()=>r(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function o(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(t=>{for(const e of t||[])"rejected"===e.status&&o(e.reason);return e().catch(o)})},f=()=>{try{return"undefined"!=typeof window&&void 0!==window.localStorage}catch{return!1}},p=(()=>{if(!f())return console.warn("[EmbyAPI] localStorage is not available"),{serverUrl:"",userId:"",accessToken:""};try{const e=localStorage.getItem("embyflix-api");if(e){const t=JSON.parse(e);return t.serverUrl,t.userId,t.accessToken,{serverUrl:t.serverUrl||"",userId:t.userId||"",accessToken:t.accessToken||""}}}catch(e){console.error("[EmbyAPI] Failed to load API state:",e)}return{serverUrl:"",userId:"",accessToken:""}})(),w=new Map,I=new Map,b=(e,t={})=>`${e}?${Object.keys(t).sort().map(e=>`${e}=${t[e]}`).join("&")}`,S=e=>{const t=I.get(e);return t&&(e=>!!e&&Date.now()-e.timestamp<3e5)(t)?t.data:(t&&I.delete(e),null)},T=(e,t)=>{I.set(e,{data:t,timestamp:Date.now()})},k=()=>{I.clear(),w.clear()},P=e(p.serverUrl),E=e(p.userId),C=e(p.accessToken),M=e(!1),D=e(null);function N(){const e=()=>{const e={"Content-Type":"application/json","X-Emby-Authorization":'MediaBrowser Client="EmbyFlix", Device="Samsung TV", DeviceId="embyflix-tizen", Version="1.0.0"'};return C.value&&(e["X-Emby-Token"]=C.value),e},t=async(t,r)=>{M.value=!0,D.value=null;try{let a=`${P.value}/emby/Shows/${t}/Episodes?UserId=${E.value}&Fields=Overview,PrimaryImageAspectRatio`;r&&(a+=`&SeasonId=${r}`);const o=await fetch(a,{headers:e(),mode:"cors",credentials:"omit"});if(!o.ok)throw new Error(`Failed to get episodes: ${o.status}`);return(await o.json()).Items||[]}catch(a){throw D.value=a instanceof Error?a.message:"Unknown error",console.error("[EmbyAPI] getEpisodes error:",a),a}finally{M.value=!1}},r=async t=>{M.value=!0,D.value=null;try{const r=`${P.value}/emby/Users/${E.value}/Items/${t}?fields=ShareLevel`,a=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)throw console.error("[EmbyAPI] Failed to get item details. Status:",a.status),new Error(`Failed to get item details: ${a.status}`);const o=await a.json();return o}catch(r){throw D.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] getItemDetails error:",r),r}finally{M.value=!1}},a=(e,t="Primary",r=300)=>{const a=new URLSearchParams({maxWidth:r.toString(),quality:"90",api_key:C.value});return`${P.value}/emby/Items/${e}/Images/${t}?${a.toString()}`};return{serverUrl:P,userId:E,accessToken:C,isLoading:M,error:D,authenticateByName:async(t,r,a="")=>{M.value=!0,D.value=null;try{P.value=t;const o=`${t}/emby/Users/AuthenticateByName`,n={Username:r,Pw:a},i=await fetch(o,{method:"POST",headers:e(),body:JSON.stringify(n),mode:"cors",credentials:"omit"});if(!i.ok){console.error("[EmbyAPI] Authentication failed with status:",i.status);let e="Authentication failed";throw 401===i.status?e="Invalid username or password":404===i.status?e="Server not found. Check the server URL":i.status>=500&&(e="Server error. Please try again later"),new Error(e)}const s=await i.json();return C.value=s.AccessToken,E.value=s.User.Id,E.value,s.User.Name,P.value,((e,t,r)=>{if(f())try{const a=JSON.stringify({serverUrl:e,userId:t,accessToken:r});localStorage.setItem("embyflix-api",a)}catch(a){if(a instanceof DOMException&&"QuotaExceededError"===a.name){console.error("[EmbyAPI] localStorage quota exceeded (5 MB limit). Attempting to clear old data...");try{localStorage.removeItem("embyflix-api"),localStorage.setItem("embyflix-api",JSON.stringify({serverUrl:e,userId:t,accessToken:r}))}catch(o){console.error("[EmbyAPI] Failed to save API state after clearing:",o)}}else console.error("[EmbyAPI] Failed to save API state:",a)}else console.warn("[EmbyAPI] localStorage is not available, API state will not persist")})(P.value,E.value,C.value),s}catch(o){let e="Unknown error";throw o instanceof TypeError&&o.message.includes("fetch")?e="Cannot connect to server.":o instanceof Error&&(e=o.message),D.value=e,console.error("[EmbyAPI] Authentication error:",o),new Error(e)}finally{M.value=!1}},getViews:async()=>{const t=b("views",{userId:E.value}),r=S(t);if(r)return r;M.value=!0,D.value=null;try{const r=`${P.value}/emby/Users/${E.value}/Views`,a=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)throw new Error(`Failed to get views: ${a.status}`);const o=(await a.json()).Items||[];return T(t,o),o}catch(a){throw D.value=a instanceof Error?a.message:"Unknown error",a}finally{M.value=!1}},getItems:async(t,r=null)=>{const a=b("items",{parentId:t,itemType:r||"all",userId:E.value}),o=S(a);if(o)return o;M.value=!0,D.value=null;try{const o=[];let n=0;const i=300;let s=0;do{let a=`${P.value}/emby/Users/${E.value}/Items?ParentId=${t}&Recursive=true&StartIndex=${n}&Limit=${i}`;r&&(a+=`&IncludeItemTypes=${r}`),a+="&Fields=UserData,Genres,Studios,Overview,CommunityRating,CriticRating,ProductionYear";const l=await fetch(a,{headers:e(),mode:"cors",credentials:"omit"});if(!l.ok)throw console.error("[EmbyAPI] Failed to get items. Status:",l.status),new Error(`Failed to get items: ${l.status}`);const c=await l.json();s=c.TotalRecordCount||0;const u=c.Items||[];u.length,o.length,u.length,o.push(...u),n+=i}while(n<s);return o.length,T(a,o),o}catch(n){throw D.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getItems error:",n),n}finally{M.value=!1}},getCollectionItems:async t=>{const r=b("collection",{collectionId:t,userId:E.value}),a=S(r);if(a)return a;M.value=!0,D.value=null;try{const a=[];let o=0;const n=300;let i=0;do{const r=`${P.value}/emby/Users/${E.value}/Items?ParentId=${t}&StartIndex=${o}&Limit=${n}&Fields=UserData`,s=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!s.ok)throw new Error(`Failed to get collection items: ${s.status}`);const l=await s.json();i=l.TotalRecordCount||0;const c=l.Items||[];a.push(...c),o+=n}while(o<i);return a.length,T(r,a),a}catch(o){throw D.value=o instanceof Error?o.message:"Unknown error",o}finally{M.value=!1}},getSeasons:async t=>{M.value=!0,D.value=null;try{const r=`${P.value}/emby/Shows/${t}/Seasons?UserId=${E.value}`,a=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)throw new Error(`Failed to get seasons: ${a.status}`);return(await a.json()).Items||[]}catch(r){throw D.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] getSeasons error:",r),r}finally{M.value=!1}},getEpisodes:t,getNextEpisode:async e=>{if("Episode"!==e.Type||!e.SeriesId)return null;try{const r=await t(e.SeriesId),a=r.findIndex(t=>t.Id===e.Id);return-1===a||a===r.length-1?null:r[a+1]}catch(r){return console.error("[EmbyAPI] getNextEpisode error:",r),null}},getPreviousEpisode:async e=>{if("Episode"!==e.Type||!e.SeriesId)return null;try{const r=await t(e.SeriesId),a=r.findIndex(t=>t.Id===e.Id);return a<=0?null:r[a-1]}catch(r){return console.error("[EmbyAPI] getPreviousEpisode error:",r),null}},getContinueWatching:async()=>{const t=b("continueWatching",{userId:E.value}),r=S(t);if(r)return r;M.value=!0,D.value=null;try{const r=`${P.value}/emby/Users/${E.value}/Items/Resume?Limit=10&Recursive=true&Fields=PrimaryImageAspectRatio,BasicSyncInfo&ImageTypeLimit=1&EnableImageTypes=Primary&MediaTypes=Video`,a=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)throw new Error(`Failed to get continue watching: ${a.status}`);const o=(await a.json()).Items||[];return o.length,T(t,o),o}catch(a){throw D.value=a instanceof Error?a.message:"Unknown error",console.error("[EmbyAPI] getContinueWatching error:",a),a}finally{M.value=!1}},getRecentlyWatched:async(t=20,r=["Movie","Series"])=>{const a=b("recentlyWatched",{userId:E.value,limit:t,itemTypes:r.join(",")}),o=S(a);if(o)return o;M.value=!0,D.value=null;try{const o=`${P.value}/emby/Users/${E.value}/Items?Limit=${t}&Recursive=true&SortBy=DatePlayed&SortOrder=Descending&Filters=IsPlayed&Fields=PrimaryImageAspectRatio,BasicSyncInfo&ImageTypeLimit=1&EnableImageTypes=Primary&IncludeItemTypes=${r.join(",")}`;r.join(",");const n=await fetch(o,{headers:e(),mode:"cors",credentials:"omit"});if(!n.ok)throw new Error(`Failed to get recently watched: ${n.status}`);const i=(await n.json()).Items||[];return i.length,T(a,i),i}catch(n){throw D.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getRecentlyWatched error:",n),n}finally{M.value=!1}},getItemDetails:r,getMediaSources:async t=>{try{const r=`${P.value}/emby/Items/${t}/PlaybackInfo?UserId=${E.value}`,a=await fetch(r,{method:"POST",headers:e(),body:JSON.stringify({DeviceProfile:{MaxStreamingBitrate:14e7}}),mode:"cors",credentials:"omit"});if(!a.ok)throw new Error(`Failed to get media sources: ${a.status}`);const o=await a.json();return o.MediaSources||[]}catch(r){throw console.error("[EmbyAPI] getMediaSources error:",r),r}},getPlaybackInfo:async(t,r,a)=>{try{const o=new URLSearchParams({UserId:E.value,StartTimeTicks:"0",IsPlayback:"true",AutoOpenLiveStream:"true",MaxStreamingBitrate:"140000000"});void 0!==r&&o.append("AudioStreamIndex",r.toString()),void 0!==a&&o.append("SubtitleStreamIndex",a.toString());const n=`${P.value}/emby/Items/${t}/PlaybackInfo?${o.toString()}`,i=await fetch(n,{method:"POST",headers:e(),body:JSON.stringify({DeviceProfile:{MaxStreamingBitrate:14e7,MusicStreamingTranscodingBitrate:192e3}}),mode:"cors",credentials:"omit"});if(!i.ok){console.error("[EmbyAPI] Failed to get playback info. Status:",i.status);const e=await i.text();throw console.error("[EmbyAPI] Error response:",e),new Error(`Failed to get playback info: ${i.status}`)}const s=await i.json();if(s.ErrorCode)throw console.error("[EmbyAPI] Playback error code:",s.ErrorCode),new Error(`Playback error: ${s.ErrorCode}`);return s}catch(o){throw console.error("[EmbyAPI] getPlaybackInfo error:",o),o}},getStreamUrl:e=>{const t=new URLSearchParams({Static:"true",MediaSourceId:e,DeviceId:"EmbyFlix",api_key:C.value});return`${P.value}/emby/Videos/${e}/stream.mp4?${t.toString()}`},generatePlaySessionId:()=>`${Date.now()}_${Math.random().toString(36).substring(2,11)}`,reportPlaybackStart:async(t,r)=>{try{const a=`${P.value}/emby/Sessions/Playing`,o={ItemId:t,PlaySessionId:r,MediaSourceId:t,CanSeek:!0,IsMuted:!1,IsPaused:!1,PositionTicks:0,PlayMethod:"DirectStream"};await fetch(a,{method:"POST",headers:e(),body:JSON.stringify(o),mode:"cors",credentials:"omit"})}catch(a){console.error("Failed to report playback start:",a)}},reportPlaybackProgress:async(t,r,a,o)=>{try{const n=`${P.value}/emby/Sessions/Playing/Progress`,i={ItemId:t,PlaySessionId:o,MediaSourceId:t,PositionTicks:r,IsPaused:a,IsMuted:!1,PlayMethod:"DirectStream"};await fetch(n,{method:"POST",headers:e(),body:JSON.stringify(i),mode:"cors",credentials:"omit"})}catch(n){console.error("Failed to report playback progress:",n)}},reportPlaybackStopped:async(t,a,o)=>{try{const n=`${P.value}/emby/Sessions/Playing/Stopped`,i={ItemId:t,PlaySessionId:o,MediaSourceId:t,PositionTicks:a,PlayMethod:"DirectStream"};await fetch(n,{method:"POST",headers:e(),body:JSON.stringify(i),mode:"cors",credentials:"omit"}),h(async()=>{const{useAnalytics:e}=await Promise.resolve().then(()=>K);return{useAnalytics:e}},void 0,import.meta.url).then(({useAnalytics:e})=>{e().trackPlaybackFromTicks(t,a,r)}).catch(e=>{console.error("[EmbyAPI] Failed to load analytics module:",e)})}catch(n){console.error("Failed to report playback stopped:",n)}},getImageUrl:a,getHeroImageUrl:async t=>{const r=`${t}-hero`;if(w.has(r))return w.get(r);try{const a=`${P.value}/emby/Users/${E.value}/Items/${t}?Fields=RemoteTrailers,ProviderIds`,o=await fetch(a,{headers:e(),cache:"default"});if(o.ok){const a=await o.json();if(a.ProviderIds?.Tmdb){const a=`${P.value}/emby/Items/${t}/RemoteImages?ProviderName=TheMovieDb&Type=Backdrop&IncludeAllLanguages=false`,o=await fetch(a,{headers:e(),cache:"default"});if(o.ok){const e=await o.json();if(e.Images&&e.Images.length>0){const t=e.Images[0].Url;return w.set(r,t),t}}}}}catch(s){}const o=new URLSearchParams({maxWidth:"1920",quality:"90",api_key:C.value}),n=`${P.value}/emby/Items/${t}/Images/Backdrop?${o.toString()}`;try{if((await fetch(n,{method:"HEAD",cache:"force-cache"})).ok)return w.set(r,n),n}catch{}const i=a(t,"Primary",1920);return w.set(r,i),i},searchItems:async(t,r)=>{if(!t.trim())return[];const a=b("search",{query:t.toLowerCase(),itemTypes:r?.join(",")||"all",userId:E.value}),o=S(a);if(o)return o;M.value=!0,D.value=null;try{const o=new URLSearchParams({SearchTerm:t,Recursive:"true",Fields:"UserData,CriticRating,CommunityRating,OfficialRating,Studios,TagItems,Genres,Name,ProviderIds",Limit:"100",UserId:E.value});r&&r.length>0&&o.append("IncludeItemTypes",r.join(","));const n=`${P.value}/emby/Users/${E.value}/Items?${o.toString()}`,i=await fetch(n,{headers:e(),mode:"cors",credentials:"omit"});if(!i.ok)throw console.error("[EmbyAPI] Failed to search items. Status:",i.status),new Error(`Failed to search items: ${i.status}`);const s=(await i.json()).Items||[];return s.length,T(a,s),s}catch(n){throw D.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] searchItems error:",n),n}finally{M.value=!1}},searchItemsByExternalId:async(t,r,a)=>{if(!t&&!r)return[];const o=b("search-external-id",{imdbId:t||"",tmdbId:r||"",itemTypes:a?.join(",")||"all",userId:E.value}),n=S(o);if(n)return n;M.value=!0,D.value=null;try{const n=new URLSearchParams({Recursive:"true",Fields:"UserData,CriticRating,CommunityRating,OfficialRating,Studios,TagItems,Genres,Name,ProviderIds,ProductionYear",Limit:"100",UserId:E.value});t&&n.append("AnyProviderIdEquals",`imdb.${t}`),r&&n.append("AnyProviderIdEquals",`tmdb.${r}`),a&&a.length>0&&n.append("IncludeItemTypes",a.join(","));const i=`${P.value}/emby/Users/${E.value}/Items?${n.toString()}`,s=await fetch(i,{headers:e(),mode:"cors",credentials:"omit"});if(!s.ok)throw console.error("[EmbyAPI] Failed to search by external ID. Status:",s.status),new Error(`Failed to search by external ID: ${s.status}`);const l=(await s.json()).Items||[];return l.length,T(o,l),l}catch(i){throw D.value=i instanceof Error?i.message:"Unknown error",console.error("[EmbyAPI] searchItemsByExternalId error:",i),i}finally{M.value=!1}},getSimilarItems:async(t,r=15)=>{const a=b("similar-items",{itemId:t,limit:r,userId:E.value}),o=S(a);if(o)return o;M.value=!0,D.value=null;try{const o=new URLSearchParams({UserId:E.value,Limit:r.toString(),Fields:"UserData,CriticRating,CommunityRating,OfficialRating,ProductionYear"}),n=`${P.value}/emby/Items/${t}/Similar?${o.toString()}`,i=await fetch(n,{headers:e(),mode:"cors",credentials:"omit"});if(!i.ok)throw console.error("[EmbyAPI] Failed to get similar items. Status:",i.status),new Error(`Failed to get similar items: ${i.status}`);const s=(await i.json()).Items||[];return s.length,T(a,s),s}catch(n){throw D.value=n instanceof Error?n.message:"Unknown error",console.error("[EmbyAPI] getSimilarItems error:",n),n}finally{M.value=!1}},markAsPlayed:async t=>{M.value=!0,D.value=null;try{const r=`${P.value}/emby/Users/${E.value}/PlayedItems/${t}`,a=await fetch(r,{method:"POST",headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)throw console.error("[EmbyAPI] Failed to mark as played. Status:",a.status),new Error(`Failed to mark as played: ${a.status}`);const o=b("continueWatching",{userId:E.value});I.delete(o)}catch(r){throw D.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] markAsPlayed error:",r),r}finally{M.value=!1}},markAsUnplayed:async t=>{M.value=!0,D.value=null;try{const r=`${P.value}/emby/Users/${E.value}/PlayedItems/${t}`,a=await fetch(r,{method:"DELETE",headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)throw console.error("[EmbyAPI] Failed to mark as unplayed. Status:",a.status),new Error(`Failed to mark as unplayed: ${a.status}`);const o=b("continueWatching",{userId:E.value});I.delete(o)}catch(r){throw D.value=r instanceof Error?r.message:"Unknown error",console.error("[EmbyAPI] markAsUnplayed error:",r),r}finally{M.value=!1}},getIntroSkipMarkers:async t=>{try{const r=`${P.value}/emby/Users/${E.value}/Items/${t}`,a=await fetch(r,{headers:e(),mode:"cors",credentials:"omit"});if(!a.ok)return console.error("[EmbyAPI] Failed to get intro markers. Status:",a.status),null;const o=await a.json();if(o.Chapters&&Array.isArray(o.Chapters)){const e=o.Chapters.find(e=>"IntroStart"===e.MarkerType||"Intro"===e.Name||"Intro"===e.ChapterType);if(e){const t=e.StartPositionTicks||0,r=e.EndPositionTicks||t+6e8;return{IntroStart:t,IntroEnd:r}}}return void 0!==o.IntroStart&&void 0!==o.IntroEnd?(o.IntroStart,o.IntroEnd,{IntroStart:o.IntroStart,IntroEnd:o.IntroEnd}):null}catch(r){return console.error("[EmbyAPI] getIntroSkipMarkers error:",r),null}},clearCache:k}}const _={ARROW_LEFT:{keyName:"ArrowLeft",keyCode:37,category:"navigation",description:"Left arrow / Navigate left",recommendedUse:"Spatial navigation left"},ARROW_UP:{keyName:"ArrowUp",keyCode:38,category:"navigation",description:"Up arrow / Navigate up",recommendedUse:"Spatial navigation up"},ARROW_RIGHT:{keyName:"ArrowRight",keyCode:39,category:"navigation",description:"Right arrow / Navigate right",recommendedUse:"Spatial navigation right"},ARROW_DOWN:{keyName:"ArrowDown",keyCode:40,category:"navigation",description:"Down arrow / Navigate down",recommendedUse:"Spatial navigation down"},ENTER:{keyName:"Enter",keyCode:13,category:"navigation",description:"Enter / OK button",recommendedUse:"Select/activate focused element"},BACK:{keyName:"Back",keyCode:10009,category:"navigation",description:"Back button",recommendedUse:"Navigate to previous page/screen"},NUM_0:{keyName:"0",keyCode:48,category:"numeric",description:"Number 0",recommendedUse:"Quick jump to content, input fields"},NUM_1:{keyName:"1",keyCode:49,category:"numeric",description:"Number 1",recommendedUse:"Quick jump to content, input fields"},NUM_2:{keyName:"2",keyCode:50,category:"numeric",description:"Number 2",recommendedUse:"Quick jump to content, input fields"},NUM_3:{keyName:"3",keyCode:51,category:"numeric",description:"Number 3",recommendedUse:"Quick jump to content, input fields"},NUM_4:{keyName:"4",keyCode:52,category:"numeric",description:"Number 4",recommendedUse:"Quick jump to content, input fields"},NUM_5:{keyName:"5",keyCode:53,category:"numeric",description:"Number 5",recommendedUse:"Quick jump to content, input fields"},NUM_6:{keyName:"6",keyCode:54,category:"numeric",description:"Number 6",recommendedUse:"Quick jump to content, input fields"},NUM_7:{keyName:"7",keyCode:55,category:"numeric",description:"Number 7",recommendedUse:"Quick jump to content, input fields"},NUM_8:{keyName:"8",keyCode:56,category:"numeric",description:"Number 8",recommendedUse:"Quick jump to content, input fields"},NUM_9:{keyName:"9",keyCode:57,category:"numeric",description:"Number 9",recommendedUse:"Quick jump to content, input fields"},MINUS:{keyName:"Minus",keyCode:189,category:"numeric",description:"Minus/Dash key",recommendedUse:"Special numeric input"},VOLUME_UP:{keyName:"VolumeUp",keyCode:447,category:"volume",description:"Volume up button",recommendedUse:"Increase volume (handled by TV OS, but can be intercepted)"},VOLUME_DOWN:{keyName:"VolumeDown",keyCode:448,category:"volume",description:"Volume down button",recommendedUse:"Decrease volume (handled by TV OS, but can be intercepted)"},VOLUME_MUTE:{keyName:"VolumeMute",keyCode:449,category:"volume",description:"Mute/unmute button",recommendedUse:"Toggle mute (handled by TV OS, but can be intercepted)"},CHANNEL_UP:{keyName:"ChannelUp",keyCode:427,category:"channel",description:"Channel up button",recommendedUse:"Navigate to next episode/video in playlist"},CHANNEL_DOWN:{keyName:"ChannelDown",keyCode:428,category:"channel",description:"Channel down button",recommendedUse:"Navigate to previous episode/video in playlist"},CHANNEL_LIST:{keyName:"ChannelList",keyCode:10073,category:"channel",description:"Channel list button",recommendedUse:"Show playlist/episode list"},PREVIOUS_CHANNEL:{keyName:"PreviousChannel",keyCode:10190,category:"channel",description:"Previous channel button",recommendedUse:"Jump back to previous content"},MEDIA_PLAY_PAUSE:{keyName:"MediaPlayPause",keyCode:10252,category:"media",description:"Play/Pause toggle button",recommendedUse:"Toggle video playback"},MEDIA_REWIND:{keyName:"MediaRewind",keyCode:412,category:"media",description:"Rewind button",recommendedUse:"Seek backward 10-30 seconds"},MEDIA_FAST_FORWARD:{keyName:"MediaFastForward",keyCode:417,category:"media",description:"Fast forward button",recommendedUse:"Seek forward 10-30 seconds"},MEDIA_PLAY:{keyName:"MediaPlay",keyCode:415,category:"media",description:"Play button",recommendedUse:"Resume/start playback"},MEDIA_PAUSE:{keyName:"MediaPause",keyCode:19,category:"media",description:"Pause button",recommendedUse:"Pause playback"},MEDIA_STOP:{keyName:"MediaStop",keyCode:413,category:"media",description:"Stop button",recommendedUse:"Stop playback and return to content list"},MEDIA_RECORD:{keyName:"MediaRecord",keyCode:416,category:"media",description:"Record button",recommendedUse:"Add to watchlist/favorites"},MEDIA_TRACK_PREVIOUS:{keyName:"MediaTrackPrevious",keyCode:10232,category:"media",description:"Previous track/episode button",recommendedUse:"Jump to previous episode"},MEDIA_TRACK_NEXT:{keyName:"MediaTrackNext",keyCode:10233,category:"media",description:"Next track/episode button",recommendedUse:"Jump to next episode"},COLOR_RED:{keyName:"ColorF0Red",keyCode:403,category:"color",description:"Red color button (F0)",recommendedUse:"Filter by genre, quick action 1"},COLOR_GREEN:{keyName:"ColorF1Green",keyCode:404,category:"color",description:"Green color button (F1)",recommendedUse:"Sort options, quick action 2"},COLOR_YELLOW:{keyName:"ColorF2Yellow",keyCode:405,category:"color",description:"Yellow color button (F2)",recommendedUse:"Search, quick action 3"},COLOR_BLUE:{keyName:"ColorF3Blue",keyCode:406,category:"color",description:"Blue color button (F3)",recommendedUse:"Settings/options, quick action 4"},MENU:{keyName:"Menu",keyCode:18,category:"system",description:"Menu button",recommendedUse:"Open main menu/sidebar"},TOOLS:{keyName:"Tools",keyCode:10135,category:"system",description:"Tools button",recommendedUse:"Open context menu/options"},INFO:{keyName:"Info",keyCode:457,category:"system",description:"Info button",recommendedUse:"Show content details/metadata"},SOURCE:{keyName:"Source",keyCode:10072,category:"system",description:"Source button",recommendedUse:"Not typically used in apps"},EXIT:{keyName:"Exit",keyCode:10182,category:"system",description:"Exit button",recommendedUse:"Exit app or close modal"},CAPTION:{keyName:"Caption",keyCode:10221,category:"system",description:"Caption/Subtitle button",recommendedUse:"Toggle subtitles on/off"},E_MANUAL:{keyName:"E-Manual",keyCode:10146,category:"system",description:"Electronic manual button",recommendedUse:"Show help/instructions"},THREE_D:{keyName:"3D",keyCode:10199,category:"system",description:"3D mode button",recommendedUse:"Not typically used"},EXTRA:{keyName:"Extra",keyCode:10253,category:"system",description:"Extra content button",recommendedUse:"Show extras/bonus content"},PICTURE_SIZE:{keyName:"PictureSize",keyCode:10140,category:"system",description:"Picture size/aspect ratio button",recommendedUse:"Toggle fullscreen or aspect ratio"},SOCCER:{keyName:"Soccer",keyCode:10228,category:"system",description:"Soccer mode button",recommendedUse:"Sports-specific features (if applicable)"},TELETEXT:{keyName:"Teletext",keyCode:10200,category:"system",description:"Teletext button",recommendedUse:"Not typically used in apps"},MTS:{keyName:"MTS",keyCode:10195,category:"system",description:"Multi-track sound button",recommendedUse:"Switch audio tracks"},SEARCH:{keyName:"Search",keyCode:10225,category:"system",description:"Search button",recommendedUse:"Open search interface"},GUIDE:{keyName:"Guide",keyCode:458,category:"system",description:"TV Guide button",recommendedUse:"Show content guide/schedule"}};function R(e,t){return e.keyCode===t.keyCode||e.key===t.keyName}function U(e){const t=(r=e.keyCode,Object.values(_).find(e=>e.keyCode===r));var r;return t?`[TizenKey] ${t.keyName} (${t.keyCode}) - ${t.description}`:`[TizenKey] Unknown key: keyCode=${e.keyCode}, key='${e.key}'`}function A(){const a=e(!1);let o=null,n=[],i=0;let s=!1,l=null;const c=(e,t)=>{const r=t.querySelector("[data-nav-scrollable]");if(!r)return;const a=e.getBoundingClientRect(),o=r.getBoundingClientRect(),n=a.width,i=3*n,s=a.left-o.left+r.scrollLeft,l=s+n,c=r.scrollLeft,u=c+o.width;s-i<c?r.scrollTo({left:Math.max(0,s-i),behavior:"smooth"}):l+i>u&&r.scrollTo({left:l+i-o.width,behavior:"smooth"})},u=()=>(()=>{const e=Date.now();if(e-i>500){const t='button:not([disabled]):not([tabindex="-1"]), a[href], input:not([disabled]), [tabindex]:not([tabindex="-1"]), .media-card, .nav-item, .hero-slider-wrapper, .player-control-btn, .up-next-item';n=Array.from(document.querySelectorAll(t)),i=e}return n})(),d=e=>e?document.querySelector(`[data-slider-id="${e}"]`):document.querySelector(".hero-slider-wrapper"),m=e=>{e.classList.contains("hero-slider-wrapper")&&(a.value=!0),e.getAttribute("aria-label"),(new Error).stack,e.focus({preventScroll:!0}),document.activeElement?.getAttribute("aria-label"),e.scrollIntoView({behavior:"smooth",block:"center"})},v=(e,t,r)=>{const a=e.getBoundingClientRect(),o={x:a.left+a.width/2,y:a.top+a.height/2};let n=null,i=1/0;for(const s of t){if(s===e)continue;const t=s.getBoundingClientRect(),a={x:t.left+t.width/2,y:t.top+t.height/2},l=a.x-o.x,c=a.y-o.y;let u=!1;switch(r){case"up":u=c<-10;break;case"down":u=c>10;break;case"left":u=l<-10;break;case"right":u=l>10}if(!u)continue;const d=s.classList.contains("hero-slider-wrapper");if(d&&("up"===r||"down"===r)){const e=o.x,r=t.left,a=t.right;if(e>=r&&e<=a){const e=Math.abs(c);e<i&&(i=e,n=s);continue}}const m=Math.sqrt(l*l+c*c);let v=0;v="up"===r||"down"===r?d?.1*Math.abs(l):.5*Math.abs(l):.5*Math.abs(c);const g=m+v;g<i&&(i=g,n=s)}return n},g=(e,t)=>{a.value=!1;const r=d(t),n=u();if(!r||0===n.length)return;if("left"===e){o=r;const e=document.querySelector(".sidebar .nav-item");if(e)return void m(e)}const i=r.getBoundingClientRect(),s=i.top,l=i.bottom;if("up"===e){let e=null,t=1/0;for(const a of n){if(a===r)continue;if(a.closest('[data-nav-zone="sidebar"]'))continue;const o=a.getBoundingClientRect();if(o.bottom<=s+10){const r=s-o.bottom;r<t&&(t=r,e=a)}}if(e)return void m(e)}let c=null,v=1/0;for(const a of n){if(a===r)continue;if(a.closest('[data-nav-zone="sidebar"]'))continue;const e=a.getBoundingClientRect();if(e.top>=l-10){const t=e.top-l;t<v&&(v=t,c=a)}}c?m(c):n.length>0&&m(n[0])},y=e=>{if(!l&&!s){s=!0,l=window.setTimeout(()=>{l=null},50);try{if(a.value){if("up"===e||"down"===e){const t=document.activeElement,r=t?.getAttribute("data-slider-id")||void 0;g(e,r)}if("left"===e){const e=d();if(e&&e===document.activeElement)return}return}const t=u(),r=document.activeElement;if(!r)return void(t.length>0&&m(t[0]));const o=(e=>{const t=e.closest("[data-nav-zone]");return t?t.getAttribute("data-nav-zone"):null})(r);"media-row"===o?h(r,e,t):"movie-grid"===o?f(r,e,t):"genre-filter"===o?p(r,e,t):"sidebar"===o?w(r,e,t):"player-controls"===o||"skip-controls"===o||"media-sidebar"===o?I(r,e,t):b(r,e,t)}finally{setTimeout(()=>{s=!1},16)}}},h=(e,t,r)=>{const a=e.closest('[data-nav-zone="media-row"]');if(!a)return;const n=(e=>Array.from(e.querySelectorAll(".media-card")))(a),i=n.indexOf(e.closest(".media-card"));if("left"===t)if(0===i){o=e;const t=document.querySelector(".sidebar .nav-item");t&&m(t)}else i>0&&(m(n[i-1]),c(n[i-1],a));else if("right"===t)i<n.length-1&&(m(n[i+1]),c(n[i+1],a));else if("up"===t||"down"===t){const a=r.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),o=v(e,a,t);o&&m(o)}},f=(e,t,r)=>{const a=e.closest('[data-nav-zone="movie-grid"]');if(!a)return;const n=Array.from(a.querySelectorAll(".media-card")),i=e.closest(".media-card"),s=n.indexOf(i);if(-1===s)return;const{row:l,col:c,colCount:u}=((e,t)=>{const r=t.indexOf(e);if(-1===r)return{row:0,col:0,colCount:1};const a=e.closest('[data-nav-zone="movie-grid"]');if(!a)return{row:0,col:0,colCount:1};const o=a.clientWidth,n=e.getBoundingClientRect().width,i=Math.max(1,Math.floor(o/(n+16)));return{row:Math.floor(r/i),col:r%i,colCount:i}})(i,n);if("left"===t)if(0===c){if(0===l){o=e;const t=document.querySelector(".sidebar .nav-item");t&&m(t)}}else s>0&&m(n[s-1]);else if("right"===t)s<n.length-1&&m(n[s+1]);else if("up"===t)if(0===l){const t=r.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),a=v(e,t,"up");a&&m(a)}else{const e=s-u;e>=0&&m(n[e])}else if("down"===t){const e=s+u;e<n.length&&m(n[e])}},p=(e,t,r)=>{if("left"===t){const t=e.closest('[data-nav-zone="genre-filter"]');if(t){if(0===Array.from(t.querySelectorAll(".genre-pill")).indexOf(e)){o=e;const t=document.querySelector(".sidebar .nav-item");t&&m(t)}}}else if("down"===t){const t=e.closest('[data-nav-zone="genre-filter"]');if(!t)return;const a=t.nextElementSibling;if(a&&a.hasAttribute("data-nav-zone")&&"media-row"===a.getAttribute("data-nav-zone")){const e=a.querySelector(".media-card");if(e)return void m(e)}const o=r.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),n=v(e,o,"down");n&&m(n)}else if("up"===t){const t=r.filter(e=>!e.closest('[data-nav-zone="sidebar"]')),a=v(e,t,"up");a&&m(a)}},w=(e,t,r)=>{if("left"===t){if(null!==e.querySelector("i.fa-search")){const e=document.querySelector(".sidebar .nav-item:has(i.fa-home)");e&&m(e)}}else if("right"===t){if(o&&document.body.contains(o)){const e=o;o=null,e.classList.contains("hero-slider-wrapper")&&(a.value=!0),m(e);const t=e.closest('[data-nav-zone="media-row"]');if(t){const r=e.closest(".media-card");r&&c(r,t)}return}const e=Array.from(document.querySelectorAll(".hero-slider-wrapper")).filter(e=>{const t=e.getBoundingClientRect();return t.height>0&&t.width>0});if(e.length>0)return a.value=!0,void m(e[0]);const t=document.querySelector("#content-container");if(t){const e=t.querySelector(".media-card, .genre-pill, button, a[href]");if(e)return void m(e)}}else if("up"===t||"down"===t){const a=r.filter(e=>e.closest('[data-nav-zone="sidebar"]')),o=a.indexOf(e);if("down"===t){if(o>=0&&o<a.length-1){const r=v(e,a,t);r&&m(r)}}else{if(null!==e.querySelector("i.fa-home")){const e=document.querySelector(".search-input");if(e)return void m(e)}const r=v(e,a,t);r&&m(r)}}},I=(e,t,r)=>{const a=e.closest('[data-nav-zone="player-controls"], [data-nav-zone="skip-controls"], [data-nav-zone="media-sidebar"]');if(!a)return;if("media-sidebar"===a.getAttribute("data-nav-zone")){if("left"===t){const e=document.querySelector(".back-btn");e&&m(e)}else if("up"===t){const t=Array.from(document.querySelectorAll(".up-next-item")),r=t.indexOf(e);if(0===r){const e=document.querySelector(".volume-menu-container .icon-btn");e&&m(e)}else r>0&&m(t[r-1])}else if("down"===t){const t=Array.from(document.querySelectorAll(".up-next-item")),r=t.indexOf(e);r>=0&&r<t.length-1&&m(t[r+1])}return}const o=Array.from(a.querySelectorAll(".player-control-btn")).filter(e=>{const t=e.getBoundingClientRect();return t.width>0&&t.height>0});if("left"===t||"right"===t){if("skip-controls"===a.getAttribute("data-nav-zone")){if("right"===t){const e=document.querySelector(".subtitle-menu-container .icon-btn");e&&m(e)}else if("left"===t){const e=document.querySelector(".back-btn");e&&m(e)}return}if("player-controls"===a.getAttribute("data-nav-zone")){const r=[...o].sort((e,t)=>{const r=e.getBoundingClientRect(),a=t.getBoundingClientRect();return r.left-a.left});let a=e;if(!a.classList.contains("player-control-btn")){const t=e.closest(".player-control-btn");t&&(a=t)}const n=r.indexOf(a);return-1===n?void(r.length>0&&m(r[0])):void("right"===t?n<r.length-1&&m(r[n+1]):"left"===t&&n>0&&m(r[n-1]))}if(e.closest(".top-bar")){if(e===document.querySelector(".volume-menu-container .icon-btn")||e.closest(".volume-menu-container")){if("left"===t){const e=document.querySelector(".back-btn");e&&m(e)}return}}if(e.closest(".control-buttons-row")){const r=[document.querySelector(".subtitle-menu-container .icon-btn"),document.querySelector(".quality-menu-container .icon-btn"),document.querySelector(".control-buttons-row > .icon-btn")].filter(e=>e&&e.getBoundingClientRect().width>0);let a=e;if(!a.classList.contains("icon-btn")){const t=e.closest(".icon-btn");t&&(a=t)}const o=r.indexOf(a);if("right"===t)o>=0&&o<r.length-1&&m(r[o+1]);else if("left"===t)if(o>0)m(r[o-1]);else if(0===o){const e=document.querySelector('[data-nav-zone="skip-controls"] .player-control-btn');if(e){const t=e.getBoundingClientRect();if(t.width>0&&t.height>0)return void m(e)}}return}}else if("up"===t||"down"===t){if("skip-controls"===a.getAttribute("data-nav-zone")){if("up"===t){const e=document.querySelector(".back-btn");e&&m(e)}else if("down"===t){const e=document.querySelector('[data-nav-zone="player-controls"]');if(e){const t=e.querySelector(".control-btn-large");if(t)m(t);else{const t=e.querySelector(".player-control-btn");t&&m(t)}}}return}if(e.closest(".control-buttons-row")){if("up"===t){const e=document.querySelector(".up-next-item");e&&m(e)}return}if("player-controls"===a.getAttribute("data-nav-zone")){const e=document.querySelector('[data-nav-zone="skip-controls"] .player-control-btn');if(e&&"up"===t){const t=e.getBoundingClientRect();t.width>0&&t.height>0&&m(e)}}}},b=(e,t,r)=>{if("right"===t){const t=d();if(t&&(!e||e.closest(".sidebar")))return a.value=!0,void m(t)}if(!r.includes(e))return void(r.length>0&&m(r[0]));const o=v(e,r,t);o&&m(o)},S=e=>{U(e);if("Escape"===e.key||"Return"===e.key||"GoBack"===e.key||"Back"===e.key||R(e,_.BACK)||461===e.keyCode){e.preventDefault();const t=new CustomEvent("app-back-navigation");return void window.dispatchEvent(t)}const t="ArrowUp"===e.key||R(e,_.ARROW_UP),r="ArrowDown"===e.key||R(e,_.ARROW_DOWN),a="ArrowLeft"===e.key||R(e,_.ARROW_LEFT),o="ArrowRight"===e.key||R(e,_.ARROW_RIGHT);if(t)return e.preventDefault(),void y("up");if(r)return e.preventDefault(),void y("down");if(a)return e.preventDefault(),void y("left");if(o)return e.preventDefault(),void y("right");if("Enter"===e.key||R(e,_.ENTER)){const e=document.activeElement;return void(e&&("BUTTON"===e.tagName||e.classList.contains("player-control-btn")))}},T=e=>{const t=e.detail,r=e.type.replace("exit","").replace("Slider","");"left"===t?g("left",r):"down"===t?g("down",r):"up"===t&&g("up",r)};return t(()=>{window.addEventListener("keydown",S),window.addEventListener("exitHeroSlider",T),window.addEventListener("exitBecauseYouWatchedSlider",T);const e=u();e.length>0&&m(e[0])}),r(()=>{window.removeEventListener("keydown",S),window.removeEventListener("exitHeroSlider",T),window.removeEventListener("exitBecauseYouWatchedSlider",T)}),{handleNavigation:y,isSliderMode:a}}const F="viewingHistory",x="browseHistory",O="searchHistory",$="userProfile",L="notInterested";const B=new class{db=null;initPromise=null;async init(){return this.db?this.db:(this.initPromise||(this.initPromise=new Promise((e,t)=>{const r=indexedDB.open("EmbyFlixPersonalization",1);r.onerror=()=>{console.error("IndexedDB error:",r.error),t(r.error)},r.onsuccess=()=>{this.db=r.result,e(this.db)},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(F)){const e=t.createObjectStore(F,{keyPath:"id",autoIncrement:!0});e.createIndex("itemId","itemId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("itemType","itemType",{unique:!1})}if(!t.objectStoreNames.contains(x)){const e=t.createObjectStore(x,{keyPath:"id",autoIncrement:!0});e.createIndex("itemId","itemId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}if(!t.objectStoreNames.contains(O)){const e=t.createObjectStore(O,{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("query","query",{unique:!1})}if(t.objectStoreNames.contains($)||t.createObjectStore($,{keyPath:"id"}),!t.objectStoreNames.contains(L)){t.createObjectStore(L,{keyPath:"itemId"}).createIndex("timestamp","timestamp",{unique:!1})}}})),this.initPromise)}async add(e,t){const r=await this.init();return new Promise((a,o)=>{const n=r.transaction([e],"readwrite").objectStore(e).add(t);n.onsuccess=()=>a(n.result),n.onerror=()=>o(n.error)})}async put(e,t){const r=await this.init();return new Promise((a,o)=>{const n=r.transaction([e],"readwrite").objectStore(e).put(t);n.onsuccess=()=>a(),n.onerror=()=>o(n.error)})}async get(e,t){const r=await this.init();return new Promise((a,o)=>{const n=r.transaction([e],"readonly").objectStore(e).get(t);n.onsuccess=()=>a(n.result),n.onerror=()=>o(n.error)})}async getAll(e){const t=await this.init();return new Promise((r,a)=>{const o=t.transaction([e],"readonly").objectStore(e).getAll();o.onsuccess=()=>r(o.result),o.onerror=()=>a(o.error)})}async getAllByIndex(e,t,r){const a=await this.init();return new Promise((o,n)=>{const i=a.transaction([e],"readonly").objectStore(e).index(t),s=r?i.getAll(r):i.getAll();s.onsuccess=()=>o(s.result),s.onerror=()=>n(s.error)})}async delete(e,t){const r=await this.init();return new Promise((a,o)=>{const n=r.transaction([e],"readwrite").objectStore(e).delete(t);n.onsuccess=()=>a(),n.onerror=()=>o(n.error)})}async clear(e){const t=await this.init();return new Promise((r,a)=>{const o=t.transaction([e],"readwrite").objectStore(e).clear();o.onsuccess=()=>r(),o.onerror=()=>a(o.error)})}async count(e){const t=await this.init();return new Promise((r,a)=>{const o=t.transaction([e],"readonly").objectStore(e).count();o.onsuccess=()=>r(o.result),o.onerror=()=>a(o.error)})}async getRecent(e,t){const r=await this.init(),a=new Date;return a.setDate(a.getDate()-t),new Promise((t,o)=>{const n=r.transaction([e],"readonly").objectStore(e).index("timestamp"),i=IDBKeyRange.lowerBound(a),s=n.getAll(i);s.onsuccess=()=>t(s.result),s.onerror=()=>o(s.error)})}};async function j(e){return B.getRecent(F,e)}async function W(e){return B.getRecent(x,e)}async function G(e){return B.getRecent(O,e)}async function q(){return(await B.getAll(L)).map(e=>e.itemId)}const Y=e(!1),z=e([]),H=e([]),V=e([]);function J(){return{isInitialized:Y,viewingHistory:z,browseHistory:H,searchHistory:V,init:async function(){if(!Y.value)try{const[e,t,r]=await Promise.all([j(180),W(180),G(180)]);z.value=e,H.value=t,V.value=r,Y.value=!0,e.length,t.length,r.length}catch(e){console.error("[ViewingHistory] Failed to initialize:",e)}},trackViewing:async function(e){try{const t={...e,timestamp:new Date},r=await async function(e){const t={itemId:e.itemId,itemName:e.itemName,itemType:e.itemType,genres:[...e.genres],studios:[...e.studios],timestamp:new Date(e.timestamp),watchDuration:e.watchDuration,completionPercent:e.completionPercent,communityRating:e.communityRating,criticRating:e.criticRating,productionYear:e.productionYear};return B.add(F,t)}(t);return z.value.push({...t,id:r}),e.itemName,e.completionPercent,e.watchDuration,r}catch(t){return console.error("[ViewingHistory] Failed to track viewing:",t),null}},trackBrowse:async function(e){try{const t={...e,timestamp:new Date},r=await async function(e){const t={itemId:e.itemId,itemName:e.itemName,itemType:e.itemType,genres:[...e.genres],studios:[...e.studios],timestamp:new Date(e.timestamp),timeSpent:e.timeSpent};return B.add(x,t)}(t);return H.value.push({...t,id:r}),e.itemName,e.timeSpent,r}catch(t){return console.error("[ViewingHistory] Failed to track browse:",t),null}},trackSearch:async function(e){try{const t={...e,timestamp:new Date},r=await async function(e){const t={query:e.query,timestamp:new Date(e.timestamp),filters:e.filters?{genres:e.filters.genres?[...e.filters.genres]:void 0,studios:e.filters.studios?[...e.filters.studios]:void 0,itemTypes:e.filters.itemTypes?[...e.filters.itemTypes]:void 0}:void 0,clickedItemId:e.clickedItemId};return B.add(O,t)}(t);return V.value.push({...t,id:r}),e.query,e.filters,e.clickedItemId,r}catch(t){return console.error("[ViewingHistory] Failed to track search:",t),null}},getViewingStats:function(){const e=z.value.reduce((e,t)=>e+t.watchDuration,0),t=z.value.filter(e=>e.completionPercent>=90).length,r=z.value.length>0?z.value.reduce((e,t)=>e+t.completionPercent,0)/z.value.length:0,a=new Map;z.value.forEach(e=>{e.genres.forEach(e=>{a.set(e,(a.get(e)||0)+1)})});const o=Array.from(a.entries()).sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e,t])=>({genre:e,count:t}));return{totalItems:z.value.length,totalWatchTime:e,completedItems:t,avgCompletionRate:r,topGenres:o}},hasEnoughData:function(e=1){return z.value.length>=e},getMostWatchedGenres:function(e=10){const t=new Map;return z.value.forEach(e=>{e.genres.forEach(e=>{t.set(e,(t.get(e)||0)+1)})}),Array.from(t.entries()).sort((e,t)=>t[1]-e[1]).slice(0,e)},getMostWatchedStudios:function(e=10){const t=new Map;return z.value.forEach(e=>{e.studios.forEach(e=>{t.set(e,(t.get(e)||0)+1)})}),Array.from(t.entries()).sort((e,t)=>t[1]-e[1]).slice(0,e)}}}function Q(t){const a=J(),o=e(0),n=e(null),i=e=>{n.value=e,o.value=Date.now()},s=(e,r)=>{if(t?.value)return;const n=r??(o.value>0?Math.floor((Date.now()-o.value)/1e3):0);n>=2&&a.trackBrowse({itemId:e.Id,itemName:e.Name,itemType:e.Type,genres:e.Genres||[],studios:(e.Studios||[]).map(e=>e.Name),timeSpent:n})},l=(e,r,o)=>{if(t?.value)return;const n=o>0?r/o*100:0;a.trackViewing({itemId:e.Id,itemName:e.Name,itemType:e.Type,genres:e.Genres||[],studios:(e.Studios||[]).map(e=>e.Name),watchDuration:r,completionPercent:Math.min(n,100),communityRating:e.CommunityRating,criticRating:e.CriticRating,productionYear:e.ProductionYear})};return{startBrowseTracking:i,trackBrowseEvent:s,trackCurrentBrowseEvent:()=>{n.value&&o.value>0&&s(n.value)},trackSearchEvent:(e,r,o)=>{t?.value||a.trackSearch({query:e,filters:r||{},clickedItemId:o})},trackPlaybackEvent:l,trackPlaybackFromTicks:async(e,r,a)=>{if(!t?.value)try{const t=await a(e),o=Math.floor(r/1e7),n=t.RunTimeTicks?Math.floor(t.RunTimeTicks/1e7):0;l(t,o,n)}catch(o){console.error("[Analytics] Failed to track playback event:",o)}},autoTrackBrowsing:e=>{i(e.value);const t=()=>{e.value&&o.value>0&&s(e.value)};return r(t),t},reset:()=>{o.value=0,n.value=null},pageLoadTime:o,currentItem:n}}const K=Object.freeze(Object.defineProperty({__proto__:null,useAnalytics:Q},Symbol.toStringTag,{value:"Module"}));function Z(t,r,a){const o=e(new Map),n=(e,o="Primary",n=i.MEDIA_CARD_DEFAULT)=>{if(a.value){const t=r.getItemDetails(e);return t?.ImageUrl||""}return t.getImageUrl(e,o,n)},s=e=>o.value.get(e)||"",l=(e,t)=>{o.value.set(e,t)},c=e=>{if(!e)return;(new Image).src=e};return{getImageUrl:n,getHeroImageUrl:async(e,o)=>{if(a.value){const t=r.getItemDetails(e);return t?.HeroImageUrl||t?.ImageUrl||""}if(o){const t=o.find(t=>t.Id===e);if(t?.HeroImageUrl)return t.HeroImageUrl}return await t.getHeroImageUrl(e)},loadImageUrl:async(e,t,r)=>{if(t){const r=t(e);return r instanceof Promise?await r:r}const a=r?.find(t=>t.Id===e);return a?.ImageUrl||""},getCachedImageUrl:s,cacheImageUrl:l,preloadImage:c,preloadImages:e=>{e.forEach(e=>c(e))},clearCache:()=>{o.value.clear()},resolveAndCacheImageUrl:(e,t="Primary",r=i.MEDIA_CARD_DEFAULT)=>{const a=s(e);if(a)return a;const o=n(e,t,r);return l(e,o),o},imageUrlCache:o}}function X(){return{formatRuntime:e=>{if(!e)return"";const t=Math.floor(e/6e8),r=Math.floor(t/60),a=t%60;return r>0?`${r}h ${a}m`:`${a}m`},formatRating:e=>{if(!e)return"";return`${"".repeat(Math.round(e/2))} ${e.toFixed(1)}`},formatDate:(e,t)=>{if(!e)return"";try{const r=new Date(e),a={year:"numeric",month:"short",day:"numeric"};return r.toLocaleDateString(void 0,t||a)}catch(r){return console.error("[useFormatters] Error formatting date:",r),e}},formatFileSize:(e,t=2)=>{if(!e||0===e)return"0 Bytes";const r=t<0?0:t,a=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,a)).toFixed(r))} ${["Bytes","KB","MB","GB","TB","PB"][a]}`},formatDuration:e=>{if(!e||e<0)return"00:00";const t=Math.floor(e/3600),r=Math.floor(e%3600/60),a=Math.floor(e%60),o=e=>e.toString().padStart(2,"0");return t>0?`${o(t)}:${o(r)}:${o(a)}`:`${o(r)}:${o(a)}`},formatYearRange:(e,t)=>{if(!e)return"";const r=new Date(e).getFullYear();if(!t)return`${r}-Present`;const a=new Date(t).getFullYear();return r===a?`${r}`:`${r}-${a}`},truncateText:(e,t=100)=>e?e.length<=t?e:`${e.substring(0,t).trim()}...`:"",formatTypeName:e=>({Movie:"Movies",Series:"TV Shows",Episode:"Episodes",Season:"Seasons",MusicAlbum:"Albums",Audio:"Music",Person:"People",BoxSet:"Collections"}[e]||e),getTypeIcon:e=>({Movie:"fas fa-film",Series:"fas fa-tv",Episode:"fas fa-video",Season:"fas fa-layer-group",MusicAlbum:"fas fa-compact-disc",Audio:"fas fa-music",Person:"fas fa-user",BoxSet:"fas fa-box"}[e]||"fas fa-file")}}function ee(a,o={}){const n=e(!1),{threshold:i=.1,rootMargin:s="0px",onEnter:l,onExit:c}=o;let u=null;return t(()=>{a.value&&(u=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?(n.value=!0,l?.()):(n.value=!1,c?.())})},{threshold:i,rootMargin:s}),u.observe(a.value))}),r(()=>{u&&u.disconnect()}),{isVisible:n}}const te=e([]);function re(){const e=a(),t=(e,t,r,a)=>{te.value.push({route:e,query:t,params:r,state:a}),te.value.length};return{pushToHistory:t,goBack:()=>{if(0===te.value.length)return!1;te.value.pop();const t=te.value[te.value.length-1];return t?(e.push({name:t.route,query:t.query,params:t.params}),!0):(e.push({name:"Home"}),!0)},peekHistory:()=>te.value[te.value.length-1],clearHistory:()=>{te.value=[]},getStackSize:()=>te.value.length,replaceCurrentEntry:(e,r,a,o)=>{te.value.length>0?te.value[te.value.length-1]={route:e,query:r,params:a,state:o}:t(e,r,a,o)},navigationStack:te}}const ae="tmdb_api_key",oe="tmdb_v4_access_token";let ne="0aed65eb34fa5c354e10385b63ab9e94",ie="eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwYWVkNjVlYjM0ZmE1YzM1NGUxMDM4NWI2M2FiOWU5NCIsIm5iZiI6MTc2MjI4MTY3MS40NDgsInN1YiI6IjY5MGE0OGM3YmJiOTA1OTU3ODFhMDg5ZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.JPZun-_M7uQTLQ0waF831FvEillgSTZ3ZkCh7HAlhDE";const se="https://image.tmdb.org/t/p",le=new Map,ce=e=>{const t=le.get(e);return t&&(e=>!!e&&Date.now()-e.timestamp<6e5)(t)?t.data:(t&&le.delete(e),null)},ue=(e,t)=>{le.set(e,{data:t,timestamp:Date.now()})};function de(){const t=e(!1),r=e(null),a=()=>!!ne,o=async(e,t={},r=3)=>{if(!a())throw new Error("TMDB API key not configured");const n=new URL(`${4===r?"https://api.themoviedb.org/4":"https://api.themoviedb.org/3"}${e}`),i={};if(4===r){if(!ie)return console.warn("[TMDB] V4 access token not configured, falling back to v3"),o(e,t,3);i.Authorization=`Bearer ${ie}`,i["Content-Type"]="application/json;charset=utf-8"}else n.searchParams.append("api_key",ne);Object.entries(t).forEach(([e,t])=>{n.searchParams.append(e,t)});const s=await fetch(n.toString(),{mode:"cors",credentials:"omit",headers:i});if(!s.ok){const e=await s.text();throw console.error(`[TMDB v${r}] API error:`,s.status,e),new Error(`TMDB API error: ${s.status}`)}return await s.json()},n=async()=>{const e="movie-genres",a=ce(e);if(a)return a;t.value=!0,r.value=null;try{const t=await o("/genre/movie/list");return ue(e,t.genres),t.genres}catch(n){throw r.value=n instanceof Error?n.message:"Unknown error",console.error("[TMDB] getMovieGenres error:",n),n}finally{t.value=!1}},i=async()=>{const e="tv-genres",a=ce(e);if(a)return a;t.value=!0,r.value=null;try{const t=await o("/genre/tv/list");return ue(e,t.genres),t.genres}catch(n){throw r.value=n instanceof Error?n.message:"Unknown error",console.error("[TMDB] getTvGenres error:",n),n}finally{t.value=!1}},s=async(e,t="US")=>{const r=`movie-watch-providers-${e}-${t}`,a=ce(r);if(null!==a)return a;try{const a=(await o(`/movie/${e}/watch/providers`)).results[t]||null;return ue(r,a),a}catch(n){return console.error("[TMDB] getMovieWatchProviders error:",n),ue(r,null),null}},l=async(e,t="US")=>{const r=`tv-watch-providers-${e}-${t}`,a=ce(r);if(null!==a)return a;try{const a=(await o(`/tv/${e}/watch/providers`)).results[t]||null;return ue(r,a),a}catch(n){return console.error("[TMDB] getTvWatchProviders error:",n),ue(r,null),null}};return{isLoading:t,error:r,isConfigured:a(),setApiKey:e=>{ne=e,localStorage.setItem(ae,e)},clearApiKey:()=>{ne="",localStorage.removeItem(ae)},setV4AccessToken:e=>{ie=e,localStorage.setItem(oe,e)},clearV4AccessToken:()=>{ie="",localStorage.removeItem(oe)},makeRequest:o,getTrendingMovies:async(e="day",a=1)=>{const n=`trending-movies-${e}-${a}`,i=ce(n);if(i)return i;t.value=!0,r.value=null;try{const t=await o(`/trending/movie/${e}`,{page:a.toString()});return t.results=t.results.map(e=>({...e,media_type:"movie"})),ue(n,t),t}catch(s){throw r.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingMovies error:",s),s}finally{t.value=!1}},getTrendingTvShows:async(e="day",a=1)=>{const n=`trending-tv-${e}-${a}`,i=ce(n);if(i)return i;t.value=!0,r.value=null;try{const t=await o(`/trending/tv/${e}`,{page:a.toString()});return t.results=t.results.map(e=>({...e,media_type:"tv"})),ue(n,t),t}catch(s){throw r.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingTvShows error:",s),s}finally{t.value=!1}},getTrendingAll:async(e="day",a=1)=>{const n=`trending-all-${e}-${a}`,i=ce(n);if(i)return i;t.value=!0,r.value=null;try{const t=await o(`/trending/all/${e}`,{page:a.toString()});return ue(n,t),t}catch(s){throw r.value=s instanceof Error?s.message:"Unknown error",console.error("[TMDB] getTrendingAll error:",s),s}finally{t.value=!1}},getPopularMovies:async(e=1)=>{const a=`popular-movies-${e}`,n=ce(a);if(n)return n;t.value=!0,r.value=null;try{const t=await o("/movie/popular",{page:e.toString()});return t.results=t.results.map(e=>({...e,media_type:"movie"})),ue(a,t),t}catch(i){throw r.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] getPopularMovies error:",i),i}finally{t.value=!1}},getPopularTvShows:async(e=1)=>{const a=`popular-tv-${e}`,n=ce(a);if(n)return n;t.value=!0,r.value=null;try{const t=await o("/tv/popular",{page:e.toString()});return t.results=t.results.map(e=>({...e,media_type:"tv"})),ue(a,t),t}catch(i){throw r.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] getPopularTvShows error:",i),i}finally{t.value=!1}},getMovieGenres:n,getTvGenres:i,getAllGenres:async()=>{const e="all-genres",a=ce(e);if(a)return a;t.value=!0,r.value=null;try{const[t,r]=await Promise.all([n(),i()]),a={movie:t,tv:r};return ue(e,a),a}catch(o){throw r.value=o instanceof Error?o.message:"Unknown error",console.error("[TMDB] getAllGenres error:",o),o}finally{t.value=!1}},getMovieDetails:async(e,a=["videos","images","credits","recommendations"])=>{const n=a.join(","),i=`movie-details-${e}-${n}`,s=ce(i);if(s)return s;t.value=!0,r.value=null;try{const t=await o(`/movie/${e}`,{append_to_response:n});return ue(i,t),t}catch(l){throw r.value=l instanceof Error?l.message:"Unknown error",console.error("[TMDB] getMovieDetails error:",l),l}finally{t.value=!1}},getTvDetails:async(e,a=["videos","images","credits","recommendations"])=>{const n=a.join(","),i=`tv-details-${e}-${n}`,s=ce(i);if(s)return s;t.value=!0,r.value=null;try{const t=await o(`/tv/${e}`,{append_to_response:n});return ue(i,t),t}catch(l){throw r.value=l instanceof Error?l.message:"Unknown error",console.error("[TMDB] getTvDetails error:",l),l}finally{t.value=!1}},getMovieWatchProviders:s,getTvWatchProviders:l,getWatchProvidersBatch:async(e,t="US",r=10)=>{const a=new Map,o=async e=>{try{const r="movie"===e.mediaType?await s(e.id,t):await l(e.id,t);a.set(e.id,r)}catch(r){console.error(`[TMDB] Error fetching watch providers for ${e.mediaType} ${e.id}:`,r),a.set(e.id,null)}},n=[];for(let i=0;i<e.length;i+=r){const t=e.slice(i,i+r);n.push(...t.map(o)),i+r<e.length&&(await Promise.all(n),n.length=0)}return await Promise.all(n),e.length,a.size,a},discoverMovies:async(e={})=>{const a=`discover-movies-${JSON.stringify(e)}`,n=ce(a);if(n)return n;t.value=!0,r.value=null;try{const t={};Object.entries(e).forEach(([e,r])=>{void 0!==r&&(t[e]=String(r))});const r=await o("/discover/movie",t);return r.results=r.results.map(e=>({...e,media_type:"movie"})),ue(a,r),r}catch(i){throw r.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] discoverMovies error:",i),i}finally{t.value=!1}},discoverTvShows:async(e={})=>{const a=`discover-tv-${JSON.stringify(e)}`,n=ce(a);if(n)return n;t.value=!0,r.value=null;try{const t={};Object.entries(e).forEach(([e,r])=>{void 0!==r&&(t[e]=String(r))});const r=await o("/discover/tv",t);return r.results=r.results.map(e=>({...e,media_type:"tv"})),ue(a,r),r}catch(i){throw r.value=i instanceof Error?i.message:"Unknown error",console.error("[TMDB] discoverTvShows error:",i),i}finally{t.value=!1}},getPosterUrl:(e,t="w500")=>e?`${se}/${t}${e}`:null,getBackdropUrl:(e,t="w1280")=>e?`${se}/${t}${e}`:null,getProviderLogoUrl:(e,t="w92")=>e?`${se}/${t}${e}`:null,clearCache:()=>{le.clear()}}}const me=e(null),ve=e(!1);function ge(){const e=J();async function t(){if(ve.value)return me.value;try{const e=await async function(){return B.get($,"current")}();return e&&(me.value={...e,genreWeights:new Map(Object.entries(e.genreWeights)),studioWeights:new Map(Object.entries(e.studioWeights))},ve.value=!0,me.value.genreWeights.size,me.value.studioWeights.size,me.value.totalItems),me.value}catch(e){return console.error("[Preferences] Failed to load profile:",e),null}}async function r(){e.isInitialized.value||await e.init();const t=e.viewingHistory.value;if(0===t.length)return null;t.length;const r=new Date,a=new Map,o=new Map;let n=0,i=0,s=0,l=0,c=0,u=0,d=0;t.forEach(e=>{const t=(r.getTime()-new Date(e.timestamp).getTime())/864e5,m=Math.pow(.5,t/30)*(e.completionPercent/100);n+=e.watchDuration,e.genres.forEach(t=>{const r=a.get(t)||{genre:t,weight:0,totalWatches:0,avgCompletionRate:0};r.weight+=m,r.totalWatches+=1,r.avgCompletionRate=(r.avgCompletionRate*(r.totalWatches-1)+e.completionPercent)/r.totalWatches,a.set(t,r)}),e.studios.forEach(e=>{const t=o.get(e)||{studio:e,weight:0,totalWatches:0};t.weight+=m,t.totalWatches+=1,o.set(e,t)}),e.communityRating&&(i+=e.communityRating,l++),e.criticRating&&(s+=e.criticRating,c++),e.watchDuration&&(u+=e.watchDuration,d++)});const m=Math.max(...Array.from(a.values()).map(e=>e.weight));a.forEach((e,t)=>{e.weight=e.weight/m,a.set(t,e)});const v=Math.max(...Array.from(o.values()).map(e=>e.weight));o.forEach((e,t)=>{e.weight=e.weight/v,o.set(t,e)});const g=l>0?i/l:0,y=c>0?s/c:0,h=d>0?u/d:0,f=t.map(e=>e.watchDuration).filter(e=>e>0),p=f.length>0?Math.min(...f):0,w=f.length>0?Math.max(...f):0;me.value={id:"current",genreWeights:a,studioWeights:o,lastUpdated:r,totalWatchTime:n,totalItems:t.length,avgCommunityRating:g,avgCriticRating:y,preferredRuntime:{min:p,max:w,avg:h}};const I={id:"current",genreWeights:Object.fromEntries(Array.from(a.entries())),studioWeights:Object.fromEntries(Array.from(o.entries())),lastUpdated:r,totalWatchTime:n,totalItems:t.length,avgCommunityRating:g,avgCriticRating:y,preferredRuntime:{min:p,max:w,avg:h}};return await async function(e){return B.put($,e)}(I),ve.value=!0,a.size,o.size,t.length,g.toFixed(1),y.toFixed(1),me.value}function a(){if(!me.value)return!1;return((new Date).getTime()-new Date(me.value.lastUpdated).getTime())/36e5<24}return{profile:me,isLoaded:ve,loadProfile:t,buildProfile:r,updateProfile:async function(){return await t(),a()||await r(),me.value},getTopGenres:function(e=10){return me.value?Array.from(me.value.genreWeights.values()).sort((e,t)=>t.weight-e.weight).slice(0,e):[]},getTopStudios:function(e=10){return me.value?Array.from(me.value.studioWeights.values()).sort((e,t)=>t.weight-e.weight).slice(0,e):[]},getGenreWeight:function(e){return me.value&&me.value.genreWeights.get(e)?.weight||0},getStudioWeight:function(e){return me.value&&me.value.studioWeights.get(e)?.weight||0},isProfileFresh:a,getLeastWatchedGenres:function(e,t=5){if(!me.value||0===e.length)return e.slice(0,t);const r=new Set(me.value.genreWeights.keys()),a=e.filter(e=>!r.has(e));if(a.length>=t)return a.slice(0,t);const o=Array.from(me.value.genreWeights.values()).sort((e,t)=>e.weight-t.weight).slice(0,t-a.length).map(e=>e.genre);return[...a,...o]}}}const ye=.4,he=.2,fe=.2,pe=.1,we=.1;function Ie(e,t){const r=function(e,t){if(!e||0===e.length)return 0;let r=0,a=0;return e.forEach(e=>{const o=t.genreWeights.get(e);o&&(a+=o.weight),r+=1}),r>0?a/r:0}(e.Genres,t),a=function(e,t){if(!e||0===e.length)return 0;let r=0,a=0;return e.forEach(e=>{const o=t.studioWeights.get(e.Name);o&&(a+=o.weight),r+=1}),r>0?a/r:0}(e.Studios,t),o=function(e,t){if(!e)return 0;const r=e/100;if(t.avgCriticRating>0){const e=t.avgCriticRating/100;return 1-Math.abs(r-e)}return r}(e.CriticRating,t),n=function(e,t){if(!e)return 0;const r=e/10;if(t.avgCommunityRating>0){const e=t.avgCommunityRating/10;return 1-Math.abs(r-e)}return r}(e.CommunityRating,t),i=function(e){if(!e)return 0;const t=(new Date).getFullYear()-e;return Math.max(0,1-.05*t)}(e.ProductionYear),s=void 0!==e.CriticRating&&e.CriticRating>0,l=void 0!==e.CommunityRating&&e.CommunityRating>0;let c=0;return c+=r*ye,c+=a*he,c+=i*pe,s?c+=o*fe:(c+=r*(.6*fe),c+=a*(.4*fe)),l?c+=n*we:(c+=r*(.6*we),c+=a*(.4*we)),{itemId:e.Id,score:c,breakdown:{genreMatch:r,studioMatch:a,criticRating:o,recencyBoost:i,communityRating:n},isDiscovery:!1}}function be(e,t){let r=0;const a=new Set(e.Genres||[]),o=new Set(t.Genres||[]),n=new Set([...a].filter(e=>o.has(e))),i=new Set([...a,...o]);if(i.size>0){r+=.7*(n.size/i.size)}const s=new Set((e.Studios||[]).map(e=>e.Name)),l=new Set((t.Studios||[]).map(e=>e.Name)),c=new Set([...s].filter(e=>l.has(e))),u=new Set([...s,...l]);if(u.size>0){r+=.3*(c.size/u.size)}return r}function Se(e){return[...e].sort((e,t)=>t.score-e.score)}const Te=e(!1);function ke(){const e=J(),t=ge(),r=o(()=>e.isInitialized.value&&t.isLoaded.value&&e.hasEnoughData(1));async function a(){Te.value||(await e.init(),e.hasEnoughData(1)?(await t.loadProfile(),t.profile.value&&t.isProfileFresh()||await t.buildProfile(),Te.value=!0):Te.value=!0)}return{isInitialized:Te,isReady:r,init:a,getRecommendations:async function(e,o={}){const{limit:n=20,excludeWatched:i=!0,minScore:s=.2,discoveryPercent:l=10}=o;if(Te.value||await a(),!r.value)return[];const c=t.profile.value;if(!c)return[];const u=await q(),d=new Set(u);let m=e.filter(e=>!d.has(e.Id)&&(!i||!e.UserData?.Played));if(Object.keys(c.genreWeights||{}).slice(0,10),Object.keys(c.studioWeights||{}).slice(0,10),m.length>0){const e=m[0];e.Genres,e.Studios?.map(e=>e.Name)}const v=m.map(e=>Ie(e,c));if(v.length,v.length>0){const e=v.map(e=>e.score).sort((e,t)=>t-e);e[0]?.toFixed(3),e[Math.floor(e.length/2)]?.toFixed(3),e[e.length-1]?.toFixed(3)}const g=function(e,t){return e.filter(e=>e.score>=t)}(v,s);g.length,v.length;const y=Se(g),h=Math.floor(n*l/100),f=n-h,p=y.slice(0,f),w=function(e,r,a,o){const n=new Set;e.forEach(e=>{e.Genres?.forEach(e=>n.add(e))});const i=t.getLeastWatchedGenres(Array.from(n),Math.ceil(a/2)),s=e.filter(e=>!o.has(e.Id)&&e.Genres?.some(e=>i.includes(e))),l=s.map(e=>{const t=Ie(e,r);return t.isDiscovery=!0,t}).filter(e=>e.score>=.1);return Se(l).slice(0,a)}(m,c,h,new Set(p.map(e=>e.itemId))),I=function(e){const t=[...e];for(let r=t.length-1;r>0;r--){const e=Math.floor(Math.random()*(r+1));[t[r],t[e]]=[t[e],t[r]]}return t}([...p,...w]),b=new Map(m.map(e=>[e.Id,e])),S=I.map(e=>b.get(e.itemId)).filter(e=>void 0!==e);return S.length,p.length,w.length,S},getSimilarItems:async function(e,t,r={}){const{limit:a=15,excludeWatched:o=!0}=r,n=await q(),i=new Set(n),s=t.filter(t=>t.Id!==e.Id&&(!i.has(t.Id)&&(!o||!t.UserData?.Played))).map(t=>({item:t,similarity:be(e,t)})).sort((e,t)=>t.similarity-e.similarity).slice(0,a).map(e=>e.item);return s.length,e.Name,s},rankSearchResults:async function(e){if(!r.value)return e;const a=t.profile.value;return a?e.map(e=>({item:e,score:Ie(e,a).score})).sort((e,t)=>t.score-e.score).map(e=>e.item):e},updateAfterViewing:async function(){await t.buildProfile()}}}const Pe="embyflix-tmdb-match-cache",Ee=864e5;function Ce(){const e=e=>{try{const t=Array.from(e.entries());localStorage.setItem(Pe,JSON.stringify(t)),e.size}catch(t){console.error("[useMediaMatching] Failed to save TMDB match cache:",t)}},t=(()=>{try{const e=localStorage.getItem(Pe);if(!e)return new Map;const t=JSON.parse(e),r=Date.now(),a=t.filter(([e,t])=>r-t.timestamp<Ee);return a.length,new Map(a)}catch(e){return console.error("[useMediaMatching] Failed to load TMDB match cache:",e),new Map}})(),r=e=>e.toLowerCase().replace(/^(the|a|an)\s+/i,"").replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim();return{matchTmdbWithEmby:async(a,o,n=!1)=>{if(n)return null;const i=a.id;if(t.has(i)){const r=t.get(i),a=Date.now()-r.timestamp;if(a<Ee)return Math.round(a/1e3/60),r.embyItem;t.delete(i),e(t)}try{const n="title"in a?"Movie":"Series",s="title"in a?a.title:a.name,l="release_date"in a?a.release_date?new Date(a.release_date).getFullYear():null:a.first_air_date?new Date(a.first_air_date).getFullYear():null,c=await o.searchItemsByExternalId(void 0,a.id.toString(),[n]);if(c.length>0){a.id;const r={embyItem:c[0],timestamp:Date.now()};return t.set(i,r),e(t),c[0]}const u=await o.searchItems(s,[n]);if(0===u.length){const r={embyItem:null,timestamp:Date.now()};return t.set(i,r),e(t),null}let d=u.find(e=>{const t=e.Name?.toLowerCase()===s.toLowerCase(),r=!l||Math.abs((e.ProductionYear||0)-l)<=1;return t&&r});if(d){const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}const m=r(s);if(d=u.find(e=>{const t=r(e.Name||"")===m,a=!l||Math.abs((e.ProductionYear||0)-l)<=2;return t&&a}),d){const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}if(l&&(d=u.find(e=>{const t=e.Name?.toLowerCase()||"",r=s.toLowerCase(),a=t.includes(r)||r.includes(t),o=Math.abs((e.ProductionYear||0)-l)<=1;return a&&o}),d)){const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}if(l){const r=u.filter(e=>Math.abs((e.ProductionYear||0)-l)<=1);if(1===r.length){const a={embyItem:r[0],timestamp:Date.now()};return t.set(i,a),e(t),r[0]}}if(l&&(d=u.find(e=>{const t=r(e.Name||""),a=Math.abs((e.ProductionYear||0)-l)<=3;return(t.includes(m)||m.includes(t))&&a}),d)){const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}if(u.length<=2){const a=u[0],o=r(a.Name||""),n=Math.min(m.length,o.length),s=m.length>o.length?m:o,l=m.length<=o.length?m:o;if(l.length>=.6*n&&s.includes(l)){u.length;const r={embyItem:a,timestamp:Date.now()};return t.set(i,r),e(t),a}}if(!l){if(d=u.find(e=>r(e.Name||"")===m),d){const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}if(1===u.length){const a=r(u[0].Name||"");if(a.includes(m)||m.includes(a)){const r={embyItem:u[0],timestamp:Date.now()};return t.set(i,r),e(t),u[0]}}}if(d=u.find(e=>r(e.Name||"")===m),d){const r={embyItem:d,timestamp:Date.now()};return t.set(i,r),e(t),d}u.length,u.slice(0,5).map(e=>({name:e.Name,year:e.ProductionYear,type:e.Type}));const v={embyItem:null,timestamp:Date.now()};return t.set(i,v),e(t),null}catch(s){console.error("[useMediaMatching] Error matching TMDB item:",s);const r={embyItem:null,timestamp:Date.now()};return t.set(i,r),e(t),null}},batchWithConcurrency:async(e,t,r=5)=>{const a=[];for(let o=0;o<e.length;o+=r){const n=e.slice(o,o+r),i=await Promise.all(n.map(t));a.push(...i)}return a},normalizeTitle:r,clearMatchCache:()=>{try{localStorage.removeItem(Pe),t.clear()}catch(e){console.error("[useMediaMatching] Failed to clear cache:",e)}},tmdbMatchCache:t}}function Me(t,r,a,o,n,i=!1){const s=e([]),l=e(null),c=e([]),u=e("libraries"),d=e(!1),m=async e=>{try{const t="Movie"===e.Type,r="Series"===e.Type;if(!t&&!r)return e;const o=e.Name||"",n=e.ProductionYear,i=t?"/search/movie":"/search/tv",s={query:o};n&&(s[t?"year":"first_air_date_year"]=n.toString());const l=await a.makeRequest(i,s);if(l.results&&l.results.length>0){let r=l.results[0];if(n&&l.results.length>1){const e=l.results.find(e=>{const r=t?e.release_date?new Date(e.release_date).getFullYear():null:e.first_air_date?new Date(e.first_air_date).getFullYear():null;return r&&Math.abs(r-n)<=1});e&&(r=e)}if(r.backdrop_path){const t=a.getBackdropUrl(r.backdrop_path,"w1280");return{...e,HeroImageUrl:t}}}return e}catch(t){return console.error("[LibraryManager] Failed to enhance item with TMDB backdrop:",t),e}};return{allLibraries:s,currentLibrary:l,featuredItems:c,isLoadingFeatured:d,currentView:u,findLibraryByType:e=>s.value.find(t=>t.CollectionType===e||t.Name?.toLowerCase().includes(e.replace("s",""))),loadFeaturedItems:async(e,r,n)=>{d.value=!0,c.value=[];const s=e.find(e=>"movies"===e.CollectionType||e.Name?.toLowerCase().includes("movie"));if(i&&s)try{const r=e.find(e=>"tvshows"===e.CollectionType||e.Name?.toLowerCase().includes("tv")||e.Name?.toLowerCase().includes("show")),a=await t.getItems(s.Id,"Movie");a.length;let n=[];r&&(n=await t.getItems(r.Id,"Series"),n.length);const i=[...a,...n];if(await o.init(),o.isReady.value){const e=(new Date).getFullYear(),t=i.filter(t=>{const r=t.ProductionYear&&t.ProductionYear>=e-15,a=t.CommunityRating&&t.CommunityRating>=6.5;return r||a}),r=t.length>100?t:i.slice(0,400);r.length;const a=await o.getRecommendations(r,{limit:6,excludeWatched:!0,minScore:.15,discoveryPercent:10});if(a.length>=6){const e=new Set,t=new Set,r=a.filter(r=>{if(e.has(r.Id))return console.warn("[LibraryManager] Duplicate ID in recommendations:",r.Name,r.Id),!1;const a=r.Name?.toLowerCase().trim();return a&&t.has(a)?(console.warn("[LibraryManager] Duplicate name in recommendations:",r.Name,"(ID:",r.Id,")"),!1):(e.add(r.Id),a&&t.add(a),!0)}),o=await Promise.all(r.map(e=>m(e)));return c.value=o,c.value.length,void(d.value=!1)}if(a.length<5){a.length;try{const e=new Set(a.map(e=>e.Id)),t=r.filter(t=>!e.has(t.Id)&&!t.UserData?.Played);t.length;t.filter(e=>e.UserData).length,t.filter(e=>e.UserData?.Played).length;t.length;const o=t.sort((e,t)=>{const r=e.CommunityRating||0,a=t.CommunityRating||0,o=e.ProductionYear||0,n=t.ProductionYear||0;return r!==a?a-r:n-o}),n=o.slice(0,20).sort(()=>Math.random()-.5),i=6-a.length,s=n.slice(0,i),l=[...a,...s],u=new Set,v=new Set,g=l.filter(e=>{if(u.has(e.Id))return console.warn("[LibraryManager] Duplicate ID detected:",e.Name,e.Id),!1;const t=e.Name?.toLowerCase().trim();return t&&v.has(t)?(console.warn("[LibraryManager] Duplicate name detected:",e.Name,"(ID:",e.Id,")"),!1):(u.add(e.Id),t&&v.add(t),!0)}),y=await Promise.all(g.map(e=>m(e)));if(c.value=y,s.length,c.value.length,c.value.length>=5)return void(d.value=!1)}catch(l){console.error("[LibraryManager] Failed to supplement with unwatched items:",l)}}else a.length}}catch(l){console.error("[LibraryManager] Failed to load personalized items:",l)}if(r&&r.length>0||n&&n.length>0){const e=[...r?.slice(0,4).map(e=>({...e.embyItem,HeroImageUrl:a.getBackdropUrl(e.tmdbData.backdrop_path,"w1280")||e.embyItem.HeroImageUrl}))||[],...n?.slice(0,2).map(e=>({...e.embyItem,HeroImageUrl:a.getBackdropUrl(e.tmdbData.backdrop_path,"w1280")||e.embyItem.HeroImageUrl}))||[]];c.value=e.slice(0,6),c.value.length}else if(s)try{const e=await t.getItems(s.Id,"Movie"),r=e.filter(e=>e.CommunityRating);let a;if(r.length>=6){a=r.sort((e,t)=>(t.CommunityRating||0)-(e.CommunityRating||0)).slice(0,6)}else a=e.slice(0,6);const o=await Promise.all(a.map(e=>m(e)));c.value=o,c.value.length}catch(l){console.error("[LibraryManager] Failed to load from Emby library:",l),c.value=[]}else console.warn("[LibraryManager] No movie library found and no trending content"),c.value=[];d.value=!1},loadLibraries:async()=>{if(u.value="libraries",l.value=null,n.value){s.value=r.getLibraries();const e=r.getLibraryItems("demo-movies");c.value=e.slice(0,6)}else try{const e=await t.getViews();s.value=e,e.map(e=>({name:e.Name,type:e.Type,collectionType:e.CollectionType,id:e.Id}))}catch(e){console.error("[LibraryManager] Failed to load libraries:",e),s.value=[]}return s.value},loadLibraryItems:async e=>{l.value=e,u.value="items";let a=[];if(n.value)a=r.getLibraryItems(e.Id);else try{let r=null;"movies"===e.CollectionType?r="Movie":"tvshows"===e.CollectionType?r="Series":"collections"===e.CollectionType&&(r="BoxSet"),e.Id,e.Name,e.CollectionType,a=await t.getItems(e.Id,r),a.length}catch(o){console.error("[LibraryManager] Failed to load library items:",o),a=[]}return a},loadCollectionItems:async e=>{if(n.value)return r.getLibraryItems(e);try{const r=await t.getItems(e,null);return r.length,r}catch(a){return console.error("[LibraryManager] Failed to load collection items:",a),[]}},reset:()=>{s.value=[],l.value=null,c.value=[],u.value="libraries"}}}function De(t,r,a,o){const n=e([]),i=e([]),s=e(!1),l=e(!1),c=e(1),u=e(1),d=e(!1),m=e(!1),v=e(!0),g=e(!0);return{trendingMovies:n,trendingTvShows:i,isLoadingTrending:s,isLoadingMoreMovies:d,isLoadingMoreTv:m,hasMoreMovies:v,hasMoreTv:g,shouldShowSplash:l,loadTrendingContent:async e=>{if(!t.isConfigured)return;if(o.value)return;const c=a.tmdbMatchCache.size;l.value=0===c,l.value&&e&&e.onShow(),s.value=!0;try{const[e,s]=await Promise.all([t.getTrendingMovies("week",1),t.getTrendingTvShows("week",1)]),l=e.results,c=s.results;l.length,c.length;const u=l.slice(0,15),d=c.slice(0,15),[m,v]=await Promise.all([t.getWatchProvidersBatch(u.map(e=>({id:e.id,mediaType:"movie"})),"US"),t.getWatchProvidersBatch(d.map(e=>({id:e.id,mediaType:"tv"})),"US")]),[g,y]=await Promise.all([a.batchWithConcurrency(u,async e=>{const t=await a.matchTmdbWithEmby(e,r,o.value);if(!t)return null;const n=m.get(e.id);return{tmdbData:e,embyId:t.Id,embyItem:t,streamingProviders:n?.flatrate||[]}},5),a.batchWithConcurrency(d,async e=>{const t=await a.matchTmdbWithEmby(e,r,o.value);if(!t)return null;const n=v.get(e.id);return{tmdbData:e,embyId:t.Id,embyItem:t,streamingProviders:n?.flatrate||[]}},5)]);n.value=g.filter(e=>null!==e),i.value=y.filter(e=>null!==e),n.value.length,l.length,i.value.length,c.length}catch(u){console.error("[TrendingContent] Failed to load trending content:",u)}finally{s.value=!1,l.value&&e&&(e.onHide(),l.value=!1)}},loadMoreMovies:async()=>{if(t.isConfigured&&!o.value&&!d.value&&v.value){d.value=!0;try{const e=c.value+1,i=await t.getTrendingMovies("week",e);if(0===i.results.length||e>=i.total_pages)return void(v.value=!1);const s=new Map(i.results.map(e=>[e.id,e])),l=Array.from(s.values()),u=await t.getWatchProvidersBatch(l.map(e=>({id:e.id,mediaType:"movie"})),"US"),d=(await a.batchWithConcurrency(l,async e=>{const t=await a.matchTmdbWithEmby(e,r,o.value);if(!t)return null;const n=u.get(e.id);return{tmdbData:e,embyId:t.Id,embyItem:t,streamingProviders:n?.flatrate||[]}},5)).filter(e=>null!==e),m=new Set(n.value.map(e=>e.tmdbData.id)),g=new Set(n.value.map(e=>e.embyId)),y=d.filter(e=>!m.has(e.tmdbData.id)&&!g.has(e.embyId));n.value=[...n.value,...y],c.value=e,y.length,d.length,y.length}catch(e){console.error("[TrendingContent] Failed to load more movies:",e)}finally{d.value=!1}}},loadMoreTvShows:async()=>{if(t.isConfigured&&!o.value&&!m.value&&g.value){m.value=!0;try{const e=u.value+1,n=await t.getTrendingTvShows("week",e);if(0===n.results.length||e>=n.total_pages)return void(g.value=!1);const s=new Map(n.results.map(e=>[e.id,e])),l=Array.from(s.values()),c=await t.getWatchProvidersBatch(l.map(e=>({id:e.id,mediaType:"tv"})),"US"),d=(await a.batchWithConcurrency(l,async e=>{const t=await a.matchTmdbWithEmby(e,r,o.value);if(!t)return null;const n=c.get(e.id);return{tmdbData:e,embyId:t.Id,embyItem:t,streamingProviders:n?.flatrate||[]}},5)).filter(e=>null!==e),m=new Set(i.value.map(e=>e.tmdbData.id)),v=new Set(i.value.map(e=>e.embyId)),y=d.filter(e=>!m.has(e.tmdbData.id)&&!v.has(e.embyId));i.value=[...i.value,...y],u.value=e,y.length,d.length,y.length}catch(e){console.error("[TrendingContent] Failed to load more TV shows:",e)}finally{m.value=!1}}},filterMoviesByGenres:e=>0===e.length?n.value:n.value.filter(t=>{const r=t.tmdbData.genre_ids||[];return e.every(e=>r.includes(e))}),filterTvShowsByGenres:e=>0===e.length?i.value:i.value.filter(t=>{const r=t.tmdbData.genre_ids||[];return e.every(e=>r.includes(e))}),reset:()=>{n.value=[],i.value=[],s.value=!1,l.value=!1,c.value=1,u.value=1,d.value=!1,m.value=!1,v.value=!0,g.value=!0}}}function Ne(t,r){const a=e([]),n=e([]),i=o(()=>{if(0===r.value.length||0===a.value.length)return[];if(0===n.value.length){const e=new Set;return r.value.forEach(t=>{t.genre_ids.forEach(t=>e.add(t))}),a.value.filter(t=>e.has(t.id))}const e=r.value.filter(e=>n.value.every(t=>e.genre_ids.includes(t))),t=new Set;return e.forEach(e=>{e.genre_ids.forEach(e=>t.add(e))}),a.value.filter(e=>t.has(e.id))}),s=o(()=>0===n.value.length?r.value:r.value.filter(e=>n.value.every(t=>e.genre_ids.includes(t))));return{allGenres:a,selectedGenres:n,availableGenres:i,filteredItems:s,loadGenres:async e=>{if(t.isConfigured)try{const r="movie"===e?await t.getMovieGenres():await t.getTvGenres();a.value=r,r.length}catch(r){console.error(`[GenreFilter] Failed to load ${e} genres:`,r)}},toggleGenre:e=>{const t=n.value.indexOf(e);t>-1?n.value.splice(t,1):n.value.push(e)},clearGenres:()=>{n.value=[]},isGenreSelected:e=>n.value.includes(e),reset:()=>{a.value=[],n.value=[]}}}const _e=[{day:"Monday",timeSlot:"morning",tvTheme:"Daily Discovery (Documentary)",tvFilters:{with_genres:"99","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Quiet Focus Film (History)",movieFilters:{with_genres:"36","vote_average.gte":7,"with_runtime.lte":90,sort_by:"vote_average.desc"}},{day:"Monday",timeSlot:"midday",tvTheme:"Workday Motivation (Lifestyle/Reality)",tvFilters:{with_genres:"10764",sort_by:"popularity.desc"},movieTheme:"Inspirational Doc (Non-Fiction Feature)",movieFilters:{with_genres:"99","vote_count.gte":500,sort_by:"vote_count.desc"}},{day:"Monday",timeSlot:"evening",tvTheme:"Prestige Drama Premiere (New or Trending Drama)",tvFilters:{with_genres:"18","first_air_date.gte":new Date(Date.now()-15552e6).toISOString().split("T")[0],sort_by:"popularity.desc"},movieTheme:"Heavy Hitter Movie (Crime/Mystery)",movieFilters:{with_genres:"80,9648","vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Tuesday",timeSlot:"morning",tvTheme:"Sci-Fi Short (Animation/Sci-Fi)",tvFilters:{with_genres:"16|878",sort_by:"popularity.desc"},movieTheme:"80s/90s Action Film (Throwback Action)",movieFilters:{with_genres:"28","primary_release_date.gte":"1980-01-01","primary_release_date.lte":"1999-12-31",sort_by:"popularity.desc"}},{day:"Tuesday",timeSlot:"midday",tvTheme:"Lunch Break Lite (Classic Sitcom/Comedy)",tvFilters:{with_genres:"35","first_air_date.lte":"2010-01-01",sort_by:"vote_average.desc"},movieTheme:"Visual Escapism (Travel/Nature Documentary)",movieFilters:{with_genres:"99",sort_by:"vote_average.desc"}},{day:"Tuesday",timeSlot:"evening",tvTheme:"Terror Tuesday (Horror Series)",tvFilters:{with_genres:"27","vote_average.gte":7,sort_by:"vote_count.desc"},movieTheme:"Psychological Thriller (High Tension Movie)",movieFilters:{with_genres:"53","vote_average.gte":7,"with_runtime.lte":120,sort_by:"vote_average.desc"}},{day:"Wednesday",timeSlot:"morning",tvTheme:"World News Review (News/Talk Show)",tvFilters:{with_genres:"10763",sort_by:"popularity.desc"},movieTheme:"Foreign Film Spotlight (Non-English Movie)",movieFilters:{"vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Wednesday",timeSlot:"midday",tvTheme:"Feel-Good Food Show (Cooking/Baking)",tvFilters:{with_genres:"10764|10767",sort_by:"popularity.desc"},movieTheme:"Animated Comfort Film (Family/Animation)",movieFilters:{with_genres:"16|10751",sort_by:"popularity.desc"}},{day:"Wednesday",timeSlot:"evening",tvTheme:"Hump Day Mystery (Whodunit Series)",tvFilters:{with_genres:"9648","vote_count.gte":100,sort_by:"vote_average.desc"},movieTheme:"Noir Classic (Black & White, Older Film)",movieFilters:{with_genres:"80|18|53","primary_release_date.lte":"1960-01-01",sort_by:"vote_average.desc"}},{day:"Thursday",timeSlot:"morning",tvTheme:"Deep Dive History (Historical Miniseries)",tvFilters:{with_genres:"36|18","vote_average.gte":7.5,sort_by:"vote_average.desc"},movieTheme:"Period Romance (Costume Drama/Romance)",movieFilters:{with_genres:"10749",sort_by:"vote_average.desc"}},{day:"Thursday",timeSlot:"midday",tvTheme:"Sports Short (Sport Documentary/Series)",tvFilters:{with_genres:"10764|99",sort_by:"popularity.desc"},movieTheme:"Fantasy/Adventure Film (Escapist Movie)",movieFilters:{with_genres:"14|12","vote_count.gte":1e3,sort_by:"popularity.desc"}},{day:"Thursday",timeSlot:"evening",tvTheme:"Throwback Thursday (Re-watch Old TV Show)",tvFilters:{"first_air_date.lte":"2005-01-01","vote_count.gte":100,sort_by:"vote_average.desc"},movieTheme:"Cult Classic (Offbeat or Niche Movie)",movieFilters:{"vote_average.gte":7,"vote_count.lte":1e3,sort_by:"vote_average.desc"}},{day:"Friday",timeSlot:"morning",tvTheme:"Tech & Science Explainer (Science Documentary/Talk)",tvFilters:{with_genres:"99",sort_by:"vote_average.desc"},movieTheme:"Art House Film (Indie/Experimental)",movieFilters:{with_genres:"18|35","vote_count.lte":500,"vote_average.gte":7.5,sort_by:"vote_average.desc"}},{day:"Friday",timeSlot:"midday",tvTheme:"Family Favorites (Kid-Friendly Series)",tvFilters:{with_genres:"10751",sort_by:"popularity.desc"},movieTheme:"Danish Movies",movieFilters:{sort_by:"popularity.desc",watch_region:"DK",with_origin_country:"DK",with_original_language:"da"}},{day:"Friday",timeSlot:"evening",tvTheme:"Friday Night Blockbuster (Action/Sci-Fi Series)",tvFilters:{with_genres:"28|878",sort_by:"popularity.desc"},movieTheme:"New Release Movie Night (Theatrical/VOD Premiere)",movieFilters:{"primary_release_date.gte":new Date(Date.now()-7776e6).toISOString().split("T")[0],sort_by:"primary_release_date.desc"}},{day:"Saturday",timeSlot:"morning",tvTheme:"Saturday Morning Animation (Cartoons/Anime)",tvFilters:{with_genres:"16|10751",sort_by:"popularity.desc"},movieTheme:"Recharge & Reflect (Spiritual/Thought-Provoking)",movieFilters:{with_genres:"18","vote_average.gte":7.5,sort_by:"vote_average.desc"}},{day:"Saturday",timeSlot:"midday",tvTheme:"Comedy Miniseries Binge (Short Comedy TV)",tvFilters:{with_genres:"35","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Midday Thriller (Suspense/Mystery Feature)",movieFilters:{with_genres:"53|9648","vote_average.gte":7,sort_by:"vote_average.desc"}},{day:"Saturday",timeSlot:"evening",tvTheme:"Saturday Night Favorites (Top-Rated Series)",tvFilters:{"vote_average.gte":8,sort_by:"popularity.desc"},movieTheme:"Saturday Night Cinema",movieFilters:{sort_by:"popularity.desc",watch_region:"DK",with_release_type:3,page:(Re=1,Ue=5,Math.floor(Math.random()*(Ue-Re))+Re)}},{day:"Sunday",timeSlot:"morning",tvTheme:"World Travel Log (Travel Series)",tvFilters:{with_genres:"99|10764",sort_by:"popularity.desc"},movieTheme:"Family Sunday Film (G-Rated or Family Adventure)",movieFilters:{with_genres:"10751",sort_by:"primary_release_date.desc"}},{day:"Sunday",timeSlot:"midday",tvTheme:"Guilty Pleasure Reality (Low-Commitment Reality)",tvFilters:{with_genres:"10764",sort_by:"popularity.desc"},movieTheme:"Silly Comedy Feature (Low-Brow Humor)",movieFilters:{with_genres:"35",sort_by:"popularity.desc"}},{day:"Sunday",timeSlot:"evening",tvTheme:"Winding Down Watch (Calm, Comfort Series)",tvFilters:{with_genres:"10749|18","vote_average.gte":7,sort_by:"vote_average.desc"},movieTheme:"Classic Blockbuster Revisit (Nostalgic Film)",movieFilters:{with_genres:"12|28|878","primary_release_date.lte":"2000-01-01","vote_count.gte":1e3,sort_by:"popularity.desc"}}];var Re,Ue;function Ae(e=new Date){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()]}function Fe(){const e=new Date,t=e.getHours(),r=function(){const e=(new Date).getHours();return e>=5&&e<12?"morning":e>=12&&e<18?"midday":"evening"}();let a;if("evening"===r&&t>=0&&t<5){const t=new Date(e);t.setDate(t.getDate()-1),a=Ae(t)}else a=Ae(e);return function(e,t){return _e.find(r=>r.day===e&&r.timeSlot===t)}(a,r)}const xe="embyflix-daily-discovery-cache";function Oe(e){const t={page:1,...e};return t.sort_by||(t.sort_by="popularity.desc"),t}function $e(e,t){return t?{tmdbData:e,embyId:t.Id,embyItem:t}:null}function Le(e,t){return t?{tmdbData:e,embyId:t.Id,embyItem:t}:null}function Be(){return(new Date).toISOString().split("T")[0]}function je(){const t=de(),{matchTmdbWithEmby:r,batchWithConcurrency:a}=Ce(),n=e(!1),i=e(null),s=e([]),l=e([]),c=e(Fe()),u=e(1),d=e(1),m=e(!1),v=e(!1),g=e(!0),y=e(!0),h=o(()=>c.value?.movieTheme||"Daily Movie Pick"),f=o(()=>c.value?.tvTheme||"Daily TV Pick"),p=o(()=>s.value.length>0||l.value.length>0),w=async(e,a=!1)=>{const o=function(){try{const e=localStorage.getItem(xe);if(!e)return null;const t=JSON.parse(e),r=Date.now()-t.timestamp,a=Be(),o=Fe();return r<864e5&&t.date===a&&o&&t.timeSlot===o.timeSlot?(t.date,t.timeSlot,Math.round(r/1e3/60),t):(t.date,t.timeSlot,null)}catch(i){return console.error("[useDailyDiscovery] Failed to load cache:",i),null}}();if(o)return s.value=o.movies,l.value=o.tvShows,void(c.value=o.theme);n.value=!0,i.value=null;try{const o=Fe();if(!o)throw new Error("No theme found for current date/time");c.value=o,o.day,o.timeSlot,o.movieTheme,o.tvTheme;const n=Oe(o.movieFilters),u=Oe(o.tvFilters),[d,m]=await Promise.all([t.discoverMovies(n),t.discoverTvShows(u)]);d.results.length,m.results.length;const v=d.results.slice(0,20),g=m.results.slice(0,20),y=await Promise.all(v.map(async t=>$e(t,await r(t,e,a)))),h=await Promise.all(g.map(async t=>Le(t,await r(t,e,a)))),f=y.filter(e=>null!==e),p=h.filter(e=>null!==e);f.length,y.length,p.length,h.length,s.value=f,l.value=p;!function(e){try{localStorage.setItem(xe,JSON.stringify(e)),e.date,e.timeSlot,e.movies.length,e.tvShows.length}catch(i){console.error("[useDailyDiscovery] Failed to save cache:",i)}}({date:Be(),timeSlot:o.timeSlot,theme:o,movies:f,tvShows:p,timestamp:Date.now()})}catch(u){i.value=u instanceof Error?u.message:"Failed to load daily content",console.error("[useDailyDiscovery] Error loading daily content:",u)}finally{n.value=!1}},I=()=>{localStorage.removeItem(xe),s.value=[],l.value=[]};return{isLoading:n,error:i,dailyMovies:s,dailyTvShows:l,currentTheme:c,movieThemeTitle:h,tvThemeTitle:f,hasContent:p,loadDailyContent:w,clearCache:I,refresh:async(e,t=!1)=>{I(),await w(e,t)},loadMoreMovies:async(e,o=!1)=>{if(!m.value&&g.value&&c.value){m.value=!0;try{const n=u.value+1,i=Oe(c.value.movieFilters);i.page=n;const l=await t.discoverMovies(i);if(0===l.results.length||n>=l.total_pages)return void(g.value=!1);const d=l.results.slice(0,20),m=(await a(d,async t=>$e(t,await r(t,e,o)),5)).filter(e=>null!==e),v=new Set(s.value.map(e=>e.tmdbData.id)),y=new Set(s.value.map(e=>e.embyId)),h=m.filter(e=>!v.has(e.tmdbData.id)&&!y.has(e.embyId));s.value=[...s.value,...h],u.value=n,h.length}catch(n){i.value=n instanceof Error?n.message:"Failed to load more movies",console.error("[useDailyDiscovery] Error loading more movies:",n)}finally{m.value=!1}}},loadMoreTvShows:async(e,o=!1)=>{if(!v.value&&y.value&&c.value){v.value=!0;try{const n=d.value+1,i=Oe(c.value.tvFilters);i.page=n;const s=await t.discoverTvShows(i);if(0===s.results.length||n>=s.total_pages)return void(y.value=!1);const u=s.results.slice(0,20),m=(await a(u,async t=>Le(t,await r(t,e,o)),5)).filter(e=>null!==e),v=new Set(l.value.map(e=>e.tmdbData.id)),g=new Set(l.value.map(e=>e.embyId)),h=m.filter(e=>!v.has(e.tmdbData.id)&&!g.has(e.embyId));l.value=[...l.value,...h],d.value=n,h.length}catch(n){i.value=n instanceof Error?n.message:"Failed to load more TV shows",console.error("[useDailyDiscovery] Error loading more TV shows:",n)}finally{v.value=!1}}},isLoadingMoreMovies:m,isLoadingMoreTv:v,hasMoreMovies:g,hasMoreTv:y}}function We(){const t=e(!1),r=e(null);const a=o(()=>r.value?`Because you watched: ${r.value.referenceItem.name}`:""),n=o(()=>null!==r.value&&r.value.recommendations.length>0);return{isLoading:t,becauseYouWatchedItem:r,sectionTitle:a,hasRecommendations:n,loadBecauseYouWatched:async function(e){if(!t.value){t.value=!0;try{r.value=await async function(e){try{const t=await e.getRecentlyWatched(20,["Movie","Series"]);if(0===t.length)return null;const r=t.slice(0,Math.min(5,t.length)),a=r[Math.floor(Math.random()*r.length)];a.Name;const o=(await e.getSimilarItems(a.Id,25)).filter(e=>!e.UserData?.Played);return 0===o.length?null:(o.length,{referenceItem:{id:a.Id,name:a.Name||"Unknown",type:a.Type},recommendations:o})}catch(t){return console.error("[BecauseYouWatched] Error generating recommendations:",t),null}}(e)}catch(a){console.error("[BecauseYouWatched] Error loading recommendations:",a),r.value=null}finally{t.value=!1}}}}}function Ge(){const e=a(),o=e=>{switch(e){case"home":return{name:"Home"};case"movies":return{name:"Category",params:{category:"movies"}};case"tvshows":return{name:"Category",params:{category:"tvshows"}};case"collections":return{name:"Category",params:{category:"collections"}};case"search":return{name:"Search"};case"settings":return{name:"Settings"};default:return console.warn("[useSidebarNavigation] Unknown navigation ID:",e),null}},n=(e,t)=>{const r=e.detail;if(t){const e=t(r);if(e instanceof Promise)return void e.then(e=>{e&&i(r)});if(!e)return}i(r)},i=t=>{const r=o(t);r&&e.push(r)};return{navigateTo:o,handleSidebarNavigation:n,performNavigation:i,registerSidebarNavigation:e=>{const a=t=>n(t,e);return t(()=>{window.addEventListener("sidebar-navigate",a)}),r(()=>{window.removeEventListener("sidebar-navigate",a)}),a}}}function qe(e="Home"){const o=a(),n=re(),i=()=>{n.goBack()||o.push({name:e})};return t(()=>{window.addEventListener("app-back-navigation",i)}),r(()=>{window.removeEventListener("app-back-navigation",i)}),{handleBack:i,handleSimpleBack:()=>{o.back()}}}function Ye(){const t=N(),r=e(""),a=e([]),i=e(!1),s=e(null),l=e({itemTypes:[],genres:[],studios:[],tags:[],runtime:"any",criticRating:"any",communityRating:"any",sortBy:"relevance"});let c=null;const u=e=>{if("any"!==l.value.criticRating){const t="60+"===l.value.criticRating?60:80,r=e.CriticRating;if(!r||r<t)return!1}if("any"!==l.value.communityRating){const t="60+"===l.value.communityRating?6:8,r=e.CommunityRating;if(!r||r<t)return!1}if("any"!==l.value.runtime){const t=(e=>e.RunTimeTicks?Math.round(e.RunTimeTicks/1e4/1e3/60):null)(e);if(!t)return!1;switch(l.value.runtime){case"short":if(t>=30)return!1;break;case"medium":if(t<30||t>=90)return!1;break;case"long":if(t<90||t>=150)return!1;break;case"verylong":if(t<150)return!1}}return!0},d=o(()=>{let e=a.value;return l.value.itemTypes.length>0&&(e=e.filter(e=>l.value.itemTypes.includes(e.Type))),l.value.genres.length>0&&(e=e.filter(e=>e.Genres&&e.Genres.some(e=>l.value.genres.includes(e)))),l.value.studios.length>0&&(e=e.filter(e=>e.Studios&&e.Studios.some(e=>l.value.studios.includes(e.Name)))),l.value.tags.length>0&&(e=e.filter(e=>e.Tags&&e.Tags.some(e=>l.value.tags.includes(e)))),e=e.filter(u),e=[...e].sort((e,t)=>{switch(l.value.sortBy){case"relevance":{const a=r.value.toLowerCase(),o=e.Name.toLowerCase(),n=t.Name.toLowerCase(),i=o===a?3:0,s=n===a?3:0;if(i!==s)return s-i;const l=o.startsWith(a)?2:0,c=n.startsWith(a)?2:0;if(l!==c)return c-l;const u=o.includes(a)?1:0,d=n.includes(a)?1:0;return u!==d?d-u:(t.CommunityRating||0)-(e.CommunityRating||0)}case"name-asc":return e.Name.localeCompare(t.Name);case"name-desc":return t.Name.localeCompare(e.Name);case"date-newest":{const r=e.PremiereDate?new Date(e.PremiereDate).getTime():365*(e.ProductionYear||0)*24*60*60*1e3;return(t.PremiereDate?new Date(t.PremiereDate).getTime():365*(t.ProductionYear||0)*24*60*60*1e3)-r}case"date-oldest":return(e.PremiereDate?new Date(e.PremiereDate).getTime():365*(e.ProductionYear||0)*24*60*60*1e3)-(t.PremiereDate?new Date(t.PremiereDate).getTime():365*(t.ProductionYear||0)*24*60*60*1e3);case"rating-high":return(t.CommunityRating||0)-(e.CommunityRating||0);case"rating-low":return(e.CommunityRating||0)-(t.CommunityRating||0);case"critic-high":return(t.CriticRating||0)-(e.CriticRating||0);case"critic-low":return(e.CriticRating||0)-(t.CriticRating||0);default:return 0}}),e}),m=o(()=>{const e={};return d.value.forEach(t=>{e[t.Type]||(e[t.Type]=[]),e[t.Type].push(t)}),e}),v=o(()=>{const e={};return a.value.forEach(t=>{e[t.Type]=(e[t.Type]||0)+1}),e}),g=o(()=>Object.keys(v.value).sort()),y=o(()=>{const e=new Set;return a.value.forEach(t=>{t.Genres&&t.Genres.forEach(t=>e.add(t))}),Array.from(e).sort()}),h=o(()=>{const e={};return a.value.forEach(t=>{t.Genres&&t.Genres.forEach(t=>{e[t]=(e[t]||0)+1})}),e}),f=o(()=>{const e=new Set;return a.value.forEach(t=>{t.Studios&&t.Studios.forEach(t=>e.add(t.Name))}),Array.from(e).sort()}),p=o(()=>{const e={};return a.value.forEach(t=>{t.Studios&&t.Studios.forEach(t=>{e[t.Name]=(e[t.Name]||0)+1})}),e}),w=o(()=>{const e=new Set;return a.value.forEach(t=>{t.Tags&&t.Tags.forEach(t=>e.add(t))}),Array.from(e).sort()}),I=o(()=>{const e={};return a.value.forEach(t=>{t.Tags&&t.Tags.forEach(t=>{e[t]=(e[t]||0)+1})}),e}),b=async e=>{if(!e.trim())return a.value=[],void(s.value=null);i.value=!0,s.value=null;try{const r=l.value.itemTypes.length>0?l.value.itemTypes:void 0,o=await t.searchItems(e,r);a.value=(e=>{const t=new Set,r=[];for(const o of e){const e=o.Name.toLowerCase().trim();t.has(e)||(t.add(e),r.push(o))}const a=e.length-r.length;return a>0&&(e.length,r.length),r})(o)}catch(r){s.value=r instanceof Error?r.message:"Search failed",console.error("[useSearch] Search error:",r),a.value=[]}finally{i.value=!1}};n(r,e=>{var t;e.trim()?(t=e,c&&clearTimeout(c),c=setTimeout(()=>{b(t)},300)):(a.value=[],s.value=null,i.value=!1)});return{searchQuery:r,searchResults:a,filteredResults:d,groupedResults:m,resultCounts:v,availableTypes:g,availableGenres:y,genreCounts:h,availableStudios:f,studioCounts:p,availableTags:w,tagCounts:I,isSearching:i,searchError:s,filters:l,toggleFilter:e=>{const t=l.value.itemTypes.indexOf(e);t>-1?l.value.itemTypes.splice(t,1):l.value.itemTypes.push(e)},toggleGenre:e=>{const t=l.value.genres.indexOf(e);t>-1?l.value.genres.splice(t,1):l.value.genres.push(e)},toggleStudio:e=>{const t=l.value.studios.indexOf(e);t>-1?l.value.studios.splice(t,1):l.value.studios.push(e)},toggleTag:e=>{const t=l.value.tags.indexOf(e);t>-1?l.value.tags.splice(t,1):l.value.tags.push(e)},clearFilters:()=>{l.value.itemTypes=[],l.value.genres=[],l.value.studios=[],l.value.tags=[],l.value.runtime="any",l.value.criticRating="any",l.value.communityRating="any",l.value.sortBy="relevance"},setFilter:e=>{l.value.itemTypes=e},isTypeFiltered:e=>l.value.itemTypes.includes(e),isGenreFiltered:e=>l.value.genres.includes(e),isStudioFiltered:e=>l.value.studios.includes(e),isTagFiltered:e=>l.value.tags.includes(e),setCriticRating:e=>{l.value.criticRating=e},setCommunityRating:e=>{l.value.communityRating=e},setRuntime:e=>{l.value.runtime=e},setSortBy:e=>{l.value.sortBy=e},clearSearch:()=>{r.value="",a.value=[],s.value=null,i.value=!1,c&&clearTimeout(c)},immediateSearch:async e=>{r.value=e,c&&clearTimeout(c),await b(e)}}}const ze=1e7;let He=null;function Ve(a,o,i={}){const s=e(!1),l=e(""),c=e(null),u=e(null);let d=!1;const m=async e=>{if(!a.value||!e)return;l.value="",d=!1;if(e.includes(".m3u8")){const t=await(async()=>{if(!He){const e=await h(()=>import("./hls-vendor.BfvSaUKw.js"),[],import.meta.url);He=e.default}return He})();t.isSupported()?(c.value&&c.value.destroy(),c.value=new t({debug:!1,enableWorker:!0,lowLatencyMode:!1,backBufferLength:30,maxBufferLength:60,maxMaxBufferLength:120,maxBufferSize:6e7,maxBufferHole:.5}),c.value.loadSource(e),c.value.attachMedia(a.value),c.value.on(t.Events.ERROR,(e,r)=>{if(r.fatal)switch(l.value=`[VideoPlayer] HLS error: ${r.type}`,r.type){case t.ErrorTypes.NETWORK_ERROR:c.value?.startLoad();break;case t.ErrorTypes.MEDIA_ERROR:c.value?.recoverMediaError();break;default:c.value?.destroy()}})):(console.error("[VideoPlayer] HLS is not supported in this browser"),l.value="HLS.js is not supported in this browser")}else a.value.src=e,a.value.load()},v=()=>{if(!a.value||!i.onProgress)return;const e=Math.floor(a.value.currentTime*ze),t=a.value.paused;i.onProgress(e,t)},g=()=>{u.value&&(clearInterval(u.value),u.value=null),c.value&&(c.value.destroy(),c.value=null),d=!1};return n(o,e=>{e&&a.value&&m(e)}),t(()=>{a.value&&(a.value&&(a.value.addEventListener("error",()=>{if(a.value?.error){const e={1:"MEDIA_ERR_ABORTED - Playback was aborted",2:"MEDIA_ERR_NETWORK - Network error occurred",3:"MEDIA_ERR_DECODE - Codec not supported",4:"MEDIA_ERR_SRC_NOT_SUPPORTED - Format not supported"};l.value=e[a.value.error.code]||"Unknown error"}}),a.value.addEventListener("canplay",()=>{if(!d&&a.value){d=!0;const e=a.value.play();void 0!==e&&e.then(()=>{s.value=!0,l.value="",i.onPlaybackStart&&i.onPlaybackStart()}).catch(e=>{l.value=`Playback failed: ${e.name} - ${e.message}`,s.value=!1})}}),a.value.addEventListener("playing",()=>{s.value=!0})),o.value&&m(o.value),u.value=window.setInterval(v,1e4))}),r(()=>{g()}),{isPlaying:s,errorMessage:l,handlePlayPause:()=>{if(a.value)if(a.value.paused){const e=a.value.play();void 0!==e?e.then(()=>{s.value=!0}).catch(e=>{console.error("[VideoPlayer] Play failed:",e.name,e.message),s.value=!1}):s.value=!0}else a.value.pause(),s.value=!1},handleStop:()=>{if(!a.value)return 0;const e=Math.floor(a.value.currentTime*ze);return i.onPlaybackStop&&i.onPlaybackStop(e),e},handleSeek:e=>{if(!a.value)return;const t=a.value.currentTime+e,r=a.value.duration;a.value.currentTime=t<0?0:t>r?r:t},initializeVideo:m,cleanup:g}}const Je=e=>e/1e7,Qe=e=>Math.floor(1e7*e),Ke="embyflix-credits-markers",Ze=e=>{try{const t=localStorage.getItem(Ke);if(!t)return{};return JSON.parse(t)[e]||{}}catch(t){return console.error("[CreditsDetection] Failed to load from storage:",t),{}}},Xe=(e,t,r)=>{try{const a=localStorage.getItem(Ke),o=a?JSON.parse(a):{};o[e]||(o[e]={}),o[e][t]=r,localStorage.setItem(Ke,JSON.stringify(o))}catch(a){console.error("[CreditsDetection] Failed to save to storage:",a)}};function et(){const t=e(!1),r=e(0);return{isDetecting:t,detectionProgress:r,detectCreditsPassively:(e,t)=>{if(!e||!e.duration)return()=>{};const r=e.duration,a=Math.max(.2*r,r-600),o=[];let n=0;a.toFixed(1);const i=()=>{const i=e.currentTime;if(i<a)return;if(i-n<5)return;n=i;const s=(e=>{const t=document.createElement("canvas"),r=t.getContext("2d",{willReadFrequently:!0});if(!r)return-1;t.width=160,t.height=90;try{return r.drawImage(e,0,0,t.width,t.height),(e=>{const t=e.data;let r=0;for(let a=0;a<t.length;a+=16)r+=.299*t[a]+.587*t[a+1]+.114*t[a+2];return r/(t.length/16)})(r.getImageData(0,0,t.width,t.height))}catch(a){return console.error("[CreditsDetection] Failed to analyze frame:",a),-1}})(e);if(s>=0&&s<5&&(o.push({time:i,brightness:s}),i.toFixed(1),s.toFixed(1),o.length>=3)){const e=o[0].time,a=Math.min(i+60,r),n={CreditsStart:Qe(e),CreditsEnd:Qe(a),confidence:Math.min(o.length/10,1),detectionMethod:"black-frames"};e.toFixed(1),a.toFixed(1),o.length,n.confidence,t(n)}};return e.addEventListener("timeupdate",i),()=>{e.removeEventListener("timeupdate",i)}},getCreditsMarker:async(e,t,r,a)=>{if(a)return a;if(t){const r=Ze(t);if(r[e])return r[e];const a=Object.values(r);if(a.length>0){const e=a[0];return{...e,confidence:.8*e.confidence}}}return null},loadCreditsFromStorage:Ze,saveCreditsToStorage:Xe,ticksToSeconds:Je,secondsToTicks:Qe}}function tt(t){const a=e(""),o=e(""),n=e(0),i=e=>(a.value=t.generatePlaySessionId(),o.value=e,n.value=0,a.value,a.value),s=e=>{if(o.value&&a.value){const r=void 0!==e?e:n.value;t.reportPlaybackStopped(o.value,r,a.value)}},l=e=>{a.value&&(s(e),a.value="",o.value="",n.value=0)};return r(()=>{a.value&&l()}),{playSessionId:a,currentItemId:o,initializeSession:i,reportStart:()=>{o.value&&a.value&&t.reportPlaybackStart(o.value,a.value)},reportProgress:(e,r)=>{o.value&&a.value&&(n.value=e,t.reportPlaybackProgress(o.value,e,r,a.value))},reportStop:s,endSession:l,switchItem:e=>(l(0),i(e))}}export{_ as T,h as _,v as a,N as b,Z as c,U as d,X as e,ee as f,et as g,Ve as h,R as i,A as j,de as k,ke as l,Ce as m,Me as n,De as o,je as p,We as q,qe as r,Ne as s,Ge as t,g as u,re as v,Ye as w,Q as x,tt as y};
